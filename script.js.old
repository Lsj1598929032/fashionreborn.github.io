// DOM Elements
document.addEventListener('DOMContentLoaded', function() {
  // å¯¼èˆªæ æ»šåŠ¨æ•ˆæœ
  const navbar = document.querySelector('.navbar');
  const heroSection = document.querySelector('.hero');
  
  if (navbar && heroSection) {
    const heroHeight = heroSection.offsetHeight;
    
    window.addEventListener('scroll', function() {
      if (window.scrollY > 100) {
        navbar.style.backgroundColor = 'rgba(47, 47, 47, 0.95)';
        navbar.style.color = '#FAF9F6';
      } else {
        navbar.style.backgroundColor = 'rgba(250, 249, 246, 0.95)';
        navbar.style.color = '#2F2F2F';
      }
    });
  }

  // åˆ‡æ¢ä¸»é¢˜æ¨¡å¼
  const themeSwitch = document.querySelector('.theme-switch');
  if (themeSwitch) {
    themeSwitch.addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      if (document.body.classList.contains('dark-mode')) {
        themeSwitch.textContent = 'â˜€ï¸';
      } else {
        themeSwitch.textContent = 'ğŸŒ™';
      }
    });
  }

  // è¯­è¨€åˆ‡æ¢
  const langSwitch = document.querySelector('.lang-switch');
  if (langSwitch) {
    langSwitch.addEventListener('click', function() {
      if (langSwitch.textContent === 'EN') {
        langSwitch.textContent = 'CN';
        // è¿™é‡Œæ·»åŠ å®é™…è¯­è¨€åˆ‡æ¢é€»è¾‘
      } else {
        langSwitch.textContent = 'EN';
        // è¿™é‡Œæ·»åŠ å®é™…è¯­è¨€åˆ‡æ¢é€»è¾‘
      }
    });
  }

  // æŒ‰é’®æ³¢çº¹æ•ˆæœ
  const buttons = document.querySelectorAll('button:not(.tag)');
  buttons.forEach(button => {
    button.classList.add('ripple-button');
    button.addEventListener('click', createRipple);
  });

  function createRipple(event) {
    const button = event.currentTarget;
    const ripple = document.createElement('span');
    const rect = button.getBoundingClientRect();
    
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;
    
    ripple.style.width = ripple.style.height = `${size}px`;
    ripple.style.left = `${x}px`;
    ripple.style.top = `${y}px`;
    
    button.appendChild(ripple);
    
    setTimeout(() => {
      ripple.remove();
    }, 600);
  }

  // ææ–™æ ‡ç­¾äº¤äº’
  const materialTags = document.querySelectorAll('.material-tags .tag');
  if (materialTags.length > 0) {
    materialTags.forEach(tag => {
      tag.addEventListener('click', function() {
        materialTags.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // æ ‡ç­¾ç¼åˆåŠ¨ç”»æ•ˆæœ
        const tagText = this.textContent;
        const filterDisplay = document.createElement('div');
        filterDisplay.classList.add('active-filter');
        filterDisplay.textContent = `å·²ç­›é€‰: ${tagText}`;
        
        const filterContainer = document.querySelector('.material-tags');
        const existingFilter = document.querySelector('.active-filter');
        
        if (existingFilter) {
          filterContainer.removeChild(existingFilter);
        }
        
        if (tagText !== 'å…¨éƒ¨') {
          filterContainer.appendChild(filterDisplay);
        }
        
        // è¿™é‡Œæ·»åŠ å®é™…è¿‡æ»¤é€»è¾‘
        filterProjects(tagText);
      });
    });
  }

  // æ¨¡æ‹Ÿé¡¹ç›®è¿‡æ»¤åŠŸèƒ½
  function filterProjects(category) {
    console.log(`Filtering projects by: ${category}`);
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šæ ¹æ®ç±»åˆ«è¿‡æ»¤DOMå…ƒç´ æˆ–ä»æœåŠ¡å™¨è¯·æ±‚æ•°æ®
  }

  // ç”Ÿæˆ3Då±•ç¤ºå¢™
  initShowcase3D();

  // ç”Ÿæˆé¡¹ç›®å±•ç¤ºå¡ç‰‡
  generateProjectCards();

  // èŠå¤©ç•Œé¢äº¤äº’
  console.log('å‡†å¤‡åˆå§‹åŒ–èŠå¤©ç•Œé¢...');
  setTimeout(() => {
    initChatInterface();
  }, 500); // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMå®Œå…¨åŠ è½½

  // è§†å·®æ»šåŠ¨æ•ˆæœ
  initParallaxEffect();

  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  initTrackingPanel();

  // åˆå§‹åŒ–è®¢é˜…ç³»ç»Ÿ
  initNewsletterSystem();
  initContentUpdateSystem();
  
  // æ¨¡æ‹Ÿå½“ç½‘ç«™æœ‰æ›´æ–°æ—¶ï¼Œé¢„è§ˆå°†è¦å‘é€çš„è®¢é˜…å†…å®¹
  const testPreviewBtn = document.createElement('button');
  testPreviewBtn.className = 'test-preview';
  testPreviewBtn.textContent = 'æµ‹è¯•è®¢é˜…æ›´æ–°é¢„è§ˆ';
  testPreviewBtn.style.display = 'none'; // å®é™…ä½¿ç”¨æ—¶è®¾ä¸ºnoneï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤º
  testPreviewBtn.addEventListener('click', () => {
    sendSubscriptionUpdates();
  });
  document.body.appendChild(testPreviewBtn);
  
  // æ·»åŠ ç®¡ç†å‘˜è§¦å‘å™¨ï¼Œå®é™…é¡¹ç›®ä¸­è¿™ä¼šæ˜¯ä¸€ä¸ªç®¡ç†å‘˜ç•Œé¢åŠŸèƒ½
  const adminKey = 'Ctrl+Alt+U';
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.altKey && e.key === 'u') {
      sendSubscriptionUpdates();
    }
  });

  // æ·»åŠ çª—å£è°ƒæ•´å¤§å°äº‹ä»¶ï¼Œç¡®ä¿é¢æ¿æ­£ç¡®æ˜¾ç¤º
  window.addEventListener('resize', function() {
    initTrackingPanel();
    adjustChatHeight(); // ç¡®ä¿èŠå¤©ç•Œé¢é«˜åº¦é€‚é…
  });
  
  // æ·»åŠ é‡è¯•æœºåˆ¶ï¼Œé˜²æ­¢é¢æ¿åˆå§‹åŒ–å¤±è´¥
  setTimeout(() => {
    const processFlow = document.querySelector('.process-flow');
    if (processFlow && processFlow.children.length === 0) {
      console.log('å°è¯•é‡æ–°åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿');
      initTrackingPanel();
    }
    
    // æ£€æŸ¥èŠå¤©ç•Œé¢æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
    const chatMessages = document.querySelector('.chat-messages');
    if (chatMessages && chatMessages.children.length === 0) {
      console.log('å°è¯•é‡æ–°åˆå§‹åŒ–èŠå¤©ç•Œé¢');
      initChatInterface();
    }
  }, 1000);
});

// 3Då±•ç¤ºå¢™åˆå§‹åŒ–
function initShowcase3D() {
  const container = document.querySelector('.showcase-container');
  if (!container) return;

  // ç§»é™¤å ä½ç¬¦
  const placeholder = container.querySelector('.placeholder-3d');
  if (placeholder) {
    container.removeChild(placeholder);
  }

  // åˆ›å»º3Då±•ç¤ºå¢™ - ç®€åŒ–ç‰ˆæ¨¡æ‹Ÿ
  // åœ¨å®Œæ•´å®ç°ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨Three.jsåº“
  
  // åˆ›å»º6ä¸ªå±•ç¤ºå¡ç‰‡ä½œä¸ºç«‹æ–¹ä½“çš„é¢
  const cube = document.createElement('div');
  cube.classList.add('showcase-cube');
  
  for (let i = 0; i < 6; i++) {
    const face = document.createElement('div');
    face.classList.add('cube-face', `face-${i+1}`);
    
    const image = document.createElement('img');
    image.src = `assets/project-${i+1}.jpg`;
    image.alt = `æ”¹é€ é¡¹ç›® ${i+1}`;
    
    face.appendChild(image);
    cube.appendChild(face);
    
    // ç‚¹å‡»å±•å¼€è¯¦æƒ…
    face.addEventListener('click', function() {
      showProjectDetail(i+1);
    });
  }
  
  container.appendChild(cube);
  
  // æ·»åŠ æ‹–åŠ¨äº¤äº’
  let isDragging = false;
  let previousX = 0;
  let previousY = 0;
  let rotX = 0;
  let rotY = 0;
  
  container.addEventListener('mousedown', function(e) {
    isDragging = true;
    previousX = e.clientX;
    previousY = e.clientY;
    container.style.cursor = 'grabbing';
  });
  
  window.addEventListener('mousemove', function(e) {
    if (isDragging) {
      const dx = e.clientX - previousX;
      const dy = e.clientY - previousY;
      
      rotY += dx * 0.5;
      rotX -= dy * 0.5;
      
      cube.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
      
      previousX = e.clientX;
      previousY = e.clientY;
    }
  });
  
  window.addEventListener('mouseup', function() {
    isDragging = false;
    container.style.cursor = 'grab';
  });
}

// é¡¹ç›®è¯¦æƒ…å¼¹çª—
function showProjectDetail(projectId) {
  // åˆ›å»ºæ¨¡æ€æ¡†
  const modal = document.createElement('div');
  modal.classList.add('project-modal');
  
  const modalContent = document.createElement('div');
  modalContent.classList.add('modal-content');
  
  // æ·»åŠ å…³é—­æŒ‰é’®
  const closeBtn = document.createElement('button');
  closeBtn.classList.add('close-modal');
  closeBtn.innerHTML = '&times;';
  closeBtn.addEventListener('click', function() {
    document.body.removeChild(modal);
  });
  
  // æ·»åŠ é¡¹ç›®å†…å®¹
  const projectContent = document.createElement('div');
  projectContent.classList.add('project-detail');
  
  const projectTitle = document.createElement('h3');
  projectTitle.textContent = `æ”¹é€ é¡¹ç›® ${projectId}`;
  
  const beforeAfterContainer = document.createElement('div');
  beforeAfterContainer.classList.add('before-after-slider');
  
  // è¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æ›´å¤æ‚çš„æ»‘å—å¯¹æ¯”ç»„ä»¶
  const beforeImg = document.createElement('img');
  beforeImg.src = `assets/project-${projectId}-before.jpg`;
  beforeImg.alt = 'æ”¹é€ å‰';
  
  const afterImg = document.createElement('img');
  afterImg.src = `assets/project-${projectId}-after.jpg`;
  afterImg.alt = 'æ”¹é€ å';
  
  beforeAfterContainer.appendChild(beforeImg);
  beforeAfterContainer.appendChild(afterImg);
  
  const projectDesc = document.createElement('p');
  projectDesc.textContent = 'è¿™æ˜¯ä¸€ä¸ªæ—§ç‰›ä»”è£¤æ”¹é€ é¡¹ç›®ï¼Œé€šè¿‡æ‹¼æ¥å‰ªè£å’Œæ‰‹å·¥è£…é¥°ï¼Œå°†åºŸæ—§ç‰›ä»”è£¤å˜æˆæ—¶å°šå•è‚©åŒ…ã€‚é‡‡ç”¨é›¶æµªè´¹è®¾è®¡åŸåˆ™ï¼Œç”šè‡³å°†æ‹‰é“¾å’Œçº½æ‰£ä¹Ÿé‡æ–°åˆ©ç”¨ã€‚';
  
  const designSketch = document.createElement('img');
  designSketch.classList.add('design-sketch');
  designSketch.src = `assets/sketch-${projectId}.jpg`;
  designSketch.alt = 'è®¾è®¡è‰å›¾';
  
  projectContent.appendChild(projectTitle);
  projectContent.appendChild(beforeAfterContainer);
  projectContent.appendChild(projectDesc);
  projectContent.appendChild(designSketch);
  
  modalContent.appendChild(closeBtn);
  modalContent.appendChild(projectContent);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}

// ç”Ÿæˆé¡¹ç›®å¡ç‰‡
function generateProjectCards() {
  const projectsGrid = document.querySelector('.projects-grid');
  if (!projectsGrid) return;
  
  // æ¨¡æ‹Ÿæ•°æ®
  const projectsData = [
    { id: 1, title: 'ç‰›ä»”å¤–å¥—æ”¹é€ ', material: 'ç‰›ä»”', difficulty: 4, imageUrl: 'assets/project-1.jpg' },
    { id: 2, title: 'ä¸è´¨å›´å·¾å˜è£™', material: 'ä¸ç»¸', difficulty: 3, imageUrl: 'assets/project-2.jpg' },
    { id: 3, title: 'äºšéº»è¡¬è¡«ç¿»æ–°', material: 'æ£‰éº»', difficulty: 2, imageUrl: 'assets/project-3.jpg' },
    { id: 4, title: 'çš®å¤¹å…‹æ”¹é€ ', material: 'çš®é©', difficulty: 5, imageUrl: 'assets/project-4.jpg' },
    { id: 5, title: 'é’ˆç»‡è¡«é‡æ„', material: 'é’ˆç»‡', difficulty: 3, imageUrl: 'assets/project-5.jpg' },
    { id: 6, title: 'ç‰›ä»”è£¤å˜åŒ…', material: 'ç‰›ä»”', difficulty: 4, imageUrl: 'assets/project-6.jpg' },
    { id: 7, title: 'ä¸å·¾å†é€ ', material: 'ä¸ç»¸', difficulty: 2, imageUrl: 'assets/project-7.jpg' },
    { id: 8, title: 'æ£‰å¸ƒæ‹¼æ¥', material: 'æ£‰éº»', difficulty: 3, imageUrl: 'assets/project-8.jpg' }
  ];
  
  projectsData.forEach(project => {
    const card = document.createElement('div');
    card.classList.add('project-card', 'card-3d');
    card.dataset.material = project.material;
    
    const cardInner = document.createElement('div');
    cardInner.classList.add('card-inner');
    
    // å¡ç‰‡æ­£é¢
    const cardFront = document.createElement('div');
    cardFront.classList.add('card-front');
    
    const image = document.createElement('img');
    image.src = project.imageUrl;
    image.alt = project.title;
    
    const title = document.createElement('h4');
    title.textContent = project.title;
    
    const difficultyContainer = document.createElement('div');
    difficultyContainer.classList.add('difficulty-stars');
    
    // æ·»åŠ éš¾åº¦æ˜Ÿçº§
    for (let i = 0; i < 5; i++) {
      const star = document.createElement('span');
      star.classList.add('star');
      if (i < project.difficulty) {
        star.classList.add('filled');
      }
      difficultyContainer.appendChild(star);
    }
    
    cardFront.appendChild(image);
    cardFront.appendChild(title);
    cardFront.appendChild(difficultyContainer);
    
    // å¡ç‰‡èƒŒé¢
    const cardBack = document.createElement('div');
    cardBack.classList.add('card-back');
    
    const materialChart = document.createElement('div');
    materialChart.classList.add('material-chart');
    materialChart.innerHTML = `<h5>ææ–™æˆåˆ†</h5>
      <div class="chart-container">
        <canvas class="radar-chart" width="150" height="150"></canvas>
      </div>
      <p>ä¸»è¦æè´¨: ${project.material}</p>`;
    
    const storyPreview = document.createElement('div');
    storyPreview.classList.add('story-preview');
    storyPreview.innerHTML = `<p>è¿™æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•ç»™æ—§è¡£ç‰©èµ‹äºˆæ–°ç”Ÿå‘½çš„æ•…äº‹ï¼Œç‚¹å‡»æŸ¥çœ‹å®Œæ•´æ”¹é€ è¿‡ç¨‹...</p>`;
    
    const viewButton = document.createElement('button');
    viewButton.classList.add('view-button');
    viewButton.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
    viewButton.addEventListener('click', function() {
      showProjectDetail(project.id);
    });
    
    cardBack.appendChild(materialChart);
    cardBack.appendChild(storyPreview);
    cardBack.appendChild(viewButton);
    
    cardInner.appendChild(cardFront);
    cardInner.appendChild(cardBack);
    card.appendChild(cardInner);
    
    projectsGrid.appendChild(card);
  });
}

// èŠå¤©ç•Œé¢äº¤äº’
function initChatInterface() {
  console.log('åˆå§‹åŒ–èŠå¤©ç•Œé¢...');
  
  const chatInput = document.querySelector('.chat-input input');
  const sendButton = document.querySelector('.send-button');
  const chatMessages = document.querySelector('.chat-messages');
  const chatInterface = document.querySelector('.chat-interface');
  const chatSidebar = document.querySelector('.chat-sidebar');
  
  // æ·»åŠ æ›´å¼ºçš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•
  if (!chatInput) {
    console.error('èŠå¤©è¾“å…¥æ¡†æœªæ‰¾åˆ°');
  }
  
  if (!sendButton) {
    console.error('å‘é€æŒ‰é’®æœªæ‰¾åˆ°');
  }
  
  if (!chatMessages) {
    console.error('èŠå¤©æ¶ˆæ¯åŒºåŸŸæœªæ‰¾åˆ°');
  }
  
  if (!chatInterface) {
    console.error('èŠå¤©ç•Œé¢æœªæ‰¾åˆ°');
  }
  
  if (!chatSidebar) {
    console.error('èŠå¤©ä¾§è¾¹æ æœªæ‰¾åˆ°');
  }
  
  // å¦‚æœå…³é”®å…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
  if (!chatInput || !sendButton || !chatMessages) {
    console.error('èŠå¤©å…³é”®å…ƒç´ æœªæ‰¾åˆ°ï¼Œåˆå§‹åŒ–å¤±è´¥');
    // å»¶è¿Ÿé‡è¯•ä¸€æ¬¡
    setTimeout(() => {
      console.log('å°è¯•é‡æ–°åˆå§‹åŒ–èŠå¤©ç•Œé¢...');
      initChatInterface();
    }, 1000);
    return;
  }
  
  console.log('èŠå¤©ç•Œé¢å…ƒç´ å·²æ‰¾åˆ°ï¼Œç»§ç»­åˆå§‹åŒ–');
  
  // ç¡®ä¿èŠå¤©åŒºåŸŸå¯è§
  if (chatInterface) {
    chatInterface.style.display = 'flex';
  }
  
  // å°è¯•ä»localStorageæ¢å¤å½“å‰ä¼šè¯IDï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºæ–°ä¼šè¯
  let currentSessionId = localStorage.getItem('currentSessionId');
  let currentSessionTitle = "æ–°å¯¹è¯";
  
  // å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯IDæˆ–è€…è¯¥ä¼šè¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ä¼šè¯
  if (!currentSessionId) {
    currentSessionId = generateSessionId();
    localStorage.setItem('currentSessionId', currentSessionId);
    console.log('åˆ›å»ºæ–°ä¼šè¯ID:', currentSessionId);
  } else {
    // å°è¯•ä»localStorageä¸­è·å–è¯¥ä¼šè¯çš„æ ‡é¢˜
    console.log('å°è¯•æ¢å¤ä¼šè¯ID:', currentSessionId);
    try {
      const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
      if (chatHistory[currentSessionId]) {
        currentSessionTitle = chatHistory[currentSessionId].title || "æ–°å¯¹è¯";
        console.log('æ¢å¤ä¼šè¯æ ‡é¢˜:', currentSessionTitle);
      } else {
        // å¦‚æœä¼šè¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ä¼šè¯
        console.log('ä¼šè¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ä¼šè¯');
        currentSessionId = generateSessionId();
        localStorage.setItem('currentSessionId', currentSessionId);
      }
    } catch (e) {
      console.error('è§£æèŠå¤©å†å²è®°å½•æ—¶å‡ºé”™:', e);
      // å‡ºé”™æ—¶é‡ç½®ä¼šè¯
      currentSessionId = generateSessionId();
      localStorage.setItem('currentSessionId', currentSessionId);
    }
  }
  
  // æ·»åŠ é»˜è®¤æ¬¢è¿æ¶ˆæ¯
  try {
    console.log('æ·»åŠ æ¬¢è¿æ¶ˆæ¯...');
    chatMessages.innerHTML = ''; // ç¡®ä¿æ¶ˆæ¯åŒºåŸŸä¸ºç©º
    
    const systemMessage = document.createElement('div');
    systemMessage.classList.add('message', 'system-message');
    
    const needleIcon = document.createElement('span');
    needleIcon.classList.add('needle-icon');
    needleIcon.innerHTML = 'ğŸ§µ';
    
    const messageText = document.createElement('span');
    messageText.innerHTML = 'æ¬¢è¿æ¥åˆ°Fashion Rebornæœè£…æ”¹é€ è‰ºæœ¯ç©ºé—´ï¼æˆ‘æ˜¯æ‚¨çš„é¡¾é—®ï¼Œæœ‰ä»»ä½•å…³äºæ¸…ç†åº“å­˜ã€æ”¶è´­åº“å­˜ï¼Œæ”¹é€ æˆè¡£æˆ–é¢æ–™çš„é—®é¢˜éƒ½å¯ä»¥å’¨è¯¢æˆ‘ã€‚å¦‚éœ€ç›´æ¥è”ç³»ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š<strong>JJ1598929032</strong>';
    
    systemMessage.appendChild(needleIcon);
    systemMessage.appendChild(messageText);
    
    chatMessages.appendChild(systemMessage);
    console.log('æ¬¢è¿æ¶ˆæ¯å·²æ·»åŠ ');
  } catch (e) {
    console.error('æ·»åŠ æ¬¢è¿æ¶ˆæ¯æ—¶å‡ºé”™:', e);
  }
  
  try {
    // åˆå§‹åŒ–å†å²ä¼šè¯
    console.log('åˆå§‹åŒ–å†å²ä¼šè¯...');
    initChatHistory(chatSidebar);
    
    // å¦‚æœæœ‰å½“å‰ä¼šè¯IDï¼ŒåŠ è½½è¯¥ä¼šè¯
    if (currentSessionId) {
      console.log('åŠ è½½ä¼šè¯:', currentSessionId);
      loadSession(currentSessionId);
    }
    
    // ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } catch (e) {
    console.error('åˆå§‹åŒ–å†å²ä¼šè¯æ—¶å‡ºé”™:', e);
  }
  
  // ç¡®ä¿å‘é€æŒ‰é’®å’Œè¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®æ·»åŠ 
  try {
    console.log('æ·»åŠ äº‹ä»¶ç›‘å¬å™¨...');
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨ï¼Œé¿å…é‡å¤
    sendButton.removeEventListener('click', sendMessage);
    chatInput.removeEventListener('keypress', handleKeyPress);
    
    // æ·»åŠ æ–°çš„ç›‘å¬å™¨
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', handleKeyPress);
    
    // æ·»åŠ è¾“å…¥æ—¶çš„åŠ¨æ€æ•ˆæœ
    chatInput.addEventListener('focus', function() {
      this.parentElement.classList.add('input-active');
    });
    
    chatInput.addEventListener('blur', function() {
      this.parentElement.classList.remove('input-active');
    });
    
    console.log('äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
  } catch (e) {
    console.error('æ·»åŠ äº‹ä»¶ç›‘å¬å™¨æ—¶å‡ºé”™:', e);
  }
  
  // ç›‘å¬å™¨å¤„ç†æŒ‰é”®äº‹ä»¶
  function handleKeyPress(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  }
  
  // åˆå§‹è°ƒæ•´é«˜åº¦
  adjustChatHeight();
  
  console.log('èŠå¤©ç•Œé¢åˆå§‹åŒ–å®Œæˆ');
  
  function sendMessage() {
    const message = chatInput.value.trim();
    if (message === '') return;
    
    // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
    const userMessage = document.createElement('div');
    userMessage.classList.add('message', 'user-message');
    userMessage.textContent = message;
    chatMessages.appendChild(userMessage);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    chatInput.value = '';
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // ç¡®ä¿èŠå¤©ç•Œé¢é«˜åº¦é€‚åº”å†…å®¹
    adjustChatHeight();
    
    // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°å½“å‰ä¼šè¯
    saveMessageToHistory(currentSessionId, 'user', message);
    
    // å¦‚æœè¿™æ˜¯æ–°ä¼šè¯çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ ¹æ®å†…å®¹ç”Ÿæˆæ ‡é¢˜
    if (currentSessionTitle === "æ–°å¯¹è¯") {
      currentSessionTitle = generateSessionTitle(message);
      updateSessionList();
    }
    
    // è·å–å½“å‰çš„èŠå¤©å†å²è®°å½•
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    const currentChatHistory = chatHistory[currentSessionId];
    
    // åˆ†æç”¨æˆ·èº«ä»½ï¼ˆå–å®¶/ä¹°å®¶ï¼‰
    const isSellerKeywords = ['å‡ºå”®', 'å–', 'å¤„ç†', 'æ¸…ç†', 'åº“å­˜', 'ç§¯å‹', 'æ‰¹å‘', 'å‡ºè´§', 'ä¾›åº”', 'æœ‰è´§', 'é—²ç½®', 'è½¬è®©', 'ç”©å–'];
    const isBuyerKeywords = ['æ”¶', 'è¦', 'æ”¶è´­', 'é‡‡è´­', 'è¿›è´§', 'æ±‚è´­', 'éœ€è¦', 'æƒ³ä¹°', 'æ‰¾è´§', 'è´­ä¹°', 'è®¢è´­'];
    
    // ç®€å•åˆ¤æ–­ç”¨æˆ·èº«ä»½
    const lowercaseMsg = message.toLowerCase();
    const isSeller = isSellerKeywords.some(keyword => lowercaseMsg.includes(keyword)) || 
                    /æˆ‘.*[æœ‰å–ä¾›]/.test(lowercaseMsg) || 
                    /æˆ‘.*åº“å­˜/.test(lowercaseMsg);
    
    const isBuyer = (!isSeller && (
                    isBuyerKeywords.some(keyword => lowercaseMsg.includes(keyword)) || 
                    /æˆ‘.*[ä¹°è¦æ‰¾]/.test(lowercaseMsg) || 
                    /æˆ‘.*éœ€è¦/.test(lowercaseMsg)));
    
    // åŸºäºç”¨æˆ·æ¶ˆæ¯æ›´æ–°å¯¹æ¥è¿›åº¦
    updateTrackingFromChat(message, isSeller, isBuyer);
    
    // æ¨¡æ‹Ÿç³»ç»Ÿå›å¤
    setTimeout(() => {
      const systemMessage = document.createElement('div');
      systemMessage.classList.add('message', 'system-message');
      
      // æ·»åŠ ç¼çº«é’ˆå›¾æ ‡å‰ç¼€
      const needleIcon = document.createElement('span');
      needleIcon.classList.add('needle-icon');
      needleIcon.innerHTML = 'ğŸ§µ';
      
      const messageText = document.createElement('span');
      const autoReply = getAutoReply(message);
      messageText.innerHTML = autoReply;
      
      systemMessage.appendChild(needleIcon);
      systemMessage.appendChild(messageText);
      
      chatMessages.appendChild(systemMessage);
      
      // ä¿å­˜ç³»ç»Ÿå›å¤åˆ°å½“å‰ä¼šè¯
      saveMessageToHistory(currentSessionId, 'system', autoReply);
      
      // æ·»åŠ æ‰“å­—åŠ¨ç”»æ•ˆæœ
      addTypingAnimation(messageText);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // å†æ¬¡è°ƒæ•´èŠå¤©ç•Œé¢é«˜åº¦
      adjustChatHeight();
      
      // åŸºäºç³»ç»Ÿå›å¤å†æ¬¡æ›´æ–°å¯¹æ¥è¿›åº¦
      updateTrackingFromChat(autoReply);
    }, 1000);
  }
  
  // ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ID
  function generateSessionId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
  
  // æ ¹æ®ç”¨æˆ·é¦–æ¡æ¶ˆæ¯å†…å®¹ç”Ÿæˆä¼šè¯æ ‡é¢˜
  function generateSessionTitle(message) {
    // æå–æ¶ˆæ¯çš„å‰10ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜ï¼Œå¦‚æœæ¶ˆæ¯å¤ªçŸ­åˆ™å…¨éƒ¨ä½¿ç”¨
    const titleText = message.length > 10 ? message.substring(0, 10) + '...' : message;
    return titleText;
  }
  
  // ä¿å­˜æ¶ˆæ¯åˆ°æœ¬åœ°å­˜å‚¨
  function saveMessageToHistory(sessionId, sender, content) {
    // ä»æœ¬åœ°å­˜å‚¨è·å–å·²æœ‰å†å²è®°å½•
    let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    
    // å¦‚æœä¼šè¯ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°ä¼šè¯
    if (!chatHistory[sessionId]) {
      chatHistory[sessionId] = {
        id: sessionId,
        title: currentSessionTitle,
        date: new Date().toISOString(),
        messages: []
      };
    }
    
    // æ·»åŠ æ–°æ¶ˆæ¯
    chatHistory[sessionId].messages.push({
      sender: sender,
      content: content,
      timestamp: new Date().toISOString()
    });
    
    // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
    chatHistory[sessionId].lastActive = new Date().toISOString();
    
    // æ›´æ–°ä¼šè¯æ ‡é¢˜ï¼ˆå¦‚æœå·²ç”Ÿæˆï¼‰
    if (currentSessionTitle !== "æ–°å¯¹è¯") {
      chatHistory[sessionId].title = currentSessionTitle;
    }
    
    // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    
    // æ›´æ–°å½“å‰ä¼šè¯IDåˆ°localStorage
    localStorage.setItem('currentSessionId', sessionId);
    
    // æ›´æ–°ä¼šè¯åˆ—è¡¨
    updateSessionList();
  }
  
  // æ·»åŠ æ‰“å­—åŠ¨ç”»æ•ˆæœ
  function addTypingAnimation(element) {
    const text = element.innerHTML;
    element.innerHTML = '';
    let i = 0;
    
    function typeWriter() {
      if (i < text.length) {
        element.innerHTML += text.charAt(i);
        i++;
        // éšæœºæ‰“å­—é€Ÿåº¦ï¼Œè®©æ•ˆæœæ›´è‡ªç„¶
        setTimeout(typeWriter, Math.random() * 10 + 20);
      }
    }
    
    // è€ƒè™‘åˆ°æ–‡æœ¬è¾ƒé•¿ä¸”æœ‰HTMLæ ‡ç­¾ï¼Œè¿™é‡Œç®€åŒ–ä¸ä½¿ç”¨çœŸå®çš„æ‰“å­—æ•ˆæœ
    element.innerHTML = text;
    element.style.opacity = '0';
    setTimeout(() => {
      element.style.transition = 'opacity 0.5s';
      element.style.opacity = '1';
    }, 100);
  }
  
  // åˆå§‹åŒ–èŠå¤©å†å²
  function initChatHistory(sidebar) {
    // ç¡®ä¿å†å²ä¼šè¯æ ‡é¢˜å·²æ·»åŠ 
    if (!sidebar.querySelector('.sidebar-header')) {
      const header = document.createElement('div');
      header.classList.add('sidebar-header');
      header.innerHTML = 'å†å²ä¼šè¯<span class="current-time"></span>';
      sidebar.appendChild(header);
    }
    
    // æ›´æ–°å½“å‰åŒ—äº¬æ—¶é—´æ˜¾ç¤º
    updateCurrentTime();
    
    // æ›´æ–°ä¼šè¯åˆ—è¡¨
    updateSessionList();
    
    // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
    setInterval(updateCurrentTime, 1000);
  }
  
  // æ›´æ–°å½“å‰åŒ—äº¬æ—¶é—´æ˜¾ç¤º
  function updateCurrentTime() {
    const now = new Date();
    now.setTime(now.getTime() + (8 * 60 * 60 * 1000)); // è°ƒæ•´ä¸ºUTC+8
    const hours = String(now.getUTCHours()).padStart(2, '0');
    const minutes = String(now.getUTCMinutes()).padStart(2, '0');
    const seconds = String(now.getUTCSeconds()).padStart(2, '0');
    const currentTime = `${hours}:${minutes}:${seconds}`;
    
    const timeElement = chatSidebar.querySelector('.sidebar-header .current-time');
    if (timeElement) {
      timeElement.textContent = `åŒ—äº¬æ—¶é—´ ${currentTime}`;
    }
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸä¸ºæ›´å‹å¥½çš„æ ¼å¼
  function formatDate(dateString) {
    const date = new Date(dateString);
    // è°ƒæ•´ä¸ºåŒ—äº¬æ—¶é—´
    date.setTime(date.getTime() + (8 * 60 * 60 * 1000));
    
    const now = new Date();
    now.setTime(now.getTime() + (8 * 60 * 60 * 1000));
    
    const today = new Date(now);
    today.setUTCHours(0, 0, 0, 0);
    
    const yesterday = new Date(today);
    yesterday.setUTCDate(yesterday.getUTCDate() - 1);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
    if (date >= today) {
      const hours = String(date.getUTCHours()).padStart(2, '0');
      const minutes = String(date.getUTCMinutes()).padStart(2, '0');
      return `ä»Šå¤© ${hours}:${minutes}`;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜¨å¤©
    if (date >= yesterday && date < today) {
      return "æ˜¨å¤©";
    }
    
    // ä¸€å‘¨å†…æ˜¾ç¤ºæ˜ŸæœŸ
    const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const diffDays = Math.floor((today - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays < 7) {
      return weekDays[date.getUTCDay()];
    }
    
    // æ›´æ—©çš„æ—¥æœŸæ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const day = String(date.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  
  // æ›´æ–°ä¼šè¯åˆ—è¡¨
  function updateSessionList() {
    // ä»æœ¬åœ°å­˜å‚¨è·å–å†å²è®°å½•
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    
    // è·å–æ‰€æœ‰ä¼šè¯å¹¶æŒ‰æœ€åæ´»åŠ¨æ—¶é—´æ’åº
    const sessions = Object.values(chatHistory).sort((a, b) => 
      new Date(b.lastActive || b.date) - new Date(a.lastActive || a.date)
    );
    
    // æ¸…ç©ºå·²æœ‰çš„å†å²ä¼šè¯é¡¹ç›®
    chatSidebar.querySelectorAll('.session-item').forEach(item => item.remove());
    
    // å¦‚æœæ²¡æœ‰å†å²ä¼šè¯è®°å½•ï¼Œæ·»åŠ æ–°ä¼šè¯æŒ‰é’®
    if (sessions.length === 0) {
      const newChatButton = document.createElement('div');
      newChatButton.classList.add('session-item', 'new-chat');
      newChatButton.innerHTML = '<div class="session-title">å¼€å§‹æ–°å¯¹è¯</div>';
      
      newChatButton.addEventListener('click', () => {
        startNewSession();
      });
      
      chatSidebar.appendChild(newChatButton);
      return;
    }
    
    // æ·»åŠ æ–°ä¼šè¯æŒ‰é’®
    const newChatButton = document.createElement('div');
    newChatButton.classList.add('session-item', 'new-chat');
    newChatButton.innerHTML = '<div class="session-title">å¼€å§‹æ–°å¯¹è¯</div>';
    
    newChatButton.addEventListener('click', () => {
      startNewSession();
    });
    
    chatSidebar.appendChild(newChatButton);
    
    // æ·»åŠ å†å²ä¼šè¯
    sessions.forEach(session => {
      const sessionItem = document.createElement('div');
      sessionItem.classList.add('session-item');
      sessionItem.dataset.sessionId = session.id;
      
      if (session.id === currentSessionId) {
        sessionItem.classList.add('active');
      }
      
      const sessionTitle = document.createElement('div');
      sessionTitle.classList.add('session-title');
      sessionTitle.textContent = session.title || "æ— æ ‡é¢˜å¯¹è¯";
      
      const sessionDate = document.createElement('div');
      sessionDate.classList.add('session-date');
      
      const formattedDate = formatDate(session.lastActive || session.date);
      sessionDate.innerHTML = `<span class="date-icon">ğŸ•’</span> ${formattedDate}`;
      
      // å®Œæ•´æ—¥æœŸä½œä¸ºæ‚¬åœæç¤º
      const fullDate = new Date(session.lastActive || session.date);
      fullDate.setTime(fullDate.getTime() + (8 * 60 * 60 * 1000)); // è°ƒæ•´ä¸ºåŒ—äº¬æ—¶é—´
      
      const fullDateStr = `${fullDate.getUTCFullYear()}-${String(fullDate.getUTCMonth() + 1).padStart(2, '0')}-${String(fullDate.getUTCDate()).padStart(2, '0')} ${String(fullDate.getUTCHours()).padStart(2, '0')}:${String(fullDate.getUTCMinutes()).padStart(2, '0')}`;
      sessionDate.title = fullDateStr;
      
      // æ·»åŠ åˆ é™¤æŒ‰é’®
      const deleteButton = document.createElement('span');
      deleteButton.classList.add('delete-session');
      deleteButton.innerHTML = 'âœ•';
      deleteButton.title = 'åˆ é™¤å¯¹è¯';
      deleteButton.onclick = (e) => {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘ä¼šè¯ç‚¹å‡»äº‹ä»¶
        deleteSession(session.id);
      };
      
      sessionItem.appendChild(sessionTitle);
      sessionItem.appendChild(sessionDate);
      sessionItem.appendChild(deleteButton);
      
      // ç‚¹å‡»åˆ‡æ¢ä¼šè¯
      sessionItem.addEventListener('click', () => {
        loadSession(session.id);
      });
      
      chatSidebar.appendChild(sessionItem);
    });
  }
  
  // åˆ é™¤ä¼šè¯
  function deleteSession(sessionId) {
    if (confirm('ç¡®è®¤åˆ é™¤è¿™ä¸ªå¯¹è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
      // ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–ä¼šè¯æ•°æ®
      const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
      
      // åˆ é™¤æŒ‡å®šä¼šè¯
      if (chatHistory[sessionId]) {
        delete chatHistory[sessionId];
        
        // ä¿å­˜æ›´æ–°åçš„ä¼šè¯æ•°æ®
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ™å¼€å§‹æ–°ä¼šè¯
        if (sessionId === currentSessionId) {
          startNewSession();
        } else {
          // ä»…æ›´æ–°ä¼šè¯åˆ—è¡¨
          updateSessionList();
        }
      }
    }
  }
  
  // åŠ è½½æŒ‡å®šä¼šè¯
  function loadSession(sessionId) {
    // ä»æœ¬åœ°å­˜å‚¨è·å–ä¼šè¯æ•°æ®
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    const session = chatHistory[sessionId];
    
    if (!session) {
      console.error('ä¼šè¯ä¸å­˜åœ¨:', sessionId);
      startNewSession(); // å¦‚æœä¼šè¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ä¼šè¯
      return;
    }
    
    // æ›´æ–°å½“å‰ä¼šè¯ID
    currentSessionId = sessionId;
    localStorage.setItem('currentSessionId', currentSessionId);
    
    // æ›´æ–°ä¼šè¯æ ‡é¢˜
    currentSessionTitle = session.title || "æ— æ ‡é¢˜å¯¹è¯";
    
    // æ›´æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„æ¿€æ´»çŠ¶æ€
    chatSidebar.querySelectorAll('.session-item').forEach(item => {
      item.classList.remove('active');
    });
    
    const activeItem = Array.from(chatSidebar.querySelectorAll('.session-item')).find(
      item => item.dataset.sessionId === sessionId
    );
    
    if (activeItem) {
      activeItem.classList.add('active');
    }
    
    // æ¸…ç©ºå½“å‰æ¶ˆæ¯
    chatMessages.innerHTML = '';
    
    // æ˜¾ç¤ºä¼šè¯æ¶ˆæ¯
    session.messages.forEach(msg => {
      const messageElement = document.createElement('div');
      
      if (msg.sender === 'user') {
        messageElement.classList.add('message', 'user-message');
        messageElement.textContent = msg.content;
      } else {
        messageElement.classList.add('message', 'system-message');
        
        const needleIcon = document.createElement('span');
        needleIcon.classList.add('needle-icon');
        needleIcon.innerHTML = 'ğŸ§µ';
        
        const messageText = document.createElement('span');
        messageText.innerHTML = msg.content;
        
        messageElement.appendChild(needleIcon);
        messageElement.appendChild(messageText);
      }
      
      chatMessages.appendChild(messageElement);
    });
    
    // å¦‚æœä¼šè¯æ²¡æœ‰æ¶ˆæ¯ï¼Œæ·»åŠ æ¬¢è¿æ¶ˆæ¯
    if (session.messages.length === 0) {
      const systemMessage = document.createElement('div');
      systemMessage.classList.add('message', 'system-message');
      
      const needleIcon = document.createElement('span');
      needleIcon.classList.add('needle-icon');
      needleIcon.innerHTML = 'ğŸ§µ';
      
      const messageText = document.createElement('span');
      messageText.innerHTML = 'æ¬¢è¿æ¥åˆ°Fashion Rebornæœè£…æ”¹é€ è‰ºæœ¯ç©ºé—´ï¼æˆ‘æ˜¯æ‚¨çš„é¡¾é—®ï¼Œæœ‰ä»»ä½•å…³äºæ¸…ç†åº“å­˜ã€æ”¶è´­åº“å­˜ï¼Œæ”¹é€ æˆè¡£æˆ–é¢æ–™çš„é—®é¢˜éƒ½å¯ä»¥å’¨è¯¢æˆ‘ã€‚å¦‚éœ€ç›´æ¥è”ç³»ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š<strong>JJ1598929032</strong>';
      
      systemMessage.appendChild(needleIcon);
      systemMessage.appendChild(messageText);
      
      chatMessages.appendChild(systemMessage);
      
      // ä¿å­˜æ¬¢è¿æ¶ˆæ¯åˆ°å†å²è®°å½•
      saveMessageToHistory(sessionId, 'system', messageText.innerHTML);
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // è°ƒæ•´é«˜åº¦
    adjustChatHeight();
  }
  
  // å¼€å§‹æ–°ä¼šè¯
  function startNewSession() {
    // ç”Ÿæˆæ–°çš„ä¼šè¯ID
    currentSessionId = generateSessionId();
    localStorage.setItem('currentSessionId', currentSessionId);
    
    currentSessionTitle = "æ–°å¯¹è¯";
    
    // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
    chatMessages.innerHTML = '';
    
    // æ·»åŠ é»˜è®¤æ¬¢è¿æ¶ˆæ¯
    const systemMessage = document.createElement('div');
    systemMessage.classList.add('message', 'system-message');
    
    const needleIcon = document.createElement('span');
    needleIcon.classList.add('needle-icon');
    needleIcon.innerHTML = 'ğŸ§µ';
    
    const messageText = document.createElement('span');
    messageText.innerHTML = 'æ¬¢è¿æ¥åˆ°Fashion Rebornæœè£…æ”¹é€ è‰ºæœ¯ç©ºé—´ï¼æˆ‘æ˜¯æ‚¨çš„é¡¾é—®ï¼Œæœ‰ä»»ä½•å…³äºæ¸…ç†åº“å­˜ã€æ”¶è´­åº“å­˜ï¼Œæ”¹é€ æˆè¡£æˆ–é¢æ–™çš„é—®é¢˜éƒ½å¯ä»¥å’¨è¯¢æˆ‘ã€‚å¦‚éœ€ç›´æ¥è”ç³»ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š<strong>JJ1598929032</strong>';
    
    systemMessage.appendChild(needleIcon);
    systemMessage.appendChild(messageText);
    
    chatMessages.appendChild(systemMessage);
    
    // ä¿å­˜æ¬¢è¿æ¶ˆæ¯åˆ°å†å²è®°å½•
    saveMessageToHistory(currentSessionId, 'system', messageText.innerHTML);
    
    // æ›´æ–°ä¼šè¯åˆ—è¡¨
    updateSessionList();
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  // è°ƒæ•´èŠå¤©ç•Œé¢é«˜åº¦ä»¥é€‚åº”å†…å®¹
  function adjustChatHeight() {
    // ç¡®ä¿å¯¹è¯æ¡†å†…å®¹å®Œå…¨æ˜¾ç¤º
    chatMessages.style.maxHeight = '520px'; // ä¿æŒæœ€å¤§é«˜åº¦é™åˆ¶
    
    // ç¡®ä¿æ•´ä¸ªèŠå¤©ç•Œé¢ä¸é®æŒ¡å¯¹æ¥è¿›åº¦é¢æ¿
    const trackingPanel = document.querySelector('.tracking-panel');
    if (trackingPanel) {
      const chatBottom = chatInterface.getBoundingClientRect().bottom;
      const trackingTop = trackingPanel.getBoundingClientRect().top;
      
      // å¦‚æœèŠå¤©ç•Œé¢åº•éƒ¨è¶…å‡ºè·Ÿè¸ªé¢æ¿é¡¶éƒ¨ï¼Œå¢åŠ ä¸Šè¾¹è·
      if (chatBottom > trackingTop) {
        const currentMargin = parseInt(getComputedStyle(trackingPanel).marginTop) || 0;
        trackingPanel.style.marginTop = (currentMargin + (chatBottom - trackingTop) + 20) + 'px';
      }
    }
    
    // ä¸ºæ¶ˆæ¯æ·»åŠ åŠ¨ç”»æ•ˆæœ
    const messages = document.querySelectorAll('.message');
    messages.forEach((message, index) => {
      if (!message.style.animationDelay) {
        message.style.animationDelay = `${index * 0.1}s`;
      }
    });
  }
  
  sendButton.addEventListener('click', sendMessage);
  
  chatInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  
  // æ·»åŠ è¾“å…¥æ—¶çš„åŠ¨æ€æ•ˆæœ
  chatInput.addEventListener('focus', function() {
    this.parentElement.classList.add('input-active');
  });
  
  chatInput.addEventListener('blur', function() {
    this.parentElement.classList.remove('input-active');
  });
  
  // åˆå§‹è°ƒæ•´é«˜åº¦
  adjustChatHeight();
  
  // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´é«˜åº¦
  window.addEventListener('resize', adjustChatHeight);
  
  // ç®€å•çš„è‡ªåŠ¨å›å¤ç³»ç»Ÿ
  function getAutoReply(message) {
    const lowercaseMsg = message.toLowerCase();
    const wechatContact = '<strong>JJ1598929032</strong>';
    
    // è·å–å½“å‰ä¼šè¯çš„å†å²æ¶ˆæ¯ï¼Œç”¨äºä¸Šä¸‹æ–‡ç†è§£
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    const sessionMessages = chatHistory[currentSessionId]?.messages || [];
    
    // æå–æœ€è¿‘çš„å¯¹è¯å†å²ï¼ˆæœ€å¤šå–æœ€è¿‘5æ¡æ¶ˆæ¯ï¼‰
    const recentMessages = sessionMessages.slice(-10);
    
    // åˆ†æè¿‘æœŸå¯¹è¯ä¸»é¢˜å’Œä¸Šä¸‹æ–‡
    let conversationContext = '';
    let previousTopics = {
      fabric: false,     // æ˜¯å¦è®¨è®ºè¿‡é¢æ–™
      clothing: false,   // æ˜¯å¦è®¨è®ºè¿‡æœè£…
      price: false,      // æ˜¯å¦è®¨è®ºè¿‡ä»·æ ¼
      contact: false,    // æ˜¯å¦è¯¢é—®è¿‡è”ç³»æ–¹å¼
      seller: false,     // ç”¨æˆ·æ˜¯å¦æ˜¯å–å®¶
      buyer: false       // ç”¨æˆ·æ˜¯å¦æ˜¯ä¹°å®¶
    };
    
    // åˆ†æè¿‘æœŸå¯¹è¯å†…å®¹ï¼Œè¯†åˆ«ä¸»é¢˜
    recentMessages.forEach(msg => {
      const content = msg.content.toLowerCase();
      
      // æ£€æŸ¥æ˜¯å¦è®¨è®ºè¿‡é¢æ–™ç›¸å…³
      if (content.includes('é¢æ–™') || content.includes('å¸ƒæ–™') || content.includes('å¸ƒ')) {
        previousTopics.fabric = true;
        conversationContext += 'é¢æ–™ç›¸å…³ ';
      }
      
      // æ£€æŸ¥æ˜¯å¦è®¨è®ºè¿‡æœè£…ç›¸å…³
      if (content.includes('è¡£æœ') || content.includes('æœè£…') || content.includes('è£¤å­') || content.includes('è£™å­')) {
        previousTopics.clothing = true;
        conversationContext += 'æœè£…ç›¸å…³ ';
      }
      
      // æ£€æŸ¥æ˜¯å¦è®¨è®ºè¿‡ä»·æ ¼
      if (content.includes('ä»·æ ¼') || content.includes('å¤šå°‘é’±') || content.includes('è´¹ç”¨')) {
        previousTopics.price = true;
        conversationContext += 'ä»·æ ¼ç›¸å…³ ';
      }
      
      // æ£€æŸ¥æ˜¯å¦è¯¢é—®è¿‡è”ç³»æ–¹å¼
      if (content.includes('å¾®ä¿¡') || content.includes('è”ç³»') || content.includes('ç”µè¯')) {
        previousTopics.contact = true;
        conversationContext += 'è”ç³»æ–¹å¼ ';
      }
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯å–å®¶
      if (content.includes('å‡ºå”®') || content.includes('å–') || content.includes('æ¸…ç†')) {
        previousTopics.seller = true;
        conversationContext += 'å–å®¶èº«ä»½ ';
      }
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ä¹°å®¶
      if (content.includes('è´­ä¹°') || content.includes('ä¹°') || content.includes('éœ€è¦')) {
        previousTopics.buyer = true;
        conversationContext += 'ä¹°å®¶èº«ä»½ ';
      }
    });
    
    // è”ç³»æ–¹å¼å…³é”®è¯
    const contactKeywords = ['å¾®ä¿¡', 'ç”µè¯', 'è”ç³»', 'vx', 'wx', 'åŠ ', 'æ²Ÿé€š', 'å’¨è¯¢', 'å¯¹æ¥', 'åˆä½œ', 'æ€ä¹ˆåŠ ', 'æ€ä¹ˆè”ç³»', 'è”ç³»æ–¹å¼', 'åŠ ä½ '];
    
    // è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼ˆå–å®¶/ä¹°å®¶ï¼‰
    const isSellerKeywords = ['å‡ºå”®', 'å–', 'å¤„ç†', 'æ¸…ç†', 'åº“å­˜', 'ç§¯å‹', 'æ‰¹å‘', 'å‡ºè´§', 'ä¾›åº”', 'æœ‰è´§', 'é—²ç½®', 'è½¬è®©', 'ç”©å–', 'è¿‡å­£', 'å¤šä½™', 'æ¸…ä»“', 'å‡ºæ‰‹', 'ä»£å‘'];
    const isBuyerKeywords = ['æ”¶', 'è¦', 'æ”¶è´­', 'é‡‡è´­', 'è¿›è´§', 'æ±‚è´­', 'éœ€è¦', 'æƒ³ä¹°', 'æ‰¾è´§', 'è´­ä¹°', 'è®¢è´­', 'æ‹¿è´§', 'ä¹°å®¶', 'é‡‡è´­å•†', 'å¯»æ‰¾', 'è¯¢ä»·', 'æƒ³è¦', 'å“ªé‡Œæœ‰'];
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºå–å®¶ - å¢åŠ å¯¹æ›´æ˜ç¡®è¡¨è¿°çš„è¯†åˆ«
    const isSeller = isSellerKeywords.some(keyword => lowercaseMsg.includes(keyword)) || 
                    previousTopics.seller || 
                    /æˆ‘.*[æœ‰å–ä¾›]/.test(lowercaseMsg) || 
                    /æˆ‘.*åº“å­˜/.test(lowercaseMsg) ||
                    /æˆ‘.*æ¸…ç†/.test(lowercaseMsg);
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºä¹°å®¶ - å¢åŠ å¯¹æ›´æ˜ç¡®è¡¨è¿°çš„è¯†åˆ«
    const isBuyer = (!isSeller && (
                    isBuyerKeywords.some(keyword => lowercaseMsg.includes(keyword)) || 
                    previousTopics.buyer || 
                    /æˆ‘.*[ä¹°è¦æ‰¾]/.test(lowercaseMsg) || 
                    /æˆ‘.*éœ€è¦/.test(lowercaseMsg) ||
                    /æˆ‘.*è´­ä¹°/.test(lowercaseMsg)));
    
    // æ›´æ–°ç”¨æˆ·è§’è‰²åˆ°ä¸Šä¸‹æ–‡è®°å¿†
    if (isSeller && !previousTopics.seller) {
      previousTopics.seller = true;
      previousTopics.buyer = false; // ä¸€ä¸ªç”¨æˆ·é€šå¸¸ä¸ä¼šåŒæ—¶æ˜¯ä¹°å®¶å’Œå–å®¶
      
      // ä¿å­˜æ›´æ–°åçš„ä¸Šä¸‹æ–‡åˆ°ä¼šè¯å†å²
      if (chatHistory[currentSessionId]) {
        chatHistory[currentSessionId].userContext = {
          ...chatHistory[currentSessionId].userContext,
          isSeller: true,
          isBuyer: false
        };
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      }
    } else if (isBuyer && !previousTopics.buyer) {
      previousTopics.buyer = true;
      previousTopics.seller = false; // ä¸€ä¸ªç”¨æˆ·é€šå¸¸ä¸ä¼šåŒæ—¶æ˜¯ä¹°å®¶å’Œå–å®¶
      
      // ä¿å­˜æ›´æ–°åçš„ä¸Šä¸‹æ–‡åˆ°ä¼šè¯å†å²
      if (chatHistory[currentSessionId]) {
        chatHistory[currentSessionId].userContext = {
          ...chatHistory[currentSessionId].userContext,
          isBuyer: true,
          isSeller: false
        };
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      }
    }
    
    // è¯†åˆ«å…·ä½“éœ€æ±‚ç±»å‹ - æ›´è¯¦ç»†çš„åˆ†ç±»
    let userNeeds = {
      price: lowercaseMsg.includes('ä»·æ ¼') || lowercaseMsg.includes('å¤šå°‘é’±') || lowercaseMsg.includes('æŠ¥ä»·') || previousTopics.price,
      quantity: /[0-9]+.*[ä»¶æ¡ç±³]/.test(lowercaseMsg) || lowercaseMsg.includes('æ•°é‡') || lowercaseMsg.includes('æ‰¹é‡'),
      quality: lowercaseMsg.includes('å“è´¨') || lowercaseMsg.includes('è´¨é‡') || lowercaseMsg.includes('ç­‰çº§') || lowercaseMsg.includes('å¥½å'),
      delivery: lowercaseMsg.includes('å‘è´§') || lowercaseMsg.includes('ç‰©æµ') || lowercaseMsg.includes('å¿«é€’') || lowercaseMsg.includes('è¿è´¹'),
      payment: lowercaseMsg.includes('ä»˜æ¬¾') || lowercaseMsg.includes('æ”¯ä»˜') || lowercaseMsg.includes('ç»“ç®—') || lowercaseMsg.includes('è½¬è´¦'),
      sample: lowercaseMsg.includes('æ ·å“') || lowercaseMsg.includes('æ ·æ¿') || lowercaseMsg.includes('æ‰“æ ·') || lowercaseMsg.includes('çœ‹æ¿')
    };
    
    // æå–è¯¢é—®çš„å…·ä½“äº§å“ç±»å‹ä»¥ä¾¿æä¾›æ›´ç²¾å‡†å›å¤
    let specificProductType = '';
    
    // æ ¹æ®å…³é”®è¯æå–å…·ä½“äº§å“
    if (lowercaseMsg.includes('ç‰›ä»”')) {
      specificProductType = 'ç‰›ä»”';
    } else if (lowercaseMsg.includes('ä¸ç»¸') || lowercaseMsg.includes('ä¸è´¨')) {
      specificProductType = 'ä¸ç»¸';
    } else if (lowercaseMsg.includes('æ£‰éº»') || lowercaseMsg.includes('äºšéº»')) {
      specificProductType = 'æ£‰éº»';
    } else if (lowercaseMsg.includes('ç¾Šæ¯›') || lowercaseMsg.includes('æ¯›å‘¢')) {
      specificProductType = 'ç¾Šæ¯›';
    }
    
    // ä»æœ€è¿‘çš„æ¶ˆæ¯ä¸­å°è¯•æå–äº§å“ç±»å‹ï¼ˆå¦‚æœå½“å‰æ¶ˆæ¯æ²¡æœ‰æ˜ç¡®æåŠï¼‰
    if (!specificProductType && recentMessages.length > 0) {
      for (let i = recentMessages.length - 1; i >= 0; i--) {
        const content = recentMessages[i].content.toLowerCase();
        if (content.includes('ç‰›ä»”')) {
          specificProductType = 'ç‰›ä»”';
          break;
        } else if (content.includes('ä¸ç»¸') || content.includes('ä¸è´¨')) {
          specificProductType = 'ä¸ç»¸';
          break;
        } else if (content.includes('æ£‰éº»') || content.includes('äºšéº»')) {
          specificProductType = 'æ£‰éº»';
          break;
        } else if (content.includes('ç¾Šæ¯›') || content.includes('æ¯›å‘¢')) {
          specificProductType = 'ç¾Šæ¯›';
          break;
        }
      }
    }
    
    // è¯†åˆ«æ˜¯å¦æ˜¯åœ¨è¯¢é—®æ›´å¤šè¯¦æƒ…çš„è·Ÿè¿›é—®é¢˜
    const isDetailFollowup = /æ›´å¤š|è¯¦ç»†|å…·ä½“|æ€ä¹ˆæ ·|å“ªäº›|ä»€ä¹ˆ|å¦‚ä½•|èƒ½å¦/.test(lowercaseMsg);
    
    // æ·»åŠ å…³é”®å˜é‡ï¼šå®šä¹‰æœè£…æŸ¥è¯¢å’Œé¢æ–™æŸ¥è¯¢è¯†åˆ«é€»è¾‘
    // æœè£…ç›¸å…³å…³é”®è¯
    const clothingKeywords = ['è¡£æœ', 'æœè£…', 'è£¤å­', 'è£™å­', 'ä¸Šè¡£', 'å¤–å¥—', 'å¤¹å…‹', 'å¤§è¡£', 'å«è¡£', 'æ¯›è¡£', 'è¡¬è¡«', 'å†…è¡£', 'Tæ¤', 'è¥¿è£…', 'ç«¥è£…', 'è¿è¡£è£™', 'é£è¡£', 'è¢œå­', 'å¸½å­', 'æœé¥°'];
    
    // æ˜ç¡®çš„æœè£…çŸ­è¯­ç»„åˆ
    const explicitClothingPhrases = [
      'ç‰›ä»”è£¤', 'ç‰›ä»”å¤¹å…‹', 'ç‰›ä»”å¤–å¥—', 'ç‰›ä»”è¡¬è¡«', 'ç‰›ä»”è£™', 
      'ä¸ç»¸è¡¬è¡«', 'ä¸ç»¸è¿è¡£è£™', 'ä¸ç»¸ç¡è¡£', 'ä¸ç»¸è£™',
      'ç¾Šæ¯›è¡«', 'ç¾Šæ¯›å¤–å¥—', 'æ¯›å‘¢å¤§è¡£', 'ç¾Šæ¯›è£¤',
      'æ£‰éº»è¡¬è¡«', 'æ£‰éº»è£¤', 'äºšéº»è£™', 'æ£‰éº»å¥—è£…'
    ];
    
    // é¢æ–™ç›¸å…³å…³é”®è¯
    const fabricKeywords = ['é¢æ–™', 'å¸ƒæ–™', 'å¸ƒ', 'çººç»‡', 'å¸ƒåŒ¹', 'æè´¨', 'ç»‡ç‰©', 'åŸæ–™', 'å¸ƒè‰º', 'ç»¸ç¼', 'çš®æ–™', 'äººé€ é©', 'çº±'];
    
    // æ˜ç¡®çš„é¢æ–™çŸ­è¯­ç»„åˆ
    const explicitFabricPhrases = [
      'ç‰›ä»”å¸ƒ', 'ç‰›ä»”é¢æ–™', 
      'ä¸ç»¸é¢æ–™', 'çœŸä¸å¸ƒæ–™',
      'ç¾Šæ¯›é¢æ–™', 'æ¯›å‘¢å¸ƒæ–™',
      'æ£‰éº»é¢æ–™', 'äºšéº»å¸ƒæ–™'
    ];
    
    // åˆ¤æ–­æ˜¯å¦æ˜¯æœè£…æŸ¥è¯¢ - ä¼˜å…ˆè€ƒè™‘æ˜ç¡®çš„æœè£…äº§å“å…³é”®è¯ï¼Œå¹¶æ’é™¤æ˜ç¡®çš„é¢æ–™æåŠ
    const isClothingQuery = (
      (clothingKeywords.some(keyword => lowercaseMsg.includes(keyword)) && 
      !fabricKeywords.some(keyword => lowercaseMsg.includes(keyword))) || 
      previousTopics.clothing
    );
    
    // åˆ¤æ–­æ˜¯å¦åŒ…å«æ˜ç¡®çš„æœè£…çŸ­è¯­ - è¿™äº›ç»„åˆé€šå¸¸æ˜ç¡®æŒ‡å‘æˆå“æœè£…
    const hasExplicitClothingPhrase = explicitClothingPhrases.some(phrase => lowercaseMsg.includes(phrase));
    
    // åˆ¤æ–­æ˜¯å¦æ˜¯é¢æ–™æŸ¥è¯¢ - ä¼˜å…ˆè€ƒè™‘æ˜ç¡®çš„é¢æ–™å…³é”®è¯ 
    const isFabricQuery = (
      (fabricKeywords.some(keyword => lowercaseMsg.includes(keyword)) &&
      !hasExplicitClothingPhrase) ||
      previousTopics.fabric
    );
    
    // åˆ¤æ–­æ˜¯å¦åŒ…å«æ˜ç¡®çš„é¢æ–™çŸ­è¯­ - è¿™äº›ç»„åˆé€šå¸¸æ˜ç¡®æŒ‡å‘é¢æ–™è€Œéæˆå“
    const hasExplicitFabricPhrase = explicitFabricPhrases.some(phrase => lowercaseMsg.includes(phrase));
    
    // æ¡ä»¶åˆ¤æ–­ä¼˜å…ˆçº§é‡æ’ï¼Œç¡®ä¿æˆè¡£æŸ¥è¯¢ä¼˜å…ˆ
    if (contactKeywords.some(keyword => lowercaseMsg.includes(keyword)) || previousTopics.contact) {
      return `æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼ä¸ºäº†ç»™æ‚¨æä¾›æ›´é«˜æ•ˆçš„æœåŠ¡ï¼Œå»ºè®®æ‚¨æ·»åŠ æˆ‘ä»¬çš„ä¸“å±å®¢æœå¾®ä¿¡ï¼š${wechatContact}<br><br>
      é€šè¿‡å¾®ä¿¡ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š<br>
      1. å‘é€æ›´å¤š${previousTopics.fabric ? 'é¢æ–™' : previousTopics.clothing ? 'æœè£…' : 'é¢æ–™/æœè£…'}å®æ‹å›¾ç‰‡å’Œè§†é¢‘<br>
      2. æä¾›ç²¾ç¡®çš„åº“å­˜æ•°é‡å’Œä»·æ ¼ä¿¡æ¯<br>
      3. åˆ†äº«æ›´å¤šæˆåŠŸæ¡ˆä¾‹å’Œæ”¹é€ æ–¹æ¡ˆ<br>
      4. é’ˆå¯¹æ‚¨çš„å…·ä½“éœ€æ±‚æä¾›ä¸€å¯¹ä¸€æœåŠ¡<br><br>
      ${isSeller ? 
        `ä½œä¸ºå–å®¶ï¼Œæˆ‘ä»¬å¯ä»¥å¸®æ‚¨ï¼š<br>
        - å¯¹æ¥åˆé€‚çš„ä¹°å®¶æ¸ é“<br>
        - æä¾›ä¸“ä¸šçš„åº“å­˜è¯„ä¼°<br>
        - åˆ¶å®šä¸ªæ€§åŒ–çš„é”€å”®æ–¹æ¡ˆ<br>`
        : 
        isBuyer ? 
        `ä½œä¸ºä¹°å®¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ‚¨ï¼š<br>
        - åŒ¹é…æœ€é€‚åˆçš„äº§å“èµ„æº<br>
        - æä¾›æ ·å“å’Œå®ç‰©å¯¹æ¯”<br>
        - ååŠ©åˆ¶å®šé‡‡è´­è®¡åˆ’<br>`
        : 
        'æ— è®ºæ‚¨æ˜¯æƒ³æ¸…ç†åº“å­˜çš„å–å®¶ï¼Œè¿˜æ˜¯å¯»æ‰¾è´§æºçš„ä¹°å®¶ï¼Œæˆ‘ä»¬éƒ½èƒ½ä¸ºæ‚¨æä¾›ä¸“ä¸šæ”¯æŒã€‚'}<br><br>
      æˆ‘ä»¬çš„å®¢æœå›¢é˜Ÿä¼šåœ¨5åˆ†é’Ÿå†…å›å¤æ‚¨çš„æ¶ˆæ¯ï¼ŒæœŸå¾…ä¸æ‚¨çš„è¿›ä¸€æ­¥æ²Ÿé€šï¼`;
    }
    // ä¹°å®¶å¯¹æˆè¡£çš„æŸ¥è¯¢
    else if ((isBuyer && isClothingQuery) || (isBuyer && hasExplicitClothingPhrase)) {
      if (userNeeds.price) {
        return `ä½œä¸ºä¹°å®¶ï¼Œæ‚¨å…³å¿ƒçš„${specificProductType ? specificProductType : ''}æœè£…ä»·æ ¼ä¿¡æ¯å¦‚ä¸‹ï¼š<br><br>
        ${specificProductType === 'ç‰›ä»”' ? 
          `ç‰›ä»”æœè£…ä»·æ ¼å‚è€ƒï¼š<br>
          - ç‰›ä»”è£¤ï¼š80-350å…ƒ/æ¡ï¼ˆå–å†³äºå·¥è‰ºå’Œé¢æ–™è´¨é‡ï¼‰<br>
          - ç‰›ä»”å¤¹å…‹ï¼š120-500å…ƒ/ä»¶<br>
          - ç‰›ä»”è¡¬è¡«ï¼š90-300å…ƒ/ä»¶<br>
          - ç‰›ä»”è£™è£…ï¼š70-280å…ƒ/æ¡<br><br>` 
          : 
          specificProductType === 'ä¸ç»¸' ? 
          `ä¸ç»¸æœè£…ä»·æ ¼å‚è€ƒï¼š<br>
          - ä¸ç»¸è¡¬è¡«ï¼š180-600å…ƒ/ä»¶ï¼ˆå–å†³äºçœŸä¸å«é‡ï¼‰<br>
          - ä¸ç»¸è¿è¡£è£™ï¼š250-1200å…ƒ/ä»¶<br>
          - ä¸ç»¸ç¡è¡£å¥—è£…ï¼š200-800å…ƒ/å¥—<br>
          - ä¸ç»¸å›´å·¾/ä¸å·¾ï¼š80-400å…ƒ/æ¡<br><br>` 
          : 
          `å„ç±»æœè£…ä»·æ ¼å‚è€ƒï¼š<br>
          - ä¼‘é—²Tæ¤ï¼š30-150å…ƒ/ä»¶<br>
          - è¡¬è¡«/ä¸Šè¡£ï¼š60-250å…ƒ/ä»¶<br>
          - è£¤è£…/è£™è£…ï¼š80-300å…ƒ/ä»¶<br>
          - å¤–å¥—/å¤§è¡£ï¼š150-800å…ƒ/ä»¶<br><br>`
        }
        æ‰¹é‡é‡‡è´­å¯äº«å—ä»¥ä¸‹ä¼˜æƒ ï¼š<br>
        - 10ä»¶ä»¥ä¸Šï¼š95æŠ˜<br>
        - 30ä»¶ä»¥ä¸Šï¼š9æŠ˜<br>
        - 100ä»¶ä»¥ä¸Šï¼š85æŠ˜<br>
        - 500ä»¶ä»¥ä¸Šï¼š8æŠ˜èµ·<br><br>
        ä¸ºè·å–å‡†ç¡®æŠ¥ä»·å’Œå½“å‰ä¿ƒé”€æ´»åŠ¨ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } 
      else if (userNeeds.quantity) {
        return `å…³äº${specificProductType ? specificProductType : ''}æœè£…çš„é‡‡è´­æ•°é‡ï¼š<br><br>
        æˆ‘ä»¬å¯ä»¥æ»¡è¶³ä¸åŒè§„æ¨¡çš„é‡‡è´­éœ€æ±‚ï¼š<br>
        - å°æ‰¹é‡ï¼š5-30ä»¶ï¼ˆé€‚åˆç²¾å“åº—å’Œå°å‹é›¶å”®å•†ï¼‰<br>
        - ä¸­ç­‰æ‰¹é‡ï¼š30-200ä»¶ï¼ˆé€‚åˆä¸­å‹é›¶å”®å•†ï¼‰<br>
        - å¤§æ‰¹é‡ï¼š200ä»¶ä»¥ä¸Šï¼ˆé€‚åˆå¤§å‹åˆ†é”€å•†ï¼‰<br><br>
        ${specificProductType ? `æˆ‘ä»¬ç›®å‰${specificProductType}æœè£…åº“å­˜å……è¶³ï¼Œå¯ä»¥æ»¡è¶³ç´§æ€¥è®¢å•éœ€æ±‚ã€‚` : 'å¤§éƒ¨åˆ†æ¬¾å¼éƒ½æœ‰ç°è´§ï¼Œå¯ç«‹å³å‘è´§ã€‚'}<br><br>
        é’ˆå¯¹ä¸åŒæ•°é‡çº§åˆ«ï¼Œæˆ‘ä»¬æœ‰ç›¸åº”çš„ä»·æ ¼æ¢¯åº¦å’ŒæœåŠ¡æ–¹æ¡ˆã€‚<br><br>
        è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¯¦ç»†æ²Ÿé€šæ‚¨çš„å…·ä½“é‡‡è´­éœ€æ±‚å’Œé¢„æœŸæ•°é‡ã€‚`;
      }
      else if (userNeeds.quality) {
        return `å…³äº${specificProductType ? specificProductType : ''}æœè£…çš„å“è´¨ï¼š<br><br>
        æˆ‘ä»¬æä¾›å¤šä¸ªå“è´¨ç­‰çº§çš„æœè£…ï¼š<br>
        - ç²¾å“çº§ï¼šé‡‡ç”¨é«˜å“è´¨é¢æ–™ï¼Œç²¾å·¥ç»†ä½œï¼Œé€‚åˆé«˜ç«¯å¸‚åœº<br>
        - å•†åŠ¡çº§ï¼šå“è´¨ç¨³å®šï¼Œåšå·¥è§„èŒƒï¼Œé€‚åˆä¸­é«˜ç«¯é›¶å”®<br>
        - ç»æµçº§ï¼šæ€§ä»·æ¯”é«˜ï¼Œé€‚åˆå¤§ä¼—å¸‚åœºå’Œä¿ƒé”€æ´»åŠ¨<br><br>
        ${specificProductType === 'ç‰›ä»”' ? 
          `æˆ‘ä»¬çš„ç‰›ä»”æœè£…é‡‡ç”¨å¤šç§ç‰›ä»”é¢æ–™ï¼Œä»è½»è–„8å®‰çš„åˆ°åšé‡16å®‰çš„å‡æœ‰æä¾›ï¼Œæ´—æ°´å·¥è‰ºåŒ…æ‹¬ï¼šåŸè‰²ã€æ°´æ´—ã€çŸ³æ´—ã€æ¼‚ç™½ã€åšæ—§ç­‰å¤šç§æ•ˆæœã€‚` 
          : 
          specificProductType === 'ä¸ç»¸' ? 
          `æˆ‘ä»¬çš„ä¸ç»¸æœè£…å¤§å¤šé‡‡ç”¨é«˜å“è´¨å¤©ç„¶æ¡‘èš•ä¸ï¼ŒçœŸä¸å«é‡åœ¨90%ä»¥ä¸Šï¼Œæ‰‹æ„Ÿé¡ºæ»‘ï¼Œå‚å æ„Ÿå¥½ï¼Œè‰²ç‰¢åº¦é«˜ã€‚` 
          : 
          `æ‰€æœ‰æœè£…åœ¨å‡ºå‚å‰éƒ½ç»è¿‡ä¸¥æ ¼çš„è´¨æ£€ï¼Œç¡®ä¿åšå·¥å’Œæè´¨ç¬¦åˆæ ‡å‡†ã€‚`
        }<br><br>
        æ¬¢è¿æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£æ›´å¤šå“è´¨ç»†èŠ‚æˆ–ç”³è¯·æ ·å“ã€‚`;
      }
      else {
        return `æ‚¨å¥½ï¼ä½œä¸ºä¹°å®¶ï¼Œæˆ‘ä»¬ä¸ºæ‚¨æä¾›ä¸°å¯Œçš„${specificProductType ? specificProductType : ''}æœè£…åº“å­˜èµ„æºï¼š<br><br>
        ${specificProductType ? 
          `æˆ‘ä»¬çš„${specificProductType}æœè£…ç³»åˆ—åŒ…æ‹¬ï¼š<br>
          ${specificProductType === 'ç‰›ä»”' ? 
            `- å¤šæ¬¾å¼ç‰›ä»”è£¤ï¼ˆç›´ç­’ã€é”¥å½¢ã€é˜”è…¿ç­‰ï¼‰<br>
            - ç‰›ä»”å¤–å¥—å’Œå¤¹å…‹ï¼ˆåŸºç¡€æ¬¾å’Œæ—¶å°šæ¬¾ï¼‰<br>
            - ç‰›ä»”è¡¬è¡«å’Œè¿è¡£è£™<br>
            - ç‰›ä»”é…é¥°ï¼ˆå¸½å­ã€åŒ…è¢‹ç­‰ï¼‰<br>` 
            : 
            specificProductType === 'ä¸ç»¸' ? 
            `- ä¸ç»¸è¡¬è¡«å’Œä¸Šè¡£ï¼ˆå¤šè‰²å¯é€‰ï¼‰<br>
            - ä¸ç»¸è¿è¡£è£™å’ŒåŠèº«è£™<br>
            - ä¸ç»¸ç¡è¡£å’Œå®¶å±…æœ<br>
            - ä¸ç»¸å›´å·¾å’Œé¢†å¸¦<br>` 
            : 
            `- ${specificProductType}ä¸Šè¡£å’Œå¤–å¥—<br>
            - ${specificProductType}è£¤è£…å’Œè£™è£…<br>
            - ${specificProductType}é…é¥°å’Œå…¶ä»–å“ç±»<br>`
          }`
          : 
          `æˆ‘ä»¬æä¾›å„ç±»æœè£…èµ„æºï¼š<br>
          - å„å¤§å“ç‰Œå°¾è´§å’Œä¸‹æ¶æ¬¾<br>
          - å·¥å‚é«˜è´¨é‡ä½™è´§<br>
          - è®¾è®¡å¸ˆåŸåˆ›ç³»åˆ—<br>
          - å„ç±»å­£èŠ‚æ€§æ¢å­£æœè£…<br>`
        }<br>
        æˆ‘ä»¬çš„ä¼˜åŠ¿ï¼š<br>
        - å“ç±»é½å…¨ï¼Œæ¬¾å¼å¤šæ ·<br>
        - ä»·æ ¼é€æ˜ï¼Œæ¢¯åº¦åˆç†<br>
        - è´¨é‡ä¿è¯ï¼Œæ”¯æŒé€€æ¢<br>
        - å‘è´§è¿…é€Ÿï¼Œç‰©æµé«˜æ•ˆ<br><br>
        è¯·é—®æ‚¨éœ€è¦å“ªç§ç±»å‹ã€é£æ ¼å’Œå°ºç çš„æœè£…ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸ºæ‚¨ç²¾å‡†åŒ¹é…åº“å­˜ã€‚<br><br>
        ä¸ºæŸ¥çœ‹æœ€æ–°æ¬¾å¼å’Œåº“å­˜çŠ¶æ€ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      }
    }
    // å–å®¶å¯¹æˆè¡£çš„æŸ¥è¯¢
    else if ((isSeller && isClothingQuery) || (isSeller && hasExplicitClothingPhrase)) {
      if (userNeeds.price) {
        return `ä½œä¸ºå–å®¶ï¼Œå…³äºæ‚¨å‡ºå”®çš„${specificProductType ? specificProductType : ''}æœè£…ï¼Œæˆ‘ä»¬å¯æä¾›ä»¥ä¸‹ä»·æ ¼å‚è€ƒï¼š<br><br>
        æ ¹æ®ç›®å‰å¸‚åœºè¡Œæƒ…ï¼Œæˆ‘ä»¬çš„æ”¶è´­ä»·æ ¼åŒºé—´ï¼š<br>
        ${specificProductType === 'ç‰›ä»”' ? 
          `- ç‰›ä»”è£¤ï¼š40-180å…ƒ/æ¡<br>
          - ç‰›ä»”å¤–å¥—ï¼š60-250å…ƒ/ä»¶<br>
          - ç‰›ä»”è¡¬è¡«ï¼š45-150å…ƒ/ä»¶<br>` 
          : 
          specificProductType === 'ä¸ç»¸' ? 
          `- ä¸ç»¸è¡¬è¡«ï¼š90-300å…ƒ/ä»¶<br>
          - ä¸ç»¸è¿è¡£è£™ï¼š120-600å…ƒ/ä»¶<br>
          - ä¸ç»¸å®¶å±…æœï¼š100-400å…ƒ/å¥—<br>` 
          : 
          `- ä¸Šè¡£/è¡¬è¡«ï¼š30-150å…ƒ/ä»¶<br>
          - è£¤è£…/è£™è£…ï¼š40-200å…ƒ/æ¡<br>
          - å¤–å¥—/å¤§è¡£ï¼š70-400å…ƒ/ä»¶<br>`
        }<br>
        å®é™…æ”¶è´­ä»·æ ¼å–å†³äºï¼š<br>
        - æœè£…å“è´¨å’Œå“ç‰Œ<br>
        - æ¬¾å¼æ–°æ—§å’Œå¸‚åœºéœ€æ±‚<br>
        - æ•°é‡å’Œæ‰¹æ¬¡ä¸€è‡´æ€§<br>
        - æ˜¯å¦æœ‰åŠç‰Œå’ŒåŒ…è£…<br><br>
        æˆ‘ä»¬æä¾›ä¸‰ç§åˆä½œæ¨¡å¼ï¼š<br>
        1. ç›´æ¥æ”¶è´­ï¼šå³æ—¶æ”¯ä»˜<br>
        2. ä»£é”€æ¨¡å¼ï¼šæŠ½å–10-20%ä½£é‡‘<br>
        3. å®šå‘å¯¹æ¥ï¼šè¿æ¥æ‚¨ä¸æŒ‡å®šä¹°å®¶<br><br>
        è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å‘é€æœè£…ç…§ç‰‡ï¼Œè·å–ç²¾å‡†è¯„ä¼°å’ŒæŠ¥ä»·ã€‚`;
      }
      else if (userNeeds.quantity || userNeeds.delivery) {
        return `å…³äºæ‚¨è¦å‡ºå”®çš„${specificProductType ? specificProductType : ''}æœè£…æ•°é‡å’Œå‘è´§ï¼š<br><br>
        æˆ‘ä»¬æ¥å—çš„æœ€ä½èµ·å”®é‡ï¼š<br>
        - ç²¾å“ç±»ï¼š10ä»¶èµ·<br>
        - æ™®é€šç±»ï¼š30ä»¶èµ·<br>
        - å°¾è´§ç±»ï¼š50ä»¶èµ·<br><br>
        å‘è´§å’Œç‰©æµå®‰æ’ï¼š<br>
        - æˆ‘ä»¬å¯å®‰æ’ç‰©æµä¸Šé—¨å–è´§ï¼ˆæ•°é‡è¾ƒå¤§æ—¶ï¼‰<br>
        - å¯æä¾›æ‰“åŒ…ææ–™å’Œæ ‡å‡†<br>
        - æ”¯æŒç¬¬ä¸‰æ–¹ç‰©æµå…¬å¸å¯¹æ¥<br><br>
        ${specificProductType ? `${specificProductType}æœè£…ç›®å‰å¸‚åœºéœ€æ±‚è¾ƒå¤§ï¼Œå¯ä¼˜å…ˆå®‰æ’æ”¶è´­ã€‚` : 'ä¸åŒç±»å‹æœè£…çš„å¤„ç†å‘¨æœŸå¯èƒ½ä¸åŒï¼Œè¯¦æƒ…è¯·å’¨è¯¢å®¢æœã€‚'}<br><br>
        è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¯¦ç»†æ²Ÿé€šæ‚¨çš„åº“å­˜æ•°é‡å’Œç‰©æµå®‰æ’ã€‚`;
      }
      else {
        return `æ‚¨å¥½ï¼ä½œä¸ºå–å®¶ï¼Œæ„Ÿè°¢æ‚¨è€ƒè™‘é€šè¿‡æˆ‘ä»¬å¹³å°å¤„ç†${specificProductType ? specificProductType : ''}æœè£…åº“å­˜ã€‚<br><br>
        æˆ‘ä»¬å¹³å°ä¸ºå–å®¶æä¾›çš„æœåŠ¡ï¼š<br>
        - å¤šç§æœè£…åº“å­˜å¤„ç†æ–¹æ¡ˆ<br>
        - ä¸“ä¸šåº“å­˜è¯„ä¼°å’Œå®šä»·å»ºè®®<br>
        - é«˜æ•ˆå¯¹æ¥ä¹°å®¶èµ„æºå’Œé”€å”®æ¸ é“<br>
        - å®‰å…¨ä¾¿æ·çš„äº¤æ˜“æµç¨‹<br><br>
        ${specificProductType ? 
          `ç›®å‰å¸‚åœºå¯¹${specificProductType}æœè£…çš„éœ€æ±‚æƒ…å†µï¼š<br>
          ${specificProductType === 'ç‰›ä»”' ? 
            `- ç‰›ä»”æœè£…éœ€æ±‚ç¨³å®šï¼Œå››å­£éƒ½æœ‰å¸‚åœº<br>
            - ä¸­é«˜ç«¯ç‰›ä»”äº§å“ç‰¹åˆ«å—æ¬¢è¿<br>
            - åšæ—§å’Œå¤å¤é£æ ¼æœ€å—è¿½æ§<br>` 
            : 
            specificProductType === 'ä¸ç»¸' ? 
            `- ä¸ç»¸æœè£…å¸‚åœºéœ€æ±‚æ­£åœ¨å¢é•¿<br>
            - é«˜å“è´¨çœŸä¸äº§å“ä¾›ä¸åº”æ±‚<br>
            - å®¶å±…æœå’Œç¡è¡£ç±»ä¸ç»¸äº§å“æœ€çƒ­é—¨<br>` 
            : 
            `- ${specificProductType}æœè£…ç›®å‰å¸‚åœºååº”è‰¯å¥½<br>
            - å“è´¨ç¨³å®šçš„äº§å“æ›´å®¹æ˜“å¯¹æ¥<br>
            - å­£èŠ‚æ€§äº§å“éœ€è€ƒè™‘æ—¶æœº<br>`
          }`
          : 
          `æˆ‘ä»¬ç‰¹åˆ«éœ€è¦ä»¥ä¸‹ç±»å‹çš„æœè£…åº“å­˜ï¼š<br>
          - å“è´¨ç¨³å®šçš„åŸºç¡€æ¬¾æœè£…<br>
          - çŸ¥åå“ç‰Œçš„å°¾è´§å’Œä¸‹æ¶æ¬¾<br>
          - ç‹¬ç‰¹è®¾è®¡çš„å°ä¼—æœè£…ç³»åˆ—<br>`
        }<br>
        è¯·é—®æ‚¨éœ€è¦å¤„ç†çš„æ˜¯å“ªç§æœè£…ï¼Ÿå¤§çº¦æœ‰å¤šå°‘æ•°é‡ï¼Ÿ<br><br>
        ä¸ºé«˜æ•ˆå¯¹æ¥ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åˆ†äº«æ›´å¤šåº“å­˜è¯¦æƒ…ï¼Œæˆ‘ä»¬ä¼šä¸ºæ‚¨æä¾›ä¸“ä¸šè¯„ä¼°å’Œæœ€ä½³å¤„ç†æ–¹æ¡ˆã€‚`;
      }
    }
    // ä¹°å®¶å¯¹é¢æ–™çš„æŸ¥è¯¢
    else if ((isBuyer && isFabricQuery) || (isBuyer && hasExplicitFabricPhrase)) {
      if (userNeeds.price) {
        return `ä½œä¸ºä¹°å®¶ï¼Œæ‚¨å…³å¿ƒçš„${specificProductType ? specificProductType : ''}é¢æ–™ä»·æ ¼ä¿¡æ¯å¦‚ä¸‹ï¼š<br><br>
        ${specificProductType === 'ç‰›ä»”' ? 
          `ç‰›ä»”é¢æ–™ä»·æ ¼å‚è€ƒï¼ˆæ¯ç±³ï¼‰ï¼š<br>
          - è½»è–„ç‰›ä»”ï¼ˆ5-8ç›å¸ï¼‰ï¼š30-80å…ƒ<br>
          - ä¸­ç­‰é‡é‡ï¼ˆ9-12ç›å¸ï¼‰ï¼š50-120å…ƒ<br>
          - é‡ç£…ç‰›ä»”ï¼ˆ13-16ç›å¸ï¼‰ï¼š70-150å…ƒ<br>
          - å¼¹åŠ›ç‰›ä»”ï¼ˆå¸¦æ°¨çº¶ï¼‰ï¼šåŠ ä»·10-30å…ƒ<br><br>` 
          : 
          specificProductType === 'ä¸ç»¸' ? 
          `ä¸ç»¸é¢æ–™ä»·æ ¼å‚è€ƒï¼ˆæ¯ç±³ï¼‰ï¼š<br>
          - çœŸä¸ç»¸ç¼ï¼š150-400å…ƒï¼ˆæ ¹æ®æ¡‘èš•ä¸å«é‡ï¼‰<br>
          - ä¸æ£‰æ··çººï¼š80-200å…ƒ<br>
          - äººé€ ä¸ç»¸ï¼š40-100å…ƒ<br>
          - å°èŠ±ä¸ç»¸ï¼šåŠ ä»·30-100å…ƒ<br><br>` 
          : 
          `å„ç±»é¢æ–™ä»·æ ¼å‚è€ƒï¼ˆæ¯ç±³ï¼‰ï¼š<br>
          - æ™®é€šæ£‰å¸ƒï¼š20-60å…ƒ<br>
          - é«˜å“è´¨æ£‰éº»ï¼š50-150å…ƒ<br>
          - ç¾Šæ¯›å‘¢æ–™ï¼š80-300å…ƒ<br>
          - åŠŸèƒ½æ€§é¢æ–™ï¼š60-200å…ƒ<br><br>`
        }
        æ‰¹é‡è´­ä¹°ä¼˜æƒ ï¼š<br>
        - 30ç±³ä»¥ä¸Šï¼š95æŠ˜<br>
        - 100ç±³ä»¥ä¸Šï¼š9æŠ˜<br>
        - 300ç±³ä»¥ä¸Šï¼š85æŠ˜<br>
        - 1000ç±³ä»¥ä¸Šï¼šè¯·è”ç³»å®¢æœæ´½è°ˆæ›´ä¼˜æƒ ä»·æ ¼<br><br>
        ä¸ºè·å–æœ€æ–°ä»·æ ¼å’Œåº“å­˜æƒ…å†µï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      }
      else if (userNeeds.quantity) {
        return `å…³äº${specificProductType ? specificProductType : ''}é¢æ–™çš„é‡‡è´­æ•°é‡ï¼š<br><br>
        æˆ‘ä»¬çš„é¢æ–™èµ·è®¢é‡ï¼š<br>
        - åº“å­˜ç°è´§ï¼šæœ€ä½3ç±³èµ·å”®<br>
        - å¤§è´§æ‰¹å‘ï¼š30ç±³èµ·è®¢<br>
        - å®šåˆ¶é¢æ–™ï¼š100ç±³èµ·è®¢<br><br>
        ${specificProductType ? 
          `æˆ‘ä»¬ç›®å‰${specificProductType}é¢æ–™åº“å­˜å……è¶³ï¼Œå¤šç§è§„æ ¼å¯é€‰ï¼š<br>
          ${specificProductType === 'ç‰›ä»”' ? 
            `- å¤šç§é‡é‡å’Œå¼¹æ€§é€‰æ‹©<br>
            - å¤šç§æ´—æ°´æ•ˆæœå¤‡é€‰<br>
            - æä¾›è‰²å¡å’Œæ ·å“`
            : 
            specificProductType === 'ä¸ç»¸' ? 
            `- å¤šç§çœŸä¸å«é‡ç­‰çº§<br>
            - å¤šç§ç»‡æ³•å’Œé£æ ¼<br>
            - çº¯è‰²å’Œå°èŠ±å‡æœ‰åº“å­˜`
            : 
            `- å¤šç§è§„æ ¼å’Œç”¨é€”<br>
            - é€‚åˆå„ç±»æœè£…åˆ¶ä½œ<br>
            - æœ‰ç°è´§å¯ç«‹å³å‘å‡º`
          }`
          : 
          `å¤§éƒ¨åˆ†é¢æ–™éƒ½æœ‰å……è¶³åº“å­˜ï¼Œå¯æ»¡è¶³ç´§æ€¥è®¢å•éœ€æ±‚ã€‚`
        }<br><br>
        è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¯¦ç»†æ²Ÿé€šæ‚¨çš„å…·ä½“éœ€æ±‚å’Œé¢„è®¡ç”¨é‡ã€‚`;
      }
      else if (userNeeds.quality) {
        return `å…³äº${specificProductType ? specificProductType : ''}é¢æ–™çš„å“è´¨ï¼š<br><br>
        æˆ‘ä»¬æä¾›å¤šä¸ªå“è´¨ç­‰çº§çš„é¢æ–™ï¼š<br>
        - é«˜ç«¯ç²¾å“ï¼šä¸€çº¿å“ç‰Œç”¨æ–™æ ‡å‡†ï¼Œé€‚åˆé«˜ç«¯å®šåˆ¶<br>
        - å•†ä¸šä¼˜é€‰ï¼šå“è´¨ç¨³å®šï¼Œé€‚åˆä¸­é«˜ç«¯æˆè¡£ç”Ÿäº§<br>
        - å®ç”¨ç»æµï¼šæ€§ä»·æ¯”é«˜ï¼Œé€‚åˆå¤§ä¼—å¸‚åœºäº§å“<br><br>
        ${specificProductType === 'ç‰›ä»”' ? 
          `æˆ‘ä»¬çš„ç‰›ä»”é¢æ–™é‡‡ç”¨ä¼˜è´¨æ£‰èŠ±ï¼Œç»è¿‡ä¸¥æ ¼çš„ç»‡é€ å’ŒæŸ“è‰²å·¥è‰ºï¼Œè‰²ç‰¢åº¦é«˜ï¼Œæ‰‹æ„Ÿå¥½ï¼Œè€ç”¨æ€§å¼ºã€‚ä¸åŒé‡é‡å’Œå¼¹æ€§é€‚åˆä¸åŒç”¨é€”ï¼Œä»è½»è–„å¤è£…åˆ°åšé‡å¤–å¥—å‡å¯åˆ¶ä½œã€‚` 
          : 
          specificProductType === 'ä¸ç»¸' ? 
          `æˆ‘ä»¬çš„ä¸ç»¸é¢æ–™åˆ†ä¸ºå¤©ç„¶æ¡‘èš•ä¸å’Œæ··çººä¸¤å¤§ç±»ã€‚å¤©ç„¶æ¡‘èš•ä¸å…‰æ³½è‡ªç„¶ï¼Œæ‰‹æ„Ÿé¡ºæ»‘ï¼Œé€æ°”æ€§å¥½ï¼›æ··çººä¸ç»¸åˆ™å¢åŠ äº†è€ç”¨æ€§å’Œæ˜“æ‰“ç†æ€§ï¼Œé€‚åˆæ—¥å¸¸ç©¿ç€æœè£…ã€‚` 
          : 
          `æ‰€æœ‰é¢æ–™åœ¨å…¥åº“å‰éƒ½ç»è¿‡ä¸¥æ ¼çš„è´¨æ£€ï¼Œç¡®ä¿ç»‡é€ å¯†åº¦ã€è‰²ç‰¢åº¦ã€å¼ºåŠ›ç­‰æŒ‡æ ‡ç¬¦åˆæ ‡å‡†ã€‚`
        }<br><br>
        æ¬¢è¿æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ç”³è¯·æ ·å“æˆ–é¢æ–™æµ‹è¯•æŠ¥å‘Šã€‚`;
      }
      else {
        return `æ‚¨å¥½ï¼ä½œä¸ºä¹°å®¶ï¼Œæˆ‘ä»¬ä¸ºæ‚¨æä¾›ä¸°å¯Œçš„${specificProductType ? specificProductType : ''}é¢æ–™åº“å­˜èµ„æºï¼š<br><br>
        ${specificProductType ? 
          `æˆ‘ä»¬çš„${specificProductType}é¢æ–™ç³»åˆ—åŒ…æ‹¬ï¼š<br>
          ${specificProductType === 'ç‰›ä»”' ? 
            `- å¤šç§é‡é‡ç‰›ä»”å¸ƒï¼ˆè½»è–„ã€ä¸­ç­‰ã€é‡ç£…ï¼‰<br>
            - å¤šç§æˆåˆ†é…æ¯”ï¼ˆå…¨æ£‰ã€å¼¹åŠ›ã€æ··çººï¼‰<br>
            - å¤šç§æ´—æ°´æ•ˆæœï¼ˆåŸè‰²ã€æ°´æ´—ã€åšæ—§ç­‰ï¼‰<br>
            - ç‰¹è‰²ç‰›ä»”ï¼ˆæ‰æŸ“ã€å°èŠ±ã€æèŠ±ç­‰ï¼‰<br>` 
            : 
            specificProductType === 'ä¸ç»¸' ? 
            `- çœŸä¸ç»¸ç¼ï¼ˆé«˜æ¡£æœè£…é¢æ–™ï¼‰<br>
            - ä¹”å…¶çº±å’ŒåŒç»‰ï¼ˆè½»è–„é€æ°”ï¼‰<br>
            - æ–œçº¹ä¸ç»¸ï¼ˆè€ç”¨æŒºæ‹¬ï¼‰<br>
            - å°èŠ±ä¸ç»¸ï¼ˆæ—¶å°šç‹¬ç‰¹ï¼‰<br>` 
            : 
            `- å„ç§è§„æ ¼çš„${specificProductType}é¢æ–™<br>
            - é€‚åˆä¸åŒå­£èŠ‚å’Œç”¨é€”<br>
            - å¤šç§é¢œè‰²å’ŒèŠ±å‹å¯é€‰<br>`
          }`
          : 
          `æˆ‘ä»¬æä¾›å„ç±»é¢æ–™èµ„æºï¼š<br>
          - å„ç±»å¤©ç„¶é¢æ–™ï¼ˆæ£‰ã€éº»ã€ä¸ã€æ¯›ç­‰ï¼‰<br>
          - é«˜å“è´¨æ··çººé¢æ–™ï¼ˆèˆ’é€‚è€ç”¨ï¼‰<br>
          - æ—¶å°šå°èŠ±å’ŒæèŠ±é¢æ–™ï¼ˆç‹¬ç‰¹è®¾è®¡ï¼‰<br>
          - åŠŸèƒ½æ€§é¢æ–™ï¼ˆé˜²æ°´ã€é€æ°”ã€å¼¹åŠ›ç­‰ï¼‰<br>`
        }<br>
        æˆ‘ä»¬çš„ä¼˜åŠ¿ï¼š<br>
        - å“ç§é½å…¨ï¼Œè§„æ ¼å¤šæ ·<br>
        - ä»·æ ¼åˆç†ï¼Œæ¥æºé€æ˜<br>
        - è´¨é‡ç¨³å®šï¼Œæ£€æµ‹ä¸¥æ ¼<br>
        - å°å•èµ·å”®ï¼Œæ–¹ä¾¿è¯•ç”¨<br><br>
        è¯·é—®æ‚¨éœ€è¦å“ªç§ç±»å‹çš„é¢æ–™ï¼Ÿç”¨äºä»€ä¹ˆé¡¹ç›®ï¼Ÿéœ€è¦å¤šå°‘ç”¨é‡ï¼Ÿ<br><br>
        ä¸ºæŸ¥çœ‹é¢æ–™å®ç‰©å’Œè¯¦ç»†è§„æ ¼ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      }
    }
    // å–å®¶å¯¹é¢æ–™çš„æŸ¥è¯¢
    else if ((isSeller && isFabricQuery) || (isSeller && hasExplicitFabricPhrase)) {
      if (userNeeds.price) {
        return `ä½œä¸ºå–å®¶ï¼Œå…³äºæ‚¨å‡ºå”®çš„${specificProductType ? specificProductType : ''}é¢æ–™ï¼Œæˆ‘ä»¬å¯æä¾›ä»¥ä¸‹ä»·æ ¼å‚è€ƒï¼š<br><br>
        æ ¹æ®ç›®å‰å¸‚åœºè¡Œæƒ…ï¼Œæˆ‘ä»¬çš„æ”¶è´­ä»·æ ¼åŒºé—´ï¼š<br>
        ${specificProductType === 'ç‰›ä»”' ? 
          `- è½»è–„ç‰›ä»”ï¼ˆ5-8ç›å¸ï¼‰ï¼š30-80å…ƒ<br>
          - ä¸­ç­‰é‡é‡ï¼ˆ9-12ç›å¸ï¼‰ï¼š50-120å…ƒ<br>
          - é‡ç£…ç‰›ä»”ï¼ˆ13-16ç›å¸ï¼‰ï¼š70-150å…ƒ<br>
          - å¼¹åŠ›ç‰›ä»”ï¼ˆå¸¦æ°¨çº¶ï¼‰ï¼šåŠ ä»·10-30å…ƒ<br><br>` 
          : 
          specificProductType === 'ä¸ç»¸' ? 
          `- çœŸä¸ç»¸ç¼ï¼š150-400å…ƒï¼ˆæ ¹æ®æ¡‘èš•ä¸å«é‡ï¼‰<br>
          - ä¸æ£‰æ··çººï¼š80-200å…ƒ<br>
          - äººé€ ä¸ç»¸ï¼š40-100å…ƒ<br>
          - å°èŠ±ä¸ç»¸ï¼šåŠ ä»·30-100å…ƒ<br><br>` 
          : 
          `- æ™®é€šæ£‰å¸ƒï¼š20-60å…ƒ<br>
          - é«˜å“è´¨æ£‰éº»ï¼š50-150å…ƒ<br>
          - ç¾Šæ¯›å‘¢æ–™ï¼š80-300å…ƒ<br>
          - åŠŸèƒ½æ€§é¢æ–™ï¼š60-200å…ƒ<br><br>`
        }
        æ‰¹é‡è´­ä¹°ä¼˜æƒ ï¼š<br>
        - 30ç±³ä»¥ä¸Šï¼š95æŠ˜<br>
        - 100ç±³ä»¥ä¸Šï¼š9æŠ˜<br>
        - 300ç±³ä»¥ä¸Šï¼š85æŠ˜<br>
        - 1000ç±³ä»¥ä¸Šï¼šè¯·è”ç³»å®¢æœæ´½è°ˆæ›´ä¼˜æƒ ä»·æ ¼<br><br>
        ä¸ºè·å–æœ€æ–°ä»·æ ¼å’Œåº“å­˜æƒ…å†µï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      }
      else if (userNeeds.quantity) {
        return `å…³äºæ‚¨è¦å‡ºå”®çš„${specificProductType ? specificProductType : ''}é¢æ–™æ•°é‡ï¼š<br><br>
        æˆ‘ä»¬çš„é¢æ–™èµ·è®¢é‡ï¼š<br>
        - åº“å­˜ç°è´§ï¼šæœ€ä½3ç±³èµ·å”®<br>
        - å¤§è´§æ‰¹å‘ï¼š30ç±³èµ·è®¢<br>
        - å®šåˆ¶é¢æ–™ï¼š100ç±³èµ·è®¢<br><br>
        ${specificProductType ? 
          `æˆ‘ä»¬ç›®å‰${specificProductType}é¢æ–™åº“å­˜å……è¶³ï¼Œå¤šç§è§„æ ¼å¯é€‰ï¼š<br>
          ${specificProductType === 'ç‰›ä»”' ? 
            `- å¤šç§é‡é‡å’Œå¼¹æ€§é€‰æ‹©<br>
            - å¤šç§æ´—æ°´æ•ˆæœå¤‡é€‰<br>
            - æä¾›è‰²å¡å’Œæ ·å“`
            : 
            specificProductType === 'ä¸ç»¸' ? 
            `- å¤šç§çœŸä¸å«é‡ç­‰çº§<br>
            - å¤šç§ç»‡æ³•å’Œé£æ ¼<br>
            - çº¯è‰²å’Œå°èŠ±å‡æœ‰åº“å­˜`
            : 
            `- å¤šç§è§„æ ¼å’Œç”¨é€”<br>
            - é€‚åˆå„ç±»æœè£…åˆ¶ä½œ<br>
            - æœ‰ç°è´§å¯ç«‹å³å‘å‡º`
          }`
          : 
          `å¤§éƒ¨åˆ†é¢æ–™éƒ½æœ‰å……è¶³åº“å­˜ï¼Œå¯æ»¡è¶³ç´§æ€¥è®¢å•éœ€æ±‚ã€‚`
        }<br><br>
        è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¯¦ç»†æ²Ÿé€šæ‚¨çš„å…·ä½“éœ€æ±‚å’Œé¢„è®¡ç”¨é‡ã€‚`;
      }
      else if (userNeeds.quality) {
        return `å…³äºæ‚¨å‡ºå”®çš„${specificProductType ? specificProductType : ''}é¢æ–™çš„å“è´¨ï¼š<br><br>
        æˆ‘ä»¬æä¾›å¤šä¸ªå“è´¨ç­‰çº§çš„é¢æ–™ï¼š<br>
        - é«˜ç«¯ç²¾å“ï¼šä¸€çº¿å“ç‰Œç”¨æ–™æ ‡å‡†ï¼Œé€‚åˆé«˜ç«¯å®šåˆ¶<br>
        - å•†ä¸šä¼˜é€‰ï¼šå“è´¨ç¨³å®šï¼Œé€‚åˆä¸­é«˜ç«¯æˆè¡£ç”Ÿäº§<br>
        - å®ç”¨ç»æµï¼šæ€§ä»·æ¯”é«˜ï¼Œé€‚åˆå¤§ä¼—å¸‚åœºäº§å“<br><br>
        ${specificProductType === 'ç‰›ä»”' ? 
          `æˆ‘ä»¬çš„ç‰›ä»”é¢æ–™é‡‡ç”¨ä¼˜è´¨æ£‰èŠ±ï¼Œç»è¿‡ä¸¥æ ¼çš„ç»‡é€ å’ŒæŸ“è‰²å·¥è‰ºï¼Œè‰²ç‰¢åº¦é«˜ï¼Œæ‰‹æ„Ÿå¥½ï¼Œè€ç”¨æ€§å¼ºã€‚ä¸åŒé‡é‡å’Œå¼¹æ€§é€‚åˆä¸åŒç”¨é€”ï¼Œä»è½»è–„å¤è£…åˆ°åšé‡å¤–å¥—å‡å¯åˆ¶ä½œã€‚` 
          : 
          specificProductType === 'ä¸ç»¸' ? 
          `æˆ‘ä»¬çš„ä¸ç»¸é¢æ–™åˆ†ä¸ºå¤©ç„¶æ¡‘èš•ä¸å’Œæ··çººä¸¤å¤§ç±»ã€‚å¤©ç„¶æ¡‘èš•ä¸å…‰æ³½è‡ªç„¶ï¼Œæ‰‹æ„Ÿé¡ºæ»‘ï¼Œé€æ°”æ€§å¥½ï¼›æ··çººä¸ç»¸åˆ™å¢åŠ äº†è€ç”¨æ€§å’Œæ˜“æ‰“ç†æ€§ï¼Œé€‚åˆæ—¥å¸¸ç©¿ç€æœè£…ã€‚` 
          : 
          `æ‰€æœ‰é¢æ–™åœ¨å…¥åº“å‰éƒ½ç»è¿‡ä¸¥æ ¼çš„è´¨æ£€ï¼Œç¡®ä¿ç»‡é€ å¯†åº¦ã€è‰²ç‰¢åº¦ã€å¼ºåŠ›ç­‰æŒ‡æ ‡ç¬¦åˆæ ‡å‡†ã€‚`
        }<br><br>
        æ¬¢è¿æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ç”³è¯·æ ·å“æˆ–é¢æ–™æµ‹è¯•æŠ¥å‘Šã€‚`;
      }
      else {
        return `æ‚¨å¥½ï¼ä½œä¸ºå–å®¶ï¼Œæˆ‘ä»¬ä¸ºæ‚¨æä¾›ä¸°å¯Œçš„${specificProductType ? specificProductType : ''}é¢æ–™åº“å­˜èµ„æºï¼š<br><br>
        ${specificProductType ? 
          `æˆ‘ä»¬çš„${specificProductType}é¢æ–™ç³»åˆ—åŒ…æ‹¬ï¼š<br>
          ${specificProductType === 'ç‰›ä»”' ? 
            `- å¤šç§é‡é‡ç‰›ä»”å¸ƒï¼ˆè½»è–„ã€ä¸­ç­‰ã€é‡ç£…ï¼‰<br>
            - å¤šç§æˆåˆ†é…æ¯”ï¼ˆå…¨æ£‰ã€å¼¹åŠ›ã€æ··çººï¼‰<br>
            - å¤šç§æ´—æ°´æ•ˆæœï¼ˆåŸè‰²ã€æ°´æ´—ã€åšæ—§ç­‰ï¼‰<br>
            - ç‰¹è‰²ç‰›ä»”ï¼ˆæ‰æŸ“ã€å°èŠ±ã€æèŠ±ç­‰ï¼‰<br>` 
            : 
            specificProductType === 'ä¸ç»¸' ? 
            `- çœŸä¸ç»¸ç¼ï¼ˆé«˜æ¡£æœè£…é¢æ–™ï¼‰<br>
            - ä¹”å…¶çº±å’ŒåŒç»‰ï¼ˆè½»è–„é€æ°”ï¼‰<br>
            - æ–œçº¹ä¸ç»¸ï¼ˆè€ç”¨æŒºæ‹¬ï¼‰<br>
            - å°èŠ±ä¸ç»¸ï¼ˆæ—¶å°šç‹¬ç‰¹ï¼‰<br>` 
            : 
            `- å„ç§è§„æ ¼çš„${specificProductType}é¢æ–™<br>
            - é€‚åˆä¸åŒå­£èŠ‚å’Œç”¨é€”<br>
            - å¤šç§é¢œè‰²å’ŒèŠ±å‹å¯é€‰<br>`
          }`
          : 
          `æˆ‘ä»¬æä¾›å„ç±»é¢æ–™èµ„æºï¼š<br>
          - å„ç±»å¤©ç„¶é¢æ–™ï¼ˆæ£‰ã€éº»ã€ä¸ã€æ¯›ç­‰ï¼‰<br>
          - é«˜å“è´¨æ··çººé¢æ–™ï¼ˆèˆ’é€‚è€ç”¨ï¼‰<br>
          - æ—¶å°šå°èŠ±å’ŒæèŠ±é¢æ–™ï¼ˆç‹¬ç‰¹è®¾è®¡ï¼‰<br>
          - åŠŸèƒ½æ€§é¢æ–™ï¼ˆé˜²æ°´ã€é€æ°”ã€å¼¹åŠ›ç­‰ï¼‰<br>`
        }<br>
        æˆ‘ä»¬çš„ä¼˜åŠ¿ï¼š<br>
        - å“ç§é½å…¨ï¼Œè§„æ ¼å¤šæ ·<br>
        - ä»·æ ¼åˆç†ï¼Œæ¥æºé€æ˜<br>
        - è´¨é‡ç¨³å®šï¼Œæ£€æµ‹ä¸¥æ ¼<br>
        - å°å•èµ·å”®ï¼Œæ–¹ä¾¿è¯•ç”¨<br><br>
        è¯·é—®æ‚¨éœ€è¦å“ªç§ç±»å‹çš„é¢æ–™ï¼Ÿç”¨äºä»€ä¹ˆé¡¹ç›®ï¼Ÿéœ€è¦å¤šå°‘ç”¨é‡ï¼Ÿ<br><br>
        ä¸ºæŸ¥çœ‹é¢æ–™å®ç‰©å’Œè¯¦ç»†è§„æ ¼ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      }
    }
    // é»˜è®¤å›å¤ï¼ŒåŒºåˆ†å–å®¶/ä¹°å®¶
    else {
      if (isSeller) {
        return `${previousTopics.seller ? 'æ„Ÿè°¢æ‚¨ç»§ç»­å…³æ³¨æˆ‘ä»¬çš„å¹³å°æœåŠ¡' : 'æ‚¨å¥½ï¼æ„Ÿè°¢æ‚¨è€ƒè™‘é€šè¿‡æˆ‘ä»¬å¹³å°å¤„ç†åº“å­˜ã€‚'}<br><br>
        æˆ‘ä»¬çš„åº“å­˜å¯¹æ¥ç³»ç»Ÿå¯ä»¥å¸®åŠ©å–å®¶ï¼š<br>
        1. é«˜æ•ˆæ¸…ç†å„ç±»é¢æ–™å’Œæœè£…åº“å­˜<br>
        2. å¯¹æ¥ä¼˜è´¨ä¹°å®¶èµ„æºå’Œé”€å”®æ¸ é“<br>
        3. æä¾›ä¸“ä¸šçš„åº“å­˜è¯„ä¼°å’Œå®šä»·å»ºè®®<br>
        4. ååŠ©å¤„ç†å­£èŠ‚æ€§å’Œæ–­ç åº“å­˜é—®é¢˜<br><br>
        æˆ‘ä»¬ç›®å‰ç‰¹åˆ«éœ€è¦ä»¥ä¸‹ç±»å‹çš„åº“å­˜ï¼š<br>
        - é«˜å“è´¨å¤©ç„¶é¢æ–™ï¼ˆæ£‰ã€éº»ã€ä¸ã€æ¯›ç­‰ï¼‰<br>
        - æ—¶å°šä¼‘é—²æœè£…å’Œå•†åŠ¡æ­£è£…<br>
        - åŠŸèƒ½æ€§é¢æ–™å’Œè¿åŠ¨ä¼‘é—²è£…<br><br>
        è¯·é—®æ‚¨éœ€è¦å¤„ç†å“ªç±»åº“å­˜ï¼Ÿè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å‘é€è¯¦ç»†ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šä¸ºæ‚¨æä¾›æœ€ä½³å¯¹æ¥æ–¹æ¡ˆã€‚`;
      } else {
        return `${previousTopics.buyer ? 'æ„Ÿè°¢æ‚¨ç»§ç»­å’¨è¯¢æˆ‘ä»¬çš„æœåŠ¡' : 'æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼'}æˆ‘ä»¬çš„åº“å­˜å¯¹æ¥ç³»ç»Ÿå¯ä»¥å¸®æ‚¨ï¼š<br><br>
        1. åŒ¹é…å„ç±»é¢æ–™åº“å­˜ï¼ˆæ£‰ã€éº»ã€ä¸ã€æ¯›ã€åŒ–çº¤ç­‰ï¼‰<br>
        2. å¯¹æ¥ä¼˜è´¨æœè£…åº“å­˜ï¼ˆä¼‘é—²è£…ã€æ­£è£…ã€ç‰¹è‰²æœè£…ç­‰ï¼‰<br>
        3. æä¾›æœè£…æ”¹é€ ä¸“ä¸šå»ºè®®å’Œæ–¹æ¡ˆ<br>
        4. è¿æ¥è®¾è®¡å¸ˆå’Œä¾›åº”å•†èµ„æº<br><br>
        è¯·é—®æ‚¨éœ€è¦äº†è§£å“ªç§é¢æ–™æˆ–æœè£…çš„ä¿¡æ¯ï¼Ÿæ˜¯å¯»æ‰¾ç‰¹å®šç±»å‹çš„äº§å“è¿˜æ˜¯å¤šç§é€‰æ‹©ï¼Ÿ<br><br>
        ä¸ºè·å–æœ€æ–°åº“å­˜ä¿¡æ¯å’Œä¸“ä¸šå»ºè®®ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      }
    }
  }
}

// è§†å·®æ»šåŠ¨æ•ˆæœ
function initParallaxEffect() {
  window.addEventListener('scroll', function() {
    const scrollPosition = window.scrollY;
    
    // å¯¹ç‰¹å®šå…ƒç´ åº”ç”¨ä¸åŒç¨‹åº¦çš„è§†å·®æ•ˆæœ
    const parallaxElements = document.querySelectorAll('.hero h1, .hero p, .showcase h2, .workshop h2, .community h2, .inventory h2');
    
    parallaxElements.forEach(element => {
      const speed = 0.2;
      const yPos = -(scrollPosition * speed);
      element.style.transform = `translateY(${yPos}px)`;
    });
    
    // ä¸ºç»Ÿè®¡æ•°å­—æ·»åŠ æ»šåŠ¨åŠ¨ç”»
    const statsSection = document.querySelector('.stats-dashboard');
    if (statsSection) {
      const statsSectionPosition = statsSection.getBoundingClientRect().top;
      const screenPosition = window.innerHeight / 1.3;
      
      if (statsSectionPosition < screenPosition) {
        animateStats();
      }
    }
  });
  
  let statsAnimated = false;
  
  function animateStats() {
    if (statsAnimated) return;
    
    const statValues = document.querySelectorAll('.stat-value');
    
    statValues.forEach(stat => {
      const targetValue = parseInt(stat.textContent);
      let currentValue = 0;
      const duration = 2000; // 2ç§’
      const increment = targetValue / (duration / 16);
      
      function updateValue() {
        if (currentValue < targetValue) {
          currentValue += increment;
          if (currentValue > targetValue) {
            currentValue = targetValue;
          }
          stat.textContent = Math.floor(currentValue);
          requestAnimationFrame(updateValue);
        }
      }
      
      updateValue();
    });
    
    statsAnimated = true;
  }
}

// å¯¹æ¥è¿›åº¦é¢æ¿åŠŸèƒ½
function initTrackingPanel() {
  console.log("åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿");
  const trackingPanel = document.querySelector('.tracking-panel');
  if (!trackingPanel) {
    console.error("æœªæ‰¾åˆ°è¿›åº¦è·Ÿè¸ªé¢æ¿å…ƒç´ ");
    return;
  }

  const processFlow = trackingPanel.querySelector('.process-flow');
  if (!processFlow) {
    console.error("æœªæ‰¾åˆ°è¿›åº¦æµç¨‹å…ƒç´ ");
    return;
  }

  // åˆå§‹åŒ–è¿›åº¦æµç¨‹å›¾ - ä»localStorageè·å–å½“å‰çŠ¶æ€
  let currentTrackingData = JSON.parse(localStorage.getItem('trackingData'));
  
  // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è·Ÿè¸ªæ•°æ®æˆ–è€…æ˜¯æ–°ä¼šè¯ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
  if (!currentTrackingData) {
    // ä½¿ç”¨é»˜è®¤æ•°æ®
    currentTrackingData = {
      currentStage: 1,
      stages: [
        { id: 1, name: 'éœ€æ±‚æäº¤', status: 'active', timestamp: new Date().toISOString() },
        { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
        { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
      ],
      lastUpdated: new Date().toISOString(),
      isSeller: false,
      isBuyer: false,
      needType: '',
      productType: '',
      quantity: '',
      budgetRange: ''
    };
    
    // ä¿å­˜åˆå§‹æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(currentTrackingData));
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²æœ‰HTMLç»“æ„
  const existingProgressBar = processFlow.querySelector('.progress-bar');
  
  // å¦‚æœæ²¡æœ‰è¿›åº¦æ¡æˆ–ä¸ºç©ºï¼Œåˆ™é‡æ–°æ„å»ºæ•´ä¸ªé¢æ¿
  if (!existingProgressBar || existingProgressBar.children.length === 0) {
    // æ¸…ç©ºå†…å®¹
    processFlow.innerHTML = '';
    
    // åˆ›å»ºè¿›åº¦æ¡
    const progressBar = document.createElement('div');
    progressBar.classList.add('progress-bar');
    
    // æ·»åŠ å„ä¸ªé˜¶æ®µ
    currentTrackingData.stages.forEach(stage => {
      const stageElement = document.createElement('div');
      stageElement.classList.add('progress-stage', `status-${stage.status}`);
      stageElement.dataset.stageId = stage.id;
      
      const stageNumber = document.createElement('div');
      stageNumber.classList.add('stage-number');
      stageNumber.textContent = stage.id;
      
      const stageName = document.createElement('div');
      stageName.classList.add('stage-name');
      stageName.textContent = stage.name;
      
      stageElement.appendChild(stageNumber);
      stageElement.appendChild(stageName);
      
      // ç‚¹å‡»é˜¶æ®µæ˜¾ç¤ºè¯¦æƒ…
      stageElement.addEventListener('click', () => showStageDetail(stage, currentTrackingData));
      
      progressBar.appendChild(stageElement);
      
      // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€ä¸ªé˜¶æ®µï¼‰
      if (stage.id < currentTrackingData.stages.length) {
        const connector = document.createElement('div');
        connector.classList.add('stage-connector', `status-${stage.status}`);
        progressBar.appendChild(connector);
      }
    });
    
    processFlow.appendChild(progressBar);
    
    // æ·»åŠ è¯´æ˜æ–‡å­—
    const statusInfo = document.createElement('div');
    statusInfo.classList.add('status-info');
    
    // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„é˜¶æ®µ
    const activeStage = currentTrackingData.stages.find(stage => stage.status === 'active');
    const pendingStage = currentTrackingData.stages.find(stage => stage.status === 'pending');
    const stageName = activeStage ? activeStage.name : (pendingStage ? pendingStage.name : 'å‡†å¤‡ä¸­');
    
    // è®¡ç®—æœ€åæ›´æ–°æ—¶é—´
    const lastUpdateTime = getTimeDifference(new Date(currentTrackingData.lastUpdated), new Date());
    
    statusInfo.innerHTML = `å½“å‰çŠ¶æ€ï¼š<span class="status-active">${stageName}</span> Â· æ›´æ–°äº ${lastUpdateTime}`;
    processFlow.appendChild(statusInfo);
    
    // æ·»åŠ è¿›åº¦æ¦‚è¦
    const progressSummary = document.createElement('div');
    progressSummary.classList.add('progress-summary');
    
    // æ ¹æ®ç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒçš„è¿›åº¦æ¦‚è¦
    const isSeller = currentTrackingData.isSeller;
    const isBuyer = currentTrackingData.isBuyer;
    
    // è·å–ä¹°å–éœ€æ±‚ç±»å‹
    const needTypeDisplay = currentTrackingData.needType ? currentTrackingData.needType : 'ç­‰å¾…ç¡®è®¤';
    const productTypeDisplay = currentTrackingData.productType ? currentTrackingData.productType : 'ç­‰å¾…ç¡®è®¤';
    
    let summaryHTML = '';
    if (isSeller) {
      summaryHTML = `
        <h4>å‡ºå”®ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>å•†å“ç±»å‹: ${productTypeDisplay}</li>
          <li>åº“å­˜æ•°é‡: ${currentTrackingData.quantity || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else if (isBuyer) {
      summaryHTML = `
        <h4>é‡‡è´­ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>éœ€æ±‚ç±»å‹: ${needTypeDisplay}</li>
          <li>äº§å“ç±»å‹: ${productTypeDisplay}</li>
          <li>é¢„ç®—èŒƒå›´: ${currentTrackingData.budgetRange || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else {
      summaryHTML = `
        <h4>å¯¹æ¥ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>è¯·åœ¨èŠå¤©ä¸­è¯´æ˜æ‚¨æ˜¯éœ€è¦å‡ºå”®è¿˜æ˜¯é‡‡è´­</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    }
    
    progressSummary.innerHTML = summaryHTML;
    processFlow.appendChild(progressSummary);
    
    // æ·»åŠ åˆ·æ–°æŒ‰é’®
    const refreshButton = document.createElement('button');
    refreshButton.classList.add('refresh-tracking');
    refreshButton.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
    refreshButton.addEventListener('click', function() {
      // è¯·æ±‚å¹³å°æ›´æ–°è¿›åº¦
      updateTrackingProgress();
      
      // æ·»åŠ åˆ·æ–°åŠ¨ç”»
      this.classList.add('refreshing');
      // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
      this.textContent = 'æ­£åœ¨è¯·æ±‚å¹³å°ç¡®è®¤...';
      setTimeout(() => {
        this.classList.remove('refreshing');
        this.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
      }, 2000);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤è¯´æ˜
    const confirmNote = document.createElement('div');
    confirmNote.classList.add('platform-note');
    confirmNote.innerHTML = 'æç¤ºï¼šæ‰€æœ‰è¿›åº¦æ›´æ–°éœ€è¦å¹³å°ç¡®è®¤åæ‰èƒ½ç”Ÿæ•ˆ';
    
    processFlow.appendChild(refreshButton);
    processFlow.appendChild(confirmNote);
  } else {
    // ä»…æ›´æ–°ç°æœ‰ç»“æ„çš„çŠ¶æ€
    currentTrackingData.stages.forEach(stage => {
      const stageElement = processFlow.querySelector(`.progress-stage[data-stage-id="${stage.id}"]`);
      if (stageElement) {
        // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
        stageElement.classList.remove('status-pending', 'status-active', 'status-completed');
        // æ·»åŠ å½“å‰çŠ¶æ€ç±»
        stageElement.classList.add(`status-${stage.status}`);
        
        // å¦‚æœç‚¹å‡»å¤„ç†ç¨‹åºä¸¢å¤±ï¼Œé‡æ–°æ·»åŠ 
        if (!stageElement._hasClickHandler) {
          stageElement.addEventListener('click', () => showStageDetail(stage, currentTrackingData));
          stageElement._hasClickHandler = true;
        }
      }
      
      // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªé˜¶æ®µï¼Œæ›´æ–°è¿æ¥çº¿
      if (stage.id < currentTrackingData.stages.length) {
        const connector = processFlow.querySelectorAll('.stage-connector')[stage.id - 1];
        if (connector) {
          connector.classList.remove('status-pending', 'status-active', 'status-completed');
          connector.classList.add(`status-${stage.status}`);
        }
      }
    });
    
    // æ›´æ–°çŠ¶æ€ä¿¡æ¯
    const statusInfo = processFlow.querySelector('.status-info');
    if (statusInfo) {
      const activeStage = currentTrackingData.stages.find(stage => stage.status === 'active');
      const pendingStage = currentTrackingData.stages.find(stage => stage.status === 'pending');
      const stageName = activeStage ? activeStage.name : (pendingStage ? pendingStage.name : 'å‡†å¤‡ä¸­');
      
      const lastUpdateTime = getTimeDifference(new Date(currentTrackingData.lastUpdated), new Date());
      statusInfo.innerHTML = `å½“å‰çŠ¶æ€ï¼š<span class="status-active">${stageName}</span> Â· æ›´æ–°äº ${lastUpdateTime}`;
    }
    
    // æ›´æ–°è¿›åº¦æ¦‚è¦
    const progressSummary = processFlow.querySelector('.progress-summary');
    if (progressSummary) {
      const isSeller = currentTrackingData.isSeller;
      const isBuyer = currentTrackingData.isBuyer;
      
      const needTypeDisplay = currentTrackingData.needType ? currentTrackingData.needType : 'ç­‰å¾…ç¡®è®¤';
      const productTypeDisplay = currentTrackingData.productType ? currentTrackingData.productType : 'ç­‰å¾…ç¡®è®¤';
      
      let summaryHTML = '';
      if (isSeller) {
        summaryHTML = `
          <h4>å‡ºå”®ä¿¡æ¯æ‘˜è¦</h4>
          <ul>
            <li>å•†å“ç±»å‹: ${productTypeDisplay}</li>
            <li>åº“å­˜æ•°é‡: ${currentTrackingData.quantity || 'ç­‰å¾…ç¡®è®¤'}</li>
            <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
          </ul>
        `;
      } else if (isBuyer) {
        summaryHTML = `
          <h4>é‡‡è´­ä¿¡æ¯æ‘˜è¦</h4>
          <ul>
            <li>éœ€æ±‚ç±»å‹: ${needTypeDisplay}</li>
            <li>äº§å“ç±»å‹: ${productTypeDisplay}</li>
            <li>é¢„ç®—èŒƒå›´: ${currentTrackingData.budgetRange || 'ç­‰å¾…ç¡®è®¤'}</li>
            <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
          </ul>
        `;
      } else {
        summaryHTML = `
          <h4>å¯¹æ¥ä¿¡æ¯æ‘˜è¦</h4>
          <ul>
            <li>è¯·åœ¨èŠå¤©ä¸­è¯´æ˜æ‚¨æ˜¯éœ€è¦å‡ºå”®è¿˜æ˜¯é‡‡è´­</li>
            <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
          </ul>
        `;
      }
      
      progressSummary.innerHTML = summaryHTML;
    }
    
    // ç¡®ä¿åˆ·æ–°æŒ‰é’®æœ‰äº‹ä»¶ç›‘å¬å™¨
    const refreshButton = processFlow.querySelector('.refresh-tracking');
    if (refreshButton && !refreshButton._hasClickHandler) {
      refreshButton.addEventListener('click', function() {
        updateTrackingProgress();
        
        this.classList.add('refreshing');
        this.textContent = 'æ­£åœ¨è¯·æ±‚å¹³å°ç¡®è®¤...';
        setTimeout(() => {
          this.classList.remove('refreshing');
          this.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
        }, 2000);
      });
      refreshButton._hasClickHandler = true;
    }
  }
}

// æ ¹æ®èŠå¤©å†…å®¹æ›´æ–°å¯¹æ¥è¿›åº¦
function updateTrackingFromChat(message, isSeller, isBuyer) {
  // è·å–å½“å‰è¿›åº¦æ•°æ®
  let trackingData = JSON.parse(localStorage.getItem('trackingData'));
  
  if (!trackingData) {
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
    trackingData = {
      currentStage: 1,
      stages: [
        { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
        { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
        { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
      ],
      lastUpdated: new Date().toISOString(),
      isSeller: false,
      isBuyer: false,
      needType: '',
      productType: '',
      quantity: '',
      budgetRange: ''
    };
  }
  
  // æ›´æ–°ä¹°å–èº«ä»½
  if (isSeller !== undefined) {
    trackingData.isSeller = isSeller;
  }
  
  if (isBuyer !== undefined) {
    trackingData.isBuyer = isBuyer;
  }
  
  // å¤„ç†é˜¶æ®µ1ï¼šéœ€æ±‚æäº¤
  if (trackingData.stages[0].status !== 'completed') {
    // åªè¦æœ‰æ¶ˆæ¯ï¼Œå°±è®¤ä¸ºéœ€æ±‚å·²æäº¤
    trackingData.stages[0].status = 'completed';
    trackingData.stages[0].timestamp = new Date().toISOString();
    
    // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
    trackingData.stages[1].status = 'active';
    trackingData.currentStage = 2;
  }
  
  // æå–äº§å“ç±»å‹ä¿¡æ¯
  const productTypes = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›', 'å°¼é¾™', 'æ¶¤çº¶'];
  for (const type of productTypes) {
    if (message.includes(type)) {
      trackingData.productType = type;
      break;
    }
  }
  
  // æå–éœ€æ±‚ç±»å‹
  if (message.includes('é¢æ–™') || message.includes('å¸ƒæ–™') || message.includes('å¸ƒ')) {
    trackingData.needType = 'é¢æ–™';
  } else if (message.includes('æœè£…') || message.includes('è¡£æœ') || message.includes('æˆè¡£')) {
    trackingData.needType = 'æœè£…';
  }
  
  // æå–æ•°é‡ä¿¡æ¯
  const quantityMatch = message.match(/(\d+)([ä»¶æ¡ç±³å¨ä¸ª])/);
  if (quantityMatch) {
    trackingData.quantity = quantityMatch[0];
  }
  
  // æå–ä»·æ ¼/é¢„ç®—ä¿¡æ¯
  if (message.includes('ä»·æ ¼') || message.includes('å¤šå°‘é’±') || message.includes('é¢„ç®—')) {
    const priceMatch = message.match(/(\d+)[-~åˆ°è‡³](\d+)[å…ƒå—]/);
    if (priceMatch) {
      trackingData.budgetRange = priceMatch[0];
    }
  }
  
  // é˜¶æ®µ2ï¼šåŒ¹é…åº“å­˜ - æ ¹æ®å…³é”®è¯åˆ¤æ–­
  if (trackingData.currentStage === 2 && trackingData.stages[1].status === 'active') {
    // å½“ç”¨æˆ·æä¾›äº†å…·ä½“çš„äº§å“å’Œéœ€æ±‚ç±»å‹æ—¶ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€é˜¶æ®µ
    if (trackingData.productType && trackingData.needType) {
      if (message.includes('åŒ¹é…') || message.includes('åº“å­˜') || message.includes('èµ„æº') || 
          message.includes('æ‰¾åˆ°') || message.includes('æœ‰è´§') || containsSpecificProductInfo(message)) {
        trackingData.stages[1].status = 'completed';
        trackingData.stages[1].timestamp = new Date().toISOString();
        
        // æ ¹æ®ç”¨æˆ·èº«ä»½å†³å®šä¸‹ä¸€æ­¥
        if (trackingData.isSeller) {
          // å–å®¶å¯»æ‰¾ä¹°å®¶ï¼Œè¿›å…¥åˆ°ä¹°å®¶ç¡®è®¤é˜¶æ®µ
          trackingData.stages[3].status = 'active';
          trackingData.currentStage = 4;
        } else if (trackingData.isBuyer) {
          // ä¹°å®¶å¯»æ‰¾å–å®¶ï¼Œè¿›å…¥åˆ°å–å®¶ç¡®è®¤é˜¶æ®µ
          trackingData.stages[2].status = 'active';
          trackingData.currentStage = 3;
        }
      }
    }
  }
  
  // é˜¶æ®µ3ï¼šå–å®¶ç¡®è®¤
  if (trackingData.currentStage === 3 && trackingData.stages[2].status === 'active') {
    if (message.includes('å–å®¶ç¡®è®¤') || message.includes('ä¾›åº”å•†ç¡®è®¤') || message.includes('å·²ç¡®è®¤') || 
        message.includes('å¯ä»¥ä¾›åº”') || message.includes('æœ‰åº“å­˜')) {
      trackingData.stages[2].status = 'completed';
      trackingData.stages[2].timestamp = new Date().toISOString();
      
      // è¿›å…¥ä¹°å®¶ç¡®è®¤é˜¶æ®µ
      trackingData.stages[3].status = 'active';
      trackingData.currentStage = 4;
    }
  }
  
  // é˜¶æ®µ4ï¼šä¹°å®¶ç¡®è®¤
  if (trackingData.currentStage === 4 && trackingData.stages[3].status === 'active') {
    if (message.includes('ä¹°å®¶ç¡®è®¤') || message.includes('å®¢æˆ·ç¡®è®¤') || message.includes('ç¡®è®¤è´­ä¹°') || 
        message.includes('æ¥å—') || message.includes('æ»¡æ„')) {
      trackingData.stages[3].status = 'completed';
      trackingData.stages[3].timestamp = new Date().toISOString();
      
      // è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µ
      trackingData.stages[4].status = 'active';
      trackingData.currentStage = 5;
    }
  }
  
  // é˜¶æ®µ5ï¼šç¡®è®¤å¯¹æ¥
  if (trackingData.currentStage === 5 && trackingData.stages[4].status === 'active') {
    if (message.includes('äº¤æ˜“æˆåŠŸ') || message.includes('å·²å¯¹æ¥') || message.includes('æˆäº¤') || 
        message.includes('å·²å®Œæˆ') || message.includes('æ„Ÿè°¢åˆä½œ')) {
      trackingData.stages[4].status = 'completed';
      trackingData.stages[4].timestamp = new Date().toISOString();
    }
  }
  
  // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
  trackingData.lastUpdated = new Date().toISOString();
  
  // ä¿å­˜æ›´æ–°åçš„æ•°æ®
  localStorage.setItem('trackingData', JSON.stringify(trackingData));
  
  // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
  initTrackingPanel();
}

// æ˜¾ç¤ºé˜¶æ®µè¯¦ç»†ä¿¡æ¯
function showStageDetail(stage, trackingData) {
  const wechatContact = '<strong>JJ1598929032</strong>';
  const modal = document.createElement('div');
  modal.classList.add('progress-modal');
  
  const modalContent = document.createElement('div');
  modalContent.classList.add('modal-content');
  
  // æ·»åŠ å…³é—­æŒ‰é’®
  const closeBtn = document.createElement('button');
  closeBtn.classList.add('close-modal');
  closeBtn.innerHTML = '&times;';
  closeBtn.addEventListener('click', function() {
    document.body.removeChild(modal);
  });
  
  // é˜¶æ®µè¯¦æƒ…å†…å®¹
  const stageContent = document.createElement('div');
  stageContent.classList.add('stage-detail');
  
  const stageTitle = document.createElement('h3');
  stageTitle.innerHTML = `é˜¶æ®µ ${stage.id}: ${stage.name} <span class="stage-status status-${stage.status}">${getStatusText(stage.status)}</span>`;
  
  const stageTimestamp = document.createElement('div');
  stageTimestamp.classList.add('stage-timestamp');
  if (stage.timestamp) {
    const date = new Date(stage.timestamp);
    stageTimestamp.textContent = `æ›´æ–°æ—¶é—´: ${formatDateTime(date)}`;
  } else {
    stageTimestamp.textContent = 'å°šæœªå¼€å§‹';
  }
  
  const stageDescription = document.createElement('p');
  let descriptionText = '';
  
  // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒå†…å®¹
  const isSeller = trackingData.isSeller;
  const isBuyer = trackingData.isBuyer;
  
  switch(stage.id) {
    case 1:
      if (stage.status === 'completed') {
        descriptionText = `æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : ''}éœ€æ±‚å·²æˆåŠŸæäº¤ï¼æˆ‘ä»¬çš„ç³»ç»Ÿæ­£åœ¨è¿›è¡Œåˆæ­¥åˆ†æï¼Œä»¥ä¾¿æ›´å¥½åœ°åŒ¹é…åˆé€‚çš„${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚å¦‚éœ€è¡¥å……å…·ä½“è¦æ±‚æˆ–æŸ¥è¯¢è¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
      } else {
        descriptionText = `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : 'éœ€æ±‚'}æ„å‘ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚æ‚¨å¯ä»¥éšæ—¶æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©ã€‚`;
      }
      break;
    case 2:
      if (stage.status === 'completed') {
        descriptionText = `ç³»ç»Ÿå·²æˆåŠŸä¸ºæ‚¨åŒ¹é…åˆ°ç¬¦åˆè¦æ±‚çš„${isSeller ? 'æ½œåœ¨ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚ç°åœ¨è¿›å…¥${isSeller ? 'ä¹°å®¶' : 'å–å®¶'}ç¡®è®¤é˜¶æ®µã€‚å¦‚éœ€äº†è§£åŒ¹é…è¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else if (stage.status === 'active') {
        descriptionText = `ç³»ç»Ÿæ­£åœ¨æ ¹æ®æ‚¨æä¾›çš„è¦æ±‚åŒ¹é…${isSeller ? 'ä¹°å®¶èµ„æº' : 'åº“å­˜'}ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦12å°æ—¶å†…å®Œæˆã€‚å¦‚éœ€åŠ å¿«è¿›åº¦æˆ–æä¾›æ›´è¯¦ç»†çš„éœ€æ±‚ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨éœ€æ±‚æäº¤åè‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚`;
      }
      break;
    case 3:
      if (stage.status === 'completed') {
        descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç°åœ¨ç­‰å¾…ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else if (stage.status === 'active') {
        descriptionText = `æˆ‘ä»¬å·²æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„åº“å­˜ï¼Œæ­£åœ¨ç­‰å¾…å–å®¶ç¡®è®¤ã€‚é€šå¸¸ä¼šåœ¨24å°æ—¶å†…å¾—åˆ°å›å¤ã€‚å¦‚æƒ³ä¼˜å…ˆå¤„ç†æˆ–äº†è§£æ›´å¤šè¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨åŒ¹é…åˆ°åˆé€‚åº“å­˜åè”ç³»å–å®¶ç¡®è®¤ã€‚`;
      }
      break;
    case 4:
      if (stage.status === 'completed') {
        descriptionText = `ä¹°å®¶å·²ç¡®è®¤è´­ä¹°æ„å‘ï¼Œç°åœ¨è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µã€‚è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆäº¤æ˜“ç»†èŠ‚ç¡®è®¤ã€‚`;
      } else if (stage.status === 'active') {
        descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç­‰å¾…æ‚¨çš„æœ€ç»ˆç¡®è®¤ã€‚ä¸ºç¡®ä¿äº¤æ˜“é¡ºåˆ©è¿›è¡Œï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¿›è¡Œåç»­æ²Ÿé€š`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨å–å®¶ç¡®è®¤åè”ç³»ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚`;
      }
      break;
    case 5:
      if (stage.status === 'completed') {
        descriptionText = `æ­å–œï¼äº¤æ˜“å·²æˆåŠŸå¯¹æ¥ã€‚è¯·é€šè¿‡å¾®ä¿¡ï¼š${wechatContact} å®Œæˆåç»­äº¤æ˜“æµç¨‹ã€‚`;
      } else if (stage.status === 'active') {
        descriptionText = `æ­å–œï¼åŒæ–¹å·²è¾¾æˆå¯¹æ¥æ„å‘ã€‚ä¸ºä¿éšœäº¤æ˜“å®‰å…¨å’Œé¡ºåˆ©å®Œæˆåç»­æµç¨‹ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–è¯¦ç»†æŒ‡å¯¼`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨ä¹°å®¶ç¡®è®¤åè¿›å…¥æœ€ç»ˆå¯¹æ¥ç¡®è®¤é˜¶æ®µã€‚`;
      }
      break;
    default:
      descriptionText = `å½“å‰é˜¶æ®µçŠ¶æ€æ›´æ–°ä¸­ã€‚å¦‚éœ€åŠæ—¶äº†è§£æœ€æ–°è¿›å±•ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
  }
  
  stageDescription.innerHTML = descriptionText;
  
  const nextStepsTitle = document.createElement('h4');
  nextStepsTitle.textContent = 'ä¸‹ä¸€æ­¥æ“ä½œ';
  
  const nextStepsList = document.createElement('ul');
  const nextSteps = getNextSteps(stage.id, stage.status, trackingData);
  
  nextSteps.forEach(step => {
    const listItem = document.createElement('li');
    listItem.innerHTML = step;
    nextStepsList.appendChild(listItem);
  });
  
  // æ·»åŠ å¹³å°ç¡®è®¤æç¤º
  const platformConfirmNote = document.createElement('div');
  platformConfirmNote.classList.add('platform-confirmation-note');
  platformConfirmNote.innerHTML = `<i>æ³¨æ„ï¼šå¯¹æ¥è¿›åº¦ç”±å¹³å°æ ¹æ®å®é™…æƒ…å†µç¡®è®¤æ›´æ–°ï¼Œé˜¶æ®µè¿›åº¦æ— æ³•æ‰‹åŠ¨ä¿®æ”¹ã€‚å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}</i>`;
  
  stageContent.appendChild(stageTitle);
  stageContent.appendChild(stageTimestamp);
  stageContent.appendChild(stageDescription);
  stageContent.appendChild(nextStepsTitle);
  stageContent.appendChild(nextStepsList);
  stageContent.appendChild(platformConfirmNote);
  
  modalContent.appendChild(closeBtn);
  modalContent.appendChild(stageContent);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}

// æ›´æ–°å¯¹æ¥è¿›åº¦
function updateTrackingProgress() {
  let trackingData = JSON.parse(localStorage.getItem('trackingData'));
  
  if (!trackingData) return;
  
  // è·å–å½“å‰æ´»è·ƒé˜¶æ®µ
  let currentActiveIndex = trackingData.stages.findIndex(stage => stage.status === 'active');
  
  // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­æ¶ˆæ¯
  showProgressUpdateMessage();
  
  // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤è¿‡ç¨‹ï¼ˆå®é™…ç¯å¢ƒä¸­åº”é€šè¿‡åç«¯APIè·å–ç¡®è®¤ç»“æœï¼‰
  setTimeout(() => {
    // å¹³å°å®¡æ ¸ç¡®è®¤åï¼Œæ›´æ–°è¿›åº¦
    // æ³¨æ„ï¼šåœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªç¡®è®¤è¿‡ç¨‹åº”è¯¥æ¥è‡ªæœåŠ¡å™¨
    const platformConfirmed = Math.random() > 0.5; // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤ç»“æœ
    
    if (platformConfirmed && currentActiveIndex !== -1 && currentActiveIndex < trackingData.stages.length - 1) {
      // å½“å‰é˜¶æ®µå®Œæˆ
      trackingData.stages[currentActiveIndex].status = 'completed';
      trackingData.stages[currentActiveIndex].timestamp = new Date().toISOString();
      
      // ä¸‹ä¸€é˜¶æ®µæ¿€æ´»
      trackingData.stages[currentActiveIndex + 1].status = 'active';
      trackingData.currentStage = currentActiveIndex + 2; // +2æ˜¯å› ä¸ºstage idä»1å¼€å§‹
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      showNotification("è¿›åº¦å·²æ›´æ–°", "å¹³å°å·²ç¡®è®¤æ‚¨çš„è¿›åº¦æ›´æ–°", "success");
    } else {
      // å¹³å°æœªç¡®è®¤
      showNotification("è¿›åº¦æ›´æ–°ç­‰å¾…ä¸­", "æ‚¨çš„è¿›åº¦æ›´æ–°è¯·æ±‚æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤", "info");
    }
    
    // éšæœºæ›´æ–°å…¶ä»–ä¿¡æ¯
    if (!trackingData.productType && Math.random() > 0.7) {
      const products = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›'];
      trackingData.productType = products[Math.floor(Math.random() * products.length)];
    }
    
    if (!trackingData.needType && Math.random() > 0.7) {
      trackingData.needType = Math.random() > 0.5 ? 'é¢æ–™' : 'æœè£…';
    }
    
    if (!trackingData.quantity && trackingData.isSeller && Math.random() > 0.7) {
      const units = ['ä»¶', 'ç±³', 'æ¡'];
      trackingData.quantity = `${Math.floor(Math.random() * 1000) + 10}${units[Math.floor(Math.random() * units.length)]}`;
    }
    
    if (!trackingData.budgetRange && trackingData.isBuyer && Math.random() > 0.7) {
      const min = Math.floor(Math.random() * 500) + 50;
      const max = min + Math.floor(Math.random() * 500) + 50;
      trackingData.budgetRange = `${min}-${max}å…ƒ`;
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    trackingData.lastUpdated = new Date().toISOString();
    
    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(trackingData));
    
    // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿
    initTrackingPanel();
  }, 2000); // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤å»¶è¿Ÿ
}

// æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­çš„æ¶ˆæ¯
function showProgressUpdateMessage() {
  const notification = document.createElement('div');
  notification.classList.add('progress-notification', 'updating');
  notification.innerHTML = `
    <div class="notification-icon">
      <div class="loading-spinner"></div>
    </div>
    <div class="notification-content">
      <h4>è¿›åº¦æ›´æ–°è¯·æ±‚å·²æäº¤</h4>
      <p>æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...</p>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // 1.5ç§’åç§»é™¤é€šçŸ¥
  setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 500);
  }, 1500);
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(title, message, type = "info") {
  const notification = document.createElement('div');
  notification.classList.add('progress-notification', type);
  
  let icon = '';
  if (type === 'success') {
    icon = '<div class="notification-icon success">âœ“</div>';
  } else if (type === 'error') {
    icon = '<div class="notification-icon error">âœ—</div>';
  } else {
    icon = '<div class="notification-icon info">i</div>';
  }
  
  notification.innerHTML = `
    ${icon}
    <div class="notification-content">
      <h4>${title}</h4>
      <p>${message}</p>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // 3ç§’åç§»é™¤é€šçŸ¥
  setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 500);
  }, 3000);
}

// è·å–çŠ¶æ€æ–‡æœ¬æè¿°
function getStatusText(status) {
  switch(status) {
    case 'pending': return 'ç­‰å¾…ä¸­';
    case 'active': return 'è¿›è¡Œä¸­';
    case 'completed': return 'å·²å®Œæˆ';
    default: return 'æœªçŸ¥çŠ¶æ€';
  }
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${year}-${month}-${day} ${hours}:${minutes}`;
}

// è·å–æ—¶é—´å·®å¼‚çš„å‹å¥½æè¿°
function getTimeDifference(oldDate, newDate) {
  const diffMs = newDate - oldDate;
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);
  const diffHour = Math.floor(diffMin / 60);
  const diffDay = Math.floor(diffHour / 24);
  
  if (diffSec < 60) {
    return 'åˆšåˆš';
  } else if (diffMin < 60) {
    return `${diffMin}åˆ†é’Ÿå‰`;
  } else if (diffHour < 24) {
    return `${diffHour}å°æ—¶å‰`;
  } else if (diffDay < 30) {
    return `${diffDay}å¤©å‰`;
  } else {
    const month = String(oldDate.getMonth() + 1).padStart(2, '0');
    const day = String(oldDate.getDate()).padStart(2, '0');
    return `${month}-${day}`;
  }
}

// è·å–å·²å®Œæˆé˜¶æ®µçš„æ•°é‡
function getCompletedStages(stages) {
  if (!stages || !Array.isArray(stages)) return 0;
  return stages.filter(stage => stage.status === 'completed').length;
}

// åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åŒ…å«å…·ä½“äº§å“ä¿¡æ¯
function containsSpecificProductInfo(message) {
  // åŒ¹é…å…·ä½“çš„äº§å“æè¿°
  const patterns = [
    /\d+[ä»¶æ¡ç±³å¨]/,  // åŒ¹é…æ•°é‡å•ä½
    /æ¬¾å¼|å‹å·|è§„æ ¼|å°ºå¯¸|é¢œè‰²|æˆåˆ†/,  // åŒ¹é…äº§å“å±æ€§
    /ç‰Œ|å“ç‰Œ|å‚å®¶|ç”Ÿäº§å•†/,  // åŒ¹é…å“ç‰Œä¿¡æ¯
    /ä»·æ ¼|æŠ¥ä»·|å…ƒ\/[ç±³ä»¶æ¡]/  // åŒ¹é…ä»·æ ¼ä¿¡æ¯
  ];
  
  return patterns.some(pattern => pattern.test(message));
}

// æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½è·å–ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•
function getNextSteps(stageId, stageStatus, trackingData) {
  const wechatContact = '<strong>JJ1598929032</strong>';
  const isSeller = trackingData.isSeller;
  const isBuyer = trackingData.isBuyer;
  
  // å¦‚æœé˜¶æ®µå·²å®Œæˆï¼Œè¿”å›ç©ºæ­¥éª¤åˆ—è¡¨
  if (stageStatus === 'completed') {
    return [`æ­¤é˜¶æ®µå·²å®Œæˆï¼Œè¯·ç»§ç»­æ¨è¿›ä¸‹ä¸€é˜¶æ®µ`, `å¦‚æœ‰é—®é¢˜è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å’¨è¯¢`];
  }
  
  // å¦‚æœé˜¶æ®µæœªå¼€å§‹ï¼Œè¿”å›ç­‰å¾…æŒ‡å¼•
  if (stageStatus === 'pending') {
    return [`è¯·ç­‰å¾…å‰åºé˜¶æ®µå®Œæˆåå†è¿›è¡Œæ­¤é˜¶æ®µ`, `å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`];
  }
  
  // é˜¶æ®µå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæ ¹æ®ä¸åŒæƒ…å†µè¿”å›æŒ‡å¼•
  if (isSeller) {
    switch(stageId) {
      case 1:
        return [
          `è¯¦ç»†æè¿°æ‚¨è¦å‡ºå”®çš„äº§å“ç±»å‹ã€æ•°é‡å’ŒæœŸæœ›ä»·æ ¼`,
          `æä¾›äº§å“å›¾ç‰‡æˆ–è¯¦ç»†è§„æ ¼è¯´æ˜`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
        ];
      case 2:
        return [
          `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…æ½œåœ¨ä¹°å®¶`,
          `å®Œå–„æ‚¨çš„äº§å“ç»†èŠ‚ä¿¡æ¯ä»¥æé«˜åŒ¹é…ç‡`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
        ];
      case 3:
        return [
          `å‡†å¤‡å¥½è¯¦ç»†çš„äº§å“è¯´æ˜å’Œä»·æ ¼èµ„æ–™`,
          `ç¡®è®¤æ‚¨çš„å‘è´§èƒ½åŠ›å’Œåº“å­˜æƒ…å†µ`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£ä¹°å®¶éœ€æ±‚ç»†èŠ‚`
        ];
      case 4:
        return [
          `å‡†å¤‡è¯¦ç»†çš„äº§å“èµ„æ–™å’ŒæŠ¥ä»·å•`,
          `ç¡®è®¤æ‚¨çš„ä»“åº“åº“å­˜å’Œç‰©æµé…é€æ–¹æ¡ˆ`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸ä¹°å®¶ç›´æ¥æ²Ÿé€š`
        ];
      case 5:
        return [
          `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œä»˜æ¬¾æ–¹å¼`,
          `å‡†å¤‡äº§å“å‘è´§å’Œå”®åæœåŠ¡æ–¹æ¡ˆ`,
          `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
        ];
      default:
        return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
    }
  } else if (isBuyer) {
    switch(stageId) {
      case 1:
        return [
          `è¯¦ç»†æè¿°æ‚¨éœ€è¦çš„äº§å“ç±»å‹ã€æ•°é‡å’Œé¢„ç®—`,
          `è¯´æ˜æ‚¨å¯¹äº§å“è´¨é‡å’Œè§„æ ¼çš„è¦æ±‚`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
        ];
      case 2:
        return [
          `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…åˆé€‚åº“å­˜`,
          `å®Œå–„æ‚¨çš„éœ€æ±‚ç»†èŠ‚ä»¥æé«˜åŒ¹é…ç²¾å‡†åº¦`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
        ];
      case 3:
        return [
          `å‡†å¤‡å¥½ä¸å–å®¶æ²Ÿé€šçš„å…·ä½“é—®é¢˜`,
          `ç¡®è®¤æ‚¨çš„é‡‡è´­é¢„ç®—å’Œä»˜æ¬¾æ–¹å¼`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£å–å®¶ç¡®è®¤è¿›åº¦`
        ];
      case 4:
        return [
          `ä»”ç»†è¯„ä¼°å–å®¶æä¾›çš„äº§å“ä¿¡æ¯`,
          `ç¡®è®¤äº§å“æ˜¯å¦æ»¡è¶³æ‚¨çš„éœ€æ±‚`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸å–å®¶ç›´æ¥æ²Ÿé€š`
        ];
      case 5:
        return [
          `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œæ”¶è´§åœ°å€`,
          `å‡†å¤‡ä»˜æ¬¾å’ŒéªŒæ”¶äº§å“`,
          `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
        ];
      default:
        return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
    }
  } else {
    // ç”¨æˆ·èº«ä»½æœªç¡®å®š
    switch(stageId) {
      case 1:
        return [
          `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨æ˜¯å¸Œæœ›å‡ºå”®è¿˜æ˜¯é‡‡è´­`,
          `è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚æˆ–äº§å“ä¿¡æ¯`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–ä¸“ä¸šæŒ‡å¯¼`
        ];
      default:
        return [
          `è¯·å…ˆæ˜ç¡®æ‚¨çš„èº«ä»½ï¼ˆä¹°å®¶/å–å®¶ï¼‰`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©`
        ];
    }
  }
}

// Newsletter subscription functionality
function initNewsletterSystem() {
  const subscribeForm = document.querySelector('.subscribe-form');
  const emailInput = subscribeForm.querySelector('input[type="email"]');
  
  subscribeForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const email = emailInput.value.trim();
    
    if (!email) {
      showSubscriptionNotification('error', 'è®¢é˜…å¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
      return;
    }
    
    if (!isValidEmail(email)) {
      showSubscriptionNotification('error', 'è®¢é˜…å¤±è´¥', 'è¯·è¾“å…¥æ­£ç¡®æ ¼å¼çš„é‚®ç®±åœ°å€');
      return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å¸¸è§é‚®ç®±æä¾›å•†
    const isCommonProvider = checkEmailProvider(email);
    if (!isCommonProvider) {
      showSubscriptionNotification('info', 'æç¤º', 'æ‚¨ä½¿ç”¨çš„é‚®ç®±ä¸æ˜¯å¸¸è§é‚®ç®±æä¾›å•†ï¼Œå¯èƒ½ä¼šå½±å“æ¥æ”¶æ•ˆæœ');
    }
    
    // æ¨¡æ‹Ÿå‘æœåŠ¡å™¨å‘é€è¯·æ±‚
    showSubscriptionNotification('info', 'å¤„ç†ä¸­', 'æ­£åœ¨å¤„ç†æ‚¨çš„è®¢é˜…è¯·æ±‚...');
    
    // æ¨¡æ‹ŸAPIè¯·æ±‚å»¶è¿Ÿ
    setTimeout(() => {
      // å°†é‚®ç®±ä¿å­˜åˆ°localStorageä»¥ä¾¿æ¼”ç¤º
      saveSubscriber(email);
      
      // å‘é€éªŒè¯é‚®ä»¶
      sendVerificationEmail(email);
      
      // æ¸…ç©ºè¾“å…¥
      emailInput.value = '';
    }, 1500);
  });
  
  // æ·»åŠ æ£€æŸ¥é‚®ä»¶æ¥æ”¶çŠ¶æ€çš„æŒ‰é’®ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
  addEmailCheckingTools();
}

function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function checkEmailProvider(email) {
  const commonProviders = [
    'gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'qq.com', 
    '163.com', '126.com', 'sina.com', 'sohu.com', 'aliyun.com', 
    'foxmail.com', '139.com', '189.com', 'live.com', 'msn.com'
  ];
  
  const domain = email.split('@')[1].toLowerCase();
  return commonProviders.includes(domain);
}

function saveSubscriber(email) {
  let subscribers = JSON.parse(localStorage.getItem('newsletter_subscribers') || '[]');
  
  // æ£€æŸ¥æ˜¯å¦å·²è®¢é˜…
  if (subscribers.some(sub => sub.email === email)) {
    showSubscriptionNotification('info', 'å·²è®¢é˜…', 'æ­¤é‚®ç®±å·²åœ¨è®¢é˜…åˆ—è¡¨ä¸­ï¼Œæ— éœ€é‡å¤è®¢é˜…');
    return;
  }
  
  // æ·»åŠ è®¢é˜…è€…ï¼ŒåŒ…å«éªŒè¯çŠ¶æ€å’Œæ—¶é—´æˆ³
  subscribers.push({
    email: email,
    verified: false,
    subscribeDate: new Date().toISOString(),
    lastEmailSent: null,
    emailStatus: {
      deliveryAttempts: 0,
      lastStatus: 'pending',
      bounceCount: 0
    }
  });
  
  localStorage.setItem('newsletter_subscribers', JSON.stringify(subscribers));
  showSubscriptionNotification('success', 'è®¢é˜…è¯·æ±‚å·²æäº¤', 'è¯·æŸ¥æ”¶éªŒè¯é‚®ä»¶ä»¥å®Œæˆè®¢é˜…');
}

function sendVerificationEmail(email) {
  // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæœ‰APIè°ƒç”¨å‘é€çœŸå®é‚®ä»¶
  console.log(`å‘é€éªŒè¯é‚®ä»¶åˆ°: ${email}`);
  
  // æ¨¡æ‹ŸéªŒè¯è¿‡ç¨‹ (å®é™…ä¸­ä¼šæœ‰ç‚¹å‡»é“¾æ¥éªŒè¯æµç¨‹)
  simulateVerification(email);
}

function simulateVerification(email) {
  // æ¨¡æ‹Ÿç”¨æˆ·æ‰“å¼€éªŒè¯é‚®ä»¶å¹¶ç‚¹å‡»éªŒè¯é“¾æ¥çš„è¿‡ç¨‹
  setTimeout(() => {
    verifySubscriber(email);
  }, 3000);
}

function verifySubscriber(email) {
  let subscribers = JSON.parse(localStorage.getItem('newsletter_subscribers') || '[]');
  const index = subscribers.findIndex(sub => sub.email === email);
  
  if (index !== -1) {
    subscribers[index].verified = true;
    subscribers[index].verifiedDate = new Date().toISOString();
    localStorage.setItem('newsletter_subscribers', JSON.stringify(subscribers));
    
    showSubscriptionNotification('success', 'è®¢é˜…æˆåŠŸ', 'æ‚¨çš„é‚®ç®±å·²æˆåŠŸéªŒè¯ï¼Œå°†å¼€å§‹æ¥æ”¶ç½‘ç«™æ›´æ–°');
  }
}

// å‘é€è®¢é˜…æ›´æ–°
function sendSubscriptionUpdates() {
  const subscribers = JSON.parse(localStorage.getItem('newsletter_subscribers') || '[]');
  const updates = JSON.parse(localStorage.getItem('latest_website_updates') || '[]');
  
  // ç­›é€‰å·²éªŒè¯çš„è®¢é˜…è€…
  const verifiedSubscribers = subscribers.filter(sub => sub.verified);
  
  if (verifiedSubscribers.length === 0) {
    showSubscriptionNotification('error', 'æ— æ³•å‘é€', 'å½“å‰æ²¡æœ‰å·²éªŒè¯çš„è®¢é˜…è€…');
    return;
  }
  
  if (updates.length === 0) {
    showSubscriptionNotification('error', 'æ— æ³•å‘é€', 'å½“å‰æ²¡æœ‰æ›´æ–°å†…å®¹å¯å‘é€');
    return;
  }
  
  // åœ¨å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šæœ‰APIè°ƒç”¨æ¥å‘é€é‚®ä»¶
  // æ¨¡æ‹Ÿå‘é€æˆåŠŸ
  showSubscriptionNotification('info', 'å‘é€ä¸­', `æ­£åœ¨å‘${verifiedSubscribers.length}ä½è®¢é˜…è€…å‘é€æ›´æ–°...`);
  
  // æ›´æ–°æ¯ä¸ªè®¢é˜…è€…çš„å‘é€çŠ¶æ€
  let updatedSubscribers = [...subscribers];
  for (let i = 0; i < updatedSubscribers.length; i++) {
    if (updatedSubscribers[i].verified) {
      updatedSubscribers[i].lastEmailSent = new Date().toISOString();
      updatedSubscribers[i].emailStatus.deliveryAttempts++;
      updatedSubscribers[i].emailStatus.lastStatus = simulateEmailDelivery(updatedSubscribers[i].email);
      
      if (updatedSubscribers[i].emailStatus.lastStatus === 'bounced') {
        updatedSubscribers[i].emailStatus.bounceCount++;
      }
    }
  }
  
  localStorage.setItem('newsletter_subscribers', JSON.stringify(updatedSubscribers));
  
  setTimeout(() => {
    // æ±‡æ€»å‘é€ç»“æœ
    const results = analyzeDeliveryResults(updatedSubscribers);
    
    // æ¨¡æ‹Ÿå‘é€è¿‡ç¨‹
    const updatesPreview = document.createElement('div');
    updatesPreview.className = 'updates-preview';
    updatesPreview.innerHTML = `
      <h3>ç½‘ç«™æ›´æ–°å†…å®¹å·²å‘é€</h3>
      <p>å‘é€ç»“æœ: æˆåŠŸ ${results.delivered}ï¼Œç­‰å¾…ä¸­ ${results.pending}ï¼Œå¤±è´¥ ${results.failed}</p>
      <div class="delivery-summary">
        <div class="delivery-status">
          <span class="status-label">å‘é€æˆåŠŸç‡:</span>
          <div class="status-bar">
            <div class="status-progress" style="width: ${(results.delivered / verifiedSubscribers.length) * 100}%"></div>
          </div>
          <span class="status-percent">${Math.round((results.delivered / verifiedSubscribers.length) * 100)}%</span>
        </div>
      </div>
      <ul>
        ${updates.map(update => `
          <li>
            <strong>${update.type}:</strong> ${update.title} 
            <span class="update-date">${update.date}</span>
          </li>
        `).join('')}
      </ul>
      <div class="troubleshooting-link">
        <button class="show-delivery-details">æŸ¥çœ‹è¯¦ç»†å‘é€æŠ¥å‘Š</button>
      </div>
      <button class="close-preview">å…³é—­</button>
    `;
    
    document.body.appendChild(updatesPreview);
    
    // è®°å½•æœ€åå‘é€æ—¶é—´
    localStorage.setItem('last_newsletter_sent', new Date().toISOString());
    
    // æ·»åŠ å…³é—­æŒ‰é’®åŠŸèƒ½
    updatesPreview.querySelector('.close-preview').addEventListener('click', () => {
      updatesPreview.remove();
    });
    
    // æ·»åŠ æŸ¥çœ‹è¯¦ç»†æŠ¥å‘ŠåŠŸèƒ½
    updatesPreview.querySelector('.show-delivery-details').addEventListener('click', () => {
      showEmailDeliveryReport(updatedSubscribers);
      updatesPreview.remove();
    });
    
    // å‡ ç§’åè‡ªåŠ¨å…³é—­
    setTimeout(() => {
      if (document.body.contains(updatesPreview)) {
        updatesPreview.remove();
      }
    }, 12000);
    
    showSubscriptionNotification('success', 'å‘é€å®Œæˆ', `æ›´æ–°å†…å®¹å·²å‘é€ç»™${verifiedSubscribers.length}ä½è®¢é˜…è€…`);
  }, 2000);
}

function simulateEmailDelivery(email) {
  // æ¨¡æ‹Ÿé‚®ä»¶å‘é€çŠ¶æ€
  // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™å°†æ˜¯åŸºäºESPï¼ˆé‚®ä»¶æœåŠ¡æä¾›å•†ï¼‰çš„å›è°ƒ
  const domain = email.split('@')[1].toLowerCase();
  
  // æ¨¡æ‹Ÿä¸€äº›å¸¸è§çš„é‚®ä»¶å‘é€é—®é¢˜
  if (['example.com', 'test.com'].includes(domain)) {
    return 'bounced'; // æ¨¡æ‹Ÿé‚®ç®±ä¸å­˜åœ¨
  }
  
  // éšæœºæ¨¡æ‹Ÿä¸€äº›å¯èƒ½çš„å¤±è´¥æƒ…å†µ
  const random = Math.random();
  if (random < 0.05) return 'bounced';
  if (random < 0.1) return 'spam';
  if (random < 0.15) return 'pending';
  
  return 'delivered';
}

function analyzeDeliveryResults(subscribers) {
  const verifiedSubscribers = subscribers.filter(sub => sub.verified);
  
  return {
    total: verifiedSubscribers.length,
    delivered: verifiedSubscribers.filter(sub => sub.emailStatus.lastStatus === 'delivered').length,
    failed: verifiedSubscribers.filter(sub => ['bounced', 'spam'].includes(sub.emailStatus.lastStatus)).length,
    pending: verifiedSubscribers.filter(sub => sub.emailStatus.lastStatus === 'pending').length
  };
}

function showEmailDeliveryReport(subscribers) {
  const verifiedSubscribers = subscribers.filter(sub => sub.verified);
  
  const reportModal = document.createElement('div');
  reportModal.className = 'email-report-modal';
  
  reportModal.innerHTML = `
    <div class="report-content">
      <div class="report-header">
        <h3>é‚®ä»¶å‘é€è¯¦æƒ…æŠ¥å‘Š</h3>
        <button class="close-report">Ã—</button>
      </div>
      <div class="report-body">
        <div class="report-summary">
          <div class="summary-item">
            <span class="summary-count">${verifiedSubscribers.length}</span>
            <span class="summary-label">æ€»è®¢é˜…æ•°</span>
          </div>
          <div class="summary-item success">
            <span class="summary-count">${verifiedSubscribers.filter(sub => sub.emailStatus.lastStatus === 'delivered').length}</span>
            <span class="summary-label">å‘é€æˆåŠŸ</span>
          </div>
          <div class="summary-item warning">
            <span class="summary-count">${verifiedSubscribers.filter(sub => sub.emailStatus.lastStatus === 'spam').length}</span>
            <span class="summary-label">å¯èƒ½è¿›å…¥åƒåœ¾ç®±</span>
          </div>
          <div class="summary-item error">
            <span class="summary-count">${verifiedSubscribers.filter(sub => sub.emailStatus.lastStatus === 'bounced').length}</span>
            <span class="summary-label">é€€ä¿¡/å‘é€å¤±è´¥</span>
          </div>
        </div>
        
        <h4>å‘é€è¯¦æƒ…</h4>
        <div class="subscriber-list">
          <div class="subscriber-header">
            <span class="sub-email">é‚®ç®±åœ°å€</span>
            <span class="sub-status">çŠ¶æ€</span>
            <span class="sub-action">æ“ä½œ</span>
          </div>
          ${verifiedSubscribers.map(sub => `
            <div class="subscriber-row ${sub.emailStatus.lastStatus}">
              <span class="sub-email">${sub.email}</span>
              <span class="sub-status">${getStatusText(sub.emailStatus.lastStatus)}</span>
              <span class="sub-action">
                ${sub.emailStatus.lastStatus !== 'delivered' ? 
                  `<button class="resend-btn" data-email="${sub.email}">é‡æ–°å‘é€</button>` : 
                  '<span class="success-check">âœ“</span>'}
              </span>
            </div>
          `).join('')}
        </div>
        
        <div class="troubleshooting-tips">
          <h4>æœªæ”¶åˆ°é‚®ä»¶çš„å¯èƒ½åŸå› </h4>
          <ul>
            <li>é‚®ç®±åœ°å€å¯èƒ½è¾“å…¥é”™è¯¯</li>
            <li>é‚®ä»¶å¯èƒ½è¢«å½’ç±»ä¸ºåƒåœ¾é‚®ä»¶ï¼Œè¯·æ£€æŸ¥åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹</li>
            <li>éƒ¨åˆ†é‚®ç®±æœåŠ¡å•†å¯èƒ½æœ‰è¾ƒä¸¥æ ¼çš„è¿‡æ»¤ç­–ç•¥</li>
            <li>é‚®ä»¶æœåŠ¡å™¨å¯èƒ½æš‚æ—¶æ€§æ•…éšœ</li>
          </ul>
          
          <h4>æ”¹å–„é‚®ä»¶æ¥æ”¶çš„å»ºè®®</h4>
          <ul>
            <li>å°†æˆ‘ä»¬çš„é‚®ç®±åœ°å€æ·»åŠ åˆ°æ‚¨çš„è”ç³»äººåå•</li>
            <li>å°†æˆ‘ä»¬çš„åŸŸåæ ‡è®°ä¸ºå®‰å…¨å‘ä»¶äºº</li>
            <li>å®šæœŸæ£€æŸ¥æ‚¨çš„åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹</li>
            <li>è€ƒè™‘ä½¿ç”¨ä¸»æµé‚®ç®±æœåŠ¡(å¦‚QQé‚®ç®±ã€163ã€Gmailç­‰)</li>
          </ul>
        </div>
      </div>
      <div class="report-footer">
        <button class="export-report">å¯¼å‡ºæŠ¥å‘Š</button>
        <button class="close-report-btn">å…³é—­</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(reportModal);
  
  // æ·»åŠ å…³é—­åŠŸèƒ½
  const closeButtons = reportModal.querySelectorAll('.close-report, .close-report-btn');
  closeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      reportModal.remove();
    });
  });
  
  // æ·»åŠ é‡å‘é‚®ä»¶åŠŸèƒ½
  const resendButtons = reportModal.querySelectorAll('.resend-btn');
  resendButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const email = btn.dataset.email;
      resendEmail(email, btn);
    });
  });
  
  // æ·»åŠ å¯¼å‡ºæŠ¥å‘ŠåŠŸèƒ½
  reportModal.querySelector('.export-report').addEventListener('click', () => {
    exportDeliveryReport(subscribers);
  });
}

function getStatusText(status) {
  switch(status) {
    case 'delivered': return 'å‘é€æˆåŠŸ';
    case 'bounced': return 'é€€ä¿¡å¤±è´¥';
    case 'spam': return 'å¯èƒ½è¿›å…¥åƒåœ¾ç®±';
    case 'pending': return 'å‘é€ä¸­';
    default: return 'æœªçŸ¥çŠ¶æ€';
  }
}

function resendEmail(email, button) {
  // æ›´æ”¹æŒ‰é’®çŠ¶æ€
  button.textContent = 'å‘é€ä¸­...';
  button.disabled = true;
  
  // æ¨¡æ‹Ÿé‡æ–°å‘é€è¿‡ç¨‹
  setTimeout(() => {
    let subscribers = JSON.parse(localStorage.getItem('newsletter_subscribers') || '[]');
    const index = subscribers.findIndex(sub => sub.email === email);
    
    if (index !== -1) {
      // æ›´æ–°çŠ¶æ€
      subscribers[index].emailStatus.deliveryAttempts++;
      subscribers[index].emailStatus.lastStatus = 'delivered'; // å‡è®¾é‡å‘æˆåŠŸ
      subscribers[index].lastEmailSent = new Date().toISOString();
      
      localStorage.setItem('newsletter_subscribers', JSON.stringify(subscribers));
      
      // æ›´æ–°UI
      const row = button.closest('.subscriber-row');
      row.className = 'subscriber-row delivered';
      row.querySelector('.sub-status').textContent = 'å‘é€æˆåŠŸ';
      button.parentNode.innerHTML = '<span class="success-check">âœ“</span>';
      
      showSubscriptionNotification('success', 'é‡å‘æˆåŠŸ', `å·²æˆåŠŸé‡æ–°å‘é€é‚®ä»¶åˆ° ${email}`);
    }
  }, 2000);
}

function exportDeliveryReport(subscribers) {
  // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šç”ŸæˆCSVæˆ–PDFæ–‡ä»¶
  // ç›®å‰åªæ˜¯æ¨¡æ‹Ÿå¯¼å‡ºåŠŸèƒ½
  showSubscriptionNotification('success', 'å¯¼å‡ºæˆåŠŸ', 'å·²å°†æŠ¥å‘Šå¯¼å‡ºåˆ°æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹');
}

function showSubscriptionNotification(type, title, message) {
  const notification = document.createElement('div');
  notification.classList.add('subscription-notification', type);
  notification.innerHTML = `
    <div class="notification-icon">${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'i'}</div>
    <div class="notification-content">
      <h4>${title}</h4>
      <p>${message}</p>
    </div>
    <button class="close-notification">Ã—</button>
  `;
  
  document.body.appendChild(notification);
  
  // æ·»åŠ å…³é—­åŠŸèƒ½
  notification.querySelector('.close-notification').addEventListener('click', () => {
    notification.remove();
  });
  
  // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
  setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 500);
  }, 3000);
}

// æ·»åŠ é‚®ä»¶æ£€æŸ¥å·¥å…·ï¼ˆæ¼”ç¤ºåŠŸèƒ½ï¼‰
function addEmailCheckingTools() {
  const subscribeForm = document.querySelector('.subscribe-form');
  if (!subscribeForm) return;
  
  const toolsContainer = document.createElement('div');
  toolsContainer.classList.add('email-tools');
  toolsContainer.innerHTML = `
    <button class="check-emails-btn">æ£€æŸ¥é‚®ä»¶æ¥æ”¶çŠ¶æ€</button>
    <button class="send-updates-btn">å‘é€ç½‘ç«™æ›´æ–°</button>
  `;
  
  subscribeForm.parentNode.appendChild(toolsContainer);
  
  // æ·»åŠ åŠŸèƒ½
  toolsContainer.querySelector('.check-emails-btn').addEventListener('click', function() {
    const subscribers = JSON.parse(localStorage.getItem('newsletter_subscribers') || '[]');
    if (subscribers.length === 0) {
      showSubscriptionNotification('error', 'æ— æ³•æ£€æŸ¥', 'å½“å‰æ²¡æœ‰è®¢é˜…è€…');
      return;
    }
    showEmailDeliveryReport(subscribers);
  });
  
  toolsContainer.querySelector('.send-updates-btn').addEventListener('click', function() {
    sendSubscriptionUpdates();
  });
}

function getCurrentDate() {
  const now = new Date();
  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
} 
} 