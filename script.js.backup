// DOM Elements
document.addEventListener('DOMContentLoaded', function() {
  // å¯¼èˆªæ æ»šåŠ¨æ•ˆæœ
  const navbar = document.querySelector('.navbar');
  const heroSection = document.querySelector('.hero');
  
  if (navbar && heroSection) {
    const heroHeight = heroSection.offsetHeight;
    
    window.addEventListener('scroll', function() {
      if (window.scrollY > 100) {
        navbar.style.backgroundColor = 'rgba(47, 47, 47, 0.95)';
        navbar.style.color = '#FAF9F6';
      } else {
        navbar.style.backgroundColor = 'rgba(250, 249, 246, 0.95)';
        navbar.style.color = '#2F2F2F';
      }
    });
  }

  // åˆ‡æ¢ä¸»é¢˜æ¨¡å¼
  const themeSwitch = document.querySelector('.theme-switch');
  if (themeSwitch) {
    themeSwitch.addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      if (document.body.classList.contains('dark-mode')) {
        themeSwitch.textContent = 'â˜€ï¸';
      } else {
        themeSwitch.textContent = 'ğŸŒ™';
      }
    });
  }

  // è¯­è¨€åˆ‡æ¢
  const langSwitch = document.querySelector('.lang-switch');
  if (langSwitch) {
    langSwitch.addEventListener('click', function() {
      if (langSwitch.textContent === 'EN') {
        langSwitch.textContent = 'CN';
        setLanguage('zh');
      } else {
        langSwitch.textContent = 'EN';
        setLanguage('en');
      }
    });
  }

  // æŒ‰é’®æ³¢çº¹æ•ˆæœ
  const buttons = document.querySelectorAll('button:not(.tag)');
  buttons.forEach(button => {
    button.classList.add('ripple-button');
    button.addEventListener('click', createRipple);
  });

  function createRipple(event) {
    const button = event.currentTarget;
    const ripple = document.createElement('span');
    const rect = button.getBoundingClientRect();
    
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;
    
    ripple.style.width = ripple.style.height = `${size}px`;
    ripple.style.left = `${x}px`;
    ripple.style.top = `${y}px`;
    
    button.appendChild(ripple);
    
    setTimeout(() => {
      ripple.remove();
    }, 600);
  }

  // ææ–™æ ‡ç­¾äº¤äº’
  const materialTags = document.querySelectorAll('.material-tags .tag');
  if (materialTags.length > 0) {
    materialTags.forEach(tag => {
      tag.addEventListener('click', function() {
        materialTags.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // æ ‡ç­¾ç¼åˆåŠ¨ç”»æ•ˆæœ
        const tagText = this.textContent;
        const filterDisplay = document.createElement('div');
        filterDisplay.classList.add('active-filter');
        filterDisplay.textContent = `å·²ç­›é€‰: ${tagText}`;
        
        const filterContainer = document.querySelector('.material-tags');
        const existingFilter = document.querySelector('.active-filter');
        
        if (existingFilter) {
          filterContainer.removeChild(existingFilter);
        }
        
        if (tagText !== 'å…¨éƒ¨') {
          filterContainer.appendChild(filterDisplay);
        }
        
        // è¿™é‡Œæ·»åŠ å®é™…è¿‡æ»¤é€»è¾‘
        filterProjects(tagText);
      });
    });
  }

  // æ¨¡æ‹Ÿé¡¹ç›®è¿‡æ»¤åŠŸèƒ½
  function filterProjects(category) {
    console.log(`Filtering projects by: ${category}`);
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šæ ¹æ®ç±»åˆ«è¿‡æ»¤DOMå…ƒç´ æˆ–ä»æœåŠ¡å™¨è¯·æ±‚æ•°æ®
  }

  // ç”Ÿæˆ3Då±•ç¤ºå¢™
  initShowcase3D();

  // ç”Ÿæˆé¡¹ç›®å±•ç¤ºå¡ç‰‡
  generateProjectCards();

  // èŠå¤©ç•Œé¢äº¤äº’
  initChatInterface();
  
  // ç¡®ä¿èŠå¤©ç•Œé¢åŠ è½½å®Œæˆåæœ‰é»˜è®¤æ¶ˆæ¯
  setTimeout(function() {
    const chatMessages = document.querySelector('#chat-messages');
    if (chatMessages && chatMessages.children.length === 0) {
      console.log("Chat interface still empty after initialization, retrying...");
      initChatInterface();
    }
  }, 500);

  // è§†å·®æ»šåŠ¨æ•ˆæœ
  initParallaxEffect();

  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  initTrackingPanel();

  // åˆå§‹åŒ–ç»Ÿè®¡æ•°å­—åŠ¨ç”»
  animateStats();
  
  // ç¡®ä¿æ ‡é¢˜ä¸ä¼šå› æ»šåŠ¨æˆ–åŠ¨ç”»è€Œç§»åŠ¨
  const sectionHeaders = document.querySelectorAll('.section-header');
  sectionHeaders.forEach(header => {
    // ä¸ºæ ‡é¢˜å…ƒç´ æ·»åŠ å›ºå®šä½ç½®ç±»
    header.classList.add('stable-position');
  });

  // å¯¹æ‰€æœ‰æ ‡é¢˜åº”ç”¨å›ºå®šæ ·å¼
  const allHeadings = document.querySelectorAll('h2, h3');
  allHeadings.forEach(heading => {
    heading.style.minHeight = heading.offsetHeight + 'px';
  });

  // åˆå§‹åŒ–å¯¼èˆªæ 
  initNavbar();
  
  // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢
  initLanguageSwitch();
  
  // åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
  initDarkMode();
  
  // åˆå§‹åŒ–èŠå¤©ç•Œé¢
  initChatInterface();
  
  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  initTrackingPanel();
  
  // ä¸ºé¡µé¢æ·»åŠ å¹³æ»‘æ»šåŠ¨
  addSmoothScrolling();
  
  // æ»šåŠ¨ç›‘å¬ï¼Œé«˜äº®å½“å‰æ´»åŠ¨çš„å¯¼èˆªèœå•é¡¹
  initScrollSpy();
});

// 3Då±•ç¤ºå¢™åˆå§‹åŒ–
function initShowcase3D() {
  const container = document.querySelector('.showcase-container');
  if (!container) return;

  // ç§»é™¤å ä½ç¬¦
  const placeholder = container.querySelector('.placeholder-3d');
  if (placeholder) {
    container.removeChild(placeholder);
  }

  // åˆ›å»º3Då±•ç¤ºå¢™ - ç®€åŒ–ç‰ˆæ¨¡æ‹Ÿ
  // åœ¨å®Œæ•´å®ç°ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨Three.jsåº“
  
  // åˆ›å»º6ä¸ªå±•ç¤ºå¡ç‰‡ä½œä¸ºç«‹æ–¹ä½“çš„é¢
  const cube = document.createElement('div');
  cube.classList.add('showcase-cube');
  
  for (let i = 0; i < 6; i++) {
    const face = document.createElement('div');
    face.classList.add('cube-face', `face-${i+1}`);
    
    const image = document.createElement('img');
    image.src = `assets/project-${i+1}.jpg`;
    image.alt = `æ”¹é€ é¡¹ç›® ${i+1}`;
    
    face.appendChild(image);
    cube.appendChild(face);
    
    // ç‚¹å‡»å±•å¼€è¯¦æƒ…
    face.addEventListener('click', function() {
      showProjectDetail(i+1);
    });
  }
  
  container.appendChild(cube);
  
  // æ·»åŠ æ‹–åŠ¨äº¤äº’
  let isDragging = false;
  let previousX = 0;
  let previousY = 0;
  let rotX = 0;
  let rotY = 0;
  
  container.addEventListener('mousedown', function(e) {
    isDragging = true;
    previousX = e.clientX;
    previousY = e.clientY;
    container.style.cursor = 'grabbing';
  });
  
  window.addEventListener('mousemove', function(e) {
    if (isDragging) {
      const dx = e.clientX - previousX;
      const dy = e.clientY - previousY;
      
      rotY += dx * 0.5;
      rotX -= dy * 0.5;
      
      cube.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
      
      previousX = e.clientX;
      previousY = e.clientY;
    }
  });
  
  window.addEventListener('mouseup', function() {
    isDragging = false;
    container.style.cursor = 'grab';
  });
}

// é¡¹ç›®è¯¦æƒ…å¼¹çª—
function showProjectDetail(projectId) {
  // åˆ›å»ºæ¨¡æ€æ¡†
  const modal = document.createElement('div');
  modal.classList.add('project-modal');
  
  const modalContent = document.createElement('div');
  modalContent.classList.add('modal-content');
  
  // æ·»åŠ å…³é—­æŒ‰é’®
  const closeBtn = document.createElement('button');
  closeBtn.classList.add('close-modal');
  closeBtn.innerHTML = '&times;';
  closeBtn.addEventListener('click', function() {
    document.body.removeChild(modal);
  });
  
  // æ·»åŠ é¡¹ç›®å†…å®¹
  const projectContent = document.createElement('div');
  projectContent.classList.add('project-detail');
  
  const projectTitle = document.createElement('h3');
  projectTitle.textContent = `æ”¹é€ é¡¹ç›® ${projectId}`;
  
  const beforeAfterContainer = document.createElement('div');
  beforeAfterContainer.classList.add('before-after-slider');
  
  // è¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æ›´å¤æ‚çš„æ»‘å—å¯¹æ¯”ç»„ä»¶
  const beforeImg = document.createElement('img');
  beforeImg.src = `assets/project-${projectId}-before.jpg`;
  beforeImg.alt = 'æ”¹é€ å‰';
  
  const afterImg = document.createElement('img');
  afterImg.src = `assets/project-${projectId}-after.jpg`;
  afterImg.alt = 'æ”¹é€ å';
  
  beforeAfterContainer.appendChild(beforeImg);
  beforeAfterContainer.appendChild(afterImg);
  
  const projectDesc = document.createElement('p');
  projectDesc.textContent = 'è¿™æ˜¯ä¸€ä¸ªæ—§ç‰›ä»”è£¤æ”¹é€ é¡¹ç›®ï¼Œé€šè¿‡æ‹¼æ¥å‰ªè£å’Œæ‰‹å·¥è£…é¥°ï¼Œå°†åºŸæ—§ç‰›ä»”è£¤å˜æˆæ—¶å°šå•è‚©åŒ…ã€‚é‡‡ç”¨é›¶æµªè´¹è®¾è®¡åŸåˆ™ï¼Œç”šè‡³å°†æ‹‰é“¾å’Œçº½æ‰£ä¹Ÿé‡æ–°åˆ©ç”¨ã€‚';
  
  const designSketch = document.createElement('img');
  designSketch.classList.add('design-sketch');
  designSketch.src = `assets/sketch-${projectId}.jpg`;
  designSketch.alt = 'è®¾è®¡è‰å›¾';
  
  projectContent.appendChild(projectTitle);
  projectContent.appendChild(beforeAfterContainer);
  projectContent.appendChild(projectDesc);
  projectContent.appendChild(designSketch);
  
  modalContent.appendChild(closeBtn);
  modalContent.appendChild(projectContent);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}

// ç”Ÿæˆé¡¹ç›®å¡ç‰‡
function generateProjectCards() {
  const projectsGrid = document.querySelector('.projects-grid');
  if (!projectsGrid) return;
  
  // æ¨¡æ‹Ÿæ•°æ®
  const projectsData = [
    { id: 1, title: 'ç‰›ä»”å¤–å¥—æ”¹é€ ', material: 'ç‰›ä»”', difficulty: 4, imageUrl: 'assets/project-1.jpg' },
    { id: 2, title: 'ä¸è´¨å›´å·¾å˜è£™', material: 'ä¸ç»¸', difficulty: 3, imageUrl: 'assets/project-2.jpg' },
    { id: 3, title: 'äºšéº»è¡¬è¡«ç¿»æ–°', material: 'æ£‰éº»', difficulty: 2, imageUrl: 'assets/project-3.jpg' },
    { id: 4, title: 'çš®å¤¹å…‹æ”¹é€ ', material: 'çš®é©', difficulty: 5, imageUrl: 'assets/project-4.jpg' },
    { id: 5, title: 'é’ˆç»‡è¡«é‡æ„', material: 'é’ˆç»‡', difficulty: 3, imageUrl: 'assets/project-5.jpg' },
    { id: 6, title: 'ç‰›ä»”è£¤å˜åŒ…', material: 'ç‰›ä»”', difficulty: 4, imageUrl: 'assets/project-6.jpg' },
    { id: 7, title: 'ä¸å·¾å†é€ ', material: 'ä¸ç»¸', difficulty: 2, imageUrl: 'assets/project-7.jpg' },
    { id: 8, title: 'æ£‰å¸ƒæ‹¼æ¥', material: 'æ£‰éº»', difficulty: 3, imageUrl: 'assets/project-8.jpg' }
  ];
  
  projectsData.forEach(project => {
    const card = document.createElement('div');
    card.classList.add('project-card', 'card-3d');
    card.dataset.material = project.material;
    
    const cardInner = document.createElement('div');
    cardInner.classList.add('card-inner');
    
    // å¡ç‰‡æ­£é¢
    const cardFront = document.createElement('div');
    cardFront.classList.add('card-front');
    
    const image = document.createElement('img');
    image.src = project.imageUrl;
    image.alt = project.title;
    
    const title = document.createElement('h4');
    title.textContent = project.title;
    
    const difficultyContainer = document.createElement('div');
    difficultyContainer.classList.add('difficulty-stars');
    
    // æ·»åŠ éš¾åº¦æ˜Ÿçº§
    for (let i = 0; i < 5; i++) {
      const star = document.createElement('span');
      star.classList.add('star');
      if (i < project.difficulty) {
        star.classList.add('filled');
      }
      difficultyContainer.appendChild(star);
    }
    
    cardFront.appendChild(image);
    cardFront.appendChild(title);
    cardFront.appendChild(difficultyContainer);
    
    // å¡ç‰‡èƒŒé¢
    const cardBack = document.createElement('div');
    cardBack.classList.add('card-back');
    
    const materialChart = document.createElement('div');
    materialChart.classList.add('material-chart');
    materialChart.innerHTML = `<h5>ææ–™æˆåˆ†</h5>
      <div class="chart-container">
        <canvas class="radar-chart" width="150" height="150"></canvas>
      </div>
      <p>ä¸»è¦æè´¨: ${project.material}</p>`;
    
    const storyPreview = document.createElement('div');
    storyPreview.classList.add('story-preview');
    storyPreview.innerHTML = `<p>è¿™æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•ç»™æ—§è¡£ç‰©èµ‹äºˆæ–°ç”Ÿå‘½çš„æ•…äº‹ï¼Œç‚¹å‡»æŸ¥çœ‹å®Œæ•´æ”¹é€ è¿‡ç¨‹...</p>`;
    
    const viewButton = document.createElement('button');
    viewButton.classList.add('view-button');
    viewButton.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
    viewButton.addEventListener('click', function() {
      showProjectDetail(project.id);
    });
    
    cardBack.appendChild(materialChart);
    cardBack.appendChild(storyPreview);
    cardBack.appendChild(viewButton);
    
    cardInner.appendChild(cardFront);
    cardInner.appendChild(cardBack);
    card.appendChild(cardInner);
    
    projectsGrid.appendChild(card);
  });
}

// èŠå¤©ç•Œé¢äº¤äº’
function initChatInterface() {
  console.log("Initializing chat interface...");
  
  const chatInterface = document.querySelector('.chat-interface');
  if (!chatInterface) {
    console.error("Chat interface not found");
    return;
  }
  
  const chatMessages = document.querySelector('#chat-messages');
  const chatInput = document.querySelector('.chat-input input');
  const sendButton = document.querySelector('.send-button');
  const chatSidebar = document.querySelector('.chat-sidebar');
  
  if (!chatMessages || !chatInput || !sendButton) {
    console.error("Chat components missing:", {
      messages: !!chatMessages,
      input: !!chatInput,
      button: !!sendButton
    });
    return;
  }
  
  console.log("Chat components found, continuing initialization");
  
  // å˜é‡ç”¨äºå­˜å‚¨å½“å‰ä¼šè¯çŠ¶æ€
  let currentSessionId = localStorage.getItem('currentSessionId');
  let currentSessionTitle = "æ–°å¯¹è¯";
  let previousTopics = {
    fabric: false,
    clothing: false,
    price: false,
    contact: false,
    seller: false,
    buyer: false
  };
  
  // åˆå§‹åŒ–èŠå¤©ç•Œé¢
  if (chatSidebar) {
    initChatHistory(chatSidebar);
  }
  
  // å¦‚æœæœ‰å½“å‰ä¼šè¯IDï¼ŒåŠ è½½è¯¥ä¼šè¯
  if (currentSessionId) {
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    if (chatHistory[currentSessionId]) {
      loadSession(currentSessionId);
    } else {
      // å¦‚æœä¿å­˜çš„ä¼šè¯IDä¸å­˜åœ¨å†å²è®°å½•ä¸­ï¼Œåˆ›å»ºæ–°ä¼šè¯
      startNewSession();
    }
  } else {
    // æ— ä¼šè¯IDï¼Œåˆ›å»ºæ–°ä¼šè¯
    startNewSession();
  }
  
  // æ£€æŸ¥èŠå¤©ç•Œé¢æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯åˆ™é‡æ–°åˆå§‹åŒ–
  checkChatInterfaceEmpty();
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  if (sendButton) {
    sendButton.addEventListener('click', sendMessage);
  }
  
  if (chatInput) {
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // æ·»åŠ è¾“å…¥æ—¶çš„åŠ¨æ€æ•ˆæœ
    chatInput.addEventListener('focus', function() {
      if (this.parentElement) {
        this.parentElement.classList.add('input-active');
      }
    });
    
    chatInput.addEventListener('blur', function() {
      if (this.parentElement) {
        this.parentElement.classList.remove('input-active');
      }
    });
  }
  
  // åˆå§‹è°ƒæ•´é«˜åº¦
  adjustChatHeight();
  
  // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´é«˜åº¦
  window.addEventListener('resize', adjustChatHeight);
  
  // å¦‚æœèŠå¤©æ¡†ä¸ºç©ºï¼Œæ·»åŠ ä¸€ä¸ªæ–°ä¼šè¯
  function checkChatInterfaceEmpty() {
    if (!chatMessages || chatMessages.children.length === 0) {
      console.log("Chat interface is empty, reinitializing...");
      startNewSession();
    }
  }

  // å‘é€æ¶ˆæ¯
  function sendMessage() {
    if (!chatInput || !chatMessages) {
      console.error("Cannot send message: UI elements not found");
      return;
    }
    
    const message = chatInput.value.trim();
    if (message === '') return;
    
    console.log("Sending message:", message);
    
    // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
    const userMessage = document.createElement('div');
    userMessage.classList.add('message', 'user-message');
    userMessage.textContent = message;
    
    chatMessages.appendChild(userMessage);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    chatInput.value = '';
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // ç¡®ä¿èŠå¤©ç•Œé¢é«˜åº¦é€‚åº”å†…å®¹
    adjustChatHeight();
    
    // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°å½“å‰ä¼šè¯
    saveMessageToHistory(currentSessionId, 'user', message);
    
    // å¦‚æœè¿™æ˜¯æ–°ä¼šè¯çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ ¹æ®å†…å®¹ç”Ÿæˆæ ‡é¢˜
    if (currentSessionTitle === "æ–°å¯¹è¯") {
      currentSessionTitle = generateSessionTitle(message);
      updateSessionList();
    }
    
    // æ¨¡æ‹Ÿç³»ç»Ÿå›å¤
    setTimeout(function() {
      // è·å–è‡ªåŠ¨å›å¤
      const autoReply = getAutoReply(message);
      
      // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯
      const systemMessage = document.createElement('div');
      systemMessage.classList.add('message', 'system-message');
      
      const needleIcon = document.createElement('span');
      needleIcon.classList.add('needle-icon');
      needleIcon.innerHTML = 'ğŸ§µ';
      
      const messageText = document.createElement('span');
      systemMessage.appendChild(needleIcon);
      systemMessage.appendChild(messageText);
      
      chatMessages.appendChild(systemMessage);
      
      // æ·»åŠ å†…å®¹
      messageText.innerHTML = autoReply;
      
      // ä¿å­˜ç³»ç»Ÿå›å¤åˆ°å½“å‰ä¼šè¯
      saveMessageToHistory(currentSessionId, 'system', autoReply);
      
      // æ·»åŠ æ‰“å­—åŠ¨ç”»æ•ˆæœ
      addTypingAnimation(messageText);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // å†æ¬¡è°ƒæ•´èŠå¤©ç•Œé¢é«˜åº¦
      adjustChatHeight();
      
      // åŸºäºç³»ç»Ÿå›å¤å†æ¬¡æ›´æ–°å¯¹æ¥è¿›åº¦
      updateTrackingFromChat(autoReply);
    }, 1000);
  }

  // ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ID
  function generateSessionId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
  
  // æ ¹æ®ç”¨æˆ·é¦–æ¡æ¶ˆæ¯å†…å®¹ç”Ÿæˆä¼šè¯æ ‡é¢˜
  function generateSessionTitle(message) {
    // æå–æ¶ˆæ¯çš„å‰10ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜ï¼Œå¦‚æœæ¶ˆæ¯å¤ªçŸ­åˆ™å…¨éƒ¨ä½¿ç”¨
    const titleText = message.length > 10 ? message.substring(0, 10) + '...' : message;
    return titleText;
  }
  
  // ä¿å­˜æ¶ˆæ¯åˆ°æœ¬åœ°å­˜å‚¨
  function saveMessageToHistory(sessionId, sender, content) {
    // ä»æœ¬åœ°å­˜å‚¨è·å–å·²æœ‰å†å²è®°å½•
    let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    
    // å¦‚æœä¼šè¯ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°ä¼šè¯
    if (!chatHistory[sessionId]) {
      chatHistory[sessionId] = {
        id: sessionId,
        title: currentSessionTitle,
        date: new Date().toISOString(),
        messages: []
      };
    }
    
    // æ·»åŠ æ–°æ¶ˆæ¯
    chatHistory[sessionId].messages.push({
      sender: sender,
      content: content,
      timestamp: new Date().toISOString()
    });
    
    // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
    chatHistory[sessionId].lastActive = new Date().toISOString();
    
    // æ›´æ–°ä¼šè¯æ ‡é¢˜ï¼ˆå¦‚æœå·²ç”Ÿæˆï¼‰
    if (currentSessionTitle !== "æ–°å¯¹è¯") {
      chatHistory[sessionId].title = currentSessionTitle;
    }
    
    // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    
    // æ›´æ–°å½“å‰ä¼šè¯IDåˆ°localStorage
    localStorage.setItem('currentSessionId', sessionId);
    
    // æ›´æ–°ä¼šè¯åˆ—è¡¨
    updateSessionList();
  }
  
  // æ·»åŠ æ‰“å­—åŠ¨ç”»æ•ˆæœ
  function addTypingAnimation(element) {
    const text = element.innerHTML;
    element.innerHTML = '';
    let i = 0;
    
    function typeWriter() {
      if (i < text.length) {
        element.innerHTML += text.charAt(i);
        i++;
        // éšæœºæ‰“å­—é€Ÿåº¦ï¼Œè®©æ•ˆæœæ›´è‡ªç„¶
        setTimeout(typeWriter, Math.random() * 10 + 20);
      }
    }
    
    // è€ƒè™‘åˆ°æ–‡æœ¬è¾ƒé•¿ä¸”æœ‰HTMLæ ‡ç­¾ï¼Œè¿™é‡Œç®€åŒ–ä¸ä½¿ç”¨çœŸå®çš„æ‰“å­—æ•ˆæœ
    element.innerHTML = text;
    element.style.opacity = '0';
    setTimeout(() => {
      element.style.transition = 'opacity 0.5s';
      element.style.opacity = '1';
    }, 100);
  }
  
  // åˆå§‹åŒ–èŠå¤©å†å²
  function initChatHistory(sidebar) {
    // ç¡®ä¿å†å²ä¼šè¯æ ‡é¢˜å·²æ·»åŠ 
    if (!sidebar.querySelector('.sidebar-header')) {
      const header = document.createElement('div');
      header.classList.add('sidebar-header');
      header.innerHTML = 'å†å²ä¼šè¯<span class="current-time"></span>';
      sidebar.appendChild(header);
    }
    
    // æ›´æ–°å½“å‰åŒ—äº¬æ—¶é—´æ˜¾ç¤º
    updateCurrentTime();
    
    // æ›´æ–°ä¼šè¯åˆ—è¡¨
    updateSessionList();
    
    // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
    setInterval(updateCurrentTime, 1000);
  }
  
  // æ›´æ–°å½“å‰åŒ—äº¬æ—¶é—´æ˜¾ç¤º
  function updateCurrentTime() {
    const now = new Date();
    now.setTime(now.getTime() + (8 * 60 * 60 * 1000)); // è°ƒæ•´ä¸ºUTC+8
    const hours = String(now.getUTCHours()).padStart(2, '0');
    const minutes = String(now.getUTCMinutes()).padStart(2, '0');
    const seconds = String(now.getUTCSeconds()).padStart(2, '0');
    const currentTime = `${hours}:${minutes}:${seconds}`;
    
    const timeElement = chatSidebar.querySelector('.sidebar-header .current-time');
    if (timeElement) {
      timeElement.textContent = `åŒ—äº¬æ—¶é—´ ${currentTime}`;
    }
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸä¸ºæ›´å‹å¥½çš„æ ¼å¼
  function formatDate(dateString) {
    const date = new Date(dateString);
    // è°ƒæ•´ä¸ºåŒ—äº¬æ—¶é—´
    date.setTime(date.getTime() + (8 * 60 * 60 * 1000));
    
    const now = new Date();
    now.setTime(now.getTime() + (8 * 60 * 60 * 1000));
    
    const today = new Date(now);
    today.setUTCHours(0, 0, 0, 0);
    
    const yesterday = new Date(today);
    yesterday.setUTCDate(yesterday.getUTCDate() - 1);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
    if (date >= today) {
      const hours = String(date.getUTCHours()).padStart(2, '0');
      const minutes = String(date.getUTCMinutes()).padStart(2, '0');
      return `ä»Šå¤© ${hours}:${minutes}`;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜¨å¤©
    if (date >= yesterday && date < today) {
      return "æ˜¨å¤©";
    }
    
    // ä¸€å‘¨å†…æ˜¾ç¤ºæ˜ŸæœŸ
    const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const diffDays = Math.floor((today - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays < 7) {
      return weekDays[date.getUTCDay()];
    }
    
    // æ›´æ—©çš„æ—¥æœŸæ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const day = String(date.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  
  // æ›´æ–°ä¼šè¯åˆ—è¡¨
  function updateSessionList() {
    // ä»æœ¬åœ°å­˜å‚¨è·å–å†å²è®°å½•
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    
    // è·å–æ‰€æœ‰ä¼šè¯å¹¶æŒ‰æœ€åæ´»åŠ¨æ—¶é—´æ’åº
    const sessions = Object.values(chatHistory).sort((a, b) => 
      new Date(b.lastActive || b.date) - new Date(a.lastActive || a.date)
    );
    
    // æ¸…ç©ºå·²æœ‰çš„å†å²ä¼šè¯é¡¹ç›®
    chatSidebar.querySelectorAll('.session-item').forEach(item => item.remove());
    
    // å¦‚æœæ²¡æœ‰å†å²ä¼šè¯è®°å½•ï¼Œæ·»åŠ æ–°ä¼šè¯æŒ‰é’®
    if (sessions.length === 0) {
      const newChatButton = document.createElement('div');
      newChatButton.classList.add('session-item', 'new-chat');
      newChatButton.innerHTML = '<div class="session-title">å¼€å§‹æ–°å¯¹è¯</div>';
      
      newChatButton.addEventListener('click', () => {
        startNewSession();
      });
      
      chatSidebar.appendChild(newChatButton);
      return;
    }
    
    // æ·»åŠ æ–°ä¼šè¯æŒ‰é’®
    const newChatButton = document.createElement('div');
    newChatButton.classList.add('session-item', 'new-chat');
    newChatButton.innerHTML = '<div class="session-title">å¼€å§‹æ–°å¯¹è¯</div>';
    
    newChatButton.addEventListener('click', () => {
      startNewSession();
    });
    
    chatSidebar.appendChild(newChatButton);
    
    // æ·»åŠ å†å²ä¼šè¯
    sessions.forEach(session => {
      const sessionItem = document.createElement('div');
      sessionItem.classList.add('session-item');
      sessionItem.dataset.sessionId = session.id;
      
      if (session.id === currentSessionId) {
        sessionItem.classList.add('active');
      }
      
      const sessionTitle = document.createElement('div');
      sessionTitle.classList.add('session-title');
      sessionTitle.textContent = session.title || "æ— æ ‡é¢˜å¯¹è¯";
      
      const sessionDate = document.createElement('div');
      sessionDate.classList.add('session-date');
      
      const formattedDate = formatDate(session.lastActive || session.date);
      sessionDate.innerHTML = `<span class="date-icon">ğŸ•’</span> ${formattedDate}`;
      
      // å®Œæ•´æ—¥æœŸä½œä¸ºæ‚¬åœæç¤º
      const fullDate = new Date(session.lastActive || session.date);
      fullDate.setTime(fullDate.getTime() + (8 * 60 * 60 * 1000)); // è°ƒæ•´ä¸ºåŒ—äº¬æ—¶é—´
      
      const fullDateStr = `${fullDate.getUTCFullYear()}-${String(fullDate.getUTCMonth() + 1).padStart(2, '0')}-${String(fullDate.getUTCDate()).padStart(2, '0')} ${String(fullDate.getUTCHours()).padStart(2, '0')}:${String(fullDate.getUTCMinutes()).padStart(2, '0')}`;
      sessionDate.title = fullDateStr;
      
      // æ·»åŠ åˆ é™¤æŒ‰é’®
      const deleteButton = document.createElement('span');
      deleteButton.classList.add('delete-session');
      deleteButton.innerHTML = 'âœ•';
      deleteButton.title = 'åˆ é™¤å¯¹è¯';
      deleteButton.onclick = (e) => {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘ä¼šè¯ç‚¹å‡»äº‹ä»¶
        deleteSession(session.id);
      };
      
      sessionItem.appendChild(sessionTitle);
      sessionItem.appendChild(sessionDate);
      sessionItem.appendChild(deleteButton);
      
      // ç‚¹å‡»åˆ‡æ¢ä¼šè¯
      sessionItem.addEventListener('click', () => {
        loadSession(session.id);
      });
      
      chatSidebar.appendChild(sessionItem);
    });
  }
  
  // åˆ é™¤ä¼šè¯
  function deleteSession(sessionId) {
    if (confirm('ç¡®è®¤åˆ é™¤è¿™ä¸ªå¯¹è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
      // ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–ä¼šè¯æ•°æ®
      const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
      
      // åˆ é™¤æŒ‡å®šä¼šè¯
      if (chatHistory[sessionId]) {
        delete chatHistory[sessionId];
        
        // ä¿å­˜æ›´æ–°åçš„ä¼šè¯æ•°æ®
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ™å¼€å§‹æ–°ä¼šè¯
        if (sessionId === currentSessionId) {
          startNewSession();
        } else {
          // ä»…æ›´æ–°ä¼šè¯åˆ—è¡¨
          updateSessionList();
        }
      }
    }
  }
  
  // åŠ è½½æŒ‡å®šä¼šè¯
  function loadSession(sessionId) {
    console.log("Loading session:", sessionId);
    
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    
    if (!chatHistory[sessionId]) {
      console.error("Session not found:", sessionId);
      startNewSession();
      return;
    }
    
    // æ›´æ–°å½“å‰ä¼šè¯
    currentSessionId = sessionId;
    localStorage.setItem('currentSessionId', currentSessionId);
    
    // æ›´æ–°ä¼šè¯æ ‡é¢˜
    currentSessionTitle = chatHistory[sessionId].title || "æœªå‘½åå¯¹è¯";
    
    // æ¸…ç©ºå½“å‰æ¶ˆæ¯åŒºåŸŸ
    if (chatMessages) {
      chatMessages.innerHTML = '';
      
      // æ¢å¤å†å²æ¶ˆæ¯
      if (chatHistory[sessionId].messages && chatHistory[sessionId].messages.length > 0) {
        chatHistory[sessionId].messages.forEach(msgObj => {
          const messageElement = document.createElement('div');
          
          if (msgObj.sender === 'user') {
            messageElement.classList.add('message', 'user-message');
            messageElement.textContent = msgObj.content;
          } else {
            messageElement.classList.add('message', 'system-message');
            
            const needleIcon = document.createElement('span');
            needleIcon.classList.add('needle-icon');
            needleIcon.innerHTML = 'ğŸ§µ';
            
            const messageText = document.createElement('span');
            messageText.innerHTML = msgObj.content;
            
            messageElement.appendChild(needleIcon);
            messageElement.appendChild(messageText);
          }
          
          chatMessages.appendChild(messageElement);
        });
      } else {
        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ·»åŠ é»˜è®¤æ¬¢è¿æ¶ˆæ¯
        const systemMessage = document.createElement('div');
        systemMessage.classList.add('message', 'system-message');
        
        const needleIcon = document.createElement('span');
        needleIcon.classList.add('needle-icon');
        needleIcon.innerHTML = 'ğŸ§µ';
        
        const messageText = document.createElement('span');
        messageText.innerHTML = 'æ¬¢è¿å›æ¥ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ';
        
        systemMessage.appendChild(needleIcon);
        systemMessage.appendChild(messageText);
        
        chatMessages.appendChild(systemMessage);
        
        // ä¿å­˜æ¬¢è¿æ¶ˆæ¯
        saveMessageToHistory(currentSessionId, 'system', messageText.innerHTML);
      }
      
      // æ›´æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„æ´»åŠ¨çŠ¶æ€
      updateSessionList();
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // è°ƒæ•´èŠå¤©ç•Œé¢é«˜åº¦
      adjustChatHeight();
    } else {
      console.error("Chat messages container not found when loading session");
    }
  }
  
  // å¼€å§‹æ–°ä¼šè¯
  function startNewSession() {
    console.log("Starting new session");
    
    // ç”Ÿæˆæ–°çš„ä¼šè¯ID
    currentSessionId = generateSessionId();
    localStorage.setItem('currentSessionId', currentSessionId);
    
    currentSessionTitle = "æ–°å¯¹è¯";
    
    // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
    if (chatMessages) {
      chatMessages.innerHTML = '';
      
      // æ·»åŠ é»˜è®¤æ¬¢è¿æ¶ˆæ¯
      const systemMessage = document.createElement('div');
      systemMessage.classList.add('message', 'system-message');
      
      const needleIcon = document.createElement('span');
      needleIcon.classList.add('needle-icon');
      needleIcon.innerHTML = 'ğŸ§µ';
      
      const messageText = document.createElement('span');
      messageText.innerHTML = 'æ¬¢è¿æ¥åˆ°Fashion Rebornæœè£…æ”¹é€ è‰ºæœ¯ç©ºé—´ï¼æˆ‘æ˜¯æ‚¨çš„é¡¾é—®ï¼Œæœ‰ä»»ä½•å…³äºæ¸…ç†åº“å­˜ã€æ”¶è´­åº“å­˜ï¼Œæ”¹é€ æˆè¡£æˆ–é¢æ–™çš„é—®é¢˜éƒ½å¯ä»¥å’¨è¯¢æˆ‘ã€‚å¦‚éœ€ç›´æ¥è”ç³»ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š<strong>JJ1598929032</strong>';
      
      systemMessage.appendChild(needleIcon);
      systemMessage.appendChild(messageText);
      
      chatMessages.appendChild(systemMessage);
      
      // ä¿å­˜æ¬¢è¿æ¶ˆæ¯åˆ°å†å²è®°å½•
      saveMessageToHistory(currentSessionId, 'system', messageText.innerHTML);
      
      // æ›´æ–°ä¼šè¯åˆ—è¡¨
      updateSessionList();
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // è°ƒæ•´é«˜åº¦
      adjustChatHeight();
    } else {
      console.error("Chat messages container not found");
    }
  }
  
  // è°ƒæ•´èŠå¤©ç•Œé¢é«˜åº¦ä»¥é€‚åº”å†…å®¹
  function adjustChatHeight() {
    // ç¡®ä¿æˆ‘ä»¬æœ‰å¿…è¦çš„DOMå…ƒç´ 
    if (!chatInterface || !chatMessages) {
      console.error("Cannot adjust chat height: Required elements not found");
      return;
    }
    
    // ç¡®ä¿å¯¹è¯æ¡†å†…å®¹å®Œå…¨æ˜¾ç¤º
    chatMessages.style.maxHeight = '520px'; // ä¿æŒæœ€å¤§é«˜åº¦é™åˆ¶
    
    // ç¡®ä¿æ•´ä¸ªèŠå¤©ç•Œé¢ä¸é®æŒ¡å¯¹æ¥è¿›åº¦é¢æ¿
    const trackingPanel = document.querySelector('.tracking-panel');
    if (trackingPanel) {
      const chatBottom = chatInterface.getBoundingClientRect().bottom;
      const trackingTop = trackingPanel.getBoundingClientRect().top;
      
      // å¦‚æœèŠå¤©ç•Œé¢åº•éƒ¨è¶…å‡ºè·Ÿè¸ªé¢æ¿é¡¶éƒ¨ï¼Œå¢åŠ ä¸Šè¾¹è·
      if (chatBottom > trackingTop) {
        const currentMargin = parseInt(getComputedStyle(trackingPanel).marginTop) || 0;
        trackingPanel.style.marginTop = (currentMargin + (chatBottom - trackingTop) + 20) + 'px';
      }
    }
    
    // ä¸ºæ¶ˆæ¯æ·»åŠ åŠ¨ç”»æ•ˆæœ
    const messages = document.querySelectorAll('.message');
    messages.forEach((message, index) => {
      if (!message.style.animationDelay) {
        message.style.animationDelay = `${index * 0.1}s`;
      }
    });
  }
}

// è§†å·®æ»šåŠ¨æ•ˆæœ
function initParallaxEffect() {
  const sections = document.querySelectorAll('section');
  
  window.addEventListener('scroll', function() {
    const scrollPosition = window.scrollY;
    
    sections.forEach(section => {
      // æ’é™¤æ ‡é¢˜å…ƒç´ ï¼Œåªå¯¹å†…å®¹åŒºåŸŸåº”ç”¨è§†å·®æ•ˆæœ
      const contentElements = section.querySelectorAll('.showcase-container, .projects-grid, .community-market, .challenge-entries, .resources-grid');
      
      contentElements.forEach(element => {
        const distance = element.getBoundingClientRect().top;
        const speed = 0.1;
        
        if (Math.abs(distance) < window.innerHeight) {
          // åªåœ¨å…ƒç´ è¿›å…¥è§†å£æ—¶åº”ç”¨å¾®å°çš„è§†å·®æ•ˆæœï¼Œé¿å…å½±å“å¸ƒå±€
          const translate = distance * speed;
          element.style.transform = `translateY(${translate}px)`;
        }
      });
      
      // ç¡®ä¿æ ‡é¢˜å…ƒç´ ä¿æŒç¨³å®š
      const sectionHeader = section.querySelector('.section-header');
      if (sectionHeader) {
        sectionHeader.style.transform = 'none';
      }
    });
  });
}

// å¯¹æ¥è¿›åº¦é¢æ¿åŠŸèƒ½
function initTrackingPanel() {
  const trackingPanel = document.querySelector('.process-flow');
  if (!trackingPanel) return;

  // åˆå§‹åŒ–è¿›åº¦æµç¨‹å›¾ - ä»localStorageè·å–å½“å‰çŠ¶æ€
  let currentTrackingData = JSON.parse(localStorage.getItem('trackingData'));
  
  // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è·Ÿè¸ªæ•°æ®æˆ–è€…æ˜¯æ–°ä¼šè¯ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
  if (!currentTrackingData) {
    currentTrackingData = {
      currentStage: 1,
      stages: [
        { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
        { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
        { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
      ],
      lastUpdated: new Date().toISOString(),
      isSeller: false,
      isBuyer: false,
      needType: '',
      productType: '',
      quantity: '',
      budgetRange: ''
    };
    
    // ä¿å­˜åˆå§‹æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(currentTrackingData));
  }
  
  // æ¸…ç©ºé»˜è®¤å†…å®¹
  trackingPanel.innerHTML = '';
  
  // åˆ›å»ºè¿›åº¦æ¡
  const progressBar = document.createElement('div');
  progressBar.classList.add('progress-bar');
  
  // æ·»åŠ å„ä¸ªé˜¶æ®µ
  currentTrackingData.stages.forEach(stage => {
    const stageElement = document.createElement('div');
    stageElement.classList.add('progress-stage', `status-${stage.status}`);
    stageElement.dataset.stageId = stage.id;
    
    const stageNumber = document.createElement('div');
    stageNumber.classList.add('stage-number');
    stageNumber.textContent = stage.id;
    
    const stageName = document.createElement('div');
    stageName.classList.add('stage-name');
    stageName.textContent = stage.name;
    
    stageElement.appendChild(stageNumber);
    stageElement.appendChild(stageName);
    
    // ç‚¹å‡»é˜¶æ®µæ˜¾ç¤ºè¯¦æƒ…
    stageElement.addEventListener('click', () => showStageDetail(stage, currentTrackingData));
    
    progressBar.appendChild(stageElement);
    
    // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€ä¸ªé˜¶æ®µï¼‰
    if (stage.id < currentTrackingData.stages.length) {
      const connector = document.createElement('div');
      connector.classList.add('stage-connector', `status-${stage.status}`);
      progressBar.appendChild(connector);
    }
  });
  
  trackingPanel.appendChild(progressBar);
  
  // æ·»åŠ è¯´æ˜æ–‡å­—
  const statusInfo = document.createElement('div');
  statusInfo.classList.add('status-info');
  
  // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„é˜¶æ®µ
  const activeStage = currentTrackingData.stages.find(stage => stage.status === 'active');
  const stageName = activeStage ? activeStage.name : 'å‡†å¤‡ä¸­';
  
  // è®¡ç®—æœ€åæ›´æ–°æ—¶é—´
  const lastUpdateTime = getTimeDifference(new Date(currentTrackingData.lastUpdated), new Date());
  
  statusInfo.innerHTML = `å½“å‰çŠ¶æ€ï¼š<span class="status-active">${stageName}</span> Â· æ›´æ–°äº ${lastUpdateTime}`;
  trackingPanel.appendChild(statusInfo);
  
  // æ·»åŠ è¿›åº¦æ¦‚è¦
  const progressSummary = document.createElement('div');
  progressSummary.classList.add('progress-summary');
  
  // æ ¹æ®ç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒçš„è¿›åº¦æ¦‚è¦
  const isSeller = currentTrackingData.isSeller;
  const isBuyer = currentTrackingData.isBuyer;
  
  // è·å–ä¹°å–éœ€æ±‚ç±»å‹
  const needTypeDisplay = currentTrackingData.needType ? currentTrackingData.needType : 'ç­‰å¾…ç¡®è®¤';
  const productTypeDisplay = currentTrackingData.productType ? currentTrackingData.productType : 'ç­‰å¾…ç¡®è®¤';
  
  let summaryHTML = '';
  if (isSeller) {
    summaryHTML = `
      <h4>å‡ºå”®ä¿¡æ¯æ‘˜è¦</h4>
      <ul>
        <li>å•†å“ç±»å‹: ${productTypeDisplay}</li>
        <li>åº“å­˜æ•°é‡: ${currentTrackingData.quantity || 'ç­‰å¾…ç¡®è®¤'}</li>
        <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
      </ul>
    `;
  } else if (isBuyer) {
    summaryHTML = `
      <h4>é‡‡è´­ä¿¡æ¯æ‘˜è¦</h4>
      <ul>
        <li>éœ€æ±‚ç±»å‹: ${needTypeDisplay}</li>
        <li>äº§å“ç±»å‹: ${productTypeDisplay}</li>
        <li>é¢„ç®—èŒƒå›´: ${currentTrackingData.budgetRange || 'ç­‰å¾…ç¡®è®¤'}</li>
        <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
      </ul>
    `;
  } else {
    summaryHTML = `
      <h4>å¯¹æ¥ä¿¡æ¯æ‘˜è¦</h4>
      <ul>
        <li>è¯·åœ¨èŠå¤©ä¸­è¯´æ˜æ‚¨æ˜¯éœ€è¦å‡ºå”®è¿˜æ˜¯é‡‡è´­</li>
        <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
      </ul>
    `;
  }
  
  progressSummary.innerHTML = summaryHTML;
  trackingPanel.appendChild(progressSummary);
  
  // æ·»åŠ åˆ·æ–°æŒ‰é’®
  const refreshButton = document.createElement('button');
  refreshButton.classList.add('refresh-tracking');
  refreshButton.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
  refreshButton.addEventListener('click', function() {
    // è¯·æ±‚å¹³å°æ›´æ–°è¿›åº¦
    updateTrackingProgress();
    
    // æ·»åŠ åˆ·æ–°åŠ¨ç”»
    this.classList.add('refreshing');
    // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
    this.textContent = 'æ­£åœ¨è¯·æ±‚å¹³å°ç¡®è®¤...';
    setTimeout(() => {
      this.classList.remove('refreshing');
      this.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
    }, 2000);
  });
  
  // æ·»åŠ å¹³å°ç¡®è®¤è¯´æ˜
  const confirmNote = document.createElement('div');
  confirmNote.classList.add('platform-note');
  confirmNote.innerHTML = 'æç¤ºï¼šæ‰€æœ‰è¿›åº¦æ›´æ–°éœ€è¦å¹³å°ç¡®è®¤åæ‰èƒ½ç”Ÿæ•ˆ';
  
  trackingPanel.appendChild(refreshButton);
  trackingPanel.appendChild(confirmNote);
}

// æ ¹æ®èŠå¤©å†…å®¹æ›´æ–°å¯¹æ¥è¿›åº¦
function updateTrackingFromChat(message, isSeller, isBuyer) {
  // è·å–å½“å‰è¿›åº¦æ•°æ®
  let trackingData = JSON.parse(localStorage.getItem('trackingData'));
  
  if (!trackingData) {
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
    trackingData = {
      currentStage: 1,
      stages: [
        { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
        { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
        { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
      ],
      lastUpdated: new Date().toISOString(),
      isSeller: false,
      isBuyer: false,
      needType: '',
      productType: '',
      quantity: '',
      budgetRange: ''
    };
  }
  
  // æ›´æ–°ä¹°å–èº«ä»½
  if (isSeller !== undefined) {
    trackingData.isSeller = isSeller;
  }
  
  if (isBuyer !== undefined) {
    trackingData.isBuyer = isBuyer;
  }
  
  // å¤„ç†é˜¶æ®µ1ï¼šéœ€æ±‚æäº¤
  if (trackingData.stages[0].status !== 'completed') {
    // åªè¦æœ‰æ¶ˆæ¯ï¼Œå°±è®¤ä¸ºéœ€æ±‚å·²æäº¤
    trackingData.stages[0].status = 'completed';
    trackingData.stages[0].timestamp = new Date().toISOString();
    
    // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
    trackingData.stages[1].status = 'active';
    trackingData.currentStage = 2;
  }
  
  // æå–äº§å“ç±»å‹ä¿¡æ¯
  const productTypes = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›', 'å°¼é¾™', 'æ¶¤çº¶'];
  for (const type of productTypes) {
    if (message.includes(type)) {
      trackingData.productType = type;
      break;
    }
  }
  
  // æå–éœ€æ±‚ç±»å‹
  if (message.includes('é¢æ–™') || message.includes('å¸ƒæ–™') || message.includes('å¸ƒ')) {
    trackingData.needType = 'é¢æ–™';
  } else if (message.includes('æœè£…') || message.includes('è¡£æœ') || message.includes('æˆè¡£')) {
    trackingData.needType = 'æœè£…';
  }
  
  // æå–æ•°é‡ä¿¡æ¯
  const quantityMatch = message.match(/(\d+)([ä»¶æ¡ç±³å¨ä¸ª])/);
  if (quantityMatch) {
    trackingData.quantity = quantityMatch[0];
  }
  
  // æå–ä»·æ ¼/é¢„ç®—ä¿¡æ¯
  if (message.includes('ä»·æ ¼') || message.includes('å¤šå°‘é’±') || message.includes('é¢„ç®—')) {
    const priceMatch = message.match(/(\d+)[-~åˆ°è‡³](\d+)[å…ƒå—]/);
    if (priceMatch) {
      trackingData.budgetRange = priceMatch[0];
    }
  }
  
  // é˜¶æ®µ2ï¼šåŒ¹é…åº“å­˜ - æ ¹æ®å…³é”®è¯åˆ¤æ–­
  if (trackingData.currentStage === 2 && trackingData.stages[1].status === 'active') {
    // å½“ç”¨æˆ·æä¾›äº†å…·ä½“çš„äº§å“å’Œéœ€æ±‚ç±»å‹æ—¶ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€é˜¶æ®µ
    if (trackingData.productType && trackingData.needType) {
      if (message.includes('åŒ¹é…') || message.includes('åº“å­˜') || message.includes('èµ„æº') || 
          message.includes('æ‰¾åˆ°') || message.includes('æœ‰è´§') || containsSpecificProductInfo(message)) {
        trackingData.stages[1].status = 'completed';
        trackingData.stages[1].timestamp = new Date().toISOString();
        
        // æ ¹æ®ç”¨æˆ·èº«ä»½å†³å®šä¸‹ä¸€æ­¥
        if (trackingData.isSeller) {
          // å–å®¶å¯»æ‰¾ä¹°å®¶ï¼Œè¿›å…¥åˆ°ä¹°å®¶ç¡®è®¤é˜¶æ®µ
          trackingData.stages[3].status = 'active';
          trackingData.currentStage = 4;
        } else if (trackingData.isBuyer) {
          // ä¹°å®¶å¯»æ‰¾å–å®¶ï¼Œè¿›å…¥åˆ°å–å®¶ç¡®è®¤é˜¶æ®µ
          trackingData.stages[2].status = 'active';
          trackingData.currentStage = 3;
        }
      }
    }
  }
  
  // é˜¶æ®µ3ï¼šå–å®¶ç¡®è®¤
  if (trackingData.currentStage === 3 && trackingData.stages[2].status === 'active') {
    if (message.includes('å–å®¶ç¡®è®¤') || message.includes('ä¾›åº”å•†ç¡®è®¤') || message.includes('å·²ç¡®è®¤') || 
        message.includes('å¯ä»¥ä¾›åº”') || message.includes('æœ‰åº“å­˜')) {
      trackingData.stages[2].status = 'completed';
      trackingData.stages[2].timestamp = new Date().toISOString();
      
      // è¿›å…¥ä¹°å®¶ç¡®è®¤é˜¶æ®µ
      trackingData.stages[3].status = 'active';
      trackingData.currentStage = 4;
    }
  }
  
  // é˜¶æ®µ4ï¼šä¹°å®¶ç¡®è®¤
  if (trackingData.currentStage === 4 && trackingData.stages[3].status === 'active') {
    if (message.includes('ä¹°å®¶ç¡®è®¤') || message.includes('å®¢æˆ·ç¡®è®¤') || message.includes('ç¡®è®¤è´­ä¹°') || 
        message.includes('æ¥å—') || message.includes('æ»¡æ„')) {
      trackingData.stages[3].status = 'completed';
      trackingData.stages[3].timestamp = new Date().toISOString();
      
      // è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µ
      trackingData.stages[4].status = 'active';
      trackingData.currentStage = 5;
    }
  }
  
  // é˜¶æ®µ5ï¼šç¡®è®¤å¯¹æ¥
  if (trackingData.currentStage === 5 && trackingData.stages[4].status === 'active') {
    if (message.includes('äº¤æ˜“æˆåŠŸ') || message.includes('å·²å¯¹æ¥') || message.includes('æˆäº¤') || 
        message.includes('å·²å®Œæˆ') || message.includes('æ„Ÿè°¢åˆä½œ')) {
      trackingData.stages[4].status = 'completed';
      trackingData.stages[4].timestamp = new Date().toISOString();
    }
  }
  
  // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
  trackingData.lastUpdated = new Date().toISOString();
  
  // ä¿å­˜æ›´æ–°åçš„æ•°æ®
  localStorage.setItem('trackingData', JSON.stringify(trackingData));
  
  // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
  initTrackingPanel();
}

// æ˜¾ç¤ºé˜¶æ®µè¯¦ç»†ä¿¡æ¯
function showStageDetail(stage, trackingData) {
  const wechatContact = '<strong>JJ1598929032</strong>';
  const modal = document.createElement('div');
  modal.classList.add('progress-modal');
  
  const modalContent = document.createElement('div');
  modalContent.classList.add('modal-content');
  
  // æ·»åŠ å…³é—­æŒ‰é’®
  const closeBtn = document.createElement('button');
  closeBtn.classList.add('close-modal');
  closeBtn.innerHTML = '&times;';
  closeBtn.addEventListener('click', function() {
    document.body.removeChild(modal);
  });
  
  // é˜¶æ®µè¯¦æƒ…å†…å®¹
  const stageContent = document.createElement('div');
  stageContent.classList.add('stage-detail');
  
  const stageTitle = document.createElement('h3');
  stageTitle.innerHTML = `é˜¶æ®µ ${stage.id}: ${stage.name} <span class="stage-status status-${stage.status}">${getStatusText(stage.status)}</span>`;
  
  const stageTimestamp = document.createElement('div');
  stageTimestamp.classList.add('stage-timestamp');
  if (stage.timestamp) {
    const date = new Date(stage.timestamp);
    stageTimestamp.textContent = `æ›´æ–°æ—¶é—´: ${formatDateTime(date)}`;
  } else {
    stageTimestamp.textContent = 'å°šæœªå¼€å§‹';
  }
  
  const stageDescription = document.createElement('p');
  let descriptionText = '';
  
  // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒå†…å®¹
  const isSeller = trackingData.isSeller;
  const isBuyer = trackingData.isBuyer;
  
  switch(stage.id) {
    case 1:
      if (stage.status === 'completed') {
        descriptionText = `æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : ''}éœ€æ±‚å·²æˆåŠŸæäº¤ï¼æˆ‘ä»¬çš„ç³»ç»Ÿæ­£åœ¨è¿›è¡Œåˆæ­¥åˆ†æï¼Œä»¥ä¾¿æ›´å¥½åœ°åŒ¹é…åˆé€‚çš„${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚å¦‚éœ€è¡¥å……å…·ä½“è¦æ±‚æˆ–æŸ¥è¯¢è¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
      } else {
        descriptionText = `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : 'éœ€æ±‚'}æ„å‘ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚æ‚¨å¯ä»¥éšæ—¶æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©ã€‚`;
      }
      break;
    case 2:
      if (stage.status === 'completed') {
        descriptionText = `ç³»ç»Ÿå·²æˆåŠŸä¸ºæ‚¨åŒ¹é…åˆ°ç¬¦åˆè¦æ±‚çš„${isSeller ? 'æ½œåœ¨ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚ç°åœ¨è¿›å…¥${isSeller ? 'ä¹°å®¶' : 'å–å®¶'}ç¡®è®¤é˜¶æ®µã€‚å¦‚éœ€äº†è§£åŒ¹é…è¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else if (stage.status === 'active') {
        descriptionText = `ç³»ç»Ÿæ­£åœ¨æ ¹æ®æ‚¨æä¾›çš„è¦æ±‚åŒ¹é…${isSeller ? 'ä¹°å®¶èµ„æº' : 'åº“å­˜'}ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦12å°æ—¶å†…å®Œæˆã€‚å¦‚éœ€åŠ å¿«è¿›åº¦æˆ–æä¾›æ›´è¯¦ç»†çš„éœ€æ±‚ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨éœ€æ±‚æäº¤åè‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚`;
      }
      break;
    case 3:
      if (stage.status === 'completed') {
        descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç°åœ¨ç­‰å¾…ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else if (stage.status === 'active') {
        descriptionText = `æˆ‘ä»¬å·²æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„åº“å­˜ï¼Œæ­£åœ¨ç­‰å¾…å–å®¶ç¡®è®¤ã€‚é€šå¸¸ä¼šåœ¨24å°æ—¶å†…å¾—åˆ°å›å¤ã€‚å¦‚æƒ³ä¼˜å…ˆå¤„ç†æˆ–äº†è§£æ›´å¤šè¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨åŒ¹é…åˆ°åˆé€‚åº“å­˜åè”ç³»å–å®¶ç¡®è®¤ã€‚`;
      }
      break;
    case 4:
      if (stage.status === 'completed') {
        descriptionText = `ä¹°å®¶å·²ç¡®è®¤è´­ä¹°æ„å‘ï¼Œç°åœ¨è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µã€‚è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆäº¤æ˜“ç»†èŠ‚ç¡®è®¤ã€‚`;
      } else if (stage.status === 'active') {
        descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç­‰å¾…æ‚¨çš„æœ€ç»ˆç¡®è®¤ã€‚ä¸ºç¡®ä¿äº¤æ˜“é¡ºåˆ©è¿›è¡Œï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¿›è¡Œåç»­æ²Ÿé€š`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨å–å®¶ç¡®è®¤åè”ç³»ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚`;
      }
      break;
    case 5:
      if (stage.status === 'completed') {
        descriptionText = `æ­å–œï¼äº¤æ˜“å·²æˆåŠŸå¯¹æ¥ã€‚è¯·é€šè¿‡å¾®ä¿¡ï¼š${wechatContact} å®Œæˆåç»­äº¤æ˜“æµç¨‹ã€‚`;
      } else if (stage.status === 'active') {
        descriptionText = `æ­å–œï¼åŒæ–¹å·²è¾¾æˆå¯¹æ¥æ„å‘ã€‚ä¸ºä¿éšœäº¤æ˜“å®‰å…¨å’Œé¡ºåˆ©å®Œæˆåç»­æµç¨‹ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–è¯¦ç»†æŒ‡å¯¼`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨ä¹°å®¶ç¡®è®¤åè¿›å…¥æœ€ç»ˆå¯¹æ¥ç¡®è®¤é˜¶æ®µã€‚`;
      }
      break;
    default:
      descriptionText = `å½“å‰é˜¶æ®µçŠ¶æ€æ›´æ–°ä¸­ã€‚å¦‚éœ€åŠæ—¶äº†è§£æœ€æ–°è¿›å±•ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
  }
  
  stageDescription.innerHTML = descriptionText;
  
  const nextStepsTitle = document.createElement('h4');
  nextStepsTitle.textContent = 'ä¸‹ä¸€æ­¥æ“ä½œ';
  
  const nextStepsList = document.createElement('ul');
  const nextSteps = getNextSteps(stage.id, stage.status, trackingData);
  
  nextSteps.forEach(step => {
    const listItem = document.createElement('li');
    listItem.innerHTML = step;
    nextStepsList.appendChild(listItem);
  });
  
  // æ·»åŠ å¹³å°ç¡®è®¤æç¤º
  const platformConfirmNote = document.createElement('div');
  platformConfirmNote.classList.add('platform-confirmation-note');
  platformConfirmNote.innerHTML = `<i>æ³¨æ„ï¼šå¯¹æ¥è¿›åº¦ç”±å¹³å°æ ¹æ®å®é™…æƒ…å†µç¡®è®¤æ›´æ–°ï¼Œé˜¶æ®µè¿›åº¦æ— æ³•æ‰‹åŠ¨ä¿®æ”¹ã€‚å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}</i>`;
  
  stageContent.appendChild(stageTitle);
  stageContent.appendChild(stageTimestamp);
  stageContent.appendChild(stageDescription);
  stageContent.appendChild(nextStepsTitle);
  stageContent.appendChild(nextStepsList);
  stageContent.appendChild(platformConfirmNote);
  
  modalContent.appendChild(closeBtn);
  modalContent.appendChild(stageContent);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}

// æ›´æ–°å¯¹æ¥è¿›åº¦
function updateTrackingProgress() {
  let trackingData = JSON.parse(localStorage.getItem('trackingData'));
  
  if (!trackingData) return;
  
  // è·å–å½“å‰æ´»è·ƒé˜¶æ®µ
  let currentActiveIndex = trackingData.stages.findIndex(stage => stage.status === 'active');
  
  // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­æ¶ˆæ¯
  showProgressUpdateMessage();
  
  // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤è¿‡ç¨‹ï¼ˆå®é™…ç¯å¢ƒä¸­åº”é€šè¿‡åç«¯APIè·å–ç¡®è®¤ç»“æœï¼‰
  setTimeout(() => {
    // å¹³å°å®¡æ ¸ç¡®è®¤åï¼Œæ›´æ–°è¿›åº¦
    // æ³¨æ„ï¼šåœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªç¡®è®¤è¿‡ç¨‹åº”è¯¥æ¥è‡ªæœåŠ¡å™¨
    const platformConfirmed = Math.random() > 0.5; // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤ç»“æœ
    
    if (platformConfirmed && currentActiveIndex !== -1 && currentActiveIndex < trackingData.stages.length - 1) {
      // å½“å‰é˜¶æ®µå®Œæˆ
      trackingData.stages[currentActiveIndex].status = 'completed';
      trackingData.stages[currentActiveIndex].timestamp = new Date().toISOString();
      
      // ä¸‹ä¸€é˜¶æ®µæ¿€æ´»
      trackingData.stages[currentActiveIndex + 1].status = 'active';
      trackingData.currentStage = currentActiveIndex + 2; // +2æ˜¯å› ä¸ºstage idä»1å¼€å§‹
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      showNotification("è¿›åº¦å·²æ›´æ–°", "å¹³å°å·²ç¡®è®¤æ‚¨çš„è¿›åº¦æ›´æ–°", "success");
    } else {
      // å¹³å°æœªç¡®è®¤
      showNotification("è¿›åº¦æ›´æ–°ç­‰å¾…ä¸­", "æ‚¨çš„è¿›åº¦æ›´æ–°è¯·æ±‚æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤", "info");
    }
    
    // éšæœºæ›´æ–°å…¶ä»–ä¿¡æ¯
    if (!trackingData.productType && Math.random() > 0.7) {
      const products = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›'];
      trackingData.productType = products[Math.floor(Math.random() * products.length)];
    }
    
    if (!trackingData.needType && Math.random() > 0.7) {
      trackingData.needType = Math.random() > 0.5 ? 'é¢æ–™' : 'æœè£…';
    }
    
    if (!trackingData.quantity && trackingData.isSeller && Math.random() > 0.7) {
      const units = ['ä»¶', 'ç±³', 'æ¡'];
      trackingData.quantity = `${Math.floor(Math.random() * 1000) + 10}${units[Math.floor(Math.random() * units.length)]}`;
    }
    
    if (!trackingData.budgetRange && trackingData.isBuyer && Math.random() > 0.7) {
      const min = Math.floor(Math.random() * 500) + 50;
      const max = min + Math.floor(Math.random() * 500) + 50;
      trackingData.budgetRange = `${min}-${max}å…ƒ`;
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    trackingData.lastUpdated = new Date().toISOString();
    
    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(trackingData));
    
    // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿
    initTrackingPanel();
  }, 2000); // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤å»¶è¿Ÿ
}

// æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­çš„æ¶ˆæ¯
function showProgressUpdateMessage() {
  const notification = document.createElement('div');
  notification.classList.add('progress-notification', 'updating');
  notification.innerHTML = `
    <div class="notification-icon">
      <div class="loading-spinner"></div>
    </div>
    <div class="notification-content">
      <h4>è¿›åº¦æ›´æ–°è¯·æ±‚å·²æäº¤</h4>
      <p>æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...</p>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // 1.5ç§’åç§»é™¤é€šçŸ¥
  setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 500);
  }, 1500);
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(title, message, type = "info") {
  const notification = document.createElement('div');
  notification.classList.add('progress-notification', type);
  
  let icon = '';
  if (type === 'success') {
    icon = '<div class="notification-icon success">âœ“</div>';
  } else if (type === 'error') {
    icon = '<div class="notification-icon error">âœ—</div>';
  } else {
    icon = '<div class="notification-icon info">i</div>';
  }
  
  notification.innerHTML = `
    ${icon}
    <div class="notification-content">
      <h4>${title}</h4>
      <p>${message}</p>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // 3ç§’åç§»é™¤é€šçŸ¥
  setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 500);
  }, 3000);
}

// è·å–çŠ¶æ€æ–‡æœ¬æè¿°
function getStatusText(status) {
  switch(status) {
    case 'pending': return 'ç­‰å¾…ä¸­';
    case 'active': return 'è¿›è¡Œä¸­';
    case 'completed': return 'å·²å®Œæˆ';
    default: return 'æœªçŸ¥çŠ¶æ€';
  }
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${year}-${month}-${day} ${hours}:${minutes}`;
}

// è·å–æ—¶é—´å·®å¼‚çš„å‹å¥½æè¿°
function getTimeDifference(oldDate, newDate) {
  const diffMs = newDate - oldDate;
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);
  const diffHour = Math.floor(diffMin / 60);
  const diffDay = Math.floor(diffHour / 24);
  
  if (diffSec < 60) {
    return 'åˆšåˆš';
  } else if (diffMin < 60) {
    return `${diffMin}åˆ†é’Ÿå‰`;
  } else if (diffHour < 24) {
    return `${diffHour}å°æ—¶å‰`;
  } else if (diffDay < 30) {
    return `${diffDay}å¤©å‰`;
  } else {
    const month = String(oldDate.getMonth() + 1).padStart(2, '0');
    const day = String(oldDate.getDate()).padStart(2, '0');
    return `${month}-${day}`;
  }
}

// è·å–å·²å®Œæˆé˜¶æ®µçš„æ•°é‡
function getCompletedStages(stages) {
  return stages.filter(stage => stage.status === 'completed').length;
}

// åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åŒ…å«å…·ä½“äº§å“ä¿¡æ¯
function containsSpecificProductInfo(message) {
  // åŒ¹é…å…·ä½“çš„äº§å“æè¿°
  const patterns = [
    /\d+[ä»¶æ¡ç±³å¨]/,  // åŒ¹é…æ•°é‡å•ä½
    /æ¬¾å¼|å‹å·|è§„æ ¼|å°ºå¯¸|é¢œè‰²|æˆåˆ†/,  // åŒ¹é…äº§å“å±æ€§
    /ç‰Œ|å“ç‰Œ|å‚å®¶|ç”Ÿäº§å•†/,  // åŒ¹é…å“ç‰Œä¿¡æ¯
    /ä»·æ ¼|æŠ¥ä»·|å…ƒ\/[ç±³ä»¶æ¡]/  // åŒ¹é…ä»·æ ¼ä¿¡æ¯
  ];
  
  return patterns.some(pattern => pattern.test(message));
}

// æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½è·å–ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•
function getNextSteps(stageId, stageStatus, trackingData) {
  const wechatContact = '<strong>JJ1598929032</strong>';
  const isSeller = trackingData.isSeller;
  const isBuyer = trackingData.isBuyer;
  
  // å¦‚æœé˜¶æ®µå·²å®Œæˆï¼Œè¿”å›ç©ºæ­¥éª¤åˆ—è¡¨
  if (stageStatus === 'completed') {
    return [`æ­¤é˜¶æ®µå·²å®Œæˆï¼Œè¯·ç»§ç»­æ¨è¿›ä¸‹ä¸€é˜¶æ®µ`, `å¦‚æœ‰é—®é¢˜è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å’¨è¯¢`];
  }
  
  // å¦‚æœé˜¶æ®µæœªå¼€å§‹ï¼Œè¿”å›ç­‰å¾…æŒ‡å¼•
  if (stageStatus === 'pending') {
    return [`è¯·ç­‰å¾…å‰åºé˜¶æ®µå®Œæˆåå†è¿›è¡Œæ­¤é˜¶æ®µ`, `å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`];
  }
  
  // é˜¶æ®µå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæ ¹æ®ä¸åŒæƒ…å†µè¿”å›æŒ‡å¼•
  if (isSeller) {
    switch(stageId) {
      case 1:
        return [
          `è¯¦ç»†æè¿°æ‚¨è¦å‡ºå”®çš„äº§å“ç±»å‹ã€æ•°é‡å’ŒæœŸæœ›ä»·æ ¼`,
          `æä¾›äº§å“å›¾ç‰‡æˆ–è¯¦ç»†è§„æ ¼è¯´æ˜`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
        ];
      case 2:
        return [
          `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…æ½œåœ¨ä¹°å®¶`,
          `å®Œå–„æ‚¨çš„äº§å“ç»†èŠ‚ä¿¡æ¯ä»¥æé«˜åŒ¹é…ç‡`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
        ];
      case 3:
        return [
          `å‡†å¤‡å¥½è¯¦ç»†çš„äº§å“è¯´æ˜å’Œä»·æ ¼èµ„æ–™`,
          `ç¡®è®¤æ‚¨çš„å‘è´§èƒ½åŠ›å’Œåº“å­˜æƒ…å†µ`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£ä¹°å®¶éœ€æ±‚ç»†èŠ‚`
        ];
      case 4:
        return [
          `å‡†å¤‡è¯¦ç»†çš„äº§å“èµ„æ–™å’ŒæŠ¥ä»·å•`,
          `ç¡®è®¤æ‚¨çš„ä»“åº“åº“å­˜å’Œç‰©æµé…é€æ–¹æ¡ˆ`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸ä¹°å®¶ç›´æ¥æ²Ÿé€š`
        ];
      case 5:
        return [
          `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œä»˜æ¬¾æ–¹å¼`,
          `å‡†å¤‡äº§å“å‘è´§å’Œå”®åæœåŠ¡æ–¹æ¡ˆ`,
          `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
        ];
      default:
        return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
    }
  } else if (isBuyer) {
    switch(stageId) {
      case 1:
        return [
          `è¯¦ç»†æè¿°æ‚¨éœ€è¦çš„äº§å“ç±»å‹ã€æ•°é‡å’Œé¢„ç®—`,
          `è¯´æ˜æ‚¨å¯¹äº§å“è´¨é‡å’Œè§„æ ¼çš„è¦æ±‚`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
        ];
      case 2:
        return [
          `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…åˆé€‚åº“å­˜`,
          `å®Œå–„æ‚¨çš„éœ€æ±‚ç»†èŠ‚ä»¥æé«˜åŒ¹é…ç²¾å‡†åº¦`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
        ];
      case 3:
        return [
          `å‡†å¤‡å¥½ä¸å–å®¶æ²Ÿé€šçš„å…·ä½“é—®é¢˜`,
          `ç¡®è®¤æ‚¨çš„é‡‡è´­é¢„ç®—å’Œä»˜æ¬¾æ–¹å¼`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£å–å®¶ç¡®è®¤è¿›åº¦`
        ];
      case 4:
        return [
          `ä»”ç»†è¯„ä¼°å–å®¶æä¾›çš„äº§å“ä¿¡æ¯`,
          `ç¡®è®¤äº§å“æ˜¯å¦æ»¡è¶³æ‚¨çš„éœ€æ±‚`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸å–å®¶ç›´æ¥æ²Ÿé€š`
        ];
      case 5:
        return [
          `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œæ”¶è´§åœ°å€`,
          `å‡†å¤‡ä»˜æ¬¾å’ŒéªŒæ”¶äº§å“`,
          `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
        ];
      default:
        return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
    }
  } else {
    // ç”¨æˆ·èº«ä»½æœªç¡®å®š
    switch(stageId) {
      case 1:
        return [
          `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨æ˜¯å¸Œæœ›å‡ºå”®è¿˜æ˜¯é‡‡è´­`,
          `è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚æˆ–äº§å“ä¿¡æ¯`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–ä¸“ä¸šæŒ‡å¯¼`
        ];
      default:
        return [
          `è¯·å…ˆæ˜ç¡®æ‚¨çš„èº«ä»½ï¼ˆä¹°å®¶/å–å®¶ï¼‰`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©`
        ];
    }
  }
}

// ä¸ºåŠ¨ç”»æ·»åŠ ç¨³å®šæ€§ä¿®å¤
function animateStats() {
  const statValues = document.querySelectorAll('.stat-value');
  
  statValues.forEach(statValue => {
    const targetValue = parseInt(statValue.textContent, 10);
    let currentValue = 0;
    const duration = 2000;
    const stepTime = 20;
    const totalSteps = duration / stepTime;
    const stepValue = targetValue / totalSteps;
    
    function updateValue() {
      currentValue += stepValue;
      
      if (currentValue < targetValue) {
        statValue.textContent = Math.floor(currentValue);
        requestAnimationFrame(updateValue);
      } else {
        statValue.textContent = targetValue;
        
        // æ·»åŠ ä»¥é˜²æ­¢æ•°å­—å˜åŒ–å¯¼è‡´å¸ƒå±€ç§»åŠ¨
        statValue.style.minWidth = statValue.offsetWidth + 'px';
      }
    }
    
    // å½“å…ƒç´ è¿›å…¥è§†å£æ—¶å¯åŠ¨åŠ¨ç”»
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          updateValue();
          observer.unobserve(entry.target);
        }
      });
    });
    
    observer.observe(statValue);
  });
}

// å¯¼èˆªæ åˆå§‹åŒ–ä¸æ»šåŠ¨æ•ˆæœ
function initNavbar() {
  const navbar = document.querySelector('.navbar');
  
  // æ»šåŠ¨ç›‘å¬
  window.addEventListener('scroll', function() {
    if (window.scrollY > 50) {
      navbar.classList.add('scrolled');
    } else {
      navbar.classList.remove('scrolled');
    }
  });
  
  // å¯¼èˆªèœå•é¡¹ç‚¹å‡»æ¿€æ´»æ•ˆæœ
  const navLinks = document.querySelectorAll('.main-nav a');
  
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      // è·å–ç›®æ ‡éƒ¨åˆ†çš„ID
      const targetId = this.getAttribute('href');
      
      // ä»…å¯¹é¡µå†…é”šç‚¹é“¾æ¥è¿›è¡Œå¤„ç†
      if (targetId.startsWith('#')) {
        e.preventDefault();
        
        const targetSection = document.querySelector(targetId);
        
        if (targetSection) {
          // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡éƒ¨åˆ†
          window.scrollTo({
            top: targetSection.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
            behavior: 'smooth'
          });
          
          // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
          history.pushState(null, null, targetId);
          
          // ç§»é™¤æ‰€æœ‰activeç±»
          navLinks.forEach(item => {
            item.parentElement.classList.remove('active');
          });
          
          // ä¸ºå½“å‰ç‚¹å‡»é¡¹æ·»åŠ activeç±»
          this.parentElement.classList.add('active');
        }
      }
    });
  });
}

// æ·»åŠ æ»šåŠ¨ç›‘å¬ï¼Œé«˜äº®å½“å‰è§†å›¾ä¸­çš„éƒ¨åˆ†
function initScrollSpy() {
  // è·å–æ‰€æœ‰ä¸»è¦éƒ¨åˆ†
  const sections = document.querySelectorAll('section[id]');
  const navLinks = document.querySelectorAll('.main-nav a');
  
  // æ·»åŠ æ»šåŠ¨ç›‘å¬
  window.addEventListener('scroll', function() {
    // å½“å‰æ»šåŠ¨ä½ç½®
    const scrollPosition = window.scrollY + 100; // æ·»åŠ ä¸€äº›åç§»ä»¥æå‰æ¿€æ´»
    
    // æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†çš„ä½ç½®
    sections.forEach(section => {
      // è·å–éƒ¨åˆ†çš„é¡¶éƒ¨å’Œåº•éƒ¨ä½ç½®
      const sectionTop = section.offsetTop;
      const sectionBottom = sectionTop + section.offsetHeight;
      
      // æ£€æŸ¥å½“å‰æ»šåŠ¨ä½ç½®æ˜¯å¦åœ¨è¯¥éƒ¨åˆ†
      if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
        // æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé“¾æ¥
        const targetId = '#' + section.getAttribute('id');
        
        // ç§»é™¤æ‰€æœ‰activeç±»
        navLinks.forEach(link => {
          link.parentElement.classList.remove('active');
          
          // ä¸ºå½“å‰éƒ¨åˆ†çš„é“¾æ¥æ·»åŠ activeç±»
          if (link.getAttribute('href') === targetId) {
            link.parentElement.classList.add('active');
          }
        });
      }
    });
  });
}

// å¹³æ»‘æ»šåŠ¨æ•ˆæœ
function addSmoothScrolling() {
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      const targetId = this.getAttribute('href');
      
      if (targetId === '#') return;
      
      const target = document.querySelector(targetId);
      
      if (target) {
        e.preventDefault();
        
        window.scrollTo({
          top: target.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
          behavior: 'smooth'
        });
        
        // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
        history.pushState(null, null, targetId);
      }
    });
  });
}

// è¯­è¨€åˆ‡æ¢åŠŸèƒ½
function initLanguageSwitch() {
  const langButtons = document.querySelectorAll('.lang-btn');
  const defaultLang = localStorage.getItem('userLanguage') || 'zh';
  
  // è®¾ç½®åˆå§‹è¯­è¨€
  setLanguage(defaultLang);
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  updateLanguageButtons(defaultLang);
  
  langButtons.forEach(button => {
    button.addEventListener('click', function() {
      const lang = this.getAttribute('data-lang');
      setLanguage(lang);
      updateLanguageButtons(lang);
    });
  });
  
  // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
  function updateLanguageButtons(activeLang) {
    langButtons.forEach(btn => {
      if (btn.getAttribute('data-lang') === activeLang) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }
}

// è®¾ç½®è¯­è¨€
function setLanguage(lang) {
  // ä¿å­˜ç”¨æˆ·è¯­è¨€é€‰æ‹©
  localStorage.setItem('userLanguage', lang);
  
  // è·å–æ‰€æœ‰éœ€è¦ç¿»è¯‘çš„å…ƒç´ 
  const elements = document.querySelectorAll('[data-i18n]');
  
  // åŠ è½½ç¿»è¯‘æ•°æ®
  const translations = getTranslations();
  
  // åº”ç”¨ç¿»è¯‘
  elements.forEach(element => {
    const key = element.getAttribute('data-i18n');
    if (translations[key] && translations[key][lang]) {
      element.innerHTML = translations[key][lang];
    }
  });
  
  // æ›´æ–°é¡µé¢æ ‡é¢˜
  if (translations.pageTitle && translations.pageTitle[lang]) {
    document.title = translations.pageTitle[lang];
  }
  
  console.log(`Language changed to: ${lang}`);
}

// è·å–ç¿»è¯‘æ•°æ®
function getTranslations() {
  return {
    pageTitle: {
      'zh': 'Fashion Reborn - æœè£…æ”¹é€ è‰ºæœ¯ç©ºé—´',
      'en': 'Fashion Reborn - Clothing Reconstruction Art Space'
    },
    'nav.home': {
      'zh': 'é¦–é¡µ',
      'en': 'Home'
    },
    'nav.workshop': {
      'zh': 'åˆ›æ„å·¥åŠ',
      'en': 'Creative Workshop'
    },
    'nav.community': {
      'zh': 'æ”¹é€ ç¤¾åŒº',
      'en': 'Redesign Community'
    },
    'nav.inventory': {
      'zh': 'åº“å­˜å¯¹æ¥',
      'en': 'Inventory Matching'
    },
    'nav.about': {
      'zh': 'å…³äºæˆ‘',
      'en': 'About Me'
    },
    'hero.subtitle': {
      'zh': 'é‡æ–°å®šä¹‰æ—¶å°šï¼Œèµ‹äºˆæ—§è¡£æ–°ç”Ÿ',
      'en': 'Redefining fashion, giving old clothes new life'
    },
    'hero.cta': {
      'zh': 'æ¢ç´¢æ”¹é€ ä¹‹æ—…',
      'en': 'Explore Redesign Journey'
    },
    'showcase.title': {
      'zh': 'ç²¾é€‰ä½œå“',
      'en': 'Featured Works'
    },
    'stats.items': {
      'zh': 'ç´¯è®¡æ”¹é€ è¡£ç‰©',
      'en': 'Items Redesigned'
    },
    'stats.fabric': {
      'zh': 'èŠ‚çº¦å¸ƒæ–™(ç±³)',
      'en': 'Fabric Saved (m)'
    },
    'stats.users': {
      'zh': 'ç¤¾åŒºæ´»è·ƒç”¨æˆ·',
      'en': 'Active Community Users'
    },
    'workshop.title': {
      'zh': 'åˆ›æ„å·¥åŠ',
      'en': 'Creative Workshop'
    },
    'material.all': {
      'zh': 'å…¨éƒ¨',
      'en': 'All'
    },
    'material.cotton': {
      'zh': 'æ£‰éº»',
      'en': 'Cotton & Linen'
    },
    'material.silk': {
      'zh': 'ä¸ç»¸',
      'en': 'Silk'
    },
    'material.denim': {
      'zh': 'ç‰›ä»”',
      'en': 'Denim'
    },
    'material.knit': {
      'zh': 'é’ˆç»‡',
      'en': 'Knit'
    },
    'material.leather': {
      'zh': 'çš®é©',
      'en': 'Leather'
    },
    'video.title': {
      'zh': 'æ•™ç¨‹è§†é¢‘',
      'en': 'Tutorial Videos'
    },
    'community.title': {
      'zh': 'æ”¹é€ ç¤¾åŒº',
      'en': 'Redesign Community'
    },
    'community.map': {
      'zh': 'ç¤¾åŒºçƒ­åŠ›å›¾',
      'en': 'Community Heatmap'
    },
    'challenge.title': {
      'zh': 'æœ¬æœˆæŒ‘æˆ˜: æ—§ç‰›ä»”é‡ç”Ÿè®¡åˆ’',
      'en': 'Monthly Challenge: Denim Rebirth Project'
    },
    'knowledge.title': {
      'zh': 'çŸ¥è¯†å…±äº«åº“',
      'en': 'Knowledge Sharing Library'
    },
    'inventory.title': {
      'zh': 'åº“å­˜åŒ¹é…ç³»ç»Ÿ',
      'en': 'Inventory Matching System'
    },
    'inventory.description': {
      'zh': 'è¾“å…¥æ‚¨æƒ³è¦çš„æœè£…ä¿¡æ¯ï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨åŒ¹é…åº“å­˜å¹¶æä¾›ä¸“ä¸šæœè£…æ”¹é€ å»ºè®®',
      'en': 'Enter your clothing preferences, and we will match inventory and provide professional redesign advice'
    },
    'chat.history': {
      'zh': 'å†å²ä¼šè¯',
      'en': 'Chat History'
    },
    'chat.placeholder': {
      'zh': 'è¾“å…¥æ‚¨çš„é¢æ–™éœ€æ±‚æˆ–é—®é¢˜...',
      'en': 'Enter your fabric needs or questions...'
    },
    'chat.send': {
      'zh': 'å‘é€',
      'en': 'Send'
    },
    'tracking.title': {
      'zh': 'å¯¹æ¥è¿›åº¦',
      'en': 'Connection Progress'
    },
    'tracking.refresh': {
      'zh': 'è¯·æ±‚æ›´æ–°è¿›åº¦',
      'en': 'Request Progress Update'
    },
    'tracking.note': {
      'zh': 'æç¤ºï¼šæ‰€æœ‰è¿›åº¦æ›´æ–°éœ€è¦å¹³å°ç¡®è®¤åæ‰èƒ½ç”Ÿæ•ˆ',
      'en': 'Note: All progress updates require platform confirmation'
    },
    'footer.follow': {
      'zh': 'å…³æ³¨æˆ‘ä»¬',
      'en': 'Follow Us'
    },
    'social.weibo': {
      'zh': 'å®˜æ–¹å¾®åš',
      'en': 'Official Weibo'
    },
    'social.douyin': {
      'zh': 'æŠ–éŸ³å·',
      'en': 'TikTok'
    },
    'social.xiaohongshu': {
      'zh': 'å°çº¢ä¹¦',
      'en': 'Xiaohongshu'
    },
    'social.message': {
      'zh': 'å…³æ³¨æˆ‘ä»¬çš„ç¤¾äº¤åª’ä½“ï¼Œè·å–æœ€æ–°æœè£…æ”¹é€ çµæ„Ÿå’Œå®ç”¨æŠ€å·§ï¼Œå‚ä¸äº’åŠ¨èµ¢å–ç²¾ç¾ç¤¼å“ï¼',
      'en': 'Follow our social media for the latest clothing redesign inspiration and practical tips. Participate in interactions to win beautiful gifts!'
    },
    'newsletter.title': {
      'zh': 'è®¢é˜…æ–°é—»',
      'en': 'Subscribe to Newsletter'
    },
    'newsletter.description': {
      'zh': 'è®¢é˜…æˆ‘ä»¬çš„ç”µå­æŠ¥ï¼Œäº†è§£æœ€æ–°çš„è®¾è®¡è¶‹åŠ¿ã€æ”¹é€ æŠ€å·§å’Œç‹¬å®¶ä¼˜æƒ ä¿¡æ¯ã€‚',
      'en': 'Subscribe to our newsletter to learn about the latest design trends, redesign techniques, and exclusive offers.'
    },
    'newsletter.placeholder': {
      'zh': 'è¯·è¾“å…¥æ‚¨çš„ç”µå­é‚®ç®±',
      'en': 'Please enter your email'
    },
    'newsletter.button': {
      'zh': 'ç«‹å³è®¢é˜…',
      'en': 'Subscribe Now'
    },
    'benefit.weekly': {
      'zh': 'æ¯å‘¨æ›´æ–°',
      'en': 'Weekly Updates'
    },
    'benefit.exclusive': {
      'zh': 'ä¸“å±ä¼˜æƒ ',
      'en': 'Exclusive Offers'
    },
    'benefit.unsubscribe': {
      'zh': 'éšæ—¶é€€è®¢',
      'en': 'Unsubscribe Anytime'
    },
    'copyright': {
      'zh': 'Â© 2023 Fashion Reborn. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚',
      'en': 'Â© 2023 Fashion Reborn. All Rights Reserved.'
    },
    'certification': {
      'zh': 'å¯æŒç»­æ—¶å°šè®¤è¯',
      'en': 'Sustainable Fashion Certified'
    },
    'visitor.count': {
      'zh': 'è®¿é—®é‡: ',
      'en': 'Visitors: '
    }
  };
}
  
  // åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
  function initDarkMode() {
    const darkModeToggle = document.querySelector('.dark-mode-toggle');
    if (darkModeToggle) {
      darkModeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
          this.textContent = 'â˜€ï¸';
        } else {
          this.textContent = 'ğŸŒ™';
        }
      });
    }
  }
});
  
  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  function initTrackingPanel() {
    const trackingPanel = document.querySelector('.process-flow');
    if (!trackingPanel) return;
  
    // åˆå§‹åŒ–è¿›åº¦æµç¨‹å›¾ - ä»localStorageè·å–å½“å‰çŠ¶æ€
    let currentTrackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è·Ÿè¸ªæ•°æ®æˆ–è€…æ˜¯æ–°ä¼šè¯ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
    if (!currentTrackingData) {
      currentTrackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
      
      // ä¿å­˜åˆå§‹æ•°æ®
      localStorage.setItem('trackingData', JSON.stringify(currentTrackingData));
    }
    
    // æ¸…ç©ºé»˜è®¤å†…å®¹
    trackingPanel.innerHTML = '';
    
    // åˆ›å»ºè¿›åº¦æ¡
    const progressBar = document.createElement('div');
    progressBar.classList.add('progress-bar');
    
    // æ·»åŠ å„ä¸ªé˜¶æ®µ
    currentTrackingData.stages.forEach(stage => {
      const stageElement = document.createElement('div');
      stageElement.classList.add('progress-stage', `status-${stage.status}`);
      stageElement.dataset.stageId = stage.id;
      
      const stageNumber = document.createElement('div');
      stageNumber.classList.add('stage-number');
      stageNumber.textContent = stage.id;
      
      const stageName = document.createElement('div');
      stageName.classList.add('stage-name');
      stageName.textContent = stage.name;
      
      stageElement.appendChild(stageNumber);
      stageElement.appendChild(stageName);
      
      // ç‚¹å‡»é˜¶æ®µæ˜¾ç¤ºè¯¦æƒ…
      stageElement.addEventListener('click', () => showStageDetail(stage, currentTrackingData));
      
      progressBar.appendChild(stageElement);
      
      // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€ä¸ªé˜¶æ®µï¼‰
      if (stage.id < currentTrackingData.stages.length) {
        const connector = document.createElement('div');
        connector.classList.add('stage-connector', `status-${stage.status}`);
        progressBar.appendChild(connector);
      }
    });
    
    trackingPanel.appendChild(progressBar);
    
    // æ·»åŠ è¯´æ˜æ–‡å­—
    const statusInfo = document.createElement('div');
    statusInfo.classList.add('status-info');
    
    // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„é˜¶æ®µ
    const activeStage = currentTrackingData.stages.find(stage => stage.status === 'active');
    const stageName = activeStage ? activeStage.name : 'å‡†å¤‡ä¸­';
    
    // è®¡ç®—æœ€åæ›´æ–°æ—¶é—´
    const lastUpdateTime = getTimeDifference(new Date(currentTrackingData.lastUpdated), new Date());
    
    statusInfo.innerHTML = `å½“å‰çŠ¶æ€ï¼š<span class="status-active">${stageName}</span> Â· æ›´æ–°äº ${lastUpdateTime}`;
    trackingPanel.appendChild(statusInfo);
    
    // æ·»åŠ è¿›åº¦æ¦‚è¦
    const progressSummary = document.createElement('div');
    progressSummary.classList.add('progress-summary');
    
    // æ ¹æ®ç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒçš„è¿›åº¦æ¦‚è¦
    const isSeller = currentTrackingData.isSeller;
    const isBuyer = currentTrackingData.isBuyer;
    
    // è·å–ä¹°å–éœ€æ±‚ç±»å‹
    const needTypeDisplay = currentTrackingData.needType ? currentTrackingData.needType : 'ç­‰å¾…ç¡®è®¤';
    const productTypeDisplay = currentTrackingData.productType ? currentTrackingData.productType : 'ç­‰å¾…ç¡®è®¤';
    
    let summaryHTML = '';
    if (isSeller) {
      summaryHTML = `
        <h4>å‡ºå”®ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>å•†å“ç±»å‹: ${productTypeDisplay}</li>
          <li>åº“å­˜æ•°é‡: ${currentTrackingData.quantity || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else if (isBuyer) {
      summaryHTML = `
        <h4>é‡‡è´­ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>éœ€æ±‚ç±»å‹: ${needTypeDisplay}</li>
          <li>äº§å“ç±»å‹: ${productTypeDisplay}</li>
          <li>é¢„ç®—èŒƒå›´: ${currentTrackingData.budgetRange || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else {
      summaryHTML = `
        <h4>å¯¹æ¥ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>è¯·åœ¨èŠå¤©ä¸­è¯´æ˜æ‚¨æ˜¯éœ€è¦å‡ºå”®è¿˜æ˜¯é‡‡è´­</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    }
    
    progressSummary.innerHTML = summaryHTML;
    trackingPanel.appendChild(progressSummary);
    
    // æ·»åŠ åˆ·æ–°æŒ‰é’®
    const refreshButton = document.createElement('button');
    refreshButton.classList.add('refresh-tracking');
    refreshButton.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
    refreshButton.addEventListener('click', function() {
      // è¯·æ±‚å¹³å°æ›´æ–°è¿›åº¦
      updateTrackingProgress();
      
      // æ·»åŠ åˆ·æ–°åŠ¨ç”»
      this.classList.add('refreshing');
      // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
      this.textContent = 'æ­£åœ¨è¯·æ±‚å¹³å°ç¡®è®¤...';
      setTimeout(() => {
        this.classList.remove('refreshing');
        this.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
      }, 2000);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤è¯´æ˜
    const confirmNote = document.createElement('div');
    confirmNote.classList.add('platform-note');
    confirmNote.innerHTML = 'æç¤ºï¼šæ‰€æœ‰è¿›åº¦æ›´æ–°éœ€è¦å¹³å°ç¡®è®¤åæ‰èƒ½ç”Ÿæ•ˆ';
    
    trackingPanel.appendChild(refreshButton);
    trackingPanel.appendChild(confirmNote);
  }
  
  // æ ¹æ®èŠå¤©å†…å®¹æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingFromChat(message, isSeller, isBuyer) {
    // è·å–å½“å‰è¿›åº¦æ•°æ®
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) {
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
      trackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
    }
    
    // æ›´æ–°ä¹°å–èº«ä»½
    if (isSeller !== undefined) {
      trackingData.isSeller = isSeller;
    }
    
    if (isBuyer !== undefined) {
      trackingData.isBuyer = isBuyer;
    }
    
    // å¤„ç†é˜¶æ®µ1ï¼šéœ€æ±‚æäº¤
    if (trackingData.stages[0].status !== 'completed') {
      // åªè¦æœ‰æ¶ˆæ¯ï¼Œå°±è®¤ä¸ºéœ€æ±‚å·²æäº¤
      trackingData.stages[0].status = 'completed';
      trackingData.stages[0].timestamp = new Date().toISOString();
      
      // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
      trackingData.stages[1].status = 'active';
      trackingData.currentStage = 2;
    }
    
    // æå–äº§å“ç±»å‹ä¿¡æ¯
    const productTypes = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›', 'å°¼é¾™', 'æ¶¤çº¶'];
    for (const type of productTypes) {
      if (message.includes(type)) {
        trackingData.productType = type;
        break;
      }
    }
    
    // æå–éœ€æ±‚ç±»å‹
    if (message.includes('é¢æ–™') || message.includes('å¸ƒæ–™') || message.includes('å¸ƒ')) {
      trackingData.needType = 'é¢æ–™';
    } else if (message.includes('æœè£…') || message.includes('è¡£æœ') || message.includes('æˆè¡£')) {
      trackingData.needType = 'æœè£…';
    }
    
    // æå–æ•°é‡ä¿¡æ¯
    const quantityMatch = message.match(/(\d+)([ä»¶æ¡ç±³å¨ä¸ª])/);
    if (quantityMatch) {
      trackingData.quantity = quantityMatch[0];
    }
    
    // æå–ä»·æ ¼/é¢„ç®—ä¿¡æ¯
    if (message.includes('ä»·æ ¼') || message.includes('å¤šå°‘é’±') || message.includes('é¢„ç®—')) {
      const priceMatch = message.match(/(\d+)[-~åˆ°è‡³](\d+)[å…ƒå—]/);
      if (priceMatch) {
        trackingData.budgetRange = priceMatch[0];
      }
    }
    
    // é˜¶æ®µ2ï¼šåŒ¹é…åº“å­˜ - æ ¹æ®å…³é”®è¯åˆ¤æ–­
    if (trackingData.currentStage === 2 && trackingData.stages[1].status === 'active') {
      // å½“ç”¨æˆ·æä¾›äº†å…·ä½“çš„äº§å“å’Œéœ€æ±‚ç±»å‹æ—¶ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€é˜¶æ®µ
      if (trackingData.productType && trackingData.needType) {
        if (message.includes('åŒ¹é…') || message.includes('åº“å­˜') || message.includes('èµ„æº') || 
            message.includes('æ‰¾åˆ°') || message.includes('æœ‰è´§') || containsSpecificProductInfo(message)) {
          trackingData.stages[1].status = 'completed';
          trackingData.stages[1].timestamp = new Date().toISOString();
          
          // æ ¹æ®ç”¨æˆ·èº«ä»½å†³å®šä¸‹ä¸€æ­¥
          if (trackingData.isSeller) {
            // å–å®¶å¯»æ‰¾ä¹°å®¶ï¼Œè¿›å…¥åˆ°ä¹°å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[3].status = 'active';
            trackingData.currentStage = 4;
          } else if (trackingData.isBuyer) {
            // ä¹°å®¶å¯»æ‰¾å–å®¶ï¼Œè¿›å…¥åˆ°å–å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[2].status = 'active';
            trackingData.currentStage = 3;
          }
        }
      }
    }
    
    // é˜¶æ®µ3ï¼šå–å®¶ç¡®è®¤
    if (trackingData.currentStage === 3 && trackingData.stages[2].status === 'active') {
      if (message.includes('å–å®¶ç¡®è®¤') || message.includes('ä¾›åº”å•†ç¡®è®¤') || message.includes('å·²ç¡®è®¤') || 
          message.includes('å¯ä»¥ä¾›åº”') || message.includes('æœ‰åº“å­˜')) {
        trackingData.stages[2].status = 'completed';
        trackingData.stages[2].timestamp = new Date().toISOString();
        
        // è¿›å…¥ä¹°å®¶ç¡®è®¤é˜¶æ®µ
        trackingData.stages[3].status = 'active';
        trackingData.currentStage = 4;
      }
    }
    
    // é˜¶æ®µ4ï¼šä¹°å®¶ç¡®è®¤
    if (trackingData.currentStage === 4 && trackingData.stages[3].status === 'active') {
      if (message.includes('ä¹°å®¶ç¡®è®¤') || message.includes('å®¢æˆ·ç¡®è®¤') || message.includes('ç¡®è®¤è´­ä¹°') || 
          message.includes('æ¥å—') || message.includes('æ»¡æ„')) {
        trackingData.stages[3].status = 'completed';
        trackingData.stages[3].timestamp = new Date().toISOString();
        
        // è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µ
        trackingData.stages[4].status = 'active';
        trackingData.currentStage = 5;
      }
    }
    
    // é˜¶æ®µ5ï¼šç¡®è®¤å¯¹æ¥
    if (trackingData.currentStage === 5 && trackingData.stages[4].status === 'active') {
      if (message.includes('äº¤æ˜“æˆåŠŸ') || message.includes('å·²å¯¹æ¥') || message.includes('æˆäº¤') || 
          message.includes('å·²å®Œæˆ') || message.includes('æ„Ÿè°¢åˆä½œ')) {
        trackingData.stages[4].status = 'completed';
        trackingData.stages[4].timestamp = new Date().toISOString();
      }
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    trackingData.lastUpdated = new Date().toISOString();
    
    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(trackingData));
    
    // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
    initTrackingPanel();
  }
  
  // æ˜¾ç¤ºé˜¶æ®µè¯¦ç»†ä¿¡æ¯
  function showStageDetail(stage, trackingData) {
    const wechatContact = '<strong>JJ1598929032</strong>';
    const modal = document.createElement('div');
    modal.classList.add('progress-modal');
    
    const modalContent = document.createElement('div');
    modalContent.classList.add('modal-content');
    
    // æ·»åŠ å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.classList.add('close-modal');
    closeBtn.innerHTML = '&times;';
    closeBtn.addEventListener('click', function() {
      document.body.removeChild(modal);
    });
    
    // é˜¶æ®µè¯¦æƒ…å†…å®¹
    const stageContent = document.createElement('div');
    stageContent.classList.add('stage-detail');
    
    const stageTitle = document.createElement('h3');
    stageTitle.innerHTML = `é˜¶æ®µ ${stage.id}: ${stage.name} <span class="stage-status status-${stage.status}">${getStatusText(stage.status)}</span>`;
    
    const stageTimestamp = document.createElement('div');
    stageTimestamp.classList.add('stage-timestamp');
    if (stage.timestamp) {
      const date = new Date(stage.timestamp);
      stageTimestamp.textContent = `æ›´æ–°æ—¶é—´: ${formatDateTime(date)}`;
    } else {
      stageTimestamp.textContent = 'å°šæœªå¼€å§‹';
    }
    
    const stageDescription = document.createElement('p');
    let descriptionText = '';
    
    // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒå†…å®¹
    const isSeller = trackingData.isSeller;
    const isBuyer = trackingData.isBuyer;
    
    switch(stage.id) {
      case 1:
        if (stage.status === 'completed') {
          descriptionText = `æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : ''}éœ€æ±‚å·²æˆåŠŸæäº¤ï¼æˆ‘ä»¬çš„ç³»ç»Ÿæ­£åœ¨è¿›è¡Œåˆæ­¥åˆ†æï¼Œä»¥ä¾¿æ›´å¥½åœ°åŒ¹é…åˆé€‚çš„${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚å¦‚éœ€è¡¥å……å…·ä½“è¦æ±‚æˆ–æŸ¥è¯¢è¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : 'éœ€æ±‚'}æ„å‘ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚æ‚¨å¯ä»¥éšæ—¶æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©ã€‚`;
        }
        break;
      case 2:
        if (stage.status === 'completed') {
          descriptionText = `ç³»ç»Ÿå·²æˆåŠŸä¸ºæ‚¨åŒ¹é…åˆ°ç¬¦åˆè¦æ±‚çš„${isSeller ? 'æ½œåœ¨ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚ç°åœ¨è¿›å…¥${isSeller ? 'ä¹°å®¶' : 'å–å®¶'}ç¡®è®¤é˜¶æ®µã€‚å¦‚éœ€äº†è§£åŒ¹é…è¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `ç³»ç»Ÿæ­£åœ¨æ ¹æ®æ‚¨æä¾›çš„è¦æ±‚åŒ¹é…${isSeller ? 'ä¹°å®¶èµ„æº' : 'åº“å­˜'}ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦12å°æ—¶å†…å®Œæˆã€‚å¦‚éœ€åŠ å¿«è¿›åº¦æˆ–æä¾›æ›´è¯¦ç»†çš„éœ€æ±‚ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨éœ€æ±‚æäº¤åè‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚`;
        }
        break;
      case 3:
        if (stage.status === 'completed') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç°åœ¨ç­‰å¾…ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `æˆ‘ä»¬å·²æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„åº“å­˜ï¼Œæ­£åœ¨ç­‰å¾…å–å®¶ç¡®è®¤ã€‚é€šå¸¸ä¼šåœ¨24å°æ—¶å†…å¾—åˆ°å›å¤ã€‚å¦‚æƒ³ä¼˜å…ˆå¤„ç†æˆ–äº†è§£æ›´å¤šè¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨åŒ¹é…åˆ°åˆé€‚åº“å­˜åè”ç³»å–å®¶ç¡®è®¤ã€‚`;
        }
        break;
      case 4:
        if (stage.status === 'completed') {
          descriptionText = `ä¹°å®¶å·²ç¡®è®¤è´­ä¹°æ„å‘ï¼Œç°åœ¨è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µã€‚è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆäº¤æ˜“ç»†èŠ‚ç¡®è®¤ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç­‰å¾…æ‚¨çš„æœ€ç»ˆç¡®è®¤ã€‚ä¸ºç¡®ä¿äº¤æ˜“é¡ºåˆ©è¿›è¡Œï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¿›è¡Œåç»­æ²Ÿé€š`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨å–å®¶ç¡®è®¤åè”ç³»ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚`;
        }
        break;
      case 5:
        if (stage.status === 'completed') {
          descriptionText = `æ­å–œï¼äº¤æ˜“å·²æˆåŠŸå¯¹æ¥ã€‚è¯·é€šè¿‡å¾®ä¿¡ï¼š${wechatContact} å®Œæˆåç»­äº¤æ˜“æµç¨‹ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `æ­å–œï¼åŒæ–¹å·²è¾¾æˆå¯¹æ¥æ„å‘ã€‚ä¸ºä¿éšœäº¤æ˜“å®‰å…¨å’Œé¡ºåˆ©å®Œæˆåç»­æµç¨‹ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–è¯¦ç»†æŒ‡å¯¼`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨ä¹°å®¶ç¡®è®¤åè¿›å…¥æœ€ç»ˆå¯¹æ¥ç¡®è®¤é˜¶æ®µã€‚`;
        }
        break;
      default:
        descriptionText = `å½“å‰é˜¶æ®µçŠ¶æ€æ›´æ–°ä¸­ã€‚å¦‚éœ€åŠæ—¶äº†è§£æœ€æ–°è¿›å±•ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
    }
    
    stageDescription.innerHTML = descriptionText;
    
    const nextStepsTitle = document.createElement('h4');
    nextStepsTitle.textContent = 'ä¸‹ä¸€æ­¥æ“ä½œ';
    
    const nextStepsList = document.createElement('ul');
    const nextSteps = getNextSteps(stage.id, stage.status, trackingData);
    
    nextSteps.forEach(step => {
      const listItem = document.createElement('li');
      listItem.innerHTML = step;
      nextStepsList.appendChild(listItem);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤æç¤º
    const platformConfirmNote = document.createElement('div');
    platformConfirmNote.classList.add('platform-confirmation-note');
    platformConfirmNote.innerHTML = `<i>æ³¨æ„ï¼šå¯¹æ¥è¿›åº¦ç”±å¹³å°æ ¹æ®å®é™…æƒ…å†µç¡®è®¤æ›´æ–°ï¼Œé˜¶æ®µè¿›åº¦æ— æ³•æ‰‹åŠ¨ä¿®æ”¹ã€‚å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}</i>`;
    
    stageContent.appendChild(stageTitle);
    stageContent.appendChild(stageTimestamp);
    stageContent.appendChild(stageDescription);
    stageContent.appendChild(nextStepsTitle);
    stageContent.appendChild(nextStepsList);
    stageContent.appendChild(platformConfirmNote);
    
    modalContent.appendChild(closeBtn);
    modalContent.appendChild(stageContent);
    modal.appendChild(modalContent);
    
    document.body.appendChild(modal);
  }
  
  // æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingProgress() {
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) return;
    
    // è·å–å½“å‰æ´»è·ƒé˜¶æ®µ
    let currentActiveIndex = trackingData.stages.findIndex(stage => stage.status === 'active');
    
    // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­æ¶ˆæ¯
    showProgressUpdateMessage();
    
    // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤è¿‡ç¨‹ï¼ˆå®é™…ç¯å¢ƒä¸­åº”é€šè¿‡åç«¯APIè·å–ç¡®è®¤ç»“æœï¼‰
    setTimeout(() => {
      // å¹³å°å®¡æ ¸ç¡®è®¤åï¼Œæ›´æ–°è¿›åº¦
      // æ³¨æ„ï¼šåœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªç¡®è®¤è¿‡ç¨‹åº”è¯¥æ¥è‡ªæœåŠ¡å™¨
      const platformConfirmed = Math.random() > 0.5; // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤ç»“æœ
      
      if (platformConfirmed && currentActiveIndex !== -1 && currentActiveIndex < trackingData.stages.length - 1) {
        // å½“å‰é˜¶æ®µå®Œæˆ
        trackingData.stages[currentActiveIndex].status = 'completed';
        trackingData.stages[currentActiveIndex].timestamp = new Date().toISOString();
        
        // ä¸‹ä¸€é˜¶æ®µæ¿€æ´»
        trackingData.stages[currentActiveIndex + 1].status = 'active';
        trackingData.currentStage = currentActiveIndex + 2; // +2æ˜¯å› ä¸ºstage idä»1å¼€å§‹
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showNotification("è¿›åº¦å·²æ›´æ–°", "å¹³å°å·²ç¡®è®¤æ‚¨çš„è¿›åº¦æ›´æ–°", "success");
      } else {
        // å¹³å°æœªç¡®è®¤
        showNotification("è¿›åº¦æ›´æ–°ç­‰å¾…ä¸­", "æ‚¨çš„è¿›åº¦æ›´æ–°è¯·æ±‚æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤", "info");
      }
      
      // éšæœºæ›´æ–°å…¶ä»–ä¿¡æ¯
      if (!trackingData.productType && Math.random() > 0.7) {
        const products = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›'];
        trackingData.productType = products[Math.floor(Math.random() * products.length)];
      }
      
      if (!trackingData.needType && Math.random() > 0.7) {
        trackingData.needType = Math.random() > 0.5 ? 'é¢æ–™' : 'æœè£…';
      }
      
      if (!trackingData.quantity && trackingData.isSeller && Math.random() > 0.7) {
        const units = ['ä»¶', 'ç±³', 'æ¡'];
        trackingData.quantity = `${Math.floor(Math.random() * 1000) + 10}${units[Math.floor(Math.random() * units.length)]}`;
      }
      
      if (!trackingData.budgetRange && trackingData.isBuyer && Math.random() > 0.7) {
        const min = Math.floor(Math.random() * 500) + 50;
        const max = min + Math.floor(Math.random() * 500) + 50;
        trackingData.budgetRange = `${min}-${max}å…ƒ`;
      }
      
      // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
      trackingData.lastUpdated = new Date().toISOString();
      
      // ä¿å­˜æ›´æ–°åçš„æ•°æ®
      localStorage.setItem('trackingData', JSON.stringify(trackingData));
      
      // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿
      initTrackingPanel();
    }, 2000); // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤å»¶è¿Ÿ
  }
  
  // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­çš„æ¶ˆæ¯
  function showProgressUpdateMessage() {
    const notification = document.createElement('div');
    notification.classList.add('progress-notification', 'updating');
    notification.innerHTML = `
      <div class="notification-icon">
        <div class="loading-spinner"></div>
      </div>
      <div class="notification-content">
        <h4>è¿›åº¦æ›´æ–°è¯·æ±‚å·²æäº¤</h4>
        <p>æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...</p>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // 1.5ç§’åç§»é™¤é€šçŸ¥
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 1500);
  }
  
  // æ˜¾ç¤ºé€šçŸ¥
  function showNotification(title, message, type = "info") {
    const notification = document.createElement('div');
    notification.classList.add('progress-notification', type);
    
    let icon = '';
    if (type === 'success') {
      icon = '<div class="notification-icon success">âœ“</div>';
    } else if (type === 'error') {
      icon = '<div class="notification-icon error">âœ—</div>';
    } else {
      icon = '<div class="notification-icon info">i</div>';
    }
    
    notification.innerHTML = `
      ${icon}
      <div class="notification-content">
        <h4>${title}</h4>
        <p>${message}</p>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’åç§»é™¤é€šçŸ¥
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 3000);
  }
  
  // è·å–çŠ¶æ€æ–‡æœ¬æè¿°
  function getStatusText(status) {
    switch(status) {
      case 'pending': return 'ç­‰å¾…ä¸­';
      case 'active': return 'è¿›è¡Œä¸­';
      case 'completed': return 'å·²å®Œæˆ';
      default: return 'æœªçŸ¥çŠ¶æ€';
    }
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
  function formatDateTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day} ${hours}:${minutes}`;
  }
  
  // è·å–æ—¶é—´å·®å¼‚çš„å‹å¥½æè¿°
  function getTimeDifference(oldDate, newDate) {
    const diffMs = newDate - oldDate;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffSec < 60) {
      return 'åˆšåˆš';
    } else if (diffMin < 60) {
      return `${diffMin}åˆ†é’Ÿå‰`;
    } else if (diffHour < 24) {
      return `${diffHour}å°æ—¶å‰`;
    } else if (diffDay < 30) {
      return `${diffDay}å¤©å‰`;
    } else {
      const month = String(oldDate.getMonth() + 1).padStart(2, '0');
      const day = String(oldDate.getDate()).padStart(2, '0');
      return `${month}-${day}`;
    }
  }
  
  // è·å–å·²å®Œæˆé˜¶æ®µçš„æ•°é‡
  function getCompletedStages(stages) {
    return stages.filter(stage => stage.status === 'completed').length;
  }
  
  // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åŒ…å«å…·ä½“äº§å“ä¿¡æ¯
  function containsSpecificProductInfo(message) {
    // åŒ¹é…å…·ä½“çš„äº§å“æè¿°
    const patterns = [
      /\d+[ä»¶æ¡ç±³å¨]/,  // åŒ¹é…æ•°é‡å•ä½
      /æ¬¾å¼|å‹å·|è§„æ ¼|å°ºå¯¸|é¢œè‰²|æˆåˆ†/,  // åŒ¹é…äº§å“å±æ€§
      /ç‰Œ|å“ç‰Œ|å‚å®¶|ç”Ÿäº§å•†/,  // åŒ¹é…å“ç‰Œä¿¡æ¯
      /ä»·æ ¼|æŠ¥ä»·|å…ƒ\/[ç±³ä»¶æ¡]/  // åŒ¹é…ä»·æ ¼ä¿¡æ¯
    ];
    
    return patterns.some(pattern => pattern.test(message));
  }
  
  // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½è·å–ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•
  function getNextSteps(stageId, stageStatus, trackingData) {
    const wechatContact = '<strong>JJ1598929032</strong>';
    const isSeller = trackingData.isSeller;
    const isBuyer = trackingData.isBuyer;
    
    // å¦‚æœé˜¶æ®µå·²å®Œæˆï¼Œè¿”å›ç©ºæ­¥éª¤åˆ—è¡¨
    if (stageStatus === 'completed') {
      return [`æ­¤é˜¶æ®µå·²å®Œæˆï¼Œè¯·ç»§ç»­æ¨è¿›ä¸‹ä¸€é˜¶æ®µ`, `å¦‚æœ‰é—®é¢˜è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å’¨è¯¢`];
    }
    
    // å¦‚æœé˜¶æ®µæœªå¼€å§‹ï¼Œè¿”å›ç­‰å¾…æŒ‡å¼•
    if (stageStatus === 'pending') {
      return [`è¯·ç­‰å¾…å‰åºé˜¶æ®µå®Œæˆåå†è¿›è¡Œæ­¤é˜¶æ®µ`, `å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`];
    }
    
    // é˜¶æ®µå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæ ¹æ®ä¸åŒæƒ…å†µè¿”å›æŒ‡å¼•
    if (isSeller) {
      switch(stageId) {
        case 1:
          return [
            `è¯¦ç»†æè¿°æ‚¨è¦å‡ºå”®çš„äº§å“ç±»å‹ã€æ•°é‡å’ŒæœŸæœ›ä»·æ ¼`,
            `æä¾›äº§å“å›¾ç‰‡æˆ–è¯¦ç»†è§„æ ¼è¯´æ˜`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
          ];
        case 2:
          return [
            `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…æ½œåœ¨ä¹°å®¶`,
            `å®Œå–„æ‚¨çš„äº§å“ç»†èŠ‚ä¿¡æ¯ä»¥æé«˜åŒ¹é…ç‡`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
          ];
        case 3:
          return [
            `å‡†å¤‡å¥½è¯¦ç»†çš„äº§å“è¯´æ˜å’Œä»·æ ¼èµ„æ–™`,
            `ç¡®è®¤æ‚¨çš„å‘è´§èƒ½åŠ›å’Œåº“å­˜æƒ…å†µ`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£ä¹°å®¶éœ€æ±‚ç»†èŠ‚`
          ];
        case 4:
          return [
            `å‡†å¤‡è¯¦ç»†çš„äº§å“èµ„æ–™å’ŒæŠ¥ä»·å•`,
            `ç¡®è®¤æ‚¨çš„ä»“åº“åº“å­˜å’Œç‰©æµé…é€æ–¹æ¡ˆ`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸ä¹°å®¶ç›´æ¥æ²Ÿé€š`
          ];
        case 5:
          return [
            `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œä»˜æ¬¾æ–¹å¼`,
            `å‡†å¤‡äº§å“å‘è´§å’Œå”®åæœåŠ¡æ–¹æ¡ˆ`,
            `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
          ];
        default:
          return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
      }
    } else if (isBuyer) {
      switch(stageId) {
        case 1:
          return [
            `è¯¦ç»†æè¿°æ‚¨éœ€è¦çš„äº§å“ç±»å‹ã€æ•°é‡å’Œé¢„ç®—`,
            `è¯´æ˜æ‚¨å¯¹äº§å“è´¨é‡å’Œè§„æ ¼çš„è¦æ±‚`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
          ];
        case 2:
          return [
            `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…åˆé€‚åº“å­˜`,
            `å®Œå–„æ‚¨çš„éœ€æ±‚ç»†èŠ‚ä»¥æé«˜åŒ¹é…ç²¾å‡†åº¦`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
          ];
        case 3:
          return [
            `å‡†å¤‡å¥½ä¸å–å®¶æ²Ÿé€šçš„å…·ä½“é—®é¢˜`,
            `ç¡®è®¤æ‚¨çš„é‡‡è´­é¢„ç®—å’Œä»˜æ¬¾æ–¹å¼`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£å–å®¶ç¡®è®¤è¿›åº¦`
          ];
        case 4:
          return [
            `ä»”ç»†è¯„ä¼°å–å®¶æä¾›çš„äº§å“ä¿¡æ¯`,
            `ç¡®è®¤äº§å“æ˜¯å¦æ»¡è¶³æ‚¨çš„éœ€æ±‚`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸å–å®¶ç›´æ¥æ²Ÿé€š`
          ];
        case 5:
          return [
            `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œæ”¶è´§åœ°å€`,
            `å‡†å¤‡ä»˜æ¬¾å’ŒéªŒæ”¶äº§å“`,
            `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
          ];
        default:
          return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
      }
    } else {
      // ç”¨æˆ·èº«ä»½æœªç¡®å®š
      switch(stageId) {
        case 1:
          return [
            `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨æ˜¯å¸Œæœ›å‡ºå”®è¿˜æ˜¯é‡‡è´­`,
            `è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚æˆ–äº§å“ä¿¡æ¯`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–ä¸“ä¸šæŒ‡å¯¼`
          ];
        default:
          return [
            `è¯·å…ˆæ˜ç¡®æ‚¨çš„èº«ä»½ï¼ˆä¹°å®¶/å–å®¶ï¼‰`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©`
          ];
      }
    }
  }
  
  // ä¸ºåŠ¨ç”»æ·»åŠ ç¨³å®šæ€§ä¿®å¤
  function animateStats() {
    const statValues = document.querySelectorAll('.stat-value');
    
    statValues.forEach(statValue => {
      const targetValue = parseInt(statValue.textContent, 10);
      let currentValue = 0;
      const duration = 2000;
      const stepTime = 20;
      const totalSteps = duration / stepTime;
      const stepValue = targetValue / totalSteps;
      
      function updateValue() {
        currentValue += stepValue;
        
        if (currentValue < targetValue) {
          statValue.textContent = Math.floor(currentValue);
          requestAnimationFrame(updateValue);
        } else {
          statValue.textContent = targetValue;
          
          // æ·»åŠ ä»¥é˜²æ­¢æ•°å­—å˜åŒ–å¯¼è‡´å¸ƒå±€ç§»åŠ¨
          statValue.style.minWidth = statValue.offsetWidth + 'px';
        }
      }
      
      // å½“å…ƒç´ è¿›å…¥è§†å£æ—¶å¯åŠ¨åŠ¨ç”»
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            updateValue();
            observer.unobserve(entry.target);
          }
        });
      });
      
      observer.observe(statValue);
    });
  }
  
  // å¯¼èˆªæ åˆå§‹åŒ–ä¸æ»šåŠ¨æ•ˆæœ
  function initNavbar() {
    const navbar = document.querySelector('.navbar');
    
    // æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', function() {
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });
    
    // å¯¼èˆªèœå•é¡¹ç‚¹å‡»æ¿€æ´»æ•ˆæœ
    const navLinks = document.querySelectorAll('.main-nav a');
    
    navLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        // è·å–ç›®æ ‡éƒ¨åˆ†çš„ID
        const targetId = this.getAttribute('href');
        
        // ä»…å¯¹é¡µå†…é”šç‚¹é“¾æ¥è¿›è¡Œå¤„ç†
        if (targetId.startsWith('#')) {
          e.preventDefault();
          
          const targetSection = document.querySelector(targetId);
          
          if (targetSection) {
            // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡éƒ¨åˆ†
            window.scrollTo({
              top: targetSection.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
              behavior: 'smooth'
            });
            
            // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
            history.pushState(null, null, targetId);
            
            // ç§»é™¤æ‰€æœ‰activeç±»
            navLinks.forEach(item => {
              item.parentElement.classList.remove('active');
            });
            
            // ä¸ºå½“å‰ç‚¹å‡»é¡¹æ·»åŠ activeç±»
            this.parentElement.classList.add('active');
          }
        }
      });
    });
  }
  
  // æ·»åŠ æ»šåŠ¨ç›‘å¬ï¼Œé«˜äº®å½“å‰è§†å›¾ä¸­çš„éƒ¨åˆ†
  function initScrollSpy() {
    // è·å–æ‰€æœ‰ä¸»è¦éƒ¨åˆ†
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.main-nav a');
    
    // æ·»åŠ æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', function() {
      // å½“å‰æ»šåŠ¨ä½ç½®
      const scrollPosition = window.scrollY + 100; // æ·»åŠ ä¸€äº›åç§»ä»¥æå‰æ¿€æ´»
      
      // æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†çš„ä½ç½®
      sections.forEach(section => {
        // è·å–éƒ¨åˆ†çš„é¡¶éƒ¨å’Œåº•éƒ¨ä½ç½®
        const sectionTop = section.offsetTop;
        const sectionBottom = sectionTop + section.offsetHeight;
        
        // æ£€æŸ¥å½“å‰æ»šåŠ¨ä½ç½®æ˜¯å¦åœ¨è¯¥éƒ¨åˆ†
        if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
          // æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé“¾æ¥
          const targetId = '#' + section.getAttribute('id');
          
          // ç§»é™¤æ‰€æœ‰activeç±»
          navLinks.forEach(link => {
            link.parentElement.classList.remove('active');
            
            // ä¸ºå½“å‰éƒ¨åˆ†çš„é“¾æ¥æ·»åŠ activeç±»
            if (link.getAttribute('href') === targetId) {
              link.parentElement.classList.add('active');
            }
          });
        }
      });
    });
  }
  
  // å¹³æ»‘æ»šåŠ¨æ•ˆæœ
  function addSmoothScrolling() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        const targetId = this.getAttribute('href');
        
        if (targetId === '#') return;
        
        const target = document.querySelector(targetId);
        
        if (target) {
          e.preventDefault();
          
          window.scrollTo({
            top: target.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
            behavior: 'smooth'
          });
          
          // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
          history.pushState(null, null, targetId);
        }
      });
    });
  }
  
  // åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
  function initDarkMode() {
    const darkModeToggle = document.querySelector('.dark-mode-toggle');
    if (darkModeToggle) {
      darkModeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
          this.textContent = 'â˜€ï¸';
        } else {
          this.textContent = 'ğŸŒ™';
        }
      });
    }
  }
});
  
  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  function initTrackingPanel() {
    const trackingPanel = document.querySelector('.process-flow');
    if (!trackingPanel) return;
  
    // åˆå§‹åŒ–è¿›åº¦æµç¨‹å›¾ - ä»localStorageè·å–å½“å‰çŠ¶æ€
    let currentTrackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è·Ÿè¸ªæ•°æ®æˆ–è€…æ˜¯æ–°ä¼šè¯ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
    if (!currentTrackingData) {
      currentTrackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
      
      // ä¿å­˜åˆå§‹æ•°æ®
      localStorage.setItem('trackingData', JSON.stringify(currentTrackingData));
    }
    
    // æ¸…ç©ºé»˜è®¤å†…å®¹
    trackingPanel.innerHTML = '';
    
    // åˆ›å»ºè¿›åº¦æ¡
    const progressBar = document.createElement('div');
    progressBar.classList.add('progress-bar');
    
    // æ·»åŠ å„ä¸ªé˜¶æ®µ
    currentTrackingData.stages.forEach(stage => {
      const stageElement = document.createElement('div');
      stageElement.classList.add('progress-stage', `status-${stage.status}`);
      stageElement.dataset.stageId = stage.id;
      
      const stageNumber = document.createElement('div');
      stageNumber.classList.add('stage-number');
      stageNumber.textContent = stage.id;
      
      const stageName = document.createElement('div');
      stageName.classList.add('stage-name');
      stageName.textContent = stage.name;
      
      stageElement.appendChild(stageNumber);
      stageElement.appendChild(stageName);
      
      // ç‚¹å‡»é˜¶æ®µæ˜¾ç¤ºè¯¦æƒ…
      stageElement.addEventListener('click', () => showStageDetail(stage, currentTrackingData));
      
      progressBar.appendChild(stageElement);
      
      // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€ä¸ªé˜¶æ®µï¼‰
      if (stage.id < currentTrackingData.stages.length) {
        const connector = document.createElement('div');
        connector.classList.add('stage-connector', `status-${stage.status}`);
        progressBar.appendChild(connector);
      }
    });
    
    trackingPanel.appendChild(progressBar);
    
    // æ·»åŠ è¯´æ˜æ–‡å­—
    const statusInfo = document.createElement('div');
    statusInfo.classList.add('status-info');
    
    // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„é˜¶æ®µ
    const activeStage = currentTrackingData.stages.find(stage => stage.status === 'active');
    const stageName = activeStage ? activeStage.name : 'å‡†å¤‡ä¸­';
    
    // è®¡ç®—æœ€åæ›´æ–°æ—¶é—´
    const lastUpdateTime = getTimeDifference(new Date(currentTrackingData.lastUpdated), new Date());
    
    statusInfo.innerHTML = `å½“å‰çŠ¶æ€ï¼š<span class="status-active">${stageName}</span> Â· æ›´æ–°äº ${lastUpdateTime}`;
    trackingPanel.appendChild(statusInfo);
    
    // æ·»åŠ è¿›åº¦æ¦‚è¦
    const progressSummary = document.createElement('div');
    progressSummary.classList.add('progress-summary');
    
    // æ ¹æ®ç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒçš„è¿›åº¦æ¦‚è¦
    const isSeller = currentTrackingData.isSeller;
    const isBuyer = currentTrackingData.isBuyer;
    
    // è·å–ä¹°å–éœ€æ±‚ç±»å‹
    const needTypeDisplay = currentTrackingData.needType ? currentTrackingData.needType : 'ç­‰å¾…ç¡®è®¤';
    const productTypeDisplay = currentTrackingData.productType ? currentTrackingData.productType : 'ç­‰å¾…ç¡®è®¤';
    
    let summaryHTML = '';
    if (isSeller) {
      summaryHTML = `
        <h4>å‡ºå”®ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>å•†å“ç±»å‹: ${productTypeDisplay}</li>
          <li>åº“å­˜æ•°é‡: ${currentTrackingData.quantity || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else if (isBuyer) {
      summaryHTML = `
        <h4>é‡‡è´­ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>éœ€æ±‚ç±»å‹: ${needTypeDisplay}</li>
          <li>äº§å“ç±»å‹: ${productTypeDisplay}</li>
          <li>é¢„ç®—èŒƒå›´: ${currentTrackingData.budgetRange || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else {
      summaryHTML = `
        <h4>å¯¹æ¥ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>è¯·åœ¨èŠå¤©ä¸­è¯´æ˜æ‚¨æ˜¯éœ€è¦å‡ºå”®è¿˜æ˜¯é‡‡è´­</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    }
    
    progressSummary.innerHTML = summaryHTML;
    trackingPanel.appendChild(progressSummary);
    
    // æ·»åŠ åˆ·æ–°æŒ‰é’®
    const refreshButton = document.createElement('button');
    refreshButton.classList.add('refresh-tracking');
    refreshButton.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
    refreshButton.addEventListener('click', function() {
      // è¯·æ±‚å¹³å°æ›´æ–°è¿›åº¦
      updateTrackingProgress();
      
      // æ·»åŠ åˆ·æ–°åŠ¨ç”»
      this.classList.add('refreshing');
      // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
      this.textContent = 'æ­£åœ¨è¯·æ±‚å¹³å°ç¡®è®¤...';
      setTimeout(() => {
        this.classList.remove('refreshing');
        this.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
      }, 2000);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤è¯´æ˜
    const confirmNote = document.createElement('div');
    confirmNote.classList.add('platform-note');
    confirmNote.innerHTML = 'æç¤ºï¼šæ‰€æœ‰è¿›åº¦æ›´æ–°éœ€è¦å¹³å°ç¡®è®¤åæ‰èƒ½ç”Ÿæ•ˆ';
    
    trackingPanel.appendChild(refreshButton);
    trackingPanel.appendChild(confirmNote);
  }
  
  // æ ¹æ®èŠå¤©å†…å®¹æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingFromChat(message, isSeller, isBuyer) {
    // è·å–å½“å‰è¿›åº¦æ•°æ®
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) {
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
      trackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
    }
    
    // æ›´æ–°ä¹°å–èº«ä»½
    if (isSeller !== undefined) {
      trackingData.isSeller = isSeller;
    }
    
    if (isBuyer !== undefined) {
      trackingData.isBuyer = isBuyer;
    }
    
    // å¤„ç†é˜¶æ®µ1ï¼šéœ€æ±‚æäº¤
    if (trackingData.stages[0].status !== 'completed') {
      // åªè¦æœ‰æ¶ˆæ¯ï¼Œå°±è®¤ä¸ºéœ€æ±‚å·²æäº¤
      trackingData.stages[0].status = 'completed';
      trackingData.stages[0].timestamp = new Date().toISOString();
      
      // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
      trackingData.stages[1].status = 'active';
      trackingData.currentStage = 2;
    }
    
    // æå–äº§å“ç±»å‹ä¿¡æ¯
    const productTypes = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›', 'å°¼é¾™', 'æ¶¤çº¶'];
    for (const type of productTypes) {
      if (message.includes(type)) {
        trackingData.productType = type;
        break;
      }
    }
    
    // æå–éœ€æ±‚ç±»å‹
    if (message.includes('é¢æ–™') || message.includes('å¸ƒæ–™') || message.includes('å¸ƒ')) {
      trackingData.needType = 'é¢æ–™';
    } else if (message.includes('æœè£…') || message.includes('è¡£æœ') || message.includes('æˆè¡£')) {
      trackingData.needType = 'æœè£…';
    }
    
    // æå–æ•°é‡ä¿¡æ¯
    const quantityMatch = message.match(/(\d+)([ä»¶æ¡ç±³å¨ä¸ª])/);
    if (quantityMatch) {
      trackingData.quantity = quantityMatch[0];
    }
    
    // æå–ä»·æ ¼/é¢„ç®—ä¿¡æ¯
    if (message.includes('ä»·æ ¼') || message.includes('å¤šå°‘é’±') || message.includes('é¢„ç®—')) {
      const priceMatch = message.match(/(\d+)[-~åˆ°è‡³](\d+)[å…ƒå—]/);
      if (priceMatch) {
        trackingData.budgetRange = priceMatch[0];
      }
    }
    
    // é˜¶æ®µ2ï¼šåŒ¹é…åº“å­˜ - æ ¹æ®å…³é”®è¯åˆ¤æ–­
    if (trackingData.currentStage === 2 && trackingData.stages[1].status === 'active') {
      // å½“ç”¨æˆ·æä¾›äº†å…·ä½“çš„äº§å“å’Œéœ€æ±‚ç±»å‹æ—¶ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€é˜¶æ®µ
      if (trackingData.productType && trackingData.needType) {
        if (message.includes('åŒ¹é…') || message.includes('åº“å­˜') || message.includes('èµ„æº') || 
            message.includes('æ‰¾åˆ°') || message.includes('æœ‰è´§') || containsSpecificProductInfo(message)) {
          trackingData.stages[1].status = 'completed';
          trackingData.stages[1].timestamp = new Date().toISOString();
          
          // æ ¹æ®ç”¨æˆ·èº«ä»½å†³å®šä¸‹ä¸€æ­¥
          if (trackingData.isSeller) {
            // å–å®¶å¯»æ‰¾ä¹°å®¶ï¼Œè¿›å…¥åˆ°ä¹°å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[3].status = 'active';
            trackingData.currentStage = 4;
          } else if (trackingData.isBuyer) {
            // ä¹°å®¶å¯»æ‰¾å–å®¶ï¼Œè¿›å…¥åˆ°å–å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[2].status = 'active';
            trackingData.currentStage = 3;
          }
        }
      }
    }
    
    // é˜¶æ®µ3ï¼šå–å®¶ç¡®è®¤
    if (trackingData.currentStage === 3 && trackingData.stages[2].status === 'active') {
      if (message.includes('å–å®¶ç¡®è®¤') || message.includes('ä¾›åº”å•†ç¡®è®¤') || message.includes('å·²ç¡®è®¤') || 
          message.includes('å¯ä»¥ä¾›åº”') || message.includes('æœ‰åº“å­˜')) {
        trackingData.stages[2].status = 'completed';
        trackingData.stages[2].timestamp = new Date().toISOString();
        
        // è¿›å…¥ä¹°å®¶ç¡®è®¤é˜¶æ®µ
        trackingData.stages[3].status = 'active';
        trackingData.currentStage = 4;
      }
    }
    
    // é˜¶æ®µ4ï¼šä¹°å®¶ç¡®è®¤
    if (trackingData.currentStage === 4 && trackingData.stages[3].status === 'active') {
      if (message.includes('ä¹°å®¶ç¡®è®¤') || message.includes('å®¢æˆ·ç¡®è®¤') || message.includes('ç¡®è®¤è´­ä¹°') || 
          message.includes('æ¥å—') || message.includes('æ»¡æ„')) {
        trackingData.stages[3].status = 'completed';
        trackingData.stages[3].timestamp = new Date().toISOString();
        
        // è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µ
        trackingData.stages[4].status = 'active';
        trackingData.currentStage = 5;
      }
    }
    
    // é˜¶æ®µ5ï¼šç¡®è®¤å¯¹æ¥
    if (trackingData.currentStage === 5 && trackingData.stages[4].status === 'active') {
      if (message.includes('äº¤æ˜“æˆåŠŸ') || message.includes('å·²å¯¹æ¥') || message.includes('æˆäº¤') || 
          message.includes('å·²å®Œæˆ') || message.includes('æ„Ÿè°¢åˆä½œ')) {
        trackingData.stages[4].status = 'completed';
        trackingData.stages[4].timestamp = new Date().toISOString();
      }
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    trackingData.lastUpdated = new Date().toISOString();
    
    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(trackingData));
    
    // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
    initTrackingPanel();
  }
  
  // æ˜¾ç¤ºé˜¶æ®µè¯¦ç»†ä¿¡æ¯
  function showStageDetail(stage, trackingData) {
    const wechatContact = '<strong>JJ1598929032</strong>';
    const modal = document.createElement('div');
    modal.classList.add('progress-modal');
    
    const modalContent = document.createElement('div');
    modalContent.classList.add('modal-content');
    
    // æ·»åŠ å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.classList.add('close-modal');
    closeBtn.innerHTML = '&times;';
    closeBtn.addEventListener('click', function() {
      document.body.removeChild(modal);
    });
    
    // é˜¶æ®µè¯¦æƒ…å†…å®¹
    const stageContent = document.createElement('div');
    stageContent.classList.add('stage-detail');
    
    const stageTitle = document.createElement('h3');
    stageTitle.innerHTML = `é˜¶æ®µ ${stage.id}: ${stage.name} <span class="stage-status status-${stage.status}">${getStatusText(stage.status)}</span>`;
    
    const stageTimestamp = document.createElement('div');
    stageTimestamp.classList.add('stage-timestamp');
    if (stage.timestamp) {
      const date = new Date(stage.timestamp);
      stageTimestamp.textContent = `æ›´æ–°æ—¶é—´: ${formatDateTime(date)}`;
    } else {
      stageTimestamp.textContent = 'å°šæœªå¼€å§‹';
    }
    
    const stageDescription = document.createElement('p');
    let descriptionText = '';
    
    // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒå†…å®¹
    const isSeller = trackingData.isSeller;
    const isBuyer = trackingData.isBuyer;
    
    switch(stage.id) {
      case 1:
        if (stage.status === 'completed') {
          descriptionText = `æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : ''}éœ€æ±‚å·²æˆåŠŸæäº¤ï¼æˆ‘ä»¬çš„ç³»ç»Ÿæ­£åœ¨è¿›è¡Œåˆæ­¥åˆ†æï¼Œä»¥ä¾¿æ›´å¥½åœ°åŒ¹é…åˆé€‚çš„${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚å¦‚éœ€è¡¥å……å…·ä½“è¦æ±‚æˆ–æŸ¥è¯¢è¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : 'éœ€æ±‚'}æ„å‘ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚æ‚¨å¯ä»¥éšæ—¶æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©ã€‚`;
        }
        break;
      case 2:
        if (stage.status === 'completed') {
          descriptionText = `ç³»ç»Ÿå·²æˆåŠŸä¸ºæ‚¨åŒ¹é…åˆ°ç¬¦åˆè¦æ±‚çš„${isSeller ? 'æ½œåœ¨ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚ç°åœ¨è¿›å…¥${isSeller ? 'ä¹°å®¶' : 'å–å®¶'}ç¡®è®¤é˜¶æ®µã€‚å¦‚éœ€äº†è§£åŒ¹é…è¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `ç³»ç»Ÿæ­£åœ¨æ ¹æ®æ‚¨æä¾›çš„è¦æ±‚åŒ¹é…${isSeller ? 'ä¹°å®¶èµ„æº' : 'åº“å­˜'}ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦12å°æ—¶å†…å®Œæˆã€‚å¦‚éœ€åŠ å¿«è¿›åº¦æˆ–æä¾›æ›´è¯¦ç»†çš„éœ€æ±‚ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨éœ€æ±‚æäº¤åè‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚`;
        }
        break;
      case 3:
        if (stage.status === 'completed') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç°åœ¨ç­‰å¾…ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `æˆ‘ä»¬å·²æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„åº“å­˜ï¼Œæ­£åœ¨ç­‰å¾…å–å®¶ç¡®è®¤ã€‚é€šå¸¸ä¼šåœ¨24å°æ—¶å†…å¾—åˆ°å›å¤ã€‚å¦‚æƒ³ä¼˜å…ˆå¤„ç†æˆ–äº†è§£æ›´å¤šè¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨åŒ¹é…åˆ°åˆé€‚åº“å­˜åè”ç³»å–å®¶ç¡®è®¤ã€‚`;
        }
        break;
      case 4:
        if (stage.status === 'completed') {
          descriptionText = `ä¹°å®¶å·²ç¡®è®¤è´­ä¹°æ„å‘ï¼Œç°åœ¨è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µã€‚è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆäº¤æ˜“ç»†èŠ‚ç¡®è®¤ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç­‰å¾…æ‚¨çš„æœ€ç»ˆç¡®è®¤ã€‚ä¸ºç¡®ä¿äº¤æ˜“é¡ºåˆ©è¿›è¡Œï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¿›è¡Œåç»­æ²Ÿé€š`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨å–å®¶ç¡®è®¤åè”ç³»ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚`;
        }
        break;
      case 5:
        if (stage.status === 'completed') {
          descriptionText = `æ­å–œï¼äº¤æ˜“å·²æˆåŠŸå¯¹æ¥ã€‚è¯·é€šè¿‡å¾®ä¿¡ï¼š${wechatContact} å®Œæˆåç»­äº¤æ˜“æµç¨‹ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `æ­å–œï¼åŒæ–¹å·²è¾¾æˆå¯¹æ¥æ„å‘ã€‚ä¸ºä¿éšœäº¤æ˜“å®‰å…¨å’Œé¡ºåˆ©å®Œæˆåç»­æµç¨‹ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–è¯¦ç»†æŒ‡å¯¼`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨ä¹°å®¶ç¡®è®¤åè¿›å…¥æœ€ç»ˆå¯¹æ¥ç¡®è®¤é˜¶æ®µã€‚`;
        }
        break;
      default:
        descriptionText = `å½“å‰é˜¶æ®µçŠ¶æ€æ›´æ–°ä¸­ã€‚å¦‚éœ€åŠæ—¶äº†è§£æœ€æ–°è¿›å±•ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
    }
    
    stageDescription.innerHTML = descriptionText;
    
    const nextStepsTitle = document.createElement('h4');
    nextStepsTitle.textContent = 'ä¸‹ä¸€æ­¥æ“ä½œ';
    
    const nextStepsList = document.createElement('ul');
    const nextSteps = getNextSteps(stage.id, stage.status, trackingData);
    
    nextSteps.forEach(step => {
      const listItem = document.createElement('li');
      listItem.innerHTML = step;
      nextStepsList.appendChild(listItem);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤æç¤º
    const platformConfirmNote = document.createElement('div');
    platformConfirmNote.classList.add('platform-confirmation-note');
    platformConfirmNote.innerHTML = `<i>æ³¨æ„ï¼šå¯¹æ¥è¿›åº¦ç”±å¹³å°æ ¹æ®å®é™…æƒ…å†µç¡®è®¤æ›´æ–°ï¼Œé˜¶æ®µè¿›åº¦æ— æ³•æ‰‹åŠ¨ä¿®æ”¹ã€‚å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}</i>`;
    
    stageContent.appendChild(stageTitle);
    stageContent.appendChild(stageTimestamp);
    stageContent.appendChild(stageDescription);
    stageContent.appendChild(nextStepsTitle);
    stageContent.appendChild(nextStepsList);
    stageContent.appendChild(platformConfirmNote);
    
    modalContent.appendChild(closeBtn);
    modalContent.appendChild(stageContent);
    modal.appendChild(modalContent);
    
    document.body.appendChild(modal);
  }
  
  // æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingProgress() {
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) return;
    
    // è·å–å½“å‰æ´»è·ƒé˜¶æ®µ
    let currentActiveIndex = trackingData.stages.findIndex(stage => stage.status === 'active');
    
    // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­æ¶ˆæ¯
    showProgressUpdateMessage();
    
    // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤è¿‡ç¨‹ï¼ˆå®é™…ç¯å¢ƒä¸­åº”é€šè¿‡åç«¯APIè·å–ç¡®è®¤ç»“æœï¼‰
    setTimeout(() => {
      // å¹³å°å®¡æ ¸ç¡®è®¤åï¼Œæ›´æ–°è¿›åº¦
      // æ³¨æ„ï¼šåœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªç¡®è®¤è¿‡ç¨‹åº”è¯¥æ¥è‡ªæœåŠ¡å™¨
      const platformConfirmed = Math.random() > 0.5; // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤ç»“æœ
      
      if (platformConfirmed && currentActiveIndex !== -1 && currentActiveIndex < trackingData.stages.length - 1) {
        // å½“å‰é˜¶æ®µå®Œæˆ
        trackingData.stages[currentActiveIndex].status = 'completed';
        trackingData.stages[currentActiveIndex].timestamp = new Date().toISOString();
        
        // ä¸‹ä¸€é˜¶æ®µæ¿€æ´»
        trackingData.stages[currentActiveIndex + 1].status = 'active';
        trackingData.currentStage = currentActiveIndex + 2; // +2æ˜¯å› ä¸ºstage idä»1å¼€å§‹
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showNotification("è¿›åº¦å·²æ›´æ–°", "å¹³å°å·²ç¡®è®¤æ‚¨çš„è¿›åº¦æ›´æ–°", "success");
      } else {
        // å¹³å°æœªç¡®è®¤
        showNotification("è¿›åº¦æ›´æ–°ç­‰å¾…ä¸­", "æ‚¨çš„è¿›åº¦æ›´æ–°è¯·æ±‚æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤", "info");
      }
      
      // éšæœºæ›´æ–°å…¶ä»–ä¿¡æ¯
      if (!trackingData.productType && Math.random() > 0.7) {
        const products = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›'];
        trackingData.productType = products[Math.floor(Math.random() * products.length)];
      }
      
      if (!trackingData.needType && Math.random() > 0.7) {
        trackingData.needType = Math.random() > 0.5 ? 'é¢æ–™' : 'æœè£…';
      }
      
      if (!trackingData.quantity && trackingData.isSeller && Math.random() > 0.7) {
        const units = ['ä»¶', 'ç±³', 'æ¡'];
        trackingData.quantity = `${Math.floor(Math.random() * 1000) + 10}${units[Math.floor(Math.random() * units.length)]}`;
      }
      
      if (!trackingData.budgetRange && trackingData.isBuyer && Math.random() > 0.7) {
        const min = Math.floor(Math.random() * 500) + 50;
        const max = min + Math.floor(Math.random() * 500) + 50;
        trackingData.budgetRange = `${min}-${max}å…ƒ`;
      }
      
      // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
      trackingData.lastUpdated = new Date().toISOString();
      
      // ä¿å­˜æ›´æ–°åçš„æ•°æ®
      localStorage.setItem('trackingData', JSON.stringify(trackingData));
      
      // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿
      initTrackingPanel();
    }, 2000); // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤å»¶è¿Ÿ
  }
  
  // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­çš„æ¶ˆæ¯
  function showProgressUpdateMessage() {
    const notification = document.createElement('div');
    notification.classList.add('progress-notification', 'updating');
    notification.innerHTML = `
      <div class="notification-icon">
        <div class="loading-spinner"></div>
      </div>
      <div class="notification-content">
        <h4>è¿›åº¦æ›´æ–°è¯·æ±‚å·²æäº¤</h4>
        <p>æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...</p>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // 1.5ç§’åç§»é™¤é€šçŸ¥
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 1500);
  }
  
  // æ˜¾ç¤ºé€šçŸ¥
  function showNotification(title, message, type = "info") {
    const notification = document.createElement('div');
    notification.classList.add('progress-notification', type);
    
    let icon = '';
    if (type === 'success') {
      icon = '<div class="notification-icon success">âœ“</div>';
    } else if (type === 'error') {
      icon = '<div class="notification-icon error">âœ—</div>';
    } else {
      icon = '<div class="notification-icon info">i</div>';
    }
    
    notification.innerHTML = `
      ${icon}
      <div class="notification-content">
        <h4>${title}</h4>
        <p>${message}</p>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’åç§»é™¤é€šçŸ¥
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 3000);
  }
  
  // è·å–çŠ¶æ€æ–‡æœ¬æè¿°
  function getStatusText(status) {
    switch(status) {
      case 'pending': return 'ç­‰å¾…ä¸­';
      case 'active': return 'è¿›è¡Œä¸­';
      case 'completed': return 'å·²å®Œæˆ';
      default: return 'æœªçŸ¥çŠ¶æ€';
    }
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
  function formatDateTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day} ${hours}:${minutes}`;
  }
  
  // è·å–æ—¶é—´å·®å¼‚çš„å‹å¥½æè¿°
  function getTimeDifference(oldDate, newDate) {
    const diffMs = newDate - oldDate;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffSec < 60) {
      return 'åˆšåˆš';
    } else if (diffMin < 60) {
      return `${diffMin}åˆ†é’Ÿå‰`;
    } else if (diffHour < 24) {
      return `${diffHour}å°æ—¶å‰`;
    } else if (diffDay < 30) {
      return `${diffDay}å¤©å‰`;
    } else {
      const month = String(oldDate.getMonth() + 1).padStart(2, '0');
      const day = String(oldDate.getDate()).padStart(2, '0');
      return `${month}-${day}`;
    }
  }
  
  // è·å–å·²å®Œæˆé˜¶æ®µçš„æ•°é‡
  function getCompletedStages(stages) {
    return stages.filter(stage => stage.status === 'completed').length;
  }
  
  // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åŒ…å«å…·ä½“äº§å“ä¿¡æ¯
  function containsSpecificProductInfo(message) {
    // åŒ¹é…å…·ä½“çš„äº§å“æè¿°
    const patterns = [
      /\d+[ä»¶æ¡ç±³å¨]/,  // åŒ¹é…æ•°é‡å•ä½
      /æ¬¾å¼|å‹å·|è§„æ ¼|å°ºå¯¸|é¢œè‰²|æˆåˆ†/,  // åŒ¹é…äº§å“å±æ€§
      /ç‰Œ|å“ç‰Œ|å‚å®¶|ç”Ÿäº§å•†/,  // åŒ¹é…å“ç‰Œä¿¡æ¯
      /ä»·æ ¼|æŠ¥ä»·|å…ƒ\/[ç±³ä»¶æ¡]/  // åŒ¹é…ä»·æ ¼ä¿¡æ¯
    ];
    
    return patterns.some(pattern => pattern.test(message));
  }
  
  // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½è·å–ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•
  function getNextSteps(stageId, stageStatus, trackingData) {
    const wechatContact = '<strong>JJ1598929032</strong>';
    const isSeller = trackingData.isSeller;
    const isBuyer = trackingData.isBuyer;
    
    // å¦‚æœé˜¶æ®µå·²å®Œæˆï¼Œè¿”å›ç©ºæ­¥éª¤åˆ—è¡¨
    if (stageStatus === 'completed') {
      return [`æ­¤é˜¶æ®µå·²å®Œæˆï¼Œè¯·ç»§ç»­æ¨è¿›ä¸‹ä¸€é˜¶æ®µ`, `å¦‚æœ‰é—®é¢˜è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å’¨è¯¢`];
    }
    
    // å¦‚æœé˜¶æ®µæœªå¼€å§‹ï¼Œè¿”å›ç­‰å¾…æŒ‡å¼•
    if (stageStatus === 'pending') {
      return [`è¯·ç­‰å¾…å‰åºé˜¶æ®µå®Œæˆåå†è¿›è¡Œæ­¤é˜¶æ®µ`, `å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`];
    }
    
    // é˜¶æ®µå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæ ¹æ®ä¸åŒæƒ…å†µè¿”å›æŒ‡å¼•
    if (isSeller) {
      switch(stageId) {
        case 1:
          return [
            `è¯¦ç»†æè¿°æ‚¨è¦å‡ºå”®çš„äº§å“ç±»å‹ã€æ•°é‡å’ŒæœŸæœ›ä»·æ ¼`,
            `æä¾›äº§å“å›¾ç‰‡æˆ–è¯¦ç»†è§„æ ¼è¯´æ˜`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
          ];
        case 2:
          return [
            `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…æ½œåœ¨ä¹°å®¶`,
            `å®Œå–„æ‚¨çš„äº§å“ç»†èŠ‚ä¿¡æ¯ä»¥æé«˜åŒ¹é…ç‡`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
          ];
        case 3:
          return [
            `å‡†å¤‡å¥½è¯¦ç»†çš„äº§å“è¯´æ˜å’Œä»·æ ¼èµ„æ–™`,
            `ç¡®è®¤æ‚¨çš„å‘è´§èƒ½åŠ›å’Œåº“å­˜æƒ…å†µ`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£ä¹°å®¶éœ€æ±‚ç»†èŠ‚`
          ];
        case 4:
          return [
            `å‡†å¤‡è¯¦ç»†çš„äº§å“èµ„æ–™å’ŒæŠ¥ä»·å•`,
            `ç¡®è®¤æ‚¨çš„ä»“åº“åº“å­˜å’Œç‰©æµé…é€æ–¹æ¡ˆ`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸ä¹°å®¶ç›´æ¥æ²Ÿé€š`
          ];
        case 5:
          return [
            `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œä»˜æ¬¾æ–¹å¼`,
            `å‡†å¤‡äº§å“å‘è´§å’Œå”®åæœåŠ¡æ–¹æ¡ˆ`,
            `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
          ];
        default:
          return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
      }
    } else if (isBuyer) {
      switch(stageId) {
        case 1:
          return [
            `è¯¦ç»†æè¿°æ‚¨éœ€è¦çš„äº§å“ç±»å‹ã€æ•°é‡å’Œé¢„ç®—`,
            `è¯´æ˜æ‚¨å¯¹äº§å“è´¨é‡å’Œè§„æ ¼çš„è¦æ±‚`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
          ];
        case 2:
          return [
            `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…åˆé€‚åº“å­˜`,
            `å®Œå–„æ‚¨çš„éœ€æ±‚ç»†èŠ‚ä»¥æé«˜åŒ¹é…ç²¾å‡†åº¦`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
          ];
        case 3:
          return [
            `å‡†å¤‡å¥½ä¸å–å®¶æ²Ÿé€šçš„å…·ä½“é—®é¢˜`,
            `ç¡®è®¤æ‚¨çš„é‡‡è´­é¢„ç®—å’Œä»˜æ¬¾æ–¹å¼`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£å–å®¶ç¡®è®¤è¿›åº¦`
          ];
        case 4:
          return [
            `ä»”ç»†è¯„ä¼°å–å®¶æä¾›çš„äº§å“ä¿¡æ¯`,
            `ç¡®è®¤äº§å“æ˜¯å¦æ»¡è¶³æ‚¨çš„éœ€æ±‚`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸å–å®¶ç›´æ¥æ²Ÿé€š`
          ];
        case 5:
          return [
            `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œæ”¶è´§åœ°å€`,
            `å‡†å¤‡ä»˜æ¬¾å’ŒéªŒæ”¶äº§å“`,
            `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
          ];
        default:
          return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
      }
    } else {
      // ç”¨æˆ·èº«ä»½æœªç¡®å®š
      switch(stageId) {
        case 1:
          return [
            `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨æ˜¯å¸Œæœ›å‡ºå”®è¿˜æ˜¯é‡‡è´­`,
            `è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚æˆ–äº§å“ä¿¡æ¯`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–ä¸“ä¸šæŒ‡å¯¼`
          ];
        default:
          return [
            `è¯·å…ˆæ˜ç¡®æ‚¨çš„èº«ä»½ï¼ˆä¹°å®¶/å–å®¶ï¼‰`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©`
          ];
      }
    }
  }
  
  // ä¸ºåŠ¨ç”»æ·»åŠ ç¨³å®šæ€§ä¿®å¤
  function animateStats() {
    const statValues = document.querySelectorAll('.stat-value');
    
    statValues.forEach(statValue => {
      const targetValue = parseInt(statValue.textContent, 10);
      let currentValue = 0;
      const duration = 2000;
      const stepTime = 20;
      const totalSteps = duration / stepTime;
      const stepValue = targetValue / totalSteps;
      
      function updateValue() {
        currentValue += stepValue;
        
        if (currentValue < targetValue) {
          statValue.textContent = Math.floor(currentValue);
          requestAnimationFrame(updateValue);
        } else {
          statValue.textContent = targetValue;
          
          // æ·»åŠ ä»¥é˜²æ­¢æ•°å­—å˜åŒ–å¯¼è‡´å¸ƒå±€ç§»åŠ¨
          statValue.style.minWidth = statValue.offsetWidth + 'px';
        }
      }
      
      // å½“å…ƒç´ è¿›å…¥è§†å£æ—¶å¯åŠ¨åŠ¨ç”»
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            updateValue();
            observer.unobserve(entry.target);
          }
        });
      });
      
      observer.observe(statValue);
    });
  }
  
  // å¯¼èˆªæ åˆå§‹åŒ–ä¸æ»šåŠ¨æ•ˆæœ
  function initNavbar() {
    const navbar = document.querySelector('.navbar');
    
    // æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', function() {
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });
    
    // å¯¼èˆªèœå•é¡¹ç‚¹å‡»æ¿€æ´»æ•ˆæœ
    const navLinks = document.querySelectorAll('.main-nav a');
    
    navLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        // è·å–ç›®æ ‡éƒ¨åˆ†çš„ID
        const targetId = this.getAttribute('href');
        
        // ä»…å¯¹é¡µå†…é”šç‚¹é“¾æ¥è¿›è¡Œå¤„ç†
        if (targetId.startsWith('#')) {
          e.preventDefault();
          
          const targetSection = document.querySelector(targetId);
          
          if (targetSection) {
            // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡éƒ¨åˆ†
            window.scrollTo({
              top: targetSection.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
              behavior: 'smooth'
            });
            
            // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
            history.pushState(null, null, targetId);
            
            // ç§»é™¤æ‰€æœ‰activeç±»
            navLinks.forEach(item => {
              item.parentElement.classList.remove('active');
            });
            
            // ä¸ºå½“å‰ç‚¹å‡»é¡¹æ·»åŠ activeç±»
            this.parentElement.classList.add('active');
          }
        }
      });
    });
  }
  
  // æ·»åŠ æ»šåŠ¨ç›‘å¬ï¼Œé«˜äº®å½“å‰è§†å›¾ä¸­çš„éƒ¨åˆ†
  function initScrollSpy() {
    // è·å–æ‰€æœ‰ä¸»è¦éƒ¨åˆ†
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.main-nav a');
    
    // æ·»åŠ æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', function() {
      // å½“å‰æ»šåŠ¨ä½ç½®
      const scrollPosition = window.scrollY + 100; // æ·»åŠ ä¸€äº›åç§»ä»¥æå‰æ¿€æ´»
      
      // æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†çš„ä½ç½®
      sections.forEach(section => {
        // è·å–éƒ¨åˆ†çš„é¡¶éƒ¨å’Œåº•éƒ¨ä½ç½®
        const sectionTop = section.offsetTop;
        const sectionBottom = sectionTop + section.offsetHeight;
        
        // æ£€æŸ¥å½“å‰æ»šåŠ¨ä½ç½®æ˜¯å¦åœ¨è¯¥éƒ¨åˆ†
        if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
          // æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé“¾æ¥
          const targetId = '#' + section.getAttribute('id');
          
          // ç§»é™¤æ‰€æœ‰activeç±»
          navLinks.forEach(link => {
            link.parentElement.classList.remove('active');
            
            // ä¸ºå½“å‰éƒ¨åˆ†çš„é“¾æ¥æ·»åŠ activeç±»
            if (link.getAttribute('href') === targetId) {
              link.parentElement.classList.add('active');
            }
          });
        }
      });
    });
  }
  
  // å¹³æ»‘æ»šåŠ¨æ•ˆæœ
  function addSmoothScrolling() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        const targetId = this.getAttribute('href');
        
        if (targetId === '#') return;
        
        const target = document.querySelector(targetId);
        
        if (target) {
          e.preventDefault();
          
          window.scrollTo({
            top: target.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
            behavior: 'smooth'
          });
          
          // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
          history.pushState(null, null, targetId);
        }
      });
    });
  }
  
  // åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
  function initDarkMode() {
    const darkModeToggle = document.querySelector('.dark-mode-toggle');
    if (darkModeToggle) {
      darkModeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
          this.textContent = 'â˜€ï¸';
        } else {
          this.textContent = 'ğŸŒ™';
        }
      });
    }
  }
});
  
  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  function initTrackingPanel() {
    const trackingPanel = document.querySelector('.process-flow');
    if (!trackingPanel) return;
  
    // åˆå§‹åŒ–è¿›åº¦æµç¨‹å›¾ - ä»localStorageè·å–å½“å‰çŠ¶æ€
    let currentTrackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è·Ÿè¸ªæ•°æ®æˆ–è€…æ˜¯æ–°ä¼šè¯ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
    if (!currentTrackingData) {
      currentTrackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
      
      // ä¿å­˜åˆå§‹æ•°æ®
      localStorage.setItem('trackingData', JSON.stringify(currentTrackingData));
    }
    
    // æ¸…ç©ºé»˜è®¤å†…å®¹
    trackingPanel.innerHTML = '';
    
    // åˆ›å»ºè¿›åº¦æ¡
    const progressBar = document.createElement('div');
    progressBar.classList.add('progress-bar');
    
    // æ·»åŠ å„ä¸ªé˜¶æ®µ
    currentTrackingData.stages.forEach(stage => {
      const stageElement = document.createElement('div');
      stageElement.classList.add('progress-stage', `status-${stage.status}`);
      stageElement.dataset.stageId = stage.id;
      
      const stageNumber = document.createElement('div');
      stageNumber.classList.add('stage-number');
      stageNumber.textContent = stage.id;
      
      const stageName = document.createElement('div');
      stageName.classList.add('stage-name');
      stageName.textContent = stage.name;
      
      stageElement.appendChild(stageNumber);
      stageElement.appendChild(stageName);
      
      // ç‚¹å‡»é˜¶æ®µæ˜¾ç¤ºè¯¦æƒ…
      stageElement.addEventListener('click', () => showStageDetail(stage, currentTrackingData));
      
      progressBar.appendChild(stageElement);
      
      // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€ä¸ªé˜¶æ®µï¼‰
      if (stage.id < currentTrackingData.stages.length) {
        const connector = document.createElement('div');
        connector.classList.add('stage-connector', `status-${stage.status}`);
        progressBar.appendChild(connector);
      }
    });
    
    trackingPanel.appendChild(progressBar);
    
    // æ·»åŠ è¯´æ˜æ–‡å­—
    const statusInfo = document.createElement('div');
    statusInfo.classList.add('status-info');
    
    // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„é˜¶æ®µ
    const activeStage = currentTrackingData.stages.find(stage => stage.status === 'active');
    const stageName = activeStage ? activeStage.name : 'å‡†å¤‡ä¸­';
    
    // è®¡ç®—æœ€åæ›´æ–°æ—¶é—´
    const lastUpdateTime = getTimeDifference(new Date(currentTrackingData.lastUpdated), new Date());
    
    statusInfo.innerHTML = `å½“å‰çŠ¶æ€ï¼š<span class="status-active">${stageName}</span> Â· æ›´æ–°äº ${lastUpdateTime}`;
    trackingPanel.appendChild(statusInfo);
    
    // æ·»åŠ è¿›åº¦æ¦‚è¦
    const progressSummary = document.createElement('div');
    progressSummary.classList.add('progress-summary');
    
    // æ ¹æ®ç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒçš„è¿›åº¦æ¦‚è¦
    const isSeller = currentTrackingData.isSeller;
    const isBuyer = currentTrackingData.isBuyer;
    
    // è·å–ä¹°å–éœ€æ±‚ç±»å‹
    const needTypeDisplay = currentTrackingData.needType ? currentTrackingData.needType : 'ç­‰å¾…ç¡®è®¤';
    const productTypeDisplay = currentTrackingData.productType ? currentTrackingData.productType : 'ç­‰å¾…ç¡®è®¤';
    
    let summaryHTML = '';
    if (isSeller) {
      summaryHTML = `
        <h4>å‡ºå”®ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>å•†å“ç±»å‹: ${productTypeDisplay}</li>
          <li>åº“å­˜æ•°é‡: ${currentTrackingData.quantity || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else if (isBuyer) {
      summaryHTML = `
        <h4>é‡‡è´­ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>éœ€æ±‚ç±»å‹: ${needTypeDisplay}</li>
          <li>äº§å“ç±»å‹: ${productTypeDisplay}</li>
          <li>é¢„ç®—èŒƒå›´: ${currentTrackingData.budgetRange || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else {
      summaryHTML = `
        <h4>å¯¹æ¥ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>è¯·åœ¨èŠå¤©ä¸­è¯´æ˜æ‚¨æ˜¯éœ€è¦å‡ºå”®è¿˜æ˜¯é‡‡è´­</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    }
    
    progressSummary.innerHTML = summaryHTML;
    trackingPanel.appendChild(progressSummary);
    
    // æ·»åŠ åˆ·æ–°æŒ‰é’®
    const refreshButton = document.createElement('button');
    refreshButton.classList.add('refresh-tracking');
    refreshButton.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
    refreshButton.addEventListener('click', function() {
      // è¯·æ±‚å¹³å°æ›´æ–°è¿›åº¦
      updateTrackingProgress();
      
      // æ·»åŠ åˆ·æ–°åŠ¨ç”»
      this.classList.add('refreshing');
      // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
      this.textContent = 'æ­£åœ¨è¯·æ±‚å¹³å°ç¡®è®¤...';
      setTimeout(() => {
        this.classList.remove('refreshing');
        this.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
      }, 2000);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤è¯´æ˜
    const confirmNote = document.createElement('div');
    confirmNote.classList.add('platform-note');
    confirmNote.innerHTML = 'æç¤ºï¼šæ‰€æœ‰è¿›åº¦æ›´æ–°éœ€è¦å¹³å°ç¡®è®¤åæ‰èƒ½ç”Ÿæ•ˆ';
    
    trackingPanel.appendChild(refreshButton);
    trackingPanel.appendChild(confirmNote);
  }
  
  // æ ¹æ®èŠå¤©å†…å®¹æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingFromChat(message, isSeller, isBuyer) {
    // è·å–å½“å‰è¿›åº¦æ•°æ®
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) {
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
      trackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
    }
    
    // æ›´æ–°ä¹°å–èº«ä»½
    if (isSeller !== undefined) {
      trackingData.isSeller = isSeller;
    }
    
    if (isBuyer !== undefined) {
      trackingData.isBuyer = isBuyer;
    }
    
    // å¤„ç†é˜¶æ®µ1ï¼šéœ€æ±‚æäº¤
    if (trackingData.stages[0].status !== 'completed') {
      // åªè¦æœ‰æ¶ˆæ¯ï¼Œå°±è®¤ä¸ºéœ€æ±‚å·²æäº¤
      trackingData.stages[0].status = 'completed';
      trackingData.stages[0].timestamp = new Date().toISOString();
      
      // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
      trackingData.stages[1].status = 'active';
      trackingData.currentStage = 2;
    }
    
    // æå–äº§å“ç±»å‹ä¿¡æ¯
    const productTypes = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›', 'å°¼é¾™', 'æ¶¤çº¶'];
    for (const type of productTypes) {
      if (message.includes(type)) {
        trackingData.productType = type;
        break;
      }
    }
    
    // æå–éœ€æ±‚ç±»å‹
    if (message.includes('é¢æ–™') || message.includes('å¸ƒæ–™') || message.includes('å¸ƒ')) {
      trackingData.needType = 'é¢æ–™';
    } else if (message.includes('æœè£…') || message.includes('è¡£æœ') || message.includes('æˆè¡£')) {
      trackingData.needType = 'æœè£…';
    }
    
    // æå–æ•°é‡ä¿¡æ¯
    const quantityMatch = message.match(/(\d+)([ä»¶æ¡ç±³å¨ä¸ª])/);
    if (quantityMatch) {
      trackingData.quantity = quantityMatch[0];
    }
    
    // æå–ä»·æ ¼/é¢„ç®—ä¿¡æ¯
    if (message.includes('ä»·æ ¼') || message.includes('å¤šå°‘é’±') || message.includes('é¢„ç®—')) {
      const priceMatch = message.match(/(\d+)[-~åˆ°è‡³](\d+)[å…ƒå—]/);
      if (priceMatch) {
        trackingData.budgetRange = priceMatch[0];
      }
    }
    
    // é˜¶æ®µ2ï¼šåŒ¹é…åº“å­˜ - æ ¹æ®å…³é”®è¯åˆ¤æ–­
    if (trackingData.currentStage === 2 && trackingData.stages[1].status === 'active') {
      // å½“ç”¨æˆ·æä¾›äº†å…·ä½“çš„äº§å“å’Œéœ€æ±‚ç±»å‹æ—¶ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€é˜¶æ®µ
      if (trackingData.productType && trackingData.needType) {
        if (message.includes('åŒ¹é…') || message.includes('åº“å­˜') || message.includes('èµ„æº') || 
            message.includes('æ‰¾åˆ°') || message.includes('æœ‰è´§') || containsSpecificProductInfo(message)) {
          trackingData.stages[1].status = 'completed';
          trackingData.stages[1].timestamp = new Date().toISOString();
          
          // æ ¹æ®ç”¨æˆ·èº«ä»½å†³å®šä¸‹ä¸€æ­¥
          if (trackingData.isSeller) {
            // å–å®¶å¯»æ‰¾ä¹°å®¶ï¼Œè¿›å…¥åˆ°ä¹°å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[3].status = 'active';
            trackingData.currentStage = 4;
          } else if (trackingData.isBuyer) {
            // ä¹°å®¶å¯»æ‰¾å–å®¶ï¼Œè¿›å…¥åˆ°å–å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[2].status = 'active';
            trackingData.currentStage = 3;
          }
        }
      }
    }
    
    // é˜¶æ®µ3ï¼šå–å®¶ç¡®è®¤
    if (trackingData.currentStage === 3 && trackingData.stages[2].status === 'active') {
      if (message.includes('å–å®¶ç¡®è®¤') || message.includes('ä¾›åº”å•†ç¡®è®¤') || message.includes('å·²ç¡®è®¤') || 
          message.includes('å¯ä»¥ä¾›åº”') || message.includes('æœ‰åº“å­˜')) {
        trackingData.stages[2].status = 'completed';
        trackingData.stages[2].timestamp = new Date().toISOString();
        
        // è¿›å…¥ä¹°å®¶ç¡®è®¤é˜¶æ®µ
        trackingData.stages[3].status = 'active';
        trackingData.currentStage = 4;
      }
    }
    
    // é˜¶æ®µ4ï¼šä¹°å®¶ç¡®è®¤
    if (trackingData.currentStage === 4 && trackingData.stages[3].status === 'active') {
      if (message.includes('ä¹°å®¶ç¡®è®¤') || message.includes('å®¢æˆ·ç¡®è®¤') || message.includes('ç¡®è®¤è´­ä¹°') || 
          message.includes('æ¥å—') || message.includes('æ»¡æ„')) {
        trackingData.stages[3].status = 'completed';
        trackingData.stages[3].timestamp = new Date().toISOString();
        
        // è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µ
        trackingData.stages[4].status = 'active';
        trackingData.currentStage = 5;
      }
    }
    
    // é˜¶æ®µ5ï¼šç¡®è®¤å¯¹æ¥
    if (trackingData.currentStage === 5 && trackingData.stages[4].status === 'active') {
      if (message.includes('äº¤æ˜“æˆåŠŸ') || message.includes('å·²å¯¹æ¥') || message.includes('æˆäº¤') || 
          message.includes('å·²å®Œæˆ') || message.includes('æ„Ÿè°¢åˆä½œ')) {
        trackingData.stages[4].status = 'completed';
        trackingData.stages[4].timestamp = new Date().toISOString();
      }
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    trackingData.lastUpdated = new Date().toISOString();
    
    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(trackingData));
    
    // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
    initTrackingPanel();
  }
  
  // æ˜¾ç¤ºé˜¶æ®µè¯¦ç»†ä¿¡æ¯
  function showStageDetail(stage, trackingData) {
    const wechatContact = '<strong>JJ1598929032</strong>';
    const modal = document.createElement('div');
    modal.classList.add('progress-modal');
    
    const modalContent = document.createElement('div');
    modalContent.classList.add('modal-content');
    
    // æ·»åŠ å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.classList.add('close-modal');
    closeBtn.innerHTML = '&times;';
    closeBtn.addEventListener('click', function() {
      document.body.removeChild(modal);
    });
    
    // é˜¶æ®µè¯¦æƒ…å†…å®¹
    const stageContent = document.createElement('div');
    stageContent.classList.add('stage-detail');
    
    const stageTitle = document.createElement('h3');
    stageTitle.innerHTML = `é˜¶æ®µ ${stage.id}: ${stage.name} <span class="stage-status status-${stage.status}">${getStatusText(stage.status)}</span>`;
    
    const stageTimestamp = document.createElement('div');
    stageTimestamp.classList.add('stage-timestamp');
    if (stage.timestamp) {
      const date = new Date(stage.timestamp);
      stageTimestamp.textContent = `æ›´æ–°æ—¶é—´: ${formatDateTime(date)}`;
    } else {
      stageTimestamp.textContent = 'å°šæœªå¼€å§‹';
    }
    
    const stageDescription = document.createElement('p');
    let descriptionText = '';
    
    // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒå†…å®¹
    const isSeller = trackingData.isSeller;
    const isBuyer = trackingData.isBuyer;
    
    switch(stage.id) {
      case 1:
        if (stage.status === 'completed') {
          descriptionText = `æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : ''}éœ€æ±‚å·²æˆåŠŸæäº¤ï¼æˆ‘ä»¬çš„ç³»ç»Ÿæ­£åœ¨è¿›è¡Œåˆæ­¥åˆ†æï¼Œä»¥ä¾¿æ›´å¥½åœ°åŒ¹é…åˆé€‚çš„${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚å¦‚éœ€è¡¥å……å…·ä½“è¦æ±‚æˆ–æŸ¥è¯¢è¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : 'éœ€æ±‚'}æ„å‘ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚æ‚¨å¯ä»¥éšæ—¶æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©ã€‚`;
        }
        break;
      case 2:
        if (stage.status === 'completed') {
          descriptionText = `ç³»ç»Ÿå·²æˆåŠŸä¸ºæ‚¨åŒ¹é…åˆ°ç¬¦åˆè¦æ±‚çš„${isSeller ? 'æ½œåœ¨ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚ç°åœ¨è¿›å…¥${isSeller ? 'ä¹°å®¶' : 'å–å®¶'}ç¡®è®¤é˜¶æ®µã€‚å¦‚éœ€äº†è§£åŒ¹é…è¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `ç³»ç»Ÿæ­£åœ¨æ ¹æ®æ‚¨æä¾›çš„è¦æ±‚åŒ¹é…${isSeller ? 'ä¹°å®¶èµ„æº' : 'åº“å­˜'}ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦12å°æ—¶å†…å®Œæˆã€‚å¦‚éœ€åŠ å¿«è¿›åº¦æˆ–æä¾›æ›´è¯¦ç»†çš„éœ€æ±‚ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨éœ€æ±‚æäº¤åè‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚`;
        }
        break;
      case 3:
        if (stage.status === 'completed') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç°åœ¨ç­‰å¾…ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `æˆ‘ä»¬å·²æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„åº“å­˜ï¼Œæ­£åœ¨ç­‰å¾…å–å®¶ç¡®è®¤ã€‚é€šå¸¸ä¼šåœ¨24å°æ—¶å†…å¾—åˆ°å›å¤ã€‚å¦‚æƒ³ä¼˜å…ˆå¤„ç†æˆ–äº†è§£æ›´å¤šè¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨åŒ¹é…åˆ°åˆé€‚åº“å­˜åè”ç³»å–å®¶ç¡®è®¤ã€‚`;
        }
        break;
      case 4:
        if (stage.status === 'completed') {
          descriptionText = `ä¹°å®¶å·²ç¡®è®¤è´­ä¹°æ„å‘ï¼Œç°åœ¨è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µã€‚è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆäº¤æ˜“ç»†èŠ‚ç¡®è®¤ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç­‰å¾…æ‚¨çš„æœ€ç»ˆç¡®è®¤ã€‚ä¸ºç¡®ä¿äº¤æ˜“é¡ºåˆ©è¿›è¡Œï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¿›è¡Œåç»­æ²Ÿé€š`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨å–å®¶ç¡®è®¤åè”ç³»ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚`;
        }
        break;
      case 5:
        if (stage.status === 'completed') {
          descriptionText = `æ­å–œï¼äº¤æ˜“å·²æˆåŠŸå¯¹æ¥ã€‚è¯·é€šè¿‡å¾®ä¿¡ï¼š${wechatContact} å®Œæˆåç»­äº¤æ˜“æµç¨‹ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `æ­å–œï¼åŒæ–¹å·²è¾¾æˆå¯¹æ¥æ„å‘ã€‚ä¸ºä¿éšœäº¤æ˜“å®‰å…¨å’Œé¡ºåˆ©å®Œæˆåç»­æµç¨‹ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–è¯¦ç»†æŒ‡å¯¼`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨ä¹°å®¶ç¡®è®¤åè¿›å…¥æœ€ç»ˆå¯¹æ¥ç¡®è®¤é˜¶æ®µã€‚`;
        }
        break;
      default:
        descriptionText = `å½“å‰é˜¶æ®µçŠ¶æ€æ›´æ–°ä¸­ã€‚å¦‚éœ€åŠæ—¶äº†è§£æœ€æ–°è¿›å±•ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
    }
    
    stageDescription.innerHTML = descriptionText;
    
    const nextStepsTitle = document.createElement('h4');
    nextStepsTitle.textContent = 'ä¸‹ä¸€æ­¥æ“ä½œ';
    
    const nextStepsList = document.createElement('ul');
    const nextSteps = getNextSteps(stage.id, stage.status, trackingData);
    
    nextSteps.forEach(step => {
      const listItem = document.createElement('li');
      listItem.innerHTML = step;
      nextStepsList.appendChild(listItem);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤æç¤º
    const platformConfirmNote = document.createElement('div');
    platformConfirmNote.classList.add('platform-confirmation-note');
    platformConfirmNote.innerHTML = `<i>æ³¨æ„ï¼šå¯¹æ¥è¿›åº¦ç”±å¹³å°æ ¹æ®å®é™…æƒ…å†µç¡®è®¤æ›´æ–°ï¼Œé˜¶æ®µè¿›åº¦æ— æ³•æ‰‹åŠ¨ä¿®æ”¹ã€‚å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}</i>`;
    
    stageContent.appendChild(stageTitle);
    stageContent.appendChild(stageTimestamp);
    stageContent.appendChild(stageDescription);
    stageContent.appendChild(nextStepsTitle);
    stageContent.appendChild(nextStepsList);
    stageContent.appendChild(platformConfirmNote);
    
    modalContent.appendChild(closeBtn);
    modalContent.appendChild(stageContent);
    modal.appendChild(modalContent);
    
    document.body.appendChild(modal);
  }
  
  // æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingProgress() {
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) return;
    
    // è·å–å½“å‰æ´»è·ƒé˜¶æ®µ
    let currentActiveIndex = trackingData.stages.findIndex(stage => stage.status === 'active');
    
    // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­æ¶ˆæ¯
    showProgressUpdateMessage();
    
    // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤è¿‡ç¨‹ï¼ˆå®é™…ç¯å¢ƒä¸­åº”é€šè¿‡åç«¯APIè·å–ç¡®è®¤ç»“æœï¼‰
    setTimeout(() => {
      // å¹³å°å®¡æ ¸ç¡®è®¤åï¼Œæ›´æ–°è¿›åº¦
      // æ³¨æ„ï¼šåœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªç¡®è®¤è¿‡ç¨‹åº”è¯¥æ¥è‡ªæœåŠ¡å™¨
      const platformConfirmed = Math.random() > 0.5; // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤ç»“æœ
      
      if (platformConfirmed && currentActiveIndex !== -1 && currentActiveIndex < trackingData.stages.length - 1) {
        // å½“å‰é˜¶æ®µå®Œæˆ
        trackingData.stages[currentActiveIndex].status = 'completed';
        trackingData.stages[currentActiveIndex].timestamp = new Date().toISOString();
        
        // ä¸‹ä¸€é˜¶æ®µæ¿€æ´»
        trackingData.stages[currentActiveIndex + 1].status = 'active';
        trackingData.currentStage = currentActiveIndex + 2; // +2æ˜¯å› ä¸ºstage idä»1å¼€å§‹
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showNotification("è¿›åº¦å·²æ›´æ–°", "å¹³å°å·²ç¡®è®¤æ‚¨çš„è¿›åº¦æ›´æ–°", "success");
      } else {
        // å¹³å°æœªç¡®è®¤
        showNotification("è¿›åº¦æ›´æ–°ç­‰å¾…ä¸­", "æ‚¨çš„è¿›åº¦æ›´æ–°è¯·æ±‚æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤", "info");
      }
      
      // éšæœºæ›´æ–°å…¶ä»–ä¿¡æ¯
      if (!trackingData.productType && Math.random() > 0.7) {
        const products = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›'];
        trackingData.productType = products[Math.floor(Math.random() * products.length)];
      }
      
      if (!trackingData.needType && Math.random() > 0.7) {
        trackingData.needType = Math.random() > 0.5 ? 'é¢æ–™' : 'æœè£…';
      }
      
      if (!trackingData.quantity && trackingData.isSeller && Math.random() > 0.7) {
        const units = ['ä»¶', 'ç±³', 'æ¡'];
        trackingData.quantity = `${Math.floor(Math.random() * 1000) + 10}${units[Math.floor(Math.random() * units.length)]}`;
      }
      
      if (!trackingData.budgetRange && trackingData.isBuyer && Math.random() > 0.7) {
        const min = Math.floor(Math.random() * 500) + 50;
        const max = min + Math.floor(Math.random() * 500) + 50;
        trackingData.budgetRange = `${min}-${max}å…ƒ`;
      }
      
      // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
      trackingData.lastUpdated = new Date().toISOString();
      
      // ä¿å­˜æ›´æ–°åçš„æ•°æ®
      localStorage.setItem('trackingData', JSON.stringify(trackingData));
      
      // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿
      initTrackingPanel();
    }, 2000); // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤å»¶è¿Ÿ
  }
  
  // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­çš„æ¶ˆæ¯
  function showProgressUpdateMessage() {
    const notification = document.createElement('div');
    notification.classList.add('progress-notification', 'updating');
    notification.innerHTML = `
      <div class="notification-icon">
        <div class="loading-spinner"></div>
      </div>
      <div class="notification-content">
        <h4>è¿›åº¦æ›´æ–°è¯·æ±‚å·²æäº¤</h4>
        <p>æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...</p>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // 1.5ç§’åç§»é™¤é€šçŸ¥
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 1500);
  }
  
  // æ˜¾ç¤ºé€šçŸ¥
  function showNotification(title, message, type = "info") {
    const notification = document.createElement('div');
    notification.classList.add('progress-notification', type);
    
    let icon = '';
    if (type === 'success') {
      icon = '<div class="notification-icon success">âœ“</div>';
    } else if (type === 'error') {
      icon = '<div class="notification-icon error">âœ—</div>';
    } else {
      icon = '<div class="notification-icon info">i</div>';
    }
    
    notification.innerHTML = `
      ${icon}
      <div class="notification-content">
        <h4>${title}</h4>
        <p>${message}</p>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’åç§»é™¤é€šçŸ¥
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 3000);
  }
  
  // è·å–çŠ¶æ€æ–‡æœ¬æè¿°
  function getStatusText(status) {
    switch(status) {
      case 'pending': return 'ç­‰å¾…ä¸­';
      case 'active': return 'è¿›è¡Œä¸­';
      case 'completed': return 'å·²å®Œæˆ';
      default: return 'æœªçŸ¥çŠ¶æ€';
    }
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
  function formatDateTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day} ${hours}:${minutes}`;
  }
  
  // è·å–æ—¶é—´å·®å¼‚çš„å‹å¥½æè¿°
  function getTimeDifference(oldDate, newDate) {
    const diffMs = newDate - oldDate;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffSec < 60) {
      return 'åˆšåˆš';
    } else if (diffMin < 60) {
      return `${diffMin}åˆ†é’Ÿå‰`;
    } else if (diffHour < 24) {
      return `${diffHour}å°æ—¶å‰`;
    } else if (diffDay < 30) {
      return `${diffDay}å¤©å‰`;
    } else {
      const month = String(oldDate.getMonth() + 1).padStart(2, '0');
      const day = String(oldDate.getDate()).padStart(2, '0');
      return `${month}-${day}`;
    }
  }
  
  // è·å–å·²å®Œæˆé˜¶æ®µçš„æ•°é‡
  function getCompletedStages(stages) {
    return stages.filter(stage => stage.status === 'completed').length;
  }
  
  // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åŒ…å«å…·ä½“äº§å“ä¿¡æ¯
  function containsSpecificProductInfo(message) {
    // åŒ¹é…å…·ä½“çš„äº§å“æè¿°
    const patterns = [
      /\d+[ä»¶æ¡ç±³å¨]/,  // åŒ¹é…æ•°é‡å•ä½
      /æ¬¾å¼|å‹å·|è§„æ ¼|å°ºå¯¸|é¢œè‰²|æˆåˆ†/,  // åŒ¹é…äº§å“å±æ€§
      /ç‰Œ|å“ç‰Œ|å‚å®¶|ç”Ÿäº§å•†/,  // åŒ¹é…å“ç‰Œä¿¡æ¯
      /ä»·æ ¼|æŠ¥ä»·|å…ƒ\/[ç±³ä»¶æ¡]/  // åŒ¹é…ä»·æ ¼ä¿¡æ¯
    ];
    
    return patterns.some(pattern => pattern.test(message));
  }
  
  // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½è·å–ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•
  function getNextSteps(stageId, stageStatus, trackingData) {
    const wechatContact = '<strong>JJ1598929032</strong>';
    const isSeller = trackingData.isSeller;
    const isBuyer = trackingData.isBuyer;
    
    // å¦‚æœé˜¶æ®µå·²å®Œæˆï¼Œè¿”å›ç©ºæ­¥éª¤åˆ—è¡¨
    if (stageStatus === 'completed') {
      return [`æ­¤é˜¶æ®µå·²å®Œæˆï¼Œè¯·ç»§ç»­æ¨è¿›ä¸‹ä¸€é˜¶æ®µ`, `å¦‚æœ‰é—®é¢˜è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å’¨è¯¢`];
    }
    
    // å¦‚æœé˜¶æ®µæœªå¼€å§‹ï¼Œè¿”å›ç­‰å¾…æŒ‡å¼•
    if (stageStatus === 'pending') {
      return [`è¯·ç­‰å¾…å‰åºé˜¶æ®µå®Œæˆåå†è¿›è¡Œæ­¤é˜¶æ®µ`, `å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`];
    }
    
    // é˜¶æ®µå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæ ¹æ®ä¸åŒæƒ…å†µè¿”å›æŒ‡å¼•
    if (isSeller) {
      switch(stageId) {
        case 1:
          return [
            `è¯¦ç»†æè¿°æ‚¨è¦å‡ºå”®çš„äº§å“ç±»å‹ã€æ•°é‡å’ŒæœŸæœ›ä»·æ ¼`,
            `æä¾›äº§å“å›¾ç‰‡æˆ–è¯¦ç»†è§„æ ¼è¯´æ˜`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
          ];
        case 2:
          return [
            `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…æ½œåœ¨ä¹°å®¶`,
            `å®Œå–„æ‚¨çš„äº§å“ç»†èŠ‚ä¿¡æ¯ä»¥æé«˜åŒ¹é…ç‡`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
          ];
        case 3:
          return [
            `å‡†å¤‡å¥½è¯¦ç»†çš„äº§å“è¯´æ˜å’Œä»·æ ¼èµ„æ–™`,
            `ç¡®è®¤æ‚¨çš„å‘è´§èƒ½åŠ›å’Œåº“å­˜æƒ…å†µ`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£ä¹°å®¶éœ€æ±‚ç»†èŠ‚`
          ];
        case 4:
          return [
            `å‡†å¤‡è¯¦ç»†çš„äº§å“èµ„æ–™å’ŒæŠ¥ä»·å•`,
            `ç¡®è®¤æ‚¨çš„ä»“åº“åº“å­˜å’Œç‰©æµé…é€æ–¹æ¡ˆ`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸ä¹°å®¶ç›´æ¥æ²Ÿé€š`
          ];
        case 5:
          return [
            `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œä»˜æ¬¾æ–¹å¼`,
            `å‡†å¤‡äº§å“å‘è´§å’Œå”®åæœåŠ¡æ–¹æ¡ˆ`,
            `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
          ];
        default:
          return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
      }
    } else if (isBuyer) {
      switch(stageId) {
        case 1:
          return [
            `è¯¦ç»†æè¿°æ‚¨éœ€è¦çš„äº§å“ç±»å‹ã€æ•°é‡å’Œé¢„ç®—`,
            `è¯´æ˜æ‚¨å¯¹äº§å“è´¨é‡å’Œè§„æ ¼çš„è¦æ±‚`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
          ];
        case 2:
          return [
            `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…åˆé€‚åº“å­˜`,
            `å®Œå–„æ‚¨çš„éœ€æ±‚ç»†èŠ‚ä»¥æé«˜åŒ¹é…ç²¾å‡†åº¦`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
          ];
        case 3:
          return [
            `å‡†å¤‡å¥½ä¸å–å®¶æ²Ÿé€šçš„å…·ä½“é—®é¢˜`,
            `ç¡®è®¤æ‚¨çš„é‡‡è´­é¢„ç®—å’Œä»˜æ¬¾æ–¹å¼`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£å–å®¶ç¡®è®¤è¿›åº¦`
          ];
        case 4:
          return [
            `ä»”ç»†è¯„ä¼°å–å®¶æä¾›çš„äº§å“ä¿¡æ¯`,
            `ç¡®è®¤äº§å“æ˜¯å¦æ»¡è¶³æ‚¨çš„éœ€æ±‚`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸å–å®¶ç›´æ¥æ²Ÿé€š`
          ];
        case 5:
          return [
            `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œæ”¶è´§åœ°å€`,
            `å‡†å¤‡ä»˜æ¬¾å’ŒéªŒæ”¶äº§å“`,
            `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
          ];
        default:
          return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
      }
    } else {
      // ç”¨æˆ·èº«ä»½æœªç¡®å®š
      switch(stageId) {
        case 1:
          return [
            `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨æ˜¯å¸Œæœ›å‡ºå”®è¿˜æ˜¯é‡‡è´­`,
            `è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚æˆ–äº§å“ä¿¡æ¯`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–ä¸“ä¸šæŒ‡å¯¼`
          ];
        default:
          return [
            `è¯·å…ˆæ˜ç¡®æ‚¨çš„èº«ä»½ï¼ˆä¹°å®¶/å–å®¶ï¼‰`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©`
          ];
      }
    }
  }
  
  // ä¸ºåŠ¨ç”»æ·»åŠ ç¨³å®šæ€§ä¿®å¤
  function animateStats() {
    const statValues = document.querySelectorAll('.stat-value');
    
    statValues.forEach(statValue => {
      const targetValue = parseInt(statValue.textContent, 10);
      let currentValue = 0;
      const duration = 2000;
      const stepTime = 20;
      const totalSteps = duration / stepTime;
      const stepValue = targetValue / totalSteps;
      
      function updateValue() {
        currentValue += stepValue;
        
        if (currentValue < targetValue) {
          statValue.textContent = Math.floor(currentValue);
          requestAnimationFrame(updateValue);
        } else {
          statValue.textContent = targetValue;
          
          // æ·»åŠ ä»¥é˜²æ­¢æ•°å­—å˜åŒ–å¯¼è‡´å¸ƒå±€ç§»åŠ¨
          statValue.style.minWidth = statValue.offsetWidth + 'px';
        }
      }
      
      // å½“å…ƒç´ è¿›å…¥è§†å£æ—¶å¯åŠ¨åŠ¨ç”»
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            updateValue();
            observer.unobserve(entry.target);
          }
        });
      });
      
      observer.observe(statValue);
    });
  }
  
  // å¯¼èˆªæ åˆå§‹åŒ–ä¸æ»šåŠ¨æ•ˆæœ
  function initNavbar() {
    const navbar = document.querySelector('.navbar');
    
    // æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', function() {
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });
    
    // å¯¼èˆªèœå•é¡¹ç‚¹å‡»æ¿€æ´»æ•ˆæœ
    const navLinks = document.querySelectorAll('.main-nav a');
    
    navLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        // è·å–ç›®æ ‡éƒ¨åˆ†çš„ID
        const targetId = this.getAttribute('href');
        
        // ä»…å¯¹é¡µå†…é”šç‚¹é“¾æ¥è¿›è¡Œå¤„ç†
        if (targetId.startsWith('#')) {
          e.preventDefault();
          
          const targetSection = document.querySelector(targetId);
          
          if (targetSection) {
            // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡éƒ¨åˆ†
            window.scrollTo({
              top: targetSection.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
              behavior: 'smooth'
            });
            
            // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
            history.pushState(null, null, targetId);
            
            // ç§»é™¤æ‰€æœ‰activeç±»
            navLinks.forEach(item => {
              item.parentElement.classList.remove('active');
            });
            
            // ä¸ºå½“å‰ç‚¹å‡»é¡¹æ·»åŠ activeç±»
            this.parentElement.classList.add('active');
          }
        }
      });
    });
  }
  
  // æ·»åŠ æ»šåŠ¨ç›‘å¬ï¼Œé«˜äº®å½“å‰è§†å›¾ä¸­çš„éƒ¨åˆ†
  function initScrollSpy() {
    // è·å–æ‰€æœ‰ä¸»è¦éƒ¨åˆ†
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.main-nav a');
    
    // æ·»åŠ æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', function() {
      // å½“å‰æ»šåŠ¨ä½ç½®
      const scrollPosition = window.scrollY + 100; // æ·»åŠ ä¸€äº›åç§»ä»¥æå‰æ¿€æ´»
      
      // æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†çš„ä½ç½®
      sections.forEach(section => {
        // è·å–éƒ¨åˆ†çš„é¡¶éƒ¨å’Œåº•éƒ¨ä½ç½®
        const sectionTop = section.offsetTop;
        const sectionBottom = sectionTop + section.offsetHeight;
        
        // æ£€æŸ¥å½“å‰æ»šåŠ¨ä½ç½®æ˜¯å¦åœ¨è¯¥éƒ¨åˆ†
        if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
          // æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé“¾æ¥
          const targetId = '#' + section.getAttribute('id');
          
          // ç§»é™¤æ‰€æœ‰activeç±»
          navLinks.forEach(link => {
            link.parentElement.classList.remove('active');
            
            // ä¸ºå½“å‰éƒ¨åˆ†çš„é“¾æ¥æ·»åŠ activeç±»
            if (link.getAttribute('href') === targetId) {
              link.parentElement.classList.add('active');
            }
          });
        }
      });
    });
  }
  
  // å¹³æ»‘æ»šåŠ¨æ•ˆæœ
  function addSmoothScrolling() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        const targetId = this.getAttribute('href');
        
        if (targetId === '#') return;
        
        const target = document.querySelector(targetId);
        
        if (target) {
          e.preventDefault();
          
          window.scrollTo({
            top: target.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
            behavior: 'smooth'
          });
          
          // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
          history.pushState(null, null, targetId);
        }
      });
    });
  }
  
  // åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
  function initDarkMode() {
    const darkModeToggle = document.querySelector('.dark-mode-toggle');
    if (darkModeToggle) {
      darkModeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
          this.textContent = 'â˜€ï¸';
        } else {
          this.textContent = 'ğŸŒ™';
        }
      });
    }
  }
});
  
  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  function initTrackingPanel() {
    const trackingPanel = document.querySelector('.process-flow');
    if (!trackingPanel) return;
  
    // åˆå§‹åŒ–è¿›åº¦æµç¨‹å›¾ - ä»localStorageè·å–å½“å‰çŠ¶æ€
    let currentTrackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è·Ÿè¸ªæ•°æ®æˆ–è€…æ˜¯æ–°ä¼šè¯ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
    if (!currentTrackingData) {
      currentTrackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
      
      // ä¿å­˜åˆå§‹æ•°æ®
      localStorage.setItem('trackingData', JSON.stringify(currentTrackingData));
    }
    
    // æ¸…ç©ºé»˜è®¤å†…å®¹
    trackingPanel.innerHTML = '';
    
    // åˆ›å»ºè¿›åº¦æ¡
    const progressBar = document.createElement('div');
    progressBar.classList.add('progress-bar');
    
    // æ·»åŠ å„ä¸ªé˜¶æ®µ
    currentTrackingData.stages.forEach(stage => {
      const stageElement = document.createElement('div');
      stageElement.classList.add('progress-stage', `status-${stage.status}`);
      stageElement.dataset.stageId = stage.id;
      
      const stageNumber = document.createElement('div');
      stageNumber.classList.add('stage-number');
      stageNumber.textContent = stage.id;
      
      const stageName = document.createElement('div');
      stageName.classList.add('stage-name');
      stageName.textContent = stage.name;
      
      stageElement.appendChild(stageNumber);
      stageElement.appendChild(stageName);
      
      // ç‚¹å‡»é˜¶æ®µæ˜¾ç¤ºè¯¦æƒ…
      stageElement.addEventListener('click', () => showStageDetail(stage, currentTrackingData));
      
      progressBar.appendChild(stageElement);
      
      // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€ä¸ªé˜¶æ®µï¼‰
      if (stage.id < currentTrackingData.stages.length) {
        const connector = document.createElement('div');
        connector.classList.add('stage-connector', `status-${stage.status}`);
        progressBar.appendChild(connector);
      }
    });
    
    trackingPanel.appendChild(progressBar);
    
    // æ·»åŠ è¯´æ˜æ–‡å­—
    const statusInfo = document.createElement('div');
    statusInfo.classList.add('status-info');
    
    // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„é˜¶æ®µ
    const activeStage = currentTrackingData.stages.find(stage => stage.status === 'active');
    const stageName = activeStage ? activeStage.name : 'å‡†å¤‡ä¸­';
    
    // è®¡ç®—æœ€åæ›´æ–°æ—¶é—´
    const lastUpdateTime = getTimeDifference(new Date(currentTrackingData.lastUpdated), new Date());
    
    statusInfo.innerHTML = `å½“å‰çŠ¶æ€ï¼š<span class="status-active">${stageName}</span> Â· æ›´æ–°äº ${lastUpdateTime}`;
    trackingPanel.appendChild(statusInfo);
    
    // æ·»åŠ è¿›åº¦æ¦‚è¦
    const progressSummary = document.createElement('div');
    progressSummary.classList.add('progress-summary');
    
    // æ ¹æ®ç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒçš„è¿›åº¦æ¦‚è¦
    const isSeller = currentTrackingData.isSeller;
    const isBuyer = currentTrackingData.isBuyer;
    
    // è·å–ä¹°å–éœ€æ±‚ç±»å‹
    const needTypeDisplay = currentTrackingData.needType ? currentTrackingData.needType : 'ç­‰å¾…ç¡®è®¤';
    const productTypeDisplay = currentTrackingData.productType ? currentTrackingData.productType : 'ç­‰å¾…ç¡®è®¤';
    
    let summaryHTML = '';
    if (isSeller) {
      summaryHTML = `
        <h4>å‡ºå”®ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>å•†å“ç±»å‹: ${productTypeDisplay}</li>
          <li>åº“å­˜æ•°é‡: ${currentTrackingData.quantity || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else if (isBuyer) {
      summaryHTML = `
        <h4>é‡‡è´­ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>éœ€æ±‚ç±»å‹: ${needTypeDisplay}</li>
          <li>äº§å“ç±»å‹: ${productTypeDisplay}</li>
          <li>é¢„ç®—èŒƒå›´: ${currentTrackingData.budgetRange || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else {
      summaryHTML = `
        <h4>å¯¹æ¥ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>è¯·åœ¨èŠå¤©ä¸­è¯´æ˜æ‚¨æ˜¯éœ€è¦å‡ºå”®è¿˜æ˜¯é‡‡è´­</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    }
    
    progressSummary.innerHTML = summaryHTML;
    trackingPanel.appendChild(progressSummary);
    
    // æ·»åŠ åˆ·æ–°æŒ‰é’®
    const refreshButton = document.createElement('button');
    refreshButton.classList.add('refresh-tracking');
    refreshButton.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
    refreshButton.addEventListener('click', function() {
      // è¯·æ±‚å¹³å°æ›´æ–°è¿›åº¦
      updateTrackingProgress();
      
      // æ·»åŠ åˆ·æ–°åŠ¨ç”»
      this.classList.add('refreshing');
      // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
      this.textContent = 'æ­£åœ¨è¯·æ±‚å¹³å°ç¡®è®¤...';
      setTimeout(() => {
        this.classList.remove('refreshing');
        this.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
      }, 2000);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤è¯´æ˜
    const confirmNote = document.createElement('div');
    confirmNote.classList.add('platform-note');
    confirmNote.innerHTML = 'æç¤ºï¼šæ‰€æœ‰è¿›åº¦æ›´æ–°éœ€è¦å¹³å°ç¡®è®¤åæ‰èƒ½ç”Ÿæ•ˆ';
    
    trackingPanel.appendChild(refreshButton);
    trackingPanel.appendChild(confirmNote);
  }
  
  // æ ¹æ®èŠå¤©å†…å®¹æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingFromChat(message, isSeller, isBuyer) {
    // è·å–å½“å‰è¿›åº¦æ•°æ®
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) {
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
      trackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
    }
    
    // æ›´æ–°ä¹°å–èº«ä»½
    if (isSeller !== undefined) {
      trackingData.isSeller = isSeller;
    }
    
    if (isBuyer !== undefined) {
      trackingData.isBuyer = isBuyer;
    }
    
    // å¤„ç†é˜¶æ®µ1ï¼šéœ€æ±‚æäº¤
    if (trackingData.stages[0].status !== 'completed') {
      // åªè¦æœ‰æ¶ˆæ¯ï¼Œå°±è®¤ä¸ºéœ€æ±‚å·²æäº¤
      trackingData.stages[0].status = 'completed';
      trackingData.stages[0].timestamp = new Date().toISOString();
      
      // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
      trackingData.stages[1].status = 'active';
      trackingData.currentStage = 2;
    }
    
    // æå–äº§å“ç±»å‹ä¿¡æ¯
    const productTypes = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›', 'å°¼é¾™', 'æ¶¤çº¶'];
    for (const type of productTypes) {
      if (message.includes(type)) {
        trackingData.productType = type;
        break;
      }
    }
    
    // æå–éœ€æ±‚ç±»å‹
    if (message.includes('é¢æ–™') || message.includes('å¸ƒæ–™') || message.includes('å¸ƒ')) {
      trackingData.needType = 'é¢æ–™';
    } else if (message.includes('æœè£…') || message.includes('è¡£æœ') || message.includes('æˆè¡£')) {
      trackingData.needType = 'æœè£…';
    }
    
    // æå–æ•°é‡ä¿¡æ¯
    const quantityMatch = message.match(/(\d+)([ä»¶æ¡ç±³å¨ä¸ª])/);
    if (quantityMatch) {
      trackingData.quantity = quantityMatch[0];
    }
    
    // æå–ä»·æ ¼/é¢„ç®—ä¿¡æ¯
    if (message.includes('ä»·æ ¼') || message.includes('å¤šå°‘é’±') || message.includes('é¢„ç®—')) {
      const priceMatch = message.match(/(\d+)[-~åˆ°è‡³](\d+)[å…ƒå—]/);
      if (priceMatch) {
        trackingData.budgetRange = priceMatch[0];
      }
    }
    
    // é˜¶æ®µ2ï¼šåŒ¹é…åº“å­˜ - æ ¹æ®å…³é”®è¯åˆ¤æ–­
    if (trackingData.currentStage === 2 && trackingData.stages[1].status === 'active') {
      // å½“ç”¨æˆ·æä¾›äº†å…·ä½“çš„äº§å“å’Œéœ€æ±‚ç±»å‹æ—¶ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€é˜¶æ®µ
      if (trackingData.productType && trackingData.needType) {
        if (message.includes('åŒ¹é…') || message.includes('åº“å­˜') || message.includes('èµ„æº') || 
            message.includes('æ‰¾åˆ°') || message.includes('æœ‰è´§') || containsSpecificProductInfo(message)) {
          trackingData.stages[1].status = 'completed';
          trackingData.stages[1].timestamp = new Date().toISOString();
          
          // æ ¹æ®ç”¨æˆ·èº«ä»½å†³å®šä¸‹ä¸€æ­¥
          if (trackingData.isSeller) {
            // å–å®¶å¯»æ‰¾ä¹°å®¶ï¼Œè¿›å…¥åˆ°ä¹°å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[3].status = 'active';
            trackingData.currentStage = 4;
          } else if (trackingData.isBuyer) {
            // ä¹°å®¶å¯»æ‰¾å–å®¶ï¼Œè¿›å…¥åˆ°å–å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[2].status = 'active';
            trackingData.currentStage = 3;
          }
        }
      }
    }
    
    // é˜¶æ®µ3ï¼šå–å®¶ç¡®è®¤
    if (trackingData.currentStage === 3 && trackingData.stages[2].status === 'active') {
      if (message.includes('å–å®¶ç¡®è®¤') || message.includes('ä¾›åº”å•†ç¡®è®¤') || message.includes('å·²ç¡®è®¤') || 
          message.includes('å¯ä»¥ä¾›åº”') || message.includes('æœ‰åº“å­˜')) {
        trackingData.stages[2].status = 'completed';
        trackingData.stages[2].timestamp = new Date().toISOString();
        
        // è¿›å…¥ä¹°å®¶ç¡®è®¤é˜¶æ®µ
        trackingData.stages[3].status = 'active';
        trackingData.currentStage = 4;
      }
    }
    
    // é˜¶æ®µ4ï¼šä¹°å®¶ç¡®è®¤
    if (trackingData.currentStage === 4 && trackingData.stages[3].status === 'active') {
      if (message.includes('ä¹°å®¶ç¡®è®¤') || message.includes('å®¢æˆ·ç¡®è®¤') || message.includes('ç¡®è®¤è´­ä¹°') || 
          message.includes('æ¥å—') || message.includes('æ»¡æ„')) {
        trackingData.stages[3].status = 'completed';
        trackingData.stages[3].timestamp = new Date().toISOString();
        
        // è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µ
        trackingData.stages[4].status = 'active';
        trackingData.currentStage = 5;
      }
    }
    
    // é˜¶æ®µ5ï¼šç¡®è®¤å¯¹æ¥
    if (trackingData.currentStage === 5 && trackingData.stages[4].status === 'active') {
      if (message.includes('äº¤æ˜“æˆåŠŸ') || message.includes('å·²å¯¹æ¥') || message.includes('æˆäº¤') || 
          message.includes('å·²å®Œæˆ') || message.includes('æ„Ÿè°¢åˆä½œ')) {
        trackingData.stages[4].status = 'completed';
        trackingData.stages[4].timestamp = new Date().toISOString();
      }
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    trackingData.lastUpdated = new Date().toISOString();
    
    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(trackingData));
    
    // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
    initTrackingPanel();
  }
  
  // æ˜¾ç¤ºé˜¶æ®µè¯¦ç»†ä¿¡æ¯
  function showStageDetail(stage, trackingData) {
    const wechatContact = '<strong>JJ1598929032</strong>';
    const modal = document.createElement('div');
    modal.classList.add('progress-modal');
    
    const modalContent = document.createElement('div');
    modalContent.classList.add('modal-content');
    
    // æ·»åŠ å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.classList.add('close-modal');
    closeBtn.innerHTML = '&times;';
    closeBtn.addEventListener('click', function() {
      document.body.removeChild(modal);
    });
    
    // é˜¶æ®µè¯¦æƒ…å†…å®¹
    const stageContent = document.createElement('div');
    stageContent.classList.add('stage-detail');
    
    const stageTitle = document.createElement('h3');
    stageTitle.innerHTML = `é˜¶æ®µ ${stage.id}: ${stage.name} <span class="stage-status status-${stage.status}">${getStatusText(stage.status)}</span>`;
    
    const stageTimestamp = document.createElement('div');
    stageTimestamp.classList.add('stage-timestamp');
    if (stage.timestamp) {
      const date = new Date(stage.timestamp);
      stageTimestamp.textContent = `æ›´æ–°æ—¶é—´: ${formatDateTime(date)}`;
    } else {
      stageTimestamp.textContent = 'å°šæœªå¼€å§‹';
    }
    
    const stageDescription = document.createElement('p');
    let descriptionText = '';
    
    // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒå†…å®¹
    const isSeller = trackingData.isSeller;
    const isBuyer = trackingData.isBuyer;
    
    switch(stage.id) {
      case 1:
        if (stage.status === 'completed') {
          descriptionText = `æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : ''}éœ€æ±‚å·²æˆåŠŸæäº¤ï¼æˆ‘ä»¬çš„ç³»ç»Ÿæ­£åœ¨è¿›è¡Œåˆæ­¥åˆ†æï¼Œä»¥ä¾¿æ›´å¥½åœ°åŒ¹é…åˆé€‚çš„${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚å¦‚éœ€è¡¥å……å…·ä½“è¦æ±‚æˆ–æŸ¥è¯¢è¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : 'éœ€æ±‚'}æ„å‘ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚æ‚¨å¯ä»¥éšæ—¶æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©ã€‚`;
        }
        break;
      case 2:
        if (stage.status === 'completed') {
          descriptionText = `ç³»ç»Ÿå·²æˆåŠŸä¸ºæ‚¨åŒ¹é…åˆ°ç¬¦åˆè¦æ±‚çš„${isSeller ? 'æ½œåœ¨ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚ç°åœ¨è¿›å…¥${isSeller ? 'ä¹°å®¶' : 'å–å®¶'}ç¡®è®¤é˜¶æ®µã€‚å¦‚éœ€äº†è§£åŒ¹é…è¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `ç³»ç»Ÿæ­£åœ¨æ ¹æ®æ‚¨æä¾›çš„è¦æ±‚åŒ¹é…${isSeller ? 'ä¹°å®¶èµ„æº' : 'åº“å­˜'}ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦12å°æ—¶å†…å®Œæˆã€‚å¦‚éœ€åŠ å¿«è¿›åº¦æˆ–æä¾›æ›´è¯¦ç»†çš„éœ€æ±‚ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨éœ€æ±‚æäº¤åè‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚`;
        }
        break;
      case 3:
        if (stage.status === 'completed') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç°åœ¨ç­‰å¾…ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `æˆ‘ä»¬å·²æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„åº“å­˜ï¼Œæ­£åœ¨ç­‰å¾…å–å®¶ç¡®è®¤ã€‚é€šå¸¸ä¼šåœ¨24å°æ—¶å†…å¾—åˆ°å›å¤ã€‚å¦‚æƒ³ä¼˜å…ˆå¤„ç†æˆ–äº†è§£æ›´å¤šè¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨åŒ¹é…åˆ°åˆé€‚åº“å­˜åè”ç³»å–å®¶ç¡®è®¤ã€‚`;
        }
        break;
      case 4:
        if (stage.status === 'completed') {
          descriptionText = `ä¹°å®¶å·²ç¡®è®¤è´­ä¹°æ„å‘ï¼Œç°åœ¨è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µã€‚è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆäº¤æ˜“ç»†èŠ‚ç¡®è®¤ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç­‰å¾…æ‚¨çš„æœ€ç»ˆç¡®è®¤ã€‚ä¸ºç¡®ä¿äº¤æ˜“é¡ºåˆ©è¿›è¡Œï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¿›è¡Œåç»­æ²Ÿé€š`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨å–å®¶ç¡®è®¤åè”ç³»ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚`;
        }
        break;
      case 5:
        if (stage.status === 'completed') {
          descriptionText = `æ­å–œï¼äº¤æ˜“å·²æˆåŠŸå¯¹æ¥ã€‚è¯·é€šè¿‡å¾®ä¿¡ï¼š${wechatContact} å®Œæˆåç»­äº¤æ˜“æµç¨‹ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `æ­å–œï¼åŒæ–¹å·²è¾¾æˆå¯¹æ¥æ„å‘ã€‚ä¸ºä¿éšœäº¤æ˜“å®‰å…¨å’Œé¡ºåˆ©å®Œæˆåç»­æµç¨‹ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–è¯¦ç»†æŒ‡å¯¼`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨ä¹°å®¶ç¡®è®¤åè¿›å…¥æœ€ç»ˆå¯¹æ¥ç¡®è®¤é˜¶æ®µã€‚`;
        }
        break;
      default:
        descriptionText = `å½“å‰é˜¶æ®µçŠ¶æ€æ›´æ–°ä¸­ã€‚å¦‚éœ€åŠæ—¶äº†è§£æœ€æ–°è¿›å±•ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
    }
    
    stageDescription.innerHTML = descriptionText;
    
    const nextStepsTitle = document.createElement('h4');
    nextStepsTitle.textContent = 'ä¸‹ä¸€æ­¥æ“ä½œ';
    
    const nextStepsList = document.createElement('ul');
    const nextSteps = getNextSteps(stage.id, stage.status, trackingData);
    
    nextSteps.forEach(step => {
      const listItem = document.createElement('li');
      listItem.innerHTML = step;
      nextStepsList.appendChild(listItem);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤æç¤º
    const platformConfirmNote = document.createElement('div');
    platformConfirmNote.classList.add('platform-confirmation-note');
    platformConfirmNote.innerHTML = `<i>æ³¨æ„ï¼šå¯¹æ¥è¿›åº¦ç”±å¹³å°æ ¹æ®å®é™…æƒ…å†µç¡®è®¤æ›´æ–°ï¼Œé˜¶æ®µè¿›åº¦æ— æ³•æ‰‹åŠ¨ä¿®æ”¹ã€‚å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}</i>`;
    
    stageContent.appendChild(stageTitle);
    stageContent.appendChild(stageTimestamp);
    stageContent.appendChild(stageDescription);
    stageContent.appendChild(nextStepsTitle);
    stageContent.appendChild(nextStepsList);
    stageContent.appendChild(platformConfirmNote);
    
    modalContent.appendChild(closeBtn);
    modalContent.appendChild(stageContent);
    modal.appendChild(modalContent);
    
    document.body.appendChild(modal);
  }
  
  // æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingProgress() {
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) return;
    
    // è·å–å½“å‰æ´»è·ƒé˜¶æ®µ
    let currentActiveIndex = trackingData.stages.findIndex(stage => stage.status === 'active');
    
    // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­æ¶ˆæ¯
    showProgressUpdateMessage();
    
    // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤è¿‡ç¨‹ï¼ˆå®é™…ç¯å¢ƒä¸­åº”é€šè¿‡åç«¯APIè·å–ç¡®è®¤ç»“æœï¼‰
    setTimeout(() => {
      // å¹³å°å®¡æ ¸ç¡®è®¤åï¼Œæ›´æ–°è¿›åº¦
      // æ³¨æ„ï¼šåœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªç¡®è®¤è¿‡ç¨‹åº”è¯¥æ¥è‡ªæœåŠ¡å™¨
      const platformConfirmed = Math.random() > 0.5; // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤ç»“æœ
      
      if (platformConfirmed && currentActiveIndex !== -1 && currentActiveIndex < trackingData.stages.length - 1) {
        // å½“å‰é˜¶æ®µå®Œæˆ
        trackingData.stages[currentActiveIndex].status = 'completed';
        trackingData.stages[currentActiveIndex].timestamp = new Date().toISOString();
        
        // ä¸‹ä¸€é˜¶æ®µæ¿€æ´»
        trackingData.stages[currentActiveIndex + 1].status = 'active';
        trackingData.currentStage = currentActiveIndex + 2; // +2æ˜¯å› ä¸ºstage idä»1å¼€å§‹
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showNotification("è¿›åº¦å·²æ›´æ–°", "å¹³å°å·²ç¡®è®¤æ‚¨çš„è¿›åº¦æ›´æ–°", "success");
      } else {
        // å¹³å°æœªç¡®è®¤
        showNotification("è¿›åº¦æ›´æ–°ç­‰å¾…ä¸­", "æ‚¨çš„è¿›åº¦æ›´æ–°è¯·æ±‚æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤", "info");
      }
      
      // éšæœºæ›´æ–°å…¶ä»–ä¿¡æ¯
      if (!trackingData.productType && Math.random() > 0.7) {
        const products = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›'];
        trackingData.productType = products[Math.floor(Math.random() * products.length)];
      }
      
      if (!trackingData.needType && Math.random() > 0.7) {
        trackingData.needType = Math.random() > 0.5 ? 'é¢æ–™' : 'æœè£…';
      }
      
      if (!trackingData.quantity && trackingData.isSeller && Math.random() > 0.7) {
        const units = ['ä»¶', 'ç±³', 'æ¡'];
        trackingData.quantity = `${Math.floor(Math.random() * 1000) + 10}${units[Math.floor(Math.random() * units.length)]}`;
      }
      
      if (!trackingData.budgetRange && trackingData.isBuyer && Math.random() > 0.7) {
        const min = Math.floor(Math.random() * 500) + 50;
        const max = min + Math.floor(Math.random() * 500) + 50;
        trackingData.budgetRange = `${min}-${max}å…ƒ`;
      }
      
      // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
      trackingData.lastUpdated = new Date().toISOString();
      
      // ä¿å­˜æ›´æ–°åçš„æ•°æ®
      localStorage.setItem('trackingData', JSON.stringify(trackingData));
      
      // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿
      initTrackingPanel();
    }, 2000); // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤å»¶è¿Ÿ
  }
  
  // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­çš„æ¶ˆæ¯
  function showProgressUpdateMessage() {
    const notification = document.createElement('div');
    notification.classList.add('progress-notification', 'updating');
    notification.innerHTML = `
      <div class="notification-icon">
        <div class="loading-spinner"></div>
      </div>
      <div class="notification-content">
        <h4>è¿›åº¦æ›´æ–°è¯·æ±‚å·²æäº¤</h4>
        <p>æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...</p>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // 1.5ç§’åç§»é™¤é€šçŸ¥
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 1500);
  }
  
  // æ˜¾ç¤ºé€šçŸ¥
  function showNotification(title, message, type = "info") {
    const notification = document.createElement('div');
    notification.classList.add('progress-notification', type);
    
    let icon = '';
    if (type === 'success') {
      icon = '<div class="notification-icon success">âœ“</div>';
    } else if (type === 'error') {
      icon = '<div class="notification-icon error">âœ—</div>';
    } else {
      icon = '<div class="notification-icon info">i</div>';
    }
    
    notification.innerHTML = `
      ${icon}
      <div class="notification-content">
        <h4>${title}</h4>
        <p>${message}</p>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’åç§»é™¤é€šçŸ¥
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 500);
    }, 3000);
  }
  
  // è·å–çŠ¶æ€æ–‡æœ¬æè¿°
  function getStatusText(status) {
    switch(status) {
      case 'pending': return 'ç­‰å¾…ä¸­';
      case 'active': return 'è¿›è¡Œä¸­';
      case 'completed': return 'å·²å®Œæˆ';
      default: return 'æœªçŸ¥çŠ¶æ€';
    }
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
  function formatDateTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day} ${hours}:${minutes}`;
  }
  
  // è·å–æ—¶é—´å·®å¼‚çš„å‹å¥½æè¿°
  function getTimeDifference(oldDate, newDate) {
    const diffMs = newDate - oldDate;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffSec < 60) {
      return 'åˆšåˆš';
    } else if (diffMin < 60) {
      return `${diffMin}åˆ†é’Ÿå‰`;
    } else if (diffHour < 24) {
      return `${diffHour}å°æ—¶å‰`;
    } else if (diffDay < 30) {
      return `${diffDay}å¤©å‰`;
    } else {
      const month = String(oldDate.getMonth() + 1).padStart(2, '0');
      const day = String(oldDate.getDate()).padStart(2, '0');
      return `${month}-${day}`;
    }
  }
  
  // è·å–å·²å®Œæˆé˜¶æ®µçš„æ•°é‡
  function getCompletedStages(stages) {
    return stages.filter(stage => stage.status === 'completed').length;
  }
  
  // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åŒ…å«å…·ä½“äº§å“ä¿¡æ¯
  function containsSpecificProductInfo(message) {
    // åŒ¹é…å…·ä½“çš„äº§å“æè¿°
    const patterns = [
      /\d+[ä»¶æ¡ç±³å¨]/,  // åŒ¹é…æ•°é‡å•ä½
      /æ¬¾å¼|å‹å·|è§„æ ¼|å°ºå¯¸|é¢œè‰²|æˆåˆ†/,  // åŒ¹é…äº§å“å±æ€§
      /ç‰Œ|å“ç‰Œ|å‚å®¶|ç”Ÿäº§å•†/,  // åŒ¹é…å“ç‰Œä¿¡æ¯
      /ä»·æ ¼|æŠ¥ä»·|å…ƒ\/[ç±³ä»¶æ¡]/  // åŒ¹é…ä»·æ ¼ä¿¡æ¯
    ];
    
    return patterns.some(pattern => pattern.test(message));
  }
  
  // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½è·å–ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•
  function getNextSteps(stageId, stageStatus, trackingData) {
    const wechatContact = '<strong>JJ1598929032</strong>';
    const isSeller = trackingData.isSeller;
    const isBuyer = trackingData.isBuyer;
    
    // å¦‚æœé˜¶æ®µå·²å®Œæˆï¼Œè¿”å›ç©ºæ­¥éª¤åˆ—è¡¨
    if (stageStatus === 'completed') {
      return [`æ­¤é˜¶æ®µå·²å®Œæˆï¼Œè¯·ç»§ç»­æ¨è¿›ä¸‹ä¸€é˜¶æ®µ`, `å¦‚æœ‰é—®é¢˜è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å’¨è¯¢`];
    }
    
    // å¦‚æœé˜¶æ®µæœªå¼€å§‹ï¼Œè¿”å›ç­‰å¾…æŒ‡å¼•
    if (stageStatus === 'pending') {
      return [`è¯·ç­‰å¾…å‰åºé˜¶æ®µå®Œæˆåå†è¿›è¡Œæ­¤é˜¶æ®µ`, `å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`];
    }
    
    // é˜¶æ®µå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæ ¹æ®ä¸åŒæƒ…å†µè¿”å›æŒ‡å¼•
    if (isSeller) {
      switch(stageId) {
        case 1:
          return [
            `è¯¦ç»†æè¿°æ‚¨è¦å‡ºå”®çš„äº§å“ç±»å‹ã€æ•°é‡å’ŒæœŸæœ›ä»·æ ¼`,
            `æä¾›äº§å“å›¾ç‰‡æˆ–è¯¦ç»†è§„æ ¼è¯´æ˜`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
          ];
        case 2:
          return [
            `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…æ½œåœ¨ä¹°å®¶`,
            `å®Œå–„æ‚¨çš„äº§å“ç»†èŠ‚ä¿¡æ¯ä»¥æé«˜åŒ¹é…ç‡`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
          ];
        case 3:
          return [
            `å‡†å¤‡å¥½è¯¦ç»†çš„äº§å“è¯´æ˜å’Œä»·æ ¼èµ„æ–™`,
            `ç¡®è®¤æ‚¨çš„å‘è´§èƒ½åŠ›å’Œåº“å­˜æƒ…å†µ`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£ä¹°å®¶éœ€æ±‚ç»†èŠ‚`
          ];
        case 4:
          return [
            `å‡†å¤‡è¯¦ç»†çš„äº§å“èµ„æ–™å’ŒæŠ¥ä»·å•`,
            `ç¡®è®¤æ‚¨çš„ä»“åº“åº“å­˜å’Œç‰©æµé…é€æ–¹æ¡ˆ`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸ä¹°å®¶ç›´æ¥æ²Ÿé€š`
          ];
        case 5:
          return [
            `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œä»˜æ¬¾æ–¹å¼`,
            `å‡†å¤‡äº§å“å‘è´§å’Œå”®åæœåŠ¡æ–¹æ¡ˆ`,
            `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
          ];
        default:
          return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
      }
    } else if (isBuyer) {
      switch(stageId) {
        case 1:
          return [
            `è¯¦ç»†æè¿°æ‚¨éœ€è¦çš„äº§å“ç±»å‹ã€æ•°é‡å’Œé¢„ç®—`,
            `è¯´æ˜æ‚¨å¯¹äº§å“è´¨é‡å’Œè§„æ ¼çš„è¦æ±‚`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
          ];
        case 2:
          return [
            `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…åˆé€‚åº“å­˜`,
            `å®Œå–„æ‚¨çš„éœ€æ±‚ç»†èŠ‚ä»¥æé«˜åŒ¹é…ç²¾å‡†åº¦`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
          ];
        case 3:
          return [
            `å‡†å¤‡å¥½ä¸å–å®¶æ²Ÿé€šçš„å…·ä½“é—®é¢˜`,
            `ç¡®è®¤æ‚¨çš„é‡‡è´­é¢„ç®—å’Œä»˜æ¬¾æ–¹å¼`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£å–å®¶ç¡®è®¤è¿›åº¦`
          ];
        case 4:
          return [
            `ä»”ç»†è¯„ä¼°å–å®¶æä¾›çš„äº§å“ä¿¡æ¯`,
            `ç¡®è®¤äº§å“æ˜¯å¦æ»¡è¶³æ‚¨çš„éœ€æ±‚`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸å–å®¶ç›´æ¥æ²Ÿé€š`
          ];
        case 5:
          return [
            `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œæ”¶è´§åœ°å€`,
            `å‡†å¤‡ä»˜æ¬¾å’ŒéªŒæ”¶äº§å“`,
            `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
          ];
        default:
          return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
      }
    } else {
      // ç”¨æˆ·èº«ä»½æœªç¡®å®š
      switch(stageId) {
        case 1:
          return [
            `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨æ˜¯å¸Œæœ›å‡ºå”®è¿˜æ˜¯é‡‡è´­`,
            `è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚æˆ–äº§å“ä¿¡æ¯`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–ä¸“ä¸šæŒ‡å¯¼`
          ];
        default:
          return [
            `è¯·å…ˆæ˜ç¡®æ‚¨çš„èº«ä»½ï¼ˆä¹°å®¶/å–å®¶ï¼‰`,
            `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©`
          ];
      }
    }
  }
  
  // ä¸ºåŠ¨ç”»æ·»åŠ ç¨³å®šæ€§ä¿®å¤
  function animateStats() {
    const statValues = document.querySelectorAll('.stat-value');
    
    statValues.forEach(statValue => {
      const targetValue = parseInt(statValue.textContent, 10);
      let currentValue = 0;
      const duration = 2000;
      const stepTime = 20;
      const totalSteps = duration / stepTime;
      const stepValue = targetValue / totalSteps;
      
      function updateValue() {
        currentValue += stepValue;
        
        if (currentValue < targetValue) {
          statValue.textContent = Math.floor(currentValue);
          requestAnimationFrame(updateValue);
        } else {
          statValue.textContent = targetValue;
          
          // æ·»åŠ ä»¥é˜²æ­¢æ•°å­—å˜åŒ–å¯¼è‡´å¸ƒå±€ç§»åŠ¨
          statValue.style.minWidth = statValue.offsetWidth + 'px';
        }
      }
      
      // å½“å…ƒç´ è¿›å…¥è§†å£æ—¶å¯åŠ¨åŠ¨ç”»
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            updateValue();
            observer.unobserve(entry.target);
          }
        });
      });
      
      observer.observe(statValue);
    });
  }
  
  // å¯¼èˆªæ åˆå§‹åŒ–ä¸æ»šåŠ¨æ•ˆæœ
  function initNavbar() {
    const navbar = document.querySelector('.navbar');
    
    // æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', function() {
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });
    
    // å¯¼èˆªèœå•é¡¹ç‚¹å‡»æ¿€æ´»æ•ˆæœ
    const navLinks = document.querySelectorAll('.main-nav a');
    
    navLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        // è·å–ç›®æ ‡éƒ¨åˆ†çš„ID
        const targetId = this.getAttribute('href');
        
        // ä»…å¯¹é¡µå†…é”šç‚¹é“¾æ¥è¿›è¡Œå¤„ç†
        if (targetId.startsWith('#')) {
          e.preventDefault();
          
          const targetSection = document.querySelector(targetId);
          
          if (targetSection) {
            // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡éƒ¨åˆ†
            window.scrollTo({
              top: targetSection.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
              behavior: 'smooth'
            });
            
            // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
            history.pushState(null, null, targetId);
            
            // ç§»é™¤æ‰€æœ‰activeç±»
            navLinks.forEach(item => {
              item.parentElement.classList.remove('active');
            });
            
            // ä¸ºå½“å‰ç‚¹å‡»é¡¹æ·»åŠ activeç±»
            this.parentElement.classList.add('active');
          }
        }
      });
    });
  }
  
  // æ·»åŠ æ»šåŠ¨ç›‘å¬ï¼Œé«˜äº®å½“å‰è§†å›¾ä¸­çš„éƒ¨åˆ†
  function initScrollSpy() {
    // è·å–æ‰€æœ‰ä¸»è¦éƒ¨åˆ†
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.main-nav a');
    
    // æ·»åŠ æ»šåŠ¨ç›‘å¬
    window.addEventListener('scroll', function() {
      // å½“å‰æ»šåŠ¨ä½ç½®
      const scrollPosition = window.scrollY + 100; // æ·»åŠ ä¸€äº›åç§»ä»¥æå‰æ¿€æ´»
      
      // æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†çš„ä½ç½®
      sections.forEach(section => {
        // è·å–éƒ¨åˆ†çš„é¡¶éƒ¨å’Œåº•éƒ¨ä½ç½®
        const sectionTop = section.offsetTop;
        const sectionBottom = sectionTop + section.offsetHeight;
        
        // æ£€æŸ¥å½“å‰æ»šåŠ¨ä½ç½®æ˜¯å¦åœ¨è¯¥éƒ¨åˆ†
        if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
          // æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé“¾æ¥
          const targetId = '#' + section.getAttribute('id');
          
          // ç§»é™¤æ‰€æœ‰activeç±»
          navLinks.forEach(link => {
            link.parentElement.classList.remove('active');
            
            // ä¸ºå½“å‰éƒ¨åˆ†çš„é“¾æ¥æ·»åŠ activeç±»
            if (link.getAttribute('href') === targetId) {
              link.parentElement.classList.add('active');
            }
          });
        }
      });
    });
  }
  
  // å¹³æ»‘æ»šåŠ¨æ•ˆæœ
  function addSmoothScrolling() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        const targetId = this.getAttribute('href');
        
        if (targetId === '#') return;
        
        const target = document.querySelector(targetId);
        
        if (target) {
          e.preventDefault();
          
          window.scrollTo({
            top: target.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
            behavior: 'smooth'
          });
          
          // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
          history.pushState(null, null, targetId);
        }
      });
    });
  }
  
  // åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
  function initDarkMode() {
    const darkModeToggle = document.querySelector('.dark-mode-toggle');
    if (darkModeToggle) {
      darkModeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
          this.textContent = 'â˜€ï¸';
        } else {
          this.textContent = 'ğŸŒ™';
        }
      });
    }
  }
});
  
  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  function initTrackingPanel() {
    const trackingPanel = document.querySelector('.process-flow');
    if (!trackingPanel) return;
  
    // åˆå§‹åŒ–è¿›åº¦æµç¨‹å›¾ - ä»localStorageè·å–å½“å‰çŠ¶æ€
    let currentTrackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è·Ÿè¸ªæ•°æ®æˆ–è€…æ˜¯æ–°ä¼šè¯ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
    if (!currentTrackingData) {
      currentTrackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
      
      // ä¿å­˜åˆå§‹æ•°æ®
      localStorage.setItem('trackingData', JSON.stringify(currentTrackingData));
    }
    
    // æ¸…ç©ºé»˜è®¤å†…å®¹
    trackingPanel.innerHTML = '';
    
    // åˆ›å»ºè¿›åº¦æ¡
    const progressBar = document.createElement('div');
    progressBar.classList.add('progress-bar');
    
    // æ·»åŠ å„ä¸ªé˜¶æ®µ
    currentTrackingData.stages.forEach(stage => {
      const stageElement = document.createElement('div');
      stageElement.classList.add('progress-stage', `status-${stage.status}`);
      stageElement.dataset.stageId = stage.id;
      
      const stageNumber = document.createElement('div');
      stageNumber.classList.add('stage-number');
      stageNumber.textContent = stage.id;
      
      const stageName = document.createElement('div');
      stageName.classList.add('stage-name');
      stageName.textContent = stage.name;
      
      stageElement.appendChild(stageNumber);
      stageElement.appendChild(stageName);
      
      // ç‚¹å‡»é˜¶æ®µæ˜¾ç¤ºè¯¦æƒ…
      stageElement.addEventListener('click', () => showStageDetail(stage, currentTrackingData));
      
      progressBar.appendChild(stageElement);
      
      // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€ä¸ªé˜¶æ®µï¼‰
      if (stage.id < currentTrackingData.stages.length) {
        const connector = document.createElement('div');
        connector.classList.add('stage-connector', `status-${stage.status}`);
        progressBar.appendChild(connector);
      }
    });
    
    trackingPanel.appendChild(progressBar);
    
    // æ·»åŠ è¯´æ˜æ–‡å­—
    const statusInfo = document.createElement('div');
    statusInfo.classList.add('status-info');
    
    // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„é˜¶æ®µ
    const activeStage = currentTrackingData.stages.find(stage => stage.status === 'active');
    const stageName = activeStage ? activeStage.name : 'å‡†å¤‡ä¸­';
    
    // è®¡ç®—æœ€åæ›´æ–°æ—¶é—´
    const lastUpdateTime = getTimeDifference(new Date(currentTrackingData.lastUpdated), new Date());
    
    statusInfo.innerHTML = `å½“å‰çŠ¶æ€ï¼š<span class="status-active">${stageName}</span> Â· æ›´æ–°äº ${lastUpdateTime}`;
    trackingPanel.appendChild(statusInfo);
    
    // æ·»åŠ è¿›åº¦æ¦‚è¦
    const progressSummary = document.createElement('div');
    progressSummary.classList.add('progress-summary');
    
    // æ ¹æ®ç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒçš„è¿›åº¦æ¦‚è¦
    const isSeller = currentTrackingData.isSeller;
    const isBuyer = currentTrackingData.isBuyer;
    
    // è·å–ä¹°å–éœ€æ±‚ç±»å‹
    const needTypeDisplay = currentTrackingData.needType ? currentTrackingData.needType : 'ç­‰å¾…ç¡®è®¤';
    const productTypeDisplay = currentTrackingData.productType ? currentTrackingData.productType : 'ç­‰å¾…ç¡®è®¤';
    
    let summaryHTML = '';
    if (isSeller) {
      summaryHTML = `
        <h4>å‡ºå”®ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>å•†å“ç±»å‹: ${productTypeDisplay}</li>
          <li>åº“å­˜æ•°é‡: ${currentTrackingData.quantity || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else if (isBuyer) {
      summaryHTML = `
        <h4>é‡‡è´­ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>éœ€æ±‚ç±»å‹: ${needTypeDisplay}</li>
          <li>äº§å“ç±»å‹: ${productTypeDisplay}</li>
          <li>é¢„ç®—èŒƒå›´: ${currentTrackingData.budgetRange || 'ç­‰å¾…ç¡®è®¤'}</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    } else {
      summaryHTML = `
        <h4>å¯¹æ¥ä¿¡æ¯æ‘˜è¦</h4>
        <ul>
          <li>è¯·åœ¨èŠå¤©ä¸­è¯´æ˜æ‚¨æ˜¯éœ€è¦å‡ºå”®è¿˜æ˜¯é‡‡è´­</li>
          <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
        </ul>
      `;
    }
    
    progressSummary.innerHTML = summaryHTML;
    trackingPanel.appendChild(progressSummary);
    
    // æ·»åŠ åˆ·æ–°æŒ‰é’®
    const refreshButton = document.createElement('button');
    refreshButton.classList.add('refresh-tracking');
    refreshButton.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
    refreshButton.addEventListener('click', function() {
      // è¯·æ±‚å¹³å°æ›´æ–°è¿›åº¦
      updateTrackingProgress();
      
      // æ·»åŠ åˆ·æ–°åŠ¨ç”»
      this.classList.add('refreshing');
      // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
      this.textContent = 'æ­£åœ¨è¯·æ±‚å¹³å°ç¡®è®¤...';
      setTimeout(() => {
        this.classList.remove('refreshing');
        this.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
      }, 2000);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤è¯´æ˜
    const confirmNote = document.createElement('div');
    confirmNote.classList.add('platform-note');
    confirmNote.innerHTML = 'æç¤ºï¼šæ‰€æœ‰è¿›åº¦æ›´æ–°éœ€è¦å¹³å°ç¡®è®¤åæ‰èƒ½ç”Ÿæ•ˆ';
    
    trackingPanel.appendChild(refreshButton);
    trackingPanel.appendChild(confirmNote);
  }
  
  // æ ¹æ®èŠå¤©å†…å®¹æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingFromChat(message, isSeller, isBuyer) {
    // è·å–å½“å‰è¿›åº¦æ•°æ®
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) {
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
      trackingData = {
        currentStage: 1,
        stages: [
          { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
          { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
          { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
          { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
        ],
        lastUpdated: new Date().toISOString(),
        isSeller: false,
        isBuyer: false,
        needType: '',
        productType: '',
        quantity: '',
        budgetRange: ''
      };
    }
    
    // æ›´æ–°ä¹°å–èº«ä»½
    if (isSeller !== undefined) {
      trackingData.isSeller = isSeller;
    }
    
    if (isBuyer !== undefined) {
      trackingData.isBuyer = isBuyer;
    }
    
    // å¤„ç†é˜¶æ®µ1ï¼šéœ€æ±‚æäº¤
    if (trackingData.stages[0].status !== 'completed') {
      // åªè¦æœ‰æ¶ˆæ¯ï¼Œå°±è®¤ä¸ºéœ€æ±‚å·²æäº¤
      trackingData.stages[0].status = 'completed';
      trackingData.stages[0].timestamp = new Date().toISOString();
      
      // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
      trackingData.stages[1].status = 'active';
      trackingData.currentStage = 2;
    }
    
    // æå–äº§å“ç±»å‹ä¿¡æ¯
    const productTypes = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›', 'å°¼é¾™', 'æ¶¤çº¶'];
    for (const type of productTypes) {
      if (message.includes(type)) {
        trackingData.productType = type;
        break;
      }
    }
    
    // æå–éœ€æ±‚ç±»å‹
    if (message.includes('é¢æ–™') || message.includes('å¸ƒæ–™') || message.includes('å¸ƒ')) {
      trackingData.needType = 'é¢æ–™';
    } else if (message.includes('æœè£…') || message.includes('è¡£æœ') || message.includes('æˆè¡£')) {
      trackingData.needType = 'æœè£…';
    }
    
    // æå–æ•°é‡ä¿¡æ¯
    const quantityMatch = message.match(/(\d+)([ä»¶æ¡ç±³å¨ä¸ª])/);
    if (quantityMatch) {
      trackingData.quantity = quantityMatch[0];
    }
    
    // æå–ä»·æ ¼/é¢„ç®—ä¿¡æ¯
    if (message.includes('ä»·æ ¼') || message.includes('å¤šå°‘é’±') || message.includes('é¢„ç®—')) {
      const priceMatch = message.match(/(\d+)[-~åˆ°è‡³](\d+)[å…ƒå—]/);
      if (priceMatch) {
        trackingData.budgetRange = priceMatch[0];
      }
    }
    
    // é˜¶æ®µ2ï¼šåŒ¹é…åº“å­˜ - æ ¹æ®å…³é”®è¯åˆ¤æ–­
    if (trackingData.currentStage === 2 && trackingData.stages[1].status === 'active') {
      // å½“ç”¨æˆ·æä¾›äº†å…·ä½“çš„äº§å“å’Œéœ€æ±‚ç±»å‹æ—¶ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€é˜¶æ®µ
      if (trackingData.productType && trackingData.needType) {
        if (message.includes('åŒ¹é…') || message.includes('åº“å­˜') || message.includes('èµ„æº') || 
            message.includes('æ‰¾åˆ°') || message.includes('æœ‰è´§') || containsSpecificProductInfo(message)) {
          trackingData.stages[1].status = 'completed';
          trackingData.stages[1].timestamp = new Date().toISOString();
          
          // æ ¹æ®ç”¨æˆ·èº«ä»½å†³å®šä¸‹ä¸€æ­¥
          if (trackingData.isSeller) {
            // å–å®¶å¯»æ‰¾ä¹°å®¶ï¼Œè¿›å…¥åˆ°ä¹°å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[3].status = 'active';
            trackingData.currentStage = 4;
          } else if (trackingData.isBuyer) {
            // ä¹°å®¶å¯»æ‰¾å–å®¶ï¼Œè¿›å…¥åˆ°å–å®¶ç¡®è®¤é˜¶æ®µ
            trackingData.stages[2].status = 'active';
            trackingData.currentStage = 3;
          }
        }
      }
    }
    
    // é˜¶æ®µ3ï¼šå–å®¶ç¡®è®¤
    if (trackingData.currentStage === 3 && trackingData.stages[2].status === 'active') {
      if (message.includes('å–å®¶ç¡®è®¤') || message.includes('ä¾›åº”å•†ç¡®è®¤') || message.includes('å·²ç¡®è®¤') || 
          message.includes('å¯ä»¥ä¾›åº”') || message.includes('æœ‰åº“å­˜')) {
        trackingData.stages[2].status = 'completed';
        trackingData.stages[2].timestamp = new Date().toISOString();
        
        // è¿›å…¥ä¹°å®¶ç¡®è®¤é˜¶æ®µ
        trackingData.stages[3].status = 'active';
        trackingData.currentStage = 4;
      }
    }
    
    // é˜¶æ®µ4ï¼šä¹°å®¶ç¡®è®¤
    if (trackingData.currentStage === 4 && trackingData.stages[3].status === 'active') {
      if (message.includes('ä¹°å®¶ç¡®è®¤') || message.includes('å®¢æˆ·ç¡®è®¤') || message.includes('ç¡®è®¤è´­ä¹°') || 
          message.includes('æ¥å—') || message.includes('æ»¡æ„')) {
        trackingData.stages[3].status = 'completed';
        trackingData.stages[3].timestamp = new Date().toISOString();
        
        // è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µ
        trackingData.stages[4].status = 'active';
        trackingData.currentStage = 5;
      }
    }
    
    // é˜¶æ®µ5ï¼šç¡®è®¤å¯¹æ¥
    if (trackingData.currentStage === 5 && trackingData.stages[4].status === 'active') {
      if (message.includes('äº¤æ˜“æˆåŠŸ') || message.includes('å·²å¯¹æ¥') || message.includes('æˆäº¤') || 
          message.includes('å·²å®Œæˆ') || message.includes('æ„Ÿè°¢åˆä½œ')) {
        trackingData.stages[4].status = 'completed';
        trackingData.stages[4].timestamp = new Date().toISOString();
      }
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    trackingData.lastUpdated = new Date().toISOString();
    
    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(trackingData));
    
    // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
    initTrackingPanel();
  }
  
  // æ˜¾ç¤ºé˜¶æ®µè¯¦ç»†ä¿¡æ¯
  function showStageDetail(stage, trackingData) {
    const wechatContact = '<strong>JJ1598929032</strong>';
    const modal = document.createElement('div');
    modal.classList.add('progress-modal');
    
    const modalContent = document.createElement('div');
    modalContent.classList.add('modal-content');
    
    // æ·»åŠ å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.classList.add('close-modal');
    closeBtn.innerHTML = '&times;';
    closeBtn.addEventListener('click', function() {
      document.body.removeChild(modal);
    });
    
    // é˜¶æ®µè¯¦æƒ…å†…å®¹
    const stageContent = document.createElement('div');
    stageContent.classList.add('stage-detail');
    
    const stageTitle = document.createElement('h3');
    stageTitle.innerHTML = `é˜¶æ®µ ${stage.id}: ${stage.name} <span class="stage-status status-${stage.status}">${getStatusText(stage.status)}</span>`;
    
    const stageTimestamp = document.createElement('div');
    stageTimestamp.classList.add('stage-timestamp');
    if (stage.timestamp) {
      const date = new Date(stage.timestamp);
      stageTimestamp.textContent = `æ›´æ–°æ—¶é—´: ${formatDateTime(date)}`;
    } else {
      stageTimestamp.textContent = 'å°šæœªå¼€å§‹';
    }
    
    const stageDescription = document.createElement('p');
    let descriptionText = '';
    
    // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒå†…å®¹
    const isSeller = trackingData.isSeller;
    const isBuyer = trackingData.isBuyer;
    
    switch(stage.id) {
      case 1:
        if (stage.status === 'completed') {
          descriptionText = `æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : ''}éœ€æ±‚å·²æˆåŠŸæäº¤ï¼æˆ‘ä»¬çš„ç³»ç»Ÿæ­£åœ¨è¿›è¡Œåˆæ­¥åˆ†æï¼Œä»¥ä¾¿æ›´å¥½åœ°åŒ¹é…åˆé€‚çš„${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚å¦‚éœ€è¡¥å……å…·ä½“è¦æ±‚æˆ–æŸ¥è¯¢è¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : 'éœ€æ±‚'}æ„å‘ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚æ‚¨å¯ä»¥éšæ—¶æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©ã€‚`;
        }
        break;
      case 2:
        if (stage.status === 'completed') {
          descriptionText = `ç³»ç»Ÿå·²æˆåŠŸä¸ºæ‚¨åŒ¹é…åˆ°ç¬¦åˆè¦æ±‚çš„${isSeller ? 'æ½œåœ¨ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚ç°åœ¨è¿›å…¥${isSeller ? 'ä¹°å®¶' : 'å–å®¶'}ç¡®è®¤é˜¶æ®µã€‚å¦‚éœ€äº†è§£åŒ¹é…è¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `ç³»ç»Ÿæ­£åœ¨æ ¹æ®æ‚¨æä¾›çš„è¦æ±‚åŒ¹é…${isSeller ? 'ä¹°å®¶èµ„æº' : 'åº“å­˜'}ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦12å°æ—¶å†…å®Œæˆã€‚å¦‚éœ€åŠ å¿«è¿›åº¦æˆ–æä¾›æ›´è¯¦ç»†çš„éœ€æ±‚ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨éœ€æ±‚æäº¤åè‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚`;
        }
        break;
      case 3:
        if (stage.status === 'completed') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç°åœ¨ç­‰å¾…ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else if (stage.status === 'active') {
          descriptionText = `æˆ‘ä»¬å·²æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„åº“å­˜ï¼Œæ­£åœ¨ç­‰å¾…å–å®¶ç¡®è®¤ã€‚é€šå¸¸ä¼šåœ¨24å°æ—¶å†…å¾—åˆ°å›å¤ã€‚å¦‚æƒ³ä¼˜å…ˆå¤„ç†æˆ–äº†è§£æ›´å¤šè¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨åŒ¹é…åˆ°åˆé€‚åº“å­˜åè”ç³»å–å®¶ç¡®è®¤ã€‚`;
        }
        break;
      case 4:
        if (stage.status === 'completed') {
          descriptionText = `ä¹°å®¶å·²ç¡®è®¤è´­ä¹°æ„å‘ï¼Œç°åœ¨è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µã€‚è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆäº¤æ˜“ç»†èŠ‚ç¡®è®¤ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç­‰å¾…æ‚¨çš„æœ€ç»ˆç¡®è®¤ã€‚ä¸ºç¡®ä¿äº¤æ˜“é¡ºåˆ©è¿›è¡Œï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¿›è¡Œåç»­æ²Ÿé€š`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨å–å®¶ç¡®è®¤åè”ç³»ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚`;
        }
        break;
      case 5:
        if (stage.status === 'completed') {
          descriptionText = `æ­å–œï¼äº¤æ˜“å·²æˆåŠŸå¯¹æ¥ã€‚è¯·é€šè¿‡å¾®ä¿¡ï¼š${wechatContact} å®Œæˆåç»­äº¤æ˜“æµç¨‹ã€‚`;
        } else if (stage.status === 'active') {
          descriptionText = `æ­å–œï¼åŒæ–¹å·²è¾¾æˆå¯¹æ¥æ„å‘ã€‚ä¸ºä¿éšœäº¤æ˜“å®‰å…¨å’Œé¡ºåˆ©å®Œæˆåç»­æµç¨‹ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–è¯¦ç»†æŒ‡å¯¼`;
        } else {
          descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨ä¹°å®¶ç¡®è®¤åè¿›å…¥æœ€ç»ˆå¯¹æ¥ç¡®è®¤é˜¶æ®µã€‚`;
        }
        break;
      default:
        descriptionText = `å½“å‰é˜¶æ®µçŠ¶æ€æ›´æ–°ä¸­ã€‚å¦‚éœ€åŠæ—¶äº†è§£æœ€æ–°è¿›å±•ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
    }
    
    stageDescription.innerHTML = descriptionText;
    
    const nextStepsTitle = document.createElement('h4');
    nextStepsTitle.textContent = 'ä¸‹ä¸€æ­¥æ“ä½œ';
    
    const nextStepsList = document.createElement('ul');
    const nextSteps = getNextSteps(stage.id, stage.status, trackingData);
    
    nextSteps.forEach(step => {
      const listItem = document.createElement('li');
      listItem.innerHTML = step;
      nextStepsList.appendChild(listItem);
    });
    
    // æ·»åŠ å¹³å°ç¡®è®¤æç¤º
    const platformConfirmNote = document.createElement('div');
    platformConfirmNote.classList.add('platform-confirmation-note');
    platformConfirmNote.innerHTML = `<i>æ³¨æ„ï¼šå¯¹æ¥è¿›åº¦ç”±å¹³å°æ ¹æ®å®é™…æƒ…å†µç¡®è®¤æ›´æ–°ï¼Œé˜¶æ®µè¿›åº¦æ— æ³•æ‰‹åŠ¨ä¿®æ”¹ã€‚å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}</i>`;
    
    stageContent.appendChild(stageTitle);
    stageContent.appendChild(stageTimestamp);
    stageContent.appendChild(stageDescription);
    stageContent.appendChild(nextStepsTitle);
    stageContent.appendChild(nextStepsList);
    stageContent.appendChild(platformConfirmNote);
    
    modalContent.appendChild(closeBtn);
    modalContent.appendChild(stageContent);
    modal.appendChild(modalContent);
    
    document.body.appendChild(modal);
  }
  
  // æ›´æ–°å¯¹æ¥è¿›åº¦
  function updateTrackingProgress() {
    let trackingData = JSON.parse(localStorage.getItem('trackingData'));
    
    if (!trackingData) return;
    
    // è·å–å½“å‰æ´»è·ƒé˜¶æ®µ
    let currentActiveIndex = trackingData.stages.findIndex(stage => stage.status === 'active');
    
    // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­æ¶ˆæ¯
    showProgressUpdateMessage();
    
    // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤è¿‡ç¨‹ï¼ˆå®é™…ç¯å¢ƒä¸­åº”é€šè¿‡åç«¯APIè·å–ç¡®è®¤ç»“æœï¼‰
    setTimeout(() => {
      // å¹³å°å®¡æ ¸ç¡®è®¤åï¼Œæ›´æ–°è¿›åº¦
      // æ³¨æ„ï¼šåœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªç¡®è®¤è¿‡ç¨‹åº”è¯¥æ¥è‡ªæœåŠ¡å™¨
      const platformConfirmed = Math.random() > 0.5; // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤ç»“æœ
      
      if (platformConfirmed && currentActiveIndex !== -1 && currentActiveIndex < trackingData.stages.length - 1) {
        // å½“å‰é˜¶æ®µå®Œæˆ
        trackingData.stages[currentActiveIndex].status = 'completed';
        trackingData.stages[currentActiveIndex].timestamp = new Date().toISOString();
        
        // ä¸‹ä¸€é˜¶æ®µæ¿€æ´»
        trackingData.stages[currentActiveIndex + 1].status = 'active';
        trackingData.currentStage = currentActiveIndex + 2; // +2æ˜¯å› ä¸ºstage idä»1å¼€å§‹
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showNotification("è¿›åº¦å·²æ›´æ–°", "å¹³å°å·²ç¡®è®¤æ‚¨çš„è¿›åº¦æ›´æ–°", "success");
      } else {
        // å¹³å°æœªç¡®è®¤
        showNotification("è¿›åº¦æ›´æ–°ç­‰å¾…ä¸­", "æ‚¨çš„è¿›åº¦æ›´æ–°è¯·æ±‚æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤", "info");
      }
      
      // éšæœºæ›´æ–°å…¶ä»–ä¿¡æ¯
      if (!trackingData.productType && Math.random() > 0.7) {
        const products = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›'];
        trackingData.productType = products[Math.floor(Math.random() * products.length)];
      }
      
      if (!trackingData.needType && Math.random() > 0.7) {
        trackingData.needType = Math.random() > 0.5 ? 'é¢æ–™' : 'æœè£…';
      }
      
      if (!trackingData.quantity && trackingData.isSeller && Math.random() > 0.7) {
        const units = ['ä»¶', 'ç±³', 'æ¡'];
        trackingData.quantity = `${Math.floor(Math.random() * 1000) + 10}${units[Math.floor(Math.random() * units.length)]}`;
      }
      
      if (!trackingData.budgetRange && trackingData.isBuyer && Math.random() > 0.7) {
        const min = Math.floor(Math.random() * 500) + 50;
// DOM Elements
document.addEventListener('DOMContentLoaded', function() {
  // å¯¼èˆªæ æ»šåŠ¨æ•ˆæœ
  const navbar = document.querySelector('.navbar');
  const heroSection = document.querySelector('.hero');
  
  if (navbar && heroSection) {
    const heroHeight = heroSection.offsetHeight;
    
    window.addEventListener('scroll', function() {
      if (window.scrollY > 100) {
        navbar.style.backgroundColor = 'rgba(47, 47, 47, 0.95)';
        navbar.style.color = '#FAF9F6';
      } else {
        navbar.style.backgroundColor = 'rgba(250, 249, 246, 0.95)';
        navbar.style.color = '#2F2F2F';
      }
    });
  }

  // åˆ‡æ¢ä¸»é¢˜æ¨¡å¼
  const themeSwitch = document.querySelector('.theme-switch');
  if (themeSwitch) {
    themeSwitch.addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      if (document.body.classList.contains('dark-mode')) {
        themeSwitch.textContent = 'â˜€ï¸';
      } else {
        themeSwitch.textContent = 'ğŸŒ™';
      }
    });
  }

  // è¯­è¨€åˆ‡æ¢
  const langSwitch = document.querySelector('.lang-switch');
  if (langSwitch) {
    langSwitch.addEventListener('click', function() {
      if (langSwitch.textContent === 'EN') {
        langSwitch.textContent = 'CN';
        // è¿™é‡Œæ·»åŠ å®é™…è¯­è¨€åˆ‡æ¢é€»è¾‘
      } else {
        langSwitch.textContent = 'EN';
        // è¿™é‡Œæ·»åŠ å®é™…è¯­è¨€åˆ‡æ¢é€»è¾‘
      }
    });
  }

  // æŒ‰é’®æ³¢çº¹æ•ˆæœ
  const buttons = document.querySelectorAll('button:not(.tag)');
  buttons.forEach(button => {
    button.classList.add('ripple-button');
    button.addEventListener('click', createRipple);
  });

  function createRipple(event) {
    const button = event.currentTarget;
    const ripple = document.createElement('span');
    const rect = button.getBoundingClientRect();
    
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;
    
    ripple.style.width = ripple.style.height = `${size}px`;
    ripple.style.left = `${x}px`;
    ripple.style.top = `${y}px`;
    
    button.appendChild(ripple);
    
    setTimeout(() => {
      ripple.remove();
    }, 600);
  }

  // ææ–™æ ‡ç­¾äº¤äº’
  const materialTags = document.querySelectorAll('.material-tags .tag');
  if (materialTags.length > 0) {
    materialTags.forEach(tag => {
      tag.addEventListener('click', function() {
        materialTags.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // æ ‡ç­¾ç¼åˆåŠ¨ç”»æ•ˆæœ
        const tagText = this.textContent;
        const filterDisplay = document.createElement('div');
        filterDisplay.classList.add('active-filter');
        filterDisplay.textContent = `å·²ç­›é€‰: ${tagText}`;
        
        const filterContainer = document.querySelector('.material-tags');
        const existingFilter = document.querySelector('.active-filter');
        
        if (existingFilter) {
          filterContainer.removeChild(existingFilter);
        }
        
        if (tagText !== 'å…¨éƒ¨') {
          filterContainer.appendChild(filterDisplay);
        }
        
        // è¿™é‡Œæ·»åŠ å®é™…è¿‡æ»¤é€»è¾‘
        filterProjects(tagText);
      });
    });
  }

  // æ¨¡æ‹Ÿé¡¹ç›®è¿‡æ»¤åŠŸèƒ½
  function filterProjects(category) {
    console.log(`Filtering projects by: ${category}`);
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šæ ¹æ®ç±»åˆ«è¿‡æ»¤DOMå…ƒç´ æˆ–ä»æœåŠ¡å™¨è¯·æ±‚æ•°æ®
  }

  // ç”Ÿæˆ3Då±•ç¤ºå¢™
  initShowcase3D();

  // ç”Ÿæˆé¡¹ç›®å±•ç¤ºå¡ç‰‡
  generateProjectCards();

  // èŠå¤©ç•Œé¢äº¤äº’
  initChatInterface();
  
  // ç¡®ä¿èŠå¤©ç•Œé¢åŠ è½½å®Œæˆåæœ‰é»˜è®¤æ¶ˆæ¯
  setTimeout(function() {
    const chatMessages = document.querySelector('#chat-messages');
    if (chatMessages && chatMessages.children.length === 0) {
      console.log("Chat interface still empty after initialization, retrying...");
      initChatInterface();
    }
  }, 500);

  // è§†å·®æ»šåŠ¨æ•ˆæœ
  initParallaxEffect();

  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  initTrackingPanel();

  // åˆå§‹åŒ–ç»Ÿè®¡æ•°å­—åŠ¨ç”»
  animateStats();
  
  // ç¡®ä¿æ ‡é¢˜ä¸ä¼šå› æ»šåŠ¨æˆ–åŠ¨ç”»è€Œç§»åŠ¨
  const sectionHeaders = document.querySelectorAll('.section-header');
  sectionHeaders.forEach(header => {
    // ä¸ºæ ‡é¢˜å…ƒç´ æ·»åŠ å›ºå®šä½ç½®ç±»
    header.classList.add('stable-position');
  });

  // å¯¹æ‰€æœ‰æ ‡é¢˜åº”ç”¨å›ºå®šæ ·å¼
  const allHeadings = document.querySelectorAll('h2, h3');
  allHeadings.forEach(heading => {
    heading.style.minHeight = heading.offsetHeight + 'px';
  });

  // åˆå§‹åŒ–å¯¼èˆªæ 
  initNavbar();
  
  // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢
  initLanguageSwitch();
  
  // åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
  initDarkMode();
  
  // åˆå§‹åŒ–èŠå¤©ç•Œé¢
  initChatInterface();
  
  // åˆå§‹åŒ–å¯¹æ¥è¿›åº¦é¢æ¿
  initTrackingPanel();
  
  // ä¸ºé¡µé¢æ·»åŠ å¹³æ»‘æ»šåŠ¨
  addSmoothScrolling();
  
  // æ»šåŠ¨ç›‘å¬ï¼Œé«˜äº®å½“å‰æ´»åŠ¨çš„å¯¼èˆªèœå•é¡¹
  initScrollSpy();
});

// 3Då±•ç¤ºå¢™åˆå§‹åŒ–
function initShowcase3D() {
  const container = document.querySelector('.showcase-container');
  if (!container) return;

  // ç§»é™¤å ä½ç¬¦
  const placeholder = container.querySelector('.placeholder-3d');
  if (placeholder) {
    container.removeChild(placeholder);
  }

  // åˆ›å»º3Då±•ç¤ºå¢™ - ç®€åŒ–ç‰ˆæ¨¡æ‹Ÿ
  // åœ¨å®Œæ•´å®ç°ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨Three.jsåº“
  
  // åˆ›å»º6ä¸ªå±•ç¤ºå¡ç‰‡ä½œä¸ºç«‹æ–¹ä½“çš„é¢
  const cube = document.createElement('div');
  cube.classList.add('showcase-cube');
  
  for (let i = 0; i < 6; i++) {
    const face = document.createElement('div');
    face.classList.add('cube-face', `face-${i+1}`);
    
    const image = document.createElement('img');
    image.src = `assets/project-${i+1}.jpg`;
    image.alt = `æ”¹é€ é¡¹ç›® ${i+1}`;
    
    face.appendChild(image);
    cube.appendChild(face);
    
    // ç‚¹å‡»å±•å¼€è¯¦æƒ…
    face.addEventListener('click', function() {
      showProjectDetail(i+1);
    });
  }
  
  container.appendChild(cube);
  
  // æ·»åŠ æ‹–åŠ¨äº¤äº’
  let isDragging = false;
  let previousX = 0;
  let previousY = 0;
  let rotX = 0;
  let rotY = 0;
  
  container.addEventListener('mousedown', function(e) {
    isDragging = true;
    previousX = e.clientX;
    previousY = e.clientY;
    container.style.cursor = 'grabbing';
  });
  
  window.addEventListener('mousemove', function(e) {
    if (isDragging) {
      const dx = e.clientX - previousX;
      const dy = e.clientY - previousY;
      
      rotY += dx * 0.5;
      rotX -= dy * 0.5;
      
      cube.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
      
      previousX = e.clientX;
      previousY = e.clientY;
    }
  });
  
  window.addEventListener('mouseup', function() {
    isDragging = false;
    container.style.cursor = 'grab';
  });
}

// é¡¹ç›®è¯¦æƒ…å¼¹çª—
function showProjectDetail(projectId) {
  // åˆ›å»ºæ¨¡æ€æ¡†
  const modal = document.createElement('div');
  modal.classList.add('project-modal');
  
  const modalContent = document.createElement('div');
  modalContent.classList.add('modal-content');
  
  // æ·»åŠ å…³é—­æŒ‰é’®
  const closeBtn = document.createElement('button');
  closeBtn.classList.add('close-modal');
  closeBtn.innerHTML = '&times;';
  closeBtn.addEventListener('click', function() {
    document.body.removeChild(modal);
  });
  
  // æ·»åŠ é¡¹ç›®å†…å®¹
  const projectContent = document.createElement('div');
  projectContent.classList.add('project-detail');
  
  const projectTitle = document.createElement('h3');
  projectTitle.textContent = `æ”¹é€ é¡¹ç›® ${projectId}`;
  
  const beforeAfterContainer = document.createElement('div');
  beforeAfterContainer.classList.add('before-after-slider');
  
  // è¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æ›´å¤æ‚çš„æ»‘å—å¯¹æ¯”ç»„ä»¶
  const beforeImg = document.createElement('img');
  beforeImg.src = `assets/project-${projectId}-before.jpg`;
  beforeImg.alt = 'æ”¹é€ å‰';
  
  const afterImg = document.createElement('img');
  afterImg.src = `assets/project-${projectId}-after.jpg`;
  afterImg.alt = 'æ”¹é€ å';
  
  beforeAfterContainer.appendChild(beforeImg);
  beforeAfterContainer.appendChild(afterImg);
  
  const projectDesc = document.createElement('p');
  projectDesc.textContent = 'è¿™æ˜¯ä¸€ä¸ªæ—§ç‰›ä»”è£¤æ”¹é€ é¡¹ç›®ï¼Œé€šè¿‡æ‹¼æ¥å‰ªè£å’Œæ‰‹å·¥è£…é¥°ï¼Œå°†åºŸæ—§ç‰›ä»”è£¤å˜æˆæ—¶å°šå•è‚©åŒ…ã€‚é‡‡ç”¨é›¶æµªè´¹è®¾è®¡åŸåˆ™ï¼Œç”šè‡³å°†æ‹‰é“¾å’Œçº½æ‰£ä¹Ÿé‡æ–°åˆ©ç”¨ã€‚';
  
  const designSketch = document.createElement('img');
  designSketch.classList.add('design-sketch');
  designSketch.src = `assets/sketch-${projectId}.jpg`;
  designSketch.alt = 'è®¾è®¡è‰å›¾';
  
  projectContent.appendChild(projectTitle);
  projectContent.appendChild(beforeAfterContainer);
  projectContent.appendChild(projectDesc);
  projectContent.appendChild(designSketch);
  
  modalContent.appendChild(closeBtn);
  modalContent.appendChild(projectContent);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}

// ç”Ÿæˆé¡¹ç›®å¡ç‰‡
function generateProjectCards() {
  const projectsGrid = document.querySelector('.projects-grid');
  if (!projectsGrid) return;
  
  // æ¨¡æ‹Ÿæ•°æ®
  const projectsData = [
    { id: 1, title: 'ç‰›ä»”å¤–å¥—æ”¹é€ ', material: 'ç‰›ä»”', difficulty: 4, imageUrl: 'assets/project-1.jpg' },
    { id: 2, title: 'ä¸è´¨å›´å·¾å˜è£™', material: 'ä¸ç»¸', difficulty: 3, imageUrl: 'assets/project-2.jpg' },
    { id: 3, title: 'äºšéº»è¡¬è¡«ç¿»æ–°', material: 'æ£‰éº»', difficulty: 2, imageUrl: 'assets/project-3.jpg' },
    { id: 4, title: 'çš®å¤¹å…‹æ”¹é€ ', material: 'çš®é©', difficulty: 5, imageUrl: 'assets/project-4.jpg' },
    { id: 5, title: 'é’ˆç»‡è¡«é‡æ„', material: 'é’ˆç»‡', difficulty: 3, imageUrl: 'assets/project-5.jpg' },
    { id: 6, title: 'ç‰›ä»”è£¤å˜åŒ…', material: 'ç‰›ä»”', difficulty: 4, imageUrl: 'assets/project-6.jpg' },
    { id: 7, title: 'ä¸å·¾å†é€ ', material: 'ä¸ç»¸', difficulty: 2, imageUrl: 'assets/project-7.jpg' },
    { id: 8, title: 'æ£‰å¸ƒæ‹¼æ¥', material: 'æ£‰éº»', difficulty: 3, imageUrl: 'assets/project-8.jpg' }
  ];
  
  projectsData.forEach(project => {
    const card = document.createElement('div');
    card.classList.add('project-card', 'card-3d');
    card.dataset.material = project.material;
    
    const cardInner = document.createElement('div');
    cardInner.classList.add('card-inner');
    
    // å¡ç‰‡æ­£é¢
    const cardFront = document.createElement('div');
    cardFront.classList.add('card-front');
    
    const image = document.createElement('img');
    image.src = project.imageUrl;
    image.alt = project.title;
    
    const title = document.createElement('h4');
    title.textContent = project.title;
    
    const difficultyContainer = document.createElement('div');
    difficultyContainer.classList.add('difficulty-stars');
    
    // æ·»åŠ éš¾åº¦æ˜Ÿçº§
    for (let i = 0; i < 5; i++) {
      const star = document.createElement('span');
      star.classList.add('star');
      if (i < project.difficulty) {
        star.classList.add('filled');
      }
      difficultyContainer.appendChild(star);
    }
    
    cardFront.appendChild(image);
    cardFront.appendChild(title);
    cardFront.appendChild(difficultyContainer);
    
    // å¡ç‰‡èƒŒé¢
    const cardBack = document.createElement('div');
    cardBack.classList.add('card-back');
    
    const materialChart = document.createElement('div');
    materialChart.classList.add('material-chart');
    materialChart.innerHTML = `<h5>ææ–™æˆåˆ†</h5>
      <div class="chart-container">
        <canvas class="radar-chart" width="150" height="150"></canvas>
      </div>
      <p>ä¸»è¦æè´¨: ${project.material}</p>`;
    
    const storyPreview = document.createElement('div');
    storyPreview.classList.add('story-preview');
    storyPreview.innerHTML = `<p>è¿™æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•ç»™æ—§è¡£ç‰©èµ‹äºˆæ–°ç”Ÿå‘½çš„æ•…äº‹ï¼Œç‚¹å‡»æŸ¥çœ‹å®Œæ•´æ”¹é€ è¿‡ç¨‹...</p>`;
    
    const viewButton = document.createElement('button');
    viewButton.classList.add('view-button');
    viewButton.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
    viewButton.addEventListener('click', function() {
      showProjectDetail(project.id);
    });
    
    cardBack.appendChild(materialChart);
    cardBack.appendChild(storyPreview);
    cardBack.appendChild(viewButton);
    
    cardInner.appendChild(cardFront);
    cardInner.appendChild(cardBack);
    card.appendChild(cardInner);
    
    projectsGrid.appendChild(card);
  });
}

// èŠå¤©ç•Œé¢äº¤äº’
function initChatInterface() {
  console.log("Initializing chat interface...");
  
  const chatInterface = document.querySelector('.chat-interface');
  if (!chatInterface) {
    console.error("Chat interface not found");
    return;
  }
  
  const chatMessages = document.querySelector('#chat-messages');
  const chatInput = document.querySelector('.chat-input input');
  const sendButton = document.querySelector('.send-button');
  const chatSidebar = document.querySelector('.chat-sidebar');
  
  if (!chatMessages || !chatInput || !sendButton) {
    console.error("Chat components missing:", {
      messages: !!chatMessages,
      input: !!chatInput,
      button: !!sendButton
    });
    return;
  }
  
  console.log("Chat components found, continuing initialization");
  
  // å˜é‡ç”¨äºå­˜å‚¨å½“å‰ä¼šè¯çŠ¶æ€
  let currentSessionId = localStorage.getItem('currentSessionId');
  let currentSessionTitle = "æ–°å¯¹è¯";
  let previousTopics = {
    fabric: false,
    clothing: false,
    price: false,
    contact: false,
    seller: false,
    buyer: false
  };
  
  // åˆå§‹åŒ–èŠå¤©ç•Œé¢
  if (chatSidebar) {
    initChatHistory(chatSidebar);
  }
  
  // å¦‚æœæœ‰å½“å‰ä¼šè¯IDï¼ŒåŠ è½½è¯¥ä¼šè¯
  if (currentSessionId) {
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    if (chatHistory[currentSessionId]) {
      loadSession(currentSessionId);
    } else {
      // å¦‚æœä¿å­˜çš„ä¼šè¯IDä¸å­˜åœ¨å†å²è®°å½•ä¸­ï¼Œåˆ›å»ºæ–°ä¼šè¯
      startNewSession();
    }
  } else {
    // æ— ä¼šè¯IDï¼Œåˆ›å»ºæ–°ä¼šè¯
    startNewSession();
  }
  
  // æ£€æŸ¥èŠå¤©ç•Œé¢æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯åˆ™é‡æ–°åˆå§‹åŒ–
  checkChatInterfaceEmpty();
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  if (sendButton) {
    sendButton.addEventListener('click', sendMessage);
  }
  
  if (chatInput) {
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // æ·»åŠ è¾“å…¥æ—¶çš„åŠ¨æ€æ•ˆæœ
    chatInput.addEventListener('focus', function() {
      if (this.parentElement) {
        this.parentElement.classList.add('input-active');
      }
    });
    
    chatInput.addEventListener('blur', function() {
      if (this.parentElement) {
        this.parentElement.classList.remove('input-active');
      }
    });
  }
  
  // åˆå§‹è°ƒæ•´é«˜åº¦
  adjustChatHeight();
  
  // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´é«˜åº¦
  window.addEventListener('resize', adjustChatHeight);
  
  // å¦‚æœèŠå¤©æ¡†ä¸ºç©ºï¼Œæ·»åŠ ä¸€ä¸ªæ–°ä¼šè¯
  function checkChatInterfaceEmpty() {
    if (!chatMessages || chatMessages.children.length === 0) {
      console.log("Chat interface is empty, reinitializing...");
      startNewSession();
    }
  }

  // å‘é€æ¶ˆæ¯
  function sendMessage() {
    if (!chatInput || !chatMessages) {
      console.error("Cannot send message: UI elements not found");
      return;
    }
    
    const message = chatInput.value.trim();
    if (message === '') return;
    
    console.log("Sending message:", message);
    
    // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
    const userMessage = document.createElement('div');
    userMessage.classList.add('message', 'user-message');
    userMessage.textContent = message;
    
    chatMessages.appendChild(userMessage);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    chatInput.value = '';
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // ç¡®ä¿èŠå¤©ç•Œé¢é«˜åº¦é€‚åº”å†…å®¹
    adjustChatHeight();
    
    // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°å½“å‰ä¼šè¯
    saveMessageToHistory(currentSessionId, 'user', message);
    
    // å¦‚æœè¿™æ˜¯æ–°ä¼šè¯çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ ¹æ®å†…å®¹ç”Ÿæˆæ ‡é¢˜
    if (currentSessionTitle === "æ–°å¯¹è¯") {
      currentSessionTitle = generateSessionTitle(message);
      updateSessionList();
    }
    
    // æ¨¡æ‹Ÿç³»ç»Ÿå›å¤
    setTimeout(function() {
      // è·å–è‡ªåŠ¨å›å¤
      const autoReply = getAutoReply(message);
      
      // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯
      const systemMessage = document.createElement('div');
      systemMessage.classList.add('message', 'system-message');
      
      const needleIcon = document.createElement('span');
      needleIcon.classList.add('needle-icon');
      needleIcon.innerHTML = 'ğŸ§µ';
      
      const messageText = document.createElement('span');
      systemMessage.appendChild(needleIcon);
      systemMessage.appendChild(messageText);
      
      chatMessages.appendChild(systemMessage);
      
      // æ·»åŠ å†…å®¹
      messageText.innerHTML = autoReply;
      
      // ä¿å­˜ç³»ç»Ÿå›å¤åˆ°å½“å‰ä¼šè¯
      saveMessageToHistory(currentSessionId, 'system', autoReply);
      
      // æ·»åŠ æ‰“å­—åŠ¨ç”»æ•ˆæœ
      addTypingAnimation(messageText);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // å†æ¬¡è°ƒæ•´èŠå¤©ç•Œé¢é«˜åº¦
      adjustChatHeight();
      
      // åŸºäºç³»ç»Ÿå›å¤å†æ¬¡æ›´æ–°å¯¹æ¥è¿›åº¦
      updateTrackingFromChat(autoReply);
    }, 1000);
  }

  // ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ID
  function generateSessionId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
  
  // æ ¹æ®ç”¨æˆ·é¦–æ¡æ¶ˆæ¯å†…å®¹ç”Ÿæˆä¼šè¯æ ‡é¢˜
  function generateSessionTitle(message) {
    // æå–æ¶ˆæ¯çš„å‰10ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜ï¼Œå¦‚æœæ¶ˆæ¯å¤ªçŸ­åˆ™å…¨éƒ¨ä½¿ç”¨
    const titleText = message.length > 10 ? message.substring(0, 10) + '...' : message;
    return titleText;
  }
  
  // ä¿å­˜æ¶ˆæ¯åˆ°æœ¬åœ°å­˜å‚¨
  function saveMessageToHistory(sessionId, sender, content) {
    // ä»æœ¬åœ°å­˜å‚¨è·å–å·²æœ‰å†å²è®°å½•
    let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    
    // å¦‚æœä¼šè¯ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°ä¼šè¯
    if (!chatHistory[sessionId]) {
      chatHistory[sessionId] = {
        id: sessionId,
        title: currentSessionTitle,
        date: new Date().toISOString(),
        messages: []
      };
    }
    
    // æ·»åŠ æ–°æ¶ˆæ¯
    chatHistory[sessionId].messages.push({
      sender: sender,
      content: content,
      timestamp: new Date().toISOString()
    });
    
    // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
    chatHistory[sessionId].lastActive = new Date().toISOString();
    
    // æ›´æ–°ä¼šè¯æ ‡é¢˜ï¼ˆå¦‚æœå·²ç”Ÿæˆï¼‰
    if (currentSessionTitle !== "æ–°å¯¹è¯") {
      chatHistory[sessionId].title = currentSessionTitle;
    }
    
    // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    
    // æ›´æ–°å½“å‰ä¼šè¯IDåˆ°localStorage
    localStorage.setItem('currentSessionId', sessionId);
    
    // æ›´æ–°ä¼šè¯åˆ—è¡¨
    updateSessionList();
  }
  
  // æ·»åŠ æ‰“å­—åŠ¨ç”»æ•ˆæœ
  function addTypingAnimation(element) {
    const text = element.innerHTML;
    element.innerHTML = '';
    let i = 0;
    
    function typeWriter() {
      if (i < text.length) {
        element.innerHTML += text.charAt(i);
        i++;
        // éšæœºæ‰“å­—é€Ÿåº¦ï¼Œè®©æ•ˆæœæ›´è‡ªç„¶
        setTimeout(typeWriter, Math.random() * 10 + 20);
      }
    }
    
    // è€ƒè™‘åˆ°æ–‡æœ¬è¾ƒé•¿ä¸”æœ‰HTMLæ ‡ç­¾ï¼Œè¿™é‡Œç®€åŒ–ä¸ä½¿ç”¨çœŸå®çš„æ‰“å­—æ•ˆæœ
    element.innerHTML = text;
    element.style.opacity = '0';
    setTimeout(() => {
      element.style.transition = 'opacity 0.5s';
      element.style.opacity = '1';
    }, 100);
  }
  
  // åˆå§‹åŒ–èŠå¤©å†å²
  function initChatHistory(sidebar) {
    // ç¡®ä¿å†å²ä¼šè¯æ ‡é¢˜å·²æ·»åŠ 
    if (!sidebar.querySelector('.sidebar-header')) {
      const header = document.createElement('div');
      header.classList.add('sidebar-header');
      header.innerHTML = 'å†å²ä¼šè¯<span class="current-time"></span>';
      sidebar.appendChild(header);
    }
    
    // æ›´æ–°å½“å‰åŒ—äº¬æ—¶é—´æ˜¾ç¤º
    updateCurrentTime();
    
    // æ›´æ–°ä¼šè¯åˆ—è¡¨
    updateSessionList();
    
    // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
    setInterval(updateCurrentTime, 1000);
  }
  
  // æ›´æ–°å½“å‰åŒ—äº¬æ—¶é—´æ˜¾ç¤º
  function updateCurrentTime() {
    const now = new Date();
    now.setTime(now.getTime() + (8 * 60 * 60 * 1000)); // è°ƒæ•´ä¸ºUTC+8
    const hours = String(now.getUTCHours()).padStart(2, '0');
    const minutes = String(now.getUTCMinutes()).padStart(2, '0');
    const seconds = String(now.getUTCSeconds()).padStart(2, '0');
    const currentTime = `${hours}:${minutes}:${seconds}`;
    
    const timeElement = chatSidebar.querySelector('.sidebar-header .current-time');
    if (timeElement) {
      timeElement.textContent = `åŒ—äº¬æ—¶é—´ ${currentTime}`;
    }
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸä¸ºæ›´å‹å¥½çš„æ ¼å¼
  function formatDate(dateString) {
    const date = new Date(dateString);
    // è°ƒæ•´ä¸ºåŒ—äº¬æ—¶é—´
    date.setTime(date.getTime() + (8 * 60 * 60 * 1000));
    
    const now = new Date();
    now.setTime(now.getTime() + (8 * 60 * 60 * 1000));
    
    const today = new Date(now);
    today.setUTCHours(0, 0, 0, 0);
    
    const yesterday = new Date(today);
    yesterday.setUTCDate(yesterday.getUTCDate() - 1);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
    if (date >= today) {
      const hours = String(date.getUTCHours()).padStart(2, '0');
      const minutes = String(date.getUTCMinutes()).padStart(2, '0');
      return `ä»Šå¤© ${hours}:${minutes}`;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜¨å¤©
    if (date >= yesterday && date < today) {
      return "æ˜¨å¤©";
    }
    
    // ä¸€å‘¨å†…æ˜¾ç¤ºæ˜ŸæœŸ
    const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const diffDays = Math.floor((today - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays < 7) {
      return weekDays[date.getUTCDay()];
    }
    
    // æ›´æ—©çš„æ—¥æœŸæ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const day = String(date.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  
  // æ›´æ–°ä¼šè¯åˆ—è¡¨
  function updateSessionList() {
    // ä»æœ¬åœ°å­˜å‚¨è·å–å†å²è®°å½•
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    
    // è·å–æ‰€æœ‰ä¼šè¯å¹¶æŒ‰æœ€åæ´»åŠ¨æ—¶é—´æ’åº
    const sessions = Object.values(chatHistory).sort((a, b) => 
      new Date(b.lastActive || b.date) - new Date(a.lastActive || a.date)
    );
    
    // æ¸…ç©ºå·²æœ‰çš„å†å²ä¼šè¯é¡¹ç›®
    chatSidebar.querySelectorAll('.session-item').forEach(item => item.remove());
    
    // å¦‚æœæ²¡æœ‰å†å²ä¼šè¯è®°å½•ï¼Œæ·»åŠ æ–°ä¼šè¯æŒ‰é’®
    if (sessions.length === 0) {
      const newChatButton = document.createElement('div');
      newChatButton.classList.add('session-item', 'new-chat');
      newChatButton.innerHTML = '<div class="session-title">å¼€å§‹æ–°å¯¹è¯</div>';
      
      newChatButton.addEventListener('click', () => {
        startNewSession();
      });
      
      chatSidebar.appendChild(newChatButton);
      return;
    }
    
    // æ·»åŠ æ–°ä¼šè¯æŒ‰é’®
    const newChatButton = document.createElement('div');
    newChatButton.classList.add('session-item', 'new-chat');
    newChatButton.innerHTML = '<div class="session-title">å¼€å§‹æ–°å¯¹è¯</div>';
    
    newChatButton.addEventListener('click', () => {
      startNewSession();
    });
    
    chatSidebar.appendChild(newChatButton);
    
    // æ·»åŠ å†å²ä¼šè¯
    sessions.forEach(session => {
      const sessionItem = document.createElement('div');
      sessionItem.classList.add('session-item');
      sessionItem.dataset.sessionId = session.id;
      
      if (session.id === currentSessionId) {
        sessionItem.classList.add('active');
      }
      
      const sessionTitle = document.createElement('div');
      sessionTitle.classList.add('session-title');
      sessionTitle.textContent = session.title || "æ— æ ‡é¢˜å¯¹è¯";
      
      const sessionDate = document.createElement('div');
      sessionDate.classList.add('session-date');
      
      const formattedDate = formatDate(session.lastActive || session.date);
      sessionDate.innerHTML = `<span class="date-icon">ğŸ•’</span> ${formattedDate}`;
      
      // å®Œæ•´æ—¥æœŸä½œä¸ºæ‚¬åœæç¤º
      const fullDate = new Date(session.lastActive || session.date);
      fullDate.setTime(fullDate.getTime() + (8 * 60 * 60 * 1000)); // è°ƒæ•´ä¸ºåŒ—äº¬æ—¶é—´
      
      const fullDateStr = `${fullDate.getUTCFullYear()}-${String(fullDate.getUTCMonth() + 1).padStart(2, '0')}-${String(fullDate.getUTCDate()).padStart(2, '0')} ${String(fullDate.getUTCHours()).padStart(2, '0')}:${String(fullDate.getUTCMinutes()).padStart(2, '0')}`;
      sessionDate.title = fullDateStr;
      
      // æ·»åŠ åˆ é™¤æŒ‰é’®
      const deleteButton = document.createElement('span');
      deleteButton.classList.add('delete-session');
      deleteButton.innerHTML = 'âœ•';
      deleteButton.title = 'åˆ é™¤å¯¹è¯';
      deleteButton.onclick = (e) => {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘ä¼šè¯ç‚¹å‡»äº‹ä»¶
        deleteSession(session.id);
      };
      
      sessionItem.appendChild(sessionTitle);
      sessionItem.appendChild(sessionDate);
      sessionItem.appendChild(deleteButton);
      
      // ç‚¹å‡»åˆ‡æ¢ä¼šè¯
      sessionItem.addEventListener('click', () => {
        loadSession(session.id);
      });
      
      chatSidebar.appendChild(sessionItem);
    });
  }
  
  // åˆ é™¤ä¼šè¯
  function deleteSession(sessionId) {
    if (confirm('ç¡®è®¤åˆ é™¤è¿™ä¸ªå¯¹è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
      // ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–ä¼šè¯æ•°æ®
      const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
      
      // åˆ é™¤æŒ‡å®šä¼šè¯
      if (chatHistory[sessionId]) {
        delete chatHistory[sessionId];
        
        // ä¿å­˜æ›´æ–°åçš„ä¼šè¯æ•°æ®
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ™å¼€å§‹æ–°ä¼šè¯
        if (sessionId === currentSessionId) {
          startNewSession();
        } else {
          // ä»…æ›´æ–°ä¼šè¯åˆ—è¡¨
          updateSessionList();
        }
      }
    }
  }
  
  // åŠ è½½æŒ‡å®šä¼šè¯
  function loadSession(sessionId) {
    console.log("Loading session:", sessionId);
    
    const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
    
    if (!chatHistory[sessionId]) {
      console.error("Session not found:", sessionId);
      startNewSession();
      return;
    }
    
    // æ›´æ–°å½“å‰ä¼šè¯
    currentSessionId = sessionId;
    localStorage.setItem('currentSessionId', currentSessionId);
    
    // æ›´æ–°ä¼šè¯æ ‡é¢˜
    currentSessionTitle = chatHistory[sessionId].title || "æœªå‘½åå¯¹è¯";
    
    // æ¸…ç©ºå½“å‰æ¶ˆæ¯åŒºåŸŸ
    if (chatMessages) {
      chatMessages.innerHTML = '';
      
      // æ¢å¤å†å²æ¶ˆæ¯
      if (chatHistory[sessionId].messages && chatHistory[sessionId].messages.length > 0) {
        chatHistory[sessionId].messages.forEach(msgObj => {
          const messageElement = document.createElement('div');
          
          if (msgObj.sender === 'user') {
            messageElement.classList.add('message', 'user-message');
            messageElement.textContent = msgObj.content;
          } else {
            messageElement.classList.add('message', 'system-message');
            
            const needleIcon = document.createElement('span');
            needleIcon.classList.add('needle-icon');
            needleIcon.innerHTML = 'ğŸ§µ';
            
            const messageText = document.createElement('span');
            messageText.innerHTML = msgObj.content;
            
            messageElement.appendChild(needleIcon);
            messageElement.appendChild(messageText);
          }
          
          chatMessages.appendChild(messageElement);
        });
      } else {
        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ·»åŠ é»˜è®¤æ¬¢è¿æ¶ˆæ¯
        const systemMessage = document.createElement('div');
        systemMessage.classList.add('message', 'system-message');
        
        const needleIcon = document.createElement('span');
        needleIcon.classList.add('needle-icon');
        needleIcon.innerHTML = 'ğŸ§µ';
        
        const messageText = document.createElement('span');
        messageText.innerHTML = 'æ¬¢è¿å›æ¥ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ';
        
        systemMessage.appendChild(needleIcon);
        systemMessage.appendChild(messageText);
        
        chatMessages.appendChild(systemMessage);
        
        // ä¿å­˜æ¬¢è¿æ¶ˆæ¯
        saveMessageToHistory(currentSessionId, 'system', messageText.innerHTML);
      }
      
      // æ›´æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„æ´»åŠ¨çŠ¶æ€
      updateSessionList();
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // è°ƒæ•´èŠå¤©ç•Œé¢é«˜åº¦
      adjustChatHeight();
    } else {
      console.error("Chat messages container not found when loading session");
    }
  }
  
  // å¼€å§‹æ–°ä¼šè¯
  function startNewSession() {
    console.log("Starting new session");
    
    // ç”Ÿæˆæ–°çš„ä¼šè¯ID
    currentSessionId = generateSessionId();
    localStorage.setItem('currentSessionId', currentSessionId);
    
    currentSessionTitle = "æ–°å¯¹è¯";
    
    // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
    if (chatMessages) {
      chatMessages.innerHTML = '';
      
      // æ·»åŠ é»˜è®¤æ¬¢è¿æ¶ˆæ¯
      const systemMessage = document.createElement('div');
      systemMessage.classList.add('message', 'system-message');
      
      const needleIcon = document.createElement('span');
      needleIcon.classList.add('needle-icon');
      needleIcon.innerHTML = 'ğŸ§µ';
      
      const messageText = document.createElement('span');
      messageText.innerHTML = 'æ¬¢è¿æ¥åˆ°Fashion Rebornæœè£…æ”¹é€ è‰ºæœ¯ç©ºé—´ï¼æˆ‘æ˜¯æ‚¨çš„é¡¾é—®ï¼Œæœ‰ä»»ä½•å…³äºæ¸…ç†åº“å­˜ã€æ”¶è´­åº“å­˜ï¼Œæ”¹é€ æˆè¡£æˆ–é¢æ–™çš„é—®é¢˜éƒ½å¯ä»¥å’¨è¯¢æˆ‘ã€‚å¦‚éœ€ç›´æ¥è”ç³»ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š<strong>JJ1598929032</strong>';
      
      systemMessage.appendChild(needleIcon);
      systemMessage.appendChild(messageText);
      
      chatMessages.appendChild(systemMessage);
      
      // ä¿å­˜æ¬¢è¿æ¶ˆæ¯åˆ°å†å²è®°å½•
      saveMessageToHistory(currentSessionId, 'system', messageText.innerHTML);
      
      // æ›´æ–°ä¼šè¯åˆ—è¡¨
      updateSessionList();
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // è°ƒæ•´é«˜åº¦
      adjustChatHeight();
    } else {
      console.error("Chat messages container not found");
    }
  }
  
  // è°ƒæ•´èŠå¤©ç•Œé¢é«˜åº¦ä»¥é€‚åº”å†…å®¹
  function adjustChatHeight() {
    // ç¡®ä¿æˆ‘ä»¬æœ‰å¿…è¦çš„DOMå…ƒç´ 
    if (!chatInterface || !chatMessages) {
      console.error("Cannot adjust chat height: Required elements not found");
      return;
    }
    
    // ç¡®ä¿å¯¹è¯æ¡†å†…å®¹å®Œå…¨æ˜¾ç¤º
    chatMessages.style.maxHeight = '520px'; // ä¿æŒæœ€å¤§é«˜åº¦é™åˆ¶
    
    // ç¡®ä¿æ•´ä¸ªèŠå¤©ç•Œé¢ä¸é®æŒ¡å¯¹æ¥è¿›åº¦é¢æ¿
    const trackingPanel = document.querySelector('.tracking-panel');
    if (trackingPanel) {
      const chatBottom = chatInterface.getBoundingClientRect().bottom;
      const trackingTop = trackingPanel.getBoundingClientRect().top;
      
      // å¦‚æœèŠå¤©ç•Œé¢åº•éƒ¨è¶…å‡ºè·Ÿè¸ªé¢æ¿é¡¶éƒ¨ï¼Œå¢åŠ ä¸Šè¾¹è·
      if (chatBottom > trackingTop) {
        const currentMargin = parseInt(getComputedStyle(trackingPanel).marginTop) || 0;
        trackingPanel.style.marginTop = (currentMargin + (chatBottom - trackingTop) + 20) + 'px';
      }
    }
    
    // ä¸ºæ¶ˆæ¯æ·»åŠ åŠ¨ç”»æ•ˆæœ
    const messages = document.querySelectorAll('.message');
    messages.forEach((message, index) => {
      if (!message.style.animationDelay) {
        message.style.animationDelay = `${index * 0.1}s`;
      }
    });
  }
}

// è§†å·®æ»šåŠ¨æ•ˆæœ
function initParallaxEffect() {
  const sections = document.querySelectorAll('section');
  
  window.addEventListener('scroll', function() {
    const scrollPosition = window.scrollY;
    
    sections.forEach(section => {
      // æ’é™¤æ ‡é¢˜å…ƒç´ ï¼Œåªå¯¹å†…å®¹åŒºåŸŸåº”ç”¨è§†å·®æ•ˆæœ
      const contentElements = section.querySelectorAll('.showcase-container, .projects-grid, .community-market, .challenge-entries, .resources-grid');
      
      contentElements.forEach(element => {
        const distance = element.getBoundingClientRect().top;
        const speed = 0.1;
        
        if (Math.abs(distance) < window.innerHeight) {
          // åªåœ¨å…ƒç´ è¿›å…¥è§†å£æ—¶åº”ç”¨å¾®å°çš„è§†å·®æ•ˆæœï¼Œé¿å…å½±å“å¸ƒå±€
          const translate = distance * speed;
          element.style.transform = `translateY(${translate}px)`;
        }
      });
      
      // ç¡®ä¿æ ‡é¢˜å…ƒç´ ä¿æŒç¨³å®š
      const sectionHeader = section.querySelector('.section-header');
      if (sectionHeader) {
        sectionHeader.style.transform = 'none';
      }
    });
  });
}

// å¯¹æ¥è¿›åº¦é¢æ¿åŠŸèƒ½
function initTrackingPanel() {
  const trackingPanel = document.querySelector('.process-flow');
  if (!trackingPanel) return;

  // åˆå§‹åŒ–è¿›åº¦æµç¨‹å›¾ - ä»localStorageè·å–å½“å‰çŠ¶æ€
  let currentTrackingData = JSON.parse(localStorage.getItem('trackingData'));
  
  // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è·Ÿè¸ªæ•°æ®æˆ–è€…æ˜¯æ–°ä¼šè¯ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
  if (!currentTrackingData) {
    currentTrackingData = {
      currentStage: 1,
      stages: [
        { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
        { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
        { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
      ],
      lastUpdated: new Date().toISOString(),
      isSeller: false,
      isBuyer: false,
      needType: '',
      productType: '',
      quantity: '',
      budgetRange: ''
    };
    
    // ä¿å­˜åˆå§‹æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(currentTrackingData));
  }
  
  // æ¸…ç©ºé»˜è®¤å†…å®¹
  trackingPanel.innerHTML = '';
  
  // åˆ›å»ºè¿›åº¦æ¡
  const progressBar = document.createElement('div');
  progressBar.classList.add('progress-bar');
  
  // æ·»åŠ å„ä¸ªé˜¶æ®µ
  currentTrackingData.stages.forEach(stage => {
    const stageElement = document.createElement('div');
    stageElement.classList.add('progress-stage', `status-${stage.status}`);
    stageElement.dataset.stageId = stage.id;
    
    const stageNumber = document.createElement('div');
    stageNumber.classList.add('stage-number');
    stageNumber.textContent = stage.id;
    
    const stageName = document.createElement('div');
    stageName.classList.add('stage-name');
    stageName.textContent = stage.name;
    
    stageElement.appendChild(stageNumber);
    stageElement.appendChild(stageName);
    
    // ç‚¹å‡»é˜¶æ®µæ˜¾ç¤ºè¯¦æƒ…
    stageElement.addEventListener('click', () => showStageDetail(stage, currentTrackingData));
    
    progressBar.appendChild(stageElement);
    
    // æ·»åŠ è¿æ¥çº¿ï¼ˆé™¤äº†æœ€åä¸€ä¸ªé˜¶æ®µï¼‰
    if (stage.id < currentTrackingData.stages.length) {
      const connector = document.createElement('div');
      connector.classList.add('stage-connector', `status-${stage.status}`);
      progressBar.appendChild(connector);
    }
  });
  
  trackingPanel.appendChild(progressBar);
  
  // æ·»åŠ è¯´æ˜æ–‡å­—
  const statusInfo = document.createElement('div');
  statusInfo.classList.add('status-info');
  
  // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„é˜¶æ®µ
  const activeStage = currentTrackingData.stages.find(stage => stage.status === 'active');
  const stageName = activeStage ? activeStage.name : 'å‡†å¤‡ä¸­';
  
  // è®¡ç®—æœ€åæ›´æ–°æ—¶é—´
  const lastUpdateTime = getTimeDifference(new Date(currentTrackingData.lastUpdated), new Date());
  
  statusInfo.innerHTML = `å½“å‰çŠ¶æ€ï¼š<span class="status-active">${stageName}</span> Â· æ›´æ–°äº ${lastUpdateTime}`;
  trackingPanel.appendChild(statusInfo);
  
  // æ·»åŠ è¿›åº¦æ¦‚è¦
  const progressSummary = document.createElement('div');
  progressSummary.classList.add('progress-summary');
  
  // æ ¹æ®ç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒçš„è¿›åº¦æ¦‚è¦
  const isSeller = currentTrackingData.isSeller;
  const isBuyer = currentTrackingData.isBuyer;
  
  // è·å–ä¹°å–éœ€æ±‚ç±»å‹
  const needTypeDisplay = currentTrackingData.needType ? currentTrackingData.needType : 'ç­‰å¾…ç¡®è®¤';
  const productTypeDisplay = currentTrackingData.productType ? currentTrackingData.productType : 'ç­‰å¾…ç¡®è®¤';
  
  let summaryHTML = '';
  if (isSeller) {
    summaryHTML = `
      <h4>å‡ºå”®ä¿¡æ¯æ‘˜è¦</h4>
      <ul>
        <li>å•†å“ç±»å‹: ${productTypeDisplay}</li>
        <li>åº“å­˜æ•°é‡: ${currentTrackingData.quantity || 'ç­‰å¾…ç¡®è®¤'}</li>
        <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
      </ul>
    `;
  } else if (isBuyer) {
    summaryHTML = `
      <h4>é‡‡è´­ä¿¡æ¯æ‘˜è¦</h4>
      <ul>
        <li>éœ€æ±‚ç±»å‹: ${needTypeDisplay}</li>
        <li>äº§å“ç±»å‹: ${productTypeDisplay}</li>
        <li>é¢„ç®—èŒƒå›´: ${currentTrackingData.budgetRange || 'ç­‰å¾…ç¡®è®¤'}</li>
        <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
      </ul>
    `;
  } else {
    summaryHTML = `
      <h4>å¯¹æ¥ä¿¡æ¯æ‘˜è¦</h4>
      <ul>
        <li>è¯·åœ¨èŠå¤©ä¸­è¯´æ˜æ‚¨æ˜¯éœ€è¦å‡ºå”®è¿˜æ˜¯é‡‡è´­</li>
        <li>å¯¹æ¥è¿›åº¦: ${Math.round((getCompletedStages(currentTrackingData.stages) / 5) * 100)}%</li>
      </ul>
    `;
  }
  
  progressSummary.innerHTML = summaryHTML;
  trackingPanel.appendChild(progressSummary);
  
  // æ·»åŠ åˆ·æ–°æŒ‰é’®
  const refreshButton = document.createElement('button');
  refreshButton.classList.add('refresh-tracking');
  refreshButton.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
  refreshButton.addEventListener('click', function() {
    // è¯·æ±‚å¹³å°æ›´æ–°è¿›åº¦
    updateTrackingProgress();
    
    // æ·»åŠ åˆ·æ–°åŠ¨ç”»
    this.classList.add('refreshing');
    // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
    this.textContent = 'æ­£åœ¨è¯·æ±‚å¹³å°ç¡®è®¤...';
    setTimeout(() => {
      this.classList.remove('refreshing');
      this.textContent = 'è¯·æ±‚æ›´æ–°è¿›åº¦';
    }, 2000);
  });
  
  // æ·»åŠ å¹³å°ç¡®è®¤è¯´æ˜
  const confirmNote = document.createElement('div');
  confirmNote.classList.add('platform-note');
  confirmNote.innerHTML = 'æç¤ºï¼šæ‰€æœ‰è¿›åº¦æ›´æ–°éœ€è¦å¹³å°ç¡®è®¤åæ‰èƒ½ç”Ÿæ•ˆ';
  
  trackingPanel.appendChild(refreshButton);
  trackingPanel.appendChild(confirmNote);
}

// æ ¹æ®èŠå¤©å†…å®¹æ›´æ–°å¯¹æ¥è¿›åº¦
function updateTrackingFromChat(message, isSeller, isBuyer) {
  // è·å–å½“å‰è¿›åº¦æ•°æ®
  let trackingData = JSON.parse(localStorage.getItem('trackingData'));
  
  if (!trackingData) {
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤æ•°æ®
    trackingData = {
      currentStage: 1,
      stages: [
        { id: 1, name: 'éœ€æ±‚æäº¤', status: 'pending', timestamp: new Date().toISOString() },
        { id: 2, name: 'åŒ¹é…åº“å­˜', status: 'pending', timestamp: null },
        { id: 3, name: 'å–å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 4, name: 'ä¹°å®¶ç¡®è®¤', status: 'pending', timestamp: null },
        { id: 5, name: 'ç¡®è®¤å¯¹æ¥', status: 'pending', timestamp: null }
      ],
      lastUpdated: new Date().toISOString(),
      isSeller: false,
      isBuyer: false,
      needType: '',
      productType: '',
      quantity: '',
      budgetRange: ''
    };
  }
  
  // æ›´æ–°ä¹°å–èº«ä»½
  if (isSeller !== undefined) {
    trackingData.isSeller = isSeller;
  }
  
  if (isBuyer !== undefined) {
    trackingData.isBuyer = isBuyer;
  }
  
  // å¤„ç†é˜¶æ®µ1ï¼šéœ€æ±‚æäº¤
  if (trackingData.stages[0].status !== 'completed') {
    // åªè¦æœ‰æ¶ˆæ¯ï¼Œå°±è®¤ä¸ºéœ€æ±‚å·²æäº¤
    trackingData.stages[0].status = 'completed';
    trackingData.stages[0].timestamp = new Date().toISOString();
    
    // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
    trackingData.stages[1].status = 'active';
    trackingData.currentStage = 2;
  }
  
  // æå–äº§å“ç±»å‹ä¿¡æ¯
  const productTypes = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›', 'å°¼é¾™', 'æ¶¤çº¶'];
  for (const type of productTypes) {
    if (message.includes(type)) {
      trackingData.productType = type;
      break;
    }
  }
  
  // æå–éœ€æ±‚ç±»å‹
  if (message.includes('é¢æ–™') || message.includes('å¸ƒæ–™') || message.includes('å¸ƒ')) {
    trackingData.needType = 'é¢æ–™';
  } else if (message.includes('æœè£…') || message.includes('è¡£æœ') || message.includes('æˆè¡£')) {
    trackingData.needType = 'æœè£…';
  }
  
  // æå–æ•°é‡ä¿¡æ¯
  const quantityMatch = message.match(/(\d+)([ä»¶æ¡ç±³å¨ä¸ª])/);
  if (quantityMatch) {
    trackingData.quantity = quantityMatch[0];
  }
  
  // æå–ä»·æ ¼/é¢„ç®—ä¿¡æ¯
  if (message.includes('ä»·æ ¼') || message.includes('å¤šå°‘é’±') || message.includes('é¢„ç®—')) {
    const priceMatch = message.match(/(\d+)[-~åˆ°è‡³](\d+)[å…ƒå—]/);
    if (priceMatch) {
      trackingData.budgetRange = priceMatch[0];
    }
  }
  
  // é˜¶æ®µ2ï¼šåŒ¹é…åº“å­˜ - æ ¹æ®å…³é”®è¯åˆ¤æ–­
  if (trackingData.currentStage === 2 && trackingData.stages[1].status === 'active') {
    // å½“ç”¨æˆ·æä¾›äº†å…·ä½“çš„äº§å“å’Œéœ€æ±‚ç±»å‹æ—¶ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€é˜¶æ®µ
    if (trackingData.productType && trackingData.needType) {
      if (message.includes('åŒ¹é…') || message.includes('åº“å­˜') || message.includes('èµ„æº') || 
          message.includes('æ‰¾åˆ°') || message.includes('æœ‰è´§') || containsSpecificProductInfo(message)) {
        trackingData.stages[1].status = 'completed';
        trackingData.stages[1].timestamp = new Date().toISOString();
        
        // æ ¹æ®ç”¨æˆ·èº«ä»½å†³å®šä¸‹ä¸€æ­¥
        if (trackingData.isSeller) {
          // å–å®¶å¯»æ‰¾ä¹°å®¶ï¼Œè¿›å…¥åˆ°ä¹°å®¶ç¡®è®¤é˜¶æ®µ
          trackingData.stages[3].status = 'active';
          trackingData.currentStage = 4;
        } else if (trackingData.isBuyer) {
          // ä¹°å®¶å¯»æ‰¾å–å®¶ï¼Œè¿›å…¥åˆ°å–å®¶ç¡®è®¤é˜¶æ®µ
          trackingData.stages[2].status = 'active';
          trackingData.currentStage = 3;
        }
      }
    }
  }
  
  // é˜¶æ®µ3ï¼šå–å®¶ç¡®è®¤
  if (trackingData.currentStage === 3 && trackingData.stages[2].status === 'active') {
    if (message.includes('å–å®¶ç¡®è®¤') || message.includes('ä¾›åº”å•†ç¡®è®¤') || message.includes('å·²ç¡®è®¤') || 
        message.includes('å¯ä»¥ä¾›åº”') || message.includes('æœ‰åº“å­˜')) {
      trackingData.stages[2].status = 'completed';
      trackingData.stages[2].timestamp = new Date().toISOString();
      
      // è¿›å…¥ä¹°å®¶ç¡®è®¤é˜¶æ®µ
      trackingData.stages[3].status = 'active';
      trackingData.currentStage = 4;
    }
  }
  
  // é˜¶æ®µ4ï¼šä¹°å®¶ç¡®è®¤
  if (trackingData.currentStage === 4 && trackingData.stages[3].status === 'active') {
    if (message.includes('ä¹°å®¶ç¡®è®¤') || message.includes('å®¢æˆ·ç¡®è®¤') || message.includes('ç¡®è®¤è´­ä¹°') || 
        message.includes('æ¥å—') || message.includes('æ»¡æ„')) {
      trackingData.stages[3].status = 'completed';
      trackingData.stages[3].timestamp = new Date().toISOString();
      
      // è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µ
      trackingData.stages[4].status = 'active';
      trackingData.currentStage = 5;
    }
  }
  
  // é˜¶æ®µ5ï¼šç¡®è®¤å¯¹æ¥
  if (trackingData.currentStage === 5 && trackingData.stages[4].status === 'active') {
    if (message.includes('äº¤æ˜“æˆåŠŸ') || message.includes('å·²å¯¹æ¥') || message.includes('æˆäº¤') || 
        message.includes('å·²å®Œæˆ') || message.includes('æ„Ÿè°¢åˆä½œ')) {
      trackingData.stages[4].status = 'completed';
      trackingData.stages[4].timestamp = new Date().toISOString();
    }
  }
  
  // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
  trackingData.lastUpdated = new Date().toISOString();
  
  // ä¿å­˜æ›´æ–°åçš„æ•°æ®
  localStorage.setItem('trackingData', JSON.stringify(trackingData));
  
  // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
  initTrackingPanel();
}

// æ˜¾ç¤ºé˜¶æ®µè¯¦ç»†ä¿¡æ¯
function showStageDetail(stage, trackingData) {
  const wechatContact = '<strong>JJ1598929032</strong>';
  const modal = document.createElement('div');
  modal.classList.add('progress-modal');
  
  const modalContent = document.createElement('div');
  modalContent.classList.add('modal-content');
  
  // æ·»åŠ å…³é—­æŒ‰é’®
  const closeBtn = document.createElement('button');
  closeBtn.classList.add('close-modal');
  closeBtn.innerHTML = '&times;';
  closeBtn.addEventListener('click', function() {
    document.body.removeChild(modal);
  });
  
  // é˜¶æ®µè¯¦æƒ…å†…å®¹
  const stageContent = document.createElement('div');
  stageContent.classList.add('stage-detail');
  
  const stageTitle = document.createElement('h3');
  stageTitle.innerHTML = `é˜¶æ®µ ${stage.id}: ${stage.name} <span class="stage-status status-${stage.status}">${getStatusText(stage.status)}</span>`;
  
  const stageTimestamp = document.createElement('div');
  stageTimestamp.classList.add('stage-timestamp');
  if (stage.timestamp) {
    const date = new Date(stage.timestamp);
    stageTimestamp.textContent = `æ›´æ–°æ—¶é—´: ${formatDateTime(date)}`;
  } else {
    stageTimestamp.textContent = 'å°šæœªå¼€å§‹';
  }
  
  const stageDescription = document.createElement('p');
  let descriptionText = '';
  
  // æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½æ˜¾ç¤ºä¸åŒå†…å®¹
  const isSeller = trackingData.isSeller;
  const isBuyer = trackingData.isBuyer;
  
  switch(stage.id) {
    case 1:
      if (stage.status === 'completed') {
        descriptionText = `æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : ''}éœ€æ±‚å·²æˆåŠŸæäº¤ï¼æˆ‘ä»¬çš„ç³»ç»Ÿæ­£åœ¨è¿›è¡Œåˆæ­¥åˆ†æï¼Œä»¥ä¾¿æ›´å¥½åœ°åŒ¹é…åˆé€‚çš„${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚å¦‚éœ€è¡¥å……å…·ä½“è¦æ±‚æˆ–æŸ¥è¯¢è¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
      } else {
        descriptionText = `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨çš„${isSeller ? 'å‡ºå”®' : isBuyer ? 'é‡‡è´­' : 'éœ€æ±‚'}æ„å‘ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'èµ„æº'}ã€‚æ‚¨å¯ä»¥éšæ—¶æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©ã€‚`;
      }
      break;
    case 2:
      if (stage.status === 'completed') {
        descriptionText = `ç³»ç»Ÿå·²æˆåŠŸä¸ºæ‚¨åŒ¹é…åˆ°ç¬¦åˆè¦æ±‚çš„${isSeller ? 'æ½œåœ¨ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚ç°åœ¨è¿›å…¥${isSeller ? 'ä¹°å®¶' : 'å–å®¶'}ç¡®è®¤é˜¶æ®µã€‚å¦‚éœ€äº†è§£åŒ¹é…è¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else if (stage.status === 'active') {
        descriptionText = `ç³»ç»Ÿæ­£åœ¨æ ¹æ®æ‚¨æä¾›çš„è¦æ±‚åŒ¹é…${isSeller ? 'ä¹°å®¶èµ„æº' : 'åº“å­˜'}ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦12å°æ—¶å†…å®Œæˆã€‚å¦‚éœ€åŠ å¿«è¿›åº¦æˆ–æä¾›æ›´è¯¦ç»†çš„éœ€æ±‚ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨éœ€æ±‚æäº¤åè‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…${isSeller ? 'ä¹°å®¶' : 'åº“å­˜èµ„æº'}ã€‚`;
      }
      break;
    case 3:
      if (stage.status === 'completed') {
        descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç°åœ¨ç­‰å¾…ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else if (stage.status === 'active') {
        descriptionText = `æˆ‘ä»¬å·²æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„åº“å­˜ï¼Œæ­£åœ¨ç­‰å¾…å–å®¶ç¡®è®¤ã€‚é€šå¸¸ä¼šåœ¨24å°æ—¶å†…å¾—åˆ°å›å¤ã€‚å¦‚æƒ³ä¼˜å…ˆå¤„ç†æˆ–äº†è§£æ›´å¤šè¯¦æƒ…ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨åŒ¹é…åˆ°åˆé€‚åº“å­˜åè”ç³»å–å®¶ç¡®è®¤ã€‚`;
      }
      break;
    case 4:
      if (stage.status === 'completed') {
        descriptionText = `ä¹°å®¶å·²ç¡®è®¤è´­ä¹°æ„å‘ï¼Œç°åœ¨è¿›å…¥æœ€ç»ˆç¡®è®¤é˜¶æ®µã€‚è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆäº¤æ˜“ç»†èŠ‚ç¡®è®¤ã€‚`;
      } else if (stage.status === 'active') {
        descriptionText = `å–å®¶å·²ç¡®è®¤åº“å­˜æœ‰æ•ˆï¼Œç­‰å¾…æ‚¨çš„æœ€ç»ˆç¡®è®¤ã€‚ä¸ºç¡®ä¿äº¤æ˜“é¡ºåˆ©è¿›è¡Œï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è¿›è¡Œåç»­æ²Ÿé€š`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨å–å®¶ç¡®è®¤åè”ç³»ä¹°å®¶æœ€ç»ˆç¡®è®¤ã€‚`;
      }
      break;
    case 5:
      if (stage.status === 'completed') {
        descriptionText = `æ­å–œï¼äº¤æ˜“å·²æˆåŠŸå¯¹æ¥ã€‚è¯·é€šè¿‡å¾®ä¿¡ï¼š${wechatContact} å®Œæˆåç»­äº¤æ˜“æµç¨‹ã€‚`;
      } else if (stage.status === 'active') {
        descriptionText = `æ­å–œï¼åŒæ–¹å·²è¾¾æˆå¯¹æ¥æ„å‘ã€‚ä¸ºä¿éšœäº¤æ˜“å®‰å…¨å’Œé¡ºåˆ©å®Œæˆåç»­æµç¨‹ï¼Œè¯·ç«‹å³æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–è¯¦ç»†æŒ‡å¯¼`;
      } else {
        descriptionText = `æ­¤é˜¶æ®µå°šæœªå¼€å§‹ã€‚ç³»ç»Ÿå°†åœ¨ä¹°å®¶ç¡®è®¤åè¿›å…¥æœ€ç»ˆå¯¹æ¥ç¡®è®¤é˜¶æ®µã€‚`;
      }
      break;
    default:
      descriptionText = `å½“å‰é˜¶æ®µçŠ¶æ€æ›´æ–°ä¸­ã€‚å¦‚éœ€åŠæ—¶äº†è§£æœ€æ–°è¿›å±•ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}`;
  }
  
  stageDescription.innerHTML = descriptionText;
  
  const nextStepsTitle = document.createElement('h4');
  nextStepsTitle.textContent = 'ä¸‹ä¸€æ­¥æ“ä½œ';
  
  const nextStepsList = document.createElement('ul');
  const nextSteps = getNextSteps(stage.id, stage.status, trackingData);
  
  nextSteps.forEach(step => {
    const listItem = document.createElement('li');
    listItem.innerHTML = step;
    nextStepsList.appendChild(listItem);
  });
  
  // æ·»åŠ å¹³å°ç¡®è®¤æç¤º
  const platformConfirmNote = document.createElement('div');
  platformConfirmNote.classList.add('platform-confirmation-note');
  platformConfirmNote.innerHTML = `<i>æ³¨æ„ï¼šå¯¹æ¥è¿›åº¦ç”±å¹³å°æ ¹æ®å®é™…æƒ…å†µç¡®è®¤æ›´æ–°ï¼Œé˜¶æ®µè¿›åº¦æ— æ³•æ‰‹åŠ¨ä¿®æ”¹ã€‚å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼š${wechatContact}</i>`;
  
  stageContent.appendChild(stageTitle);
  stageContent.appendChild(stageTimestamp);
  stageContent.appendChild(stageDescription);
  stageContent.appendChild(nextStepsTitle);
  stageContent.appendChild(nextStepsList);
  stageContent.appendChild(platformConfirmNote);
  
  modalContent.appendChild(closeBtn);
  modalContent.appendChild(stageContent);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}

// æ›´æ–°å¯¹æ¥è¿›åº¦
function updateTrackingProgress() {
  let trackingData = JSON.parse(localStorage.getItem('trackingData'));
  
  if (!trackingData) return;
  
  // è·å–å½“å‰æ´»è·ƒé˜¶æ®µ
  let currentActiveIndex = trackingData.stages.findIndex(stage => stage.status === 'active');
  
  // æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­æ¶ˆæ¯
  showProgressUpdateMessage();
  
  // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤è¿‡ç¨‹ï¼ˆå®é™…ç¯å¢ƒä¸­åº”é€šè¿‡åç«¯APIè·å–ç¡®è®¤ç»“æœï¼‰
  setTimeout(() => {
    // å¹³å°å®¡æ ¸ç¡®è®¤åï¼Œæ›´æ–°è¿›åº¦
    // æ³¨æ„ï¼šåœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªç¡®è®¤è¿‡ç¨‹åº”è¯¥æ¥è‡ªæœåŠ¡å™¨
    const platformConfirmed = Math.random() > 0.5; // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤ç»“æœ
    
    if (platformConfirmed && currentActiveIndex !== -1 && currentActiveIndex < trackingData.stages.length - 1) {
      // å½“å‰é˜¶æ®µå®Œæˆ
      trackingData.stages[currentActiveIndex].status = 'completed';
      trackingData.stages[currentActiveIndex].timestamp = new Date().toISOString();
      
      // ä¸‹ä¸€é˜¶æ®µæ¿€æ´»
      trackingData.stages[currentActiveIndex + 1].status = 'active';
      trackingData.currentStage = currentActiveIndex + 2; // +2æ˜¯å› ä¸ºstage idä»1å¼€å§‹
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      showNotification("è¿›åº¦å·²æ›´æ–°", "å¹³å°å·²ç¡®è®¤æ‚¨çš„è¿›åº¦æ›´æ–°", "success");
    } else {
      // å¹³å°æœªç¡®è®¤
      showNotification("è¿›åº¦æ›´æ–°ç­‰å¾…ä¸­", "æ‚¨çš„è¿›åº¦æ›´æ–°è¯·æ±‚æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤", "info");
    }
    
    // éšæœºæ›´æ–°å…¶ä»–ä¿¡æ¯
    if (!trackingData.productType && Math.random() > 0.7) {
      const products = ['ç‰›ä»”', 'ä¸ç»¸', 'æ£‰éº»', 'ç¾Šæ¯›'];
      trackingData.productType = products[Math.floor(Math.random() * products.length)];
    }
    
    if (!trackingData.needType && Math.random() > 0.7) {
      trackingData.needType = Math.random() > 0.5 ? 'é¢æ–™' : 'æœè£…';
    }
    
    if (!trackingData.quantity && trackingData.isSeller && Math.random() > 0.7) {
      const units = ['ä»¶', 'ç±³', 'æ¡'];
      trackingData.quantity = `${Math.floor(Math.random() * 1000) + 10}${units[Math.floor(Math.random() * units.length)]}`;
    }
    
    if (!trackingData.budgetRange && trackingData.isBuyer && Math.random() > 0.7) {
      const min = Math.floor(Math.random() * 500) + 50;
      const max = min + Math.floor(Math.random() * 500) + 50;
      trackingData.budgetRange = `${min}-${max}å…ƒ`;
    }
    
    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    trackingData.lastUpdated = new Date().toISOString();
    
    // ä¿å­˜æ›´æ–°åçš„æ•°æ®
    localStorage.setItem('trackingData', JSON.stringify(trackingData));
    
    // é‡æ–°åˆå§‹åŒ–è¿›åº¦é¢æ¿
    initTrackingPanel();
  }, 2000); // æ¨¡æ‹Ÿå¹³å°ç¡®è®¤å»¶è¿Ÿ
}

// æ˜¾ç¤ºè¿›åº¦æ›´æ–°ä¸­çš„æ¶ˆæ¯
function showProgressUpdateMessage() {
  const notification = document.createElement('div');
  notification.classList.add('progress-notification', 'updating');
  notification.innerHTML = `
    <div class="notification-icon">
      <div class="loading-spinner"></div>
    </div>
    <div class="notification-content">
      <h4>è¿›åº¦æ›´æ–°è¯·æ±‚å·²æäº¤</h4>
      <p>æ­£åœ¨ç­‰å¾…å¹³å°ç¡®è®¤ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...</p>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // 1.5ç§’åç§»é™¤é€šçŸ¥
  setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 500);
  }, 1500);
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(title, message, type = "info") {
  const notification = document.createElement('div');
  notification.classList.add('progress-notification', type);
  
  let icon = '';
  if (type === 'success') {
    icon = '<div class="notification-icon success">âœ“</div>';
  } else if (type === 'error') {
    icon = '<div class="notification-icon error">âœ—</div>';
  } else {
    icon = '<div class="notification-icon info">i</div>';
  }
  
  notification.innerHTML = `
    ${icon}
    <div class="notification-content">
      <h4>${title}</h4>
      <p>${message}</p>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // 3ç§’åç§»é™¤é€šçŸ¥
  setTimeout(() => {
    notification.classList.add('fade-out');
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 500);
  }, 3000);
}

// è·å–çŠ¶æ€æ–‡æœ¬æè¿°
function getStatusText(status) {
  switch(status) {
    case 'pending': return 'ç­‰å¾…ä¸­';
    case 'active': return 'è¿›è¡Œä¸­';
    case 'completed': return 'å·²å®Œæˆ';
    default: return 'æœªçŸ¥çŠ¶æ€';
  }
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${year}-${month}-${day} ${hours}:${minutes}`;
}

// è·å–æ—¶é—´å·®å¼‚çš„å‹å¥½æè¿°
function getTimeDifference(oldDate, newDate) {
  const diffMs = newDate - oldDate;
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);
  const diffHour = Math.floor(diffMin / 60);
  const diffDay = Math.floor(diffHour / 24);
  
  if (diffSec < 60) {
    return 'åˆšåˆš';
  } else if (diffMin < 60) {
    return `${diffMin}åˆ†é’Ÿå‰`;
  } else if (diffHour < 24) {
    return `${diffHour}å°æ—¶å‰`;
  } else if (diffDay < 30) {
    return `${diffDay}å¤©å‰`;
  } else {
    const month = String(oldDate.getMonth() + 1).padStart(2, '0');
    const day = String(oldDate.getDate()).padStart(2, '0');
    return `${month}-${day}`;
  }
}

// è·å–å·²å®Œæˆé˜¶æ®µçš„æ•°é‡
function getCompletedStages(stages) {
  return stages.filter(stage => stage.status === 'completed').length;
}

// åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åŒ…å«å…·ä½“äº§å“ä¿¡æ¯
function containsSpecificProductInfo(message) {
  // åŒ¹é…å…·ä½“çš„äº§å“æè¿°
  const patterns = [
    /\d+[ä»¶æ¡ç±³å¨]/,  // åŒ¹é…æ•°é‡å•ä½
    /æ¬¾å¼|å‹å·|è§„æ ¼|å°ºå¯¸|é¢œè‰²|æˆåˆ†/,  // åŒ¹é…äº§å“å±æ€§
    /ç‰Œ|å“ç‰Œ|å‚å®¶|ç”Ÿäº§å•†/,  // åŒ¹é…å“ç‰Œä¿¡æ¯
    /ä»·æ ¼|æŠ¥ä»·|å…ƒ\/[ç±³ä»¶æ¡]/  // åŒ¹é…ä»·æ ¼ä¿¡æ¯
  ];
  
  return patterns.some(pattern => pattern.test(message));
}

// æ ¹æ®ä¸åŒé˜¶æ®µå’Œç”¨æˆ·èº«ä»½è·å–ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•
function getNextSteps(stageId, stageStatus, trackingData) {
  const wechatContact = '<strong>JJ1598929032</strong>';
  const isSeller = trackingData.isSeller;
  const isBuyer = trackingData.isBuyer;
  
  // å¦‚æœé˜¶æ®µå·²å®Œæˆï¼Œè¿”å›ç©ºæ­¥éª¤åˆ—è¡¨
  if (stageStatus === 'completed') {
    return [`æ­¤é˜¶æ®µå·²å®Œæˆï¼Œè¯·ç»§ç»­æ¨è¿›ä¸‹ä¸€é˜¶æ®µ`, `å¦‚æœ‰é—®é¢˜è¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å’¨è¯¢`];
  }
  
  // å¦‚æœé˜¶æ®µæœªå¼€å§‹ï¼Œè¿”å›ç­‰å¾…æŒ‡å¼•
  if (stageStatus === 'pending') {
    return [`è¯·ç­‰å¾…å‰åºé˜¶æ®µå®Œæˆåå†è¿›è¡Œæ­¤é˜¶æ®µ`, `å¦‚éœ€åŠ é€Ÿè¿›åº¦ï¼Œè¯·æ·»åŠ å¾®ä¿¡ï¼š${wechatContact}`];
  }
  
  // é˜¶æ®µå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæ ¹æ®ä¸åŒæƒ…å†µè¿”å›æŒ‡å¼•
  if (isSeller) {
    switch(stageId) {
      case 1:
        return [
          `è¯¦ç»†æè¿°æ‚¨è¦å‡ºå”®çš„äº§å“ç±»å‹ã€æ•°é‡å’ŒæœŸæœ›ä»·æ ¼`,
          `æä¾›äº§å“å›¾ç‰‡æˆ–è¯¦ç»†è§„æ ¼è¯´æ˜`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
        ];
      case 2:
        return [
          `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…æ½œåœ¨ä¹°å®¶`,
          `å®Œå–„æ‚¨çš„äº§å“ç»†èŠ‚ä¿¡æ¯ä»¥æé«˜åŒ¹é…ç‡`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
        ];
      case 3:
        return [
          `å‡†å¤‡å¥½è¯¦ç»†çš„äº§å“è¯´æ˜å’Œä»·æ ¼èµ„æ–™`,
          `ç¡®è®¤æ‚¨çš„å‘è´§èƒ½åŠ›å’Œåº“å­˜æƒ…å†µ`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£ä¹°å®¶éœ€æ±‚ç»†èŠ‚`
        ];
      case 4:
        return [
          `å‡†å¤‡è¯¦ç»†çš„äº§å“èµ„æ–™å’ŒæŠ¥ä»·å•`,
          `ç¡®è®¤æ‚¨çš„ä»“åº“åº“å­˜å’Œç‰©æµé…é€æ–¹æ¡ˆ`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸ä¹°å®¶ç›´æ¥æ²Ÿé€š`
        ];
      case 5:
        return [
          `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œä»˜æ¬¾æ–¹å¼`,
          `å‡†å¤‡äº§å“å‘è´§å’Œå”®åæœåŠ¡æ–¹æ¡ˆ`,
          `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
        ];
      default:
        return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
    }
  } else if (isBuyer) {
    switch(stageId) {
      case 1:
        return [
          `è¯¦ç»†æè¿°æ‚¨éœ€è¦çš„äº§å“ç±»å‹ã€æ•°é‡å’Œé¢„ç®—`,
          `è¯´æ˜æ‚¨å¯¹äº§å“è´¨é‡å’Œè§„æ ¼çš„è¦æ±‚`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} åŠ é€Ÿå¯¹æ¥è¿›ç¨‹`
        ];
      case 2:
        return [
          `è€å¿ƒç­‰å¾…ç³»ç»Ÿä¸ºæ‚¨åŒ¹é…åˆé€‚åº“å­˜`,
          `å®Œå–„æ‚¨çš„éœ€æ±‚ç»†èŠ‚ä»¥æé«˜åŒ¹é…ç²¾å‡†åº¦`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å®æ—¶åŒ¹é…è¿›åº¦`
        ];
      case 3:
        return [
          `å‡†å¤‡å¥½ä¸å–å®¶æ²Ÿé€šçš„å…·ä½“é—®é¢˜`,
          `ç¡®è®¤æ‚¨çš„é‡‡è´­é¢„ç®—å’Œä»˜æ¬¾æ–¹å¼`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} äº†è§£å–å®¶ç¡®è®¤è¿›åº¦`
        ];
      case 4:
        return [
          `ä»”ç»†è¯„ä¼°å–å®¶æä¾›çš„äº§å“ä¿¡æ¯`,
          `ç¡®è®¤äº§å“æ˜¯å¦æ»¡è¶³æ‚¨çš„éœ€æ±‚`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} ä¸å–å®¶ç›´æ¥æ²Ÿé€š`
        ];
      case 5:
        return [
          `ç¡®è®¤äº¤æ˜“ç»†èŠ‚å’Œæ”¶è´§åœ°å€`,
          `å‡†å¤‡ä»˜æ¬¾å’ŒéªŒæ”¶äº§å“`,
          `å¿…é¡»æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} å®Œæˆæœ€ç»ˆäº¤æ˜“`
        ];
      default:
        return [`æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–æŒ‡å¯¼`];
    }
  } else {
    // ç”¨æˆ·èº«ä»½æœªç¡®å®š
    switch(stageId) {
      case 1:
        return [
          `è¯·åœ¨èŠå¤©æ¡†ä¸­è¯´æ˜æ‚¨æ˜¯å¸Œæœ›å‡ºå”®è¿˜æ˜¯é‡‡è´­`,
          `è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚æˆ–äº§å“ä¿¡æ¯`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–ä¸“ä¸šæŒ‡å¯¼`
        ];
      default:
        return [
          `è¯·å…ˆæ˜ç¡®æ‚¨çš„èº«ä»½ï¼ˆä¹°å®¶/å–å®¶ï¼‰`,
          `æ·»åŠ å¾®ä¿¡ï¼š${wechatContact} è·å–å¸®åŠ©`
        ];
    }
  }
}

// ä¸ºåŠ¨ç”»æ·»åŠ ç¨³å®šæ€§ä¿®å¤
function animateStats() {
  const statValues = document.querySelectorAll('.stat-value');
  
  statValues.forEach(statValue => {
    const targetValue = parseInt(statValue.textContent, 10);
    let currentValue = 0;
    const duration = 2000;
    const stepTime = 20;
    const totalSteps = duration / stepTime;
    const stepValue = targetValue / totalSteps;
    
    function updateValue() {
      currentValue += stepValue;
      
      if (currentValue < targetValue) {
        statValue.textContent = Math.floor(currentValue);
        requestAnimationFrame(updateValue);
      } else {
        statValue.textContent = targetValue;
        
        // æ·»åŠ ä»¥é˜²æ­¢æ•°å­—å˜åŒ–å¯¼è‡´å¸ƒå±€ç§»åŠ¨
        statValue.style.minWidth = statValue.offsetWidth + 'px';
      }
    }
    
    // å½“å…ƒç´ è¿›å…¥è§†å£æ—¶å¯åŠ¨åŠ¨ç”»
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          updateValue();
          observer.unobserve(entry.target);
        }
      });
    });
    
    observer.observe(statValue);
  });
}

// å¯¼èˆªæ åˆå§‹åŒ–ä¸æ»šåŠ¨æ•ˆæœ
function initNavbar() {
  const navbar = document.querySelector('.navbar');
  
  // æ»šåŠ¨ç›‘å¬
  window.addEventListener('scroll', function() {
    if (window.scrollY > 50) {
      navbar.classList.add('scrolled');
    } else {
      navbar.classList.remove('scrolled');
    }
  });
  
  // å¯¼èˆªèœå•é¡¹ç‚¹å‡»æ¿€æ´»æ•ˆæœ
  const navLinks = document.querySelectorAll('.main-nav a');
  
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      // è·å–ç›®æ ‡éƒ¨åˆ†çš„ID
      const targetId = this.getAttribute('href');
      
      // ä»…å¯¹é¡µå†…é”šç‚¹é“¾æ¥è¿›è¡Œå¤„ç†
      if (targetId.startsWith('#')) {
        e.preventDefault();
        
        const targetSection = document.querySelector(targetId);
        
        if (targetSection) {
          // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡éƒ¨åˆ†
          window.scrollTo({
            top: targetSection.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
            behavior: 'smooth'
          });
          
          // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
          history.pushState(null, null, targetId);
          
          // ç§»é™¤æ‰€æœ‰activeç±»
          navLinks.forEach(item => {
            item.parentElement.classList.remove('active');
          });
          
          // ä¸ºå½“å‰ç‚¹å‡»é¡¹æ·»åŠ activeç±»
          this.parentElement.classList.add('active');
        }
      }
    });
  });
}

// æ·»åŠ æ»šåŠ¨ç›‘å¬ï¼Œé«˜äº®å½“å‰è§†å›¾ä¸­çš„éƒ¨åˆ†
function initScrollSpy() {
  // è·å–æ‰€æœ‰ä¸»è¦éƒ¨åˆ†
  const sections = document.querySelectorAll('section[id]');
  const navLinks = document.querySelectorAll('.main-nav a');
  
  // æ·»åŠ æ»šåŠ¨ç›‘å¬
  window.addEventListener('scroll', function() {
    // å½“å‰æ»šåŠ¨ä½ç½®
    const scrollPosition = window.scrollY + 100; // æ·»åŠ ä¸€äº›åç§»ä»¥æå‰æ¿€æ´»
    
    // æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†çš„ä½ç½®
    sections.forEach(section => {
      // è·å–éƒ¨åˆ†çš„é¡¶éƒ¨å’Œåº•éƒ¨ä½ç½®
      const sectionTop = section.offsetTop;
      const sectionBottom = sectionTop + section.offsetHeight;
      
      // æ£€æŸ¥å½“å‰æ»šåŠ¨ä½ç½®æ˜¯å¦åœ¨è¯¥éƒ¨åˆ†
      if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
        // æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé“¾æ¥
        const targetId = '#' + section.getAttribute('id');
        
        // ç§»é™¤æ‰€æœ‰activeç±»
        navLinks.forEach(link => {
          link.parentElement.classList.remove('active');
          
          // ä¸ºå½“å‰éƒ¨åˆ†çš„é“¾æ¥æ·»åŠ activeç±»
          if (link.getAttribute('href') === targetId) {
            link.parentElement.classList.add('active');
          }
        });
      }
    });
  });
}

// å¹³æ»‘æ»šåŠ¨æ•ˆæœ
function addSmoothScrolling() {
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      const targetId = this.getAttribute('href');
      
      if (targetId === '#') return;
      
      const target = document.querySelector(targetId);
      
      if (target) {
        e.preventDefault();
        
        window.scrollTo({
          top: target.offsetTop - 70, // å‡å»å¯¼èˆªæ é«˜åº¦
          behavior: 'smooth'
        });
        
        // æ›´æ–°URLé”šç‚¹ï¼Œä½†ä¸è·³è½¬
        history.pushState(null, null, targetId);
      }
    });
  });
} 